{% extends "base.html" %}
{% block content %}
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:24px;">
    <h2 style="margin:0">User Management</h2>
  </div>

  <!-- Invite New User -->
  <div class="card" style="margin-bottom:32px;">
    <div class="card-header">
      <h3 class="card-title">Invite New User</h3>
      <p class="card-subtitle">Send an invitation to create a new account</p>
    </div>
    <form method="post" action="{{ url_for('admin_invite') }}" style="display:flex; gap:12px; align-items:end;">
      <div class="form-group" style="flex:1; margin:0;">
        <label class="form-label">Email Address</label>
        <input class="form-input" type="email" name="email" placeholder="user@example.com" required>
      </div>
      <div class="form-group" style="margin:0;">
        <label class="form-label">
          <input type="checkbox" name="is_admin" style="margin-right:8px;">
          System Administrator
        </label>
      </div>
      <button class="btn primary" type="submit">Send Invitation</button>
    </form>
  </div>

  <!-- Pending Invitations -->
  {% if invitations %}
  <div class="card" style="margin-bottom:32px;">
    <div class="card-header">
      <h3 class="card-title">Pending Invitations</h3>
      <p class="card-subtitle">{{ invitations|length }} invitation(s) waiting to be accepted</p>
    </div>
    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="border-bottom:1px solid #374151;">
            <th style="text-align:left; padding:12px; color:#9ca3af; font-size:12px; text-transform:uppercase;">Email</th>
            <th style="text-align:left; padding:12px; color:#9ca3af; font-size:12px; text-transform:uppercase;">Role</th>
            <th style="text-align:left; padding:12px; color:#9ca3af; font-size:12px; text-transform:uppercase;">Expires</th>
            <th style="text-align:left; padding:12px; color:#9ca3af; font-size:12px; text-transform:uppercase;">Invited By</th>
            <th style="text-align:left; padding:12px; color:#9ca3af; font-size:12px; text-transform:uppercase;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for inv in invitations %}
          <tr style="border-bottom:1px solid #2d3748;">
            <td style="padding:12px; color:#e5e7eb;">{{ inv.email }}</td>
            <td style="padding:12px;">
              <span class="chip" style="background:{% if inv.is_admin == 'true' %}#dc2626{% else %}#059669{% endif %}; color:white; padding:4px 8px; border-radius:4px; font-size:12px;">
                {% if inv.is_admin == 'true' %}Admin{% else %}User{% endif %}
              </span>
            </td>
            <td style="padding:12px; color:#9ca3af; font-size:14px;">{{ inv.expires_at.strftime('%Y-%m-%d %H:%M') if inv.expires_at else 'No expiry' }}</td>
            <td style="padding:12px; color:#9ca3af; font-size:14px;">{{ inv.invited_by }}</td>
            <td style="padding:12px;">
              <form method="post" action="{{ url_for('admin_delete_invitation', invitation_id=inv.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this invitation?')">
                <button type="submit" class="btn small secondary" style="background:#dc2626; color:white; padding:4px 8px; border:none; border-radius:4px; font-size:12px; cursor:pointer;">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Existing Users -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Existing Users</h3>
      <p class="card-subtitle">{{ users|length }} registered user(s)</p>
    </div>
    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="border-bottom:1px solid #374151;">
            <th style="text-align:left; padding:12px; color:#9ca3af; font-size:12px; text-transform:uppercase;">Name</th>
            <th style="text-align:left; padding:12px; color:#9ca3af; font-size:12px; text-transform:uppercase;">Email</th>
            <th style="text-align:left; padding:12px; color:#9ca3af; font-size:12px; text-transform:uppercase;">Role</th>
            <th style="text-align:left; padding:12px; color:#9ca3af; font-size:12px; text-transform:uppercase;">Status</th>
            <th style="text-align:left; padding:12px; color:#9ca3af; font-size:12px; text-transform:uppercase;">Created</th>
            <th style="text-align:left; padding:12px; color:#9ca3af; font-size:12px; text-transform:uppercase;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr style="border-bottom:1px solid #2d3748;">
            <td style="padding:12px; color:#e5e7eb;">
              <div style="font-weight:600;">{{ user.name or user.email.split('@')[0] }}</div>
              {% if user.id == session.get('uid') %}<span style="color:#f97316; font-size:12px;">(You)</span>{% endif %}
            </td>
            <td style="padding:12px; color:#9ca3af; font-size:14px;">
              {{ user.email }}
            </td>
            <td style="padding:12px;">
              <span class="chip" style="background:{% if user.is_admin == 'true' %}#dc2626{% else %}#059669{% endif %}; color:white; padding:4px 8px; border-radius:4px; font-size:12px;">
                {% if user.is_admin == 'true' %}Admin{% else %}User{% endif %}
              </span>
            </td>
            <td style="padding:12px;">
              <span class="chip" style="background:{% if user.is_active == 'true' %}#059669{% else %}#6b7280{% endif %}; color:white; padding:4px 8px; border-radius:4px; font-size:12px;">
                {% if user.is_active == 'true' %}Active{% else %}Inactive{% endif %}
              </span>
            </td>
            <td style="padding:12px; color:#9ca3af; font-size:14px;">{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'Unknown' }}</td>
            <td style="padding:12px;">
              {% if user.id != session.get('uid') %}
                <!-- Toggle Active/Inactive -->
                <form method="post" action="{{ url_for('admin_toggle_user', user_id=user.id) }}" style="display:inline; margin-right:8px;">
                  <button class="btn small {% if user.is_active == 'true' %}secondary{% else %}primary{% endif %}" type="submit">
                    {% if user.is_active == 'true' %}Deactivate{% else %}Activate{% endif %}
                  </button>
                </form>
                
                <!-- Edit Name -->
                <button class="btn small" onclick="editUserName('{{ user.id }}', '{{ user.name or user.email.split('@')[0] }}')" style="background:#3b82f6; color:white; margin-right:8px;">
                  ‚úèÔ∏è Edit
                </button>
                
                <!-- Delete User -->
                <form method="post" action="{{ url_for('admin_delete_user', user_id=user.id) }}" style="display:inline;" onsubmit="return confirm('‚ö†Ô∏è Are you sure you want to DELETE this user permanently?\\n\\nThis action cannot be undone and will:\\n‚Ä¢ Remove the user account\\n‚Ä¢ Remove access to all projects\\n\\nUser: {{ user.name or user.email }}')">
                  <button type="submit" class="btn small" style="background:#dc2626; color:white;">
                    üóëÔ∏è Delete
                  </button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Edit User Name Modal -->
  <div id="editNameModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#1f2937; padding:24px; border-radius:8px; width:90%; max-width:400px;">
      <h3 style="color:#ffffff; margin-bottom:16px;">Edit User Name</h3>
      <form id="editNameForm" method="post" action="">
        <div class="form-group" style="margin-bottom:16px;">
          <label class="form-label" style="color:#e5e7eb;">Display Name</label>
          <input id="editNameInput" class="form-input" type="text" name="name" placeholder="Enter user's display name" required style="background:#374151; color:#ffffff; border:1px solid #4b5563; padding:8px 12px; border-radius:4px; width:100%;">
        </div>
        <div style="display:flex; gap:12px; justify-content:flex-end;">
          <button type="button" onclick="closeEditModal()" class="btn secondary">Cancel</button>
          <button type="submit" class="btn primary">Save Name</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function editUserName(userId, currentName) {
      document.getElementById('editNameInput').value = currentName;
      document.getElementById('editNameForm').action = `/admin/users/${userId}/edit`;
      document.getElementById('editNameModal').style.display = 'block';
    }
    
    function closeEditModal() {
      document.getElementById('editNameModal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    document.getElementById('editNameModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeEditModal();
      }
    });
  </script>
{% endblock %}
