{% extends "base.html" %}
{% block content %}
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <div>
      <div class="kicker">{{ project.human_code or project.category }}</div>
      <h2 style="margin:0">{{ project.name }}</h2>
      <div class="addr">
        {{ project.address_line or '' }}{% if project.city %}, {{ project.city }}{% endif %}{% if project.state %}, {{ project.state }}{% endif %}{% if project.zip %} {{ project.zip }}{% endif %}
      </div>
    </div>
    <div class="toolbar">
      <a class="btn secondary" href="{{ url_for('dashboard') }}">‚Üê Dashboard</a>
      <a class="btn secondary" href="{{ url_for('project_edit_form', proj_id=project.id) }}">‚úèÔ∏è Edit</a>
      <button class="btn" onclick="startCameraCapture('{{ project.id }}')" id="cameraBtn">
        üì∏ Camera
      </button>
      <button class="btn" onclick="enhancedUpload('{{ project.id }}')">üìÅ Upload Photos</button>
      <a class="btn" href="{{ url_for('reports_simple') }}?project_id={{ project.id }}" style="background:#f97316;color:#fff;border:none;">üßæ Quick Report</a>
    </div>
  </div>

  <style>
    @media (max-width: 768px) {
      #voiceBtn { display: none !important; }
    }
  </style>

  <!-- Notes Section -->
  <div class="modal-section" style="margin-top:20px;">
    <div class="modal-section-header" style="display:flex;align-items:center;gap:8px;">
      <h4 style="margin:0;">Notes</h4>
      <button class="modal-add-btn" onclick="toggleVoice('{{ project.id }}')" id="voiceBtn">üéôÔ∏è Start</button>
      <button class="modal-add-btn" onclick="saveNotes('{{ project.id }}','overwrite')">Save</button>
      <button class="modal-add-btn" onclick="saveNotes('{{ project.id }}','append')">Append</button>
      <a class="modal-add-btn" href="/api/projects/{{ project.id }}/notes/download">Download</a>
    </div>
    <textarea id="notesText" class="description-input" style="min-height:140px; margin-top:8px;" placeholder="Type notes here or use voice‚Ä¶"></textarea>
  </div>

  <form class="searchbar" method="get" action="{{ url_for('project_view', proj_id=project.id) }}">
    <input class="input" name="q" placeholder="Search (author/date/tags)" value="{{ q or '' }}">
    <button class="btn" type="submit">Search</button>
  </form>

  <!-- Photos grouped by date -->
  {% if grouped_photos %}
    {% for date_str, photos_in_date in grouped_photos %}
      <div class="date-group">
        <!-- Date header -->
        <div class="date-header">
          <h3 class="date-title">
            {% set date_parts = date_str.split('-') %}
            {% set year = date_parts[0] %}
            {% set month = date_parts[1] %}
            {% set day = date_parts[2] %}
            {% set months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}
            {% set month_name = months[month|int - 1] %}
            {{ month_name }} {{ day|int }}, {{ year }}
          </h3>
          <div class="date-count">{{ photos_in_date | length }} photo{{ 's' if photos_in_date | length != 1 else '' }}</div>
        </div>
        
        <!-- Photos grid for this date -->
        <div class="project-photos-grid">
          {% for ph in photos_in_date %}
            <div class="project-photo-card" data-photo-id="{{ ph.id }}">
              <div class="photo-container">
                <img class="photo-thumb" src="{{ ph.src }}" alt="Photo {{ ph.id }}" onclick="openPhotoDetail('{{ ph.id }}')">
                
                <!-- Three dots menu button -->
                <button class="photo-menu-btn" onclick="togglePhotoMenu(event, '{{ ph.id }}')" aria-label="Photo options">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <circle cx="12" cy="12" r="2"></circle>
                    <circle cx="12" cy="5" r="2"></circle>
                    <circle cx="12" cy="19" r="2"></circle>
                  </svg>
                </button>

                <!-- Dropdown menu -->
                <div class="photo-menu" id="menu-{{ ph.id }}">
                  <div class="menu-item" onclick="downloadPhoto('{{ ph.id }}', '{{ ph.src }}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7,10 12,15 17,10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download
                  </div>
                  <div class="menu-item" onclick="duplicatePhoto('{{ ph.id }}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    Duplicate
                  </div>
                  <div class="menu-item" onclick="setCoverPhoto('{{ project.id }}', '{{ ph.id }}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21,15 16,10 5,21"></polyline>
                    </svg>
                    Set as Cover Photo
                  </div>
                  <div class="menu-item" onclick="sharePhoto('{{ ph.id }}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="18" cy="5" r="3"></circle>
                      <circle cx="6" cy="12" r="3"></circle>
                      <circle cx="18" cy="19" r="3"></circle>
                      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    Share
                  </div>
                  <div class="menu-item" onclick="tagPhoto('{{ ph.id }}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                      <line x1="7" y1="7" x2="7.01" y2="7"></line>
                    </svg>
                    Tag
                  </div>
                  <div class="menu-item" onclick="openPhotoEditor('{{ ph.id }}', '{{ project.id }}', '{{ ph.src }}')" id="edit-item-{{ ph.id }}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 20h9"></path>
                      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
                    </svg>
                    Edit
                  </div>
                  <div class="menu-item danger" onclick="moveToTrash('{{ ph.id }}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3,6 5,6 21,6"></polyline>
                      <path d="M19,6V20a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                    </svg>
                    Move to Trash
                  </div>
                </div>
              </div>

              <!-- CompanyCam-style photo info -->
              <div class="photo-info">
                <div class="photo-meta-line">{{ project.name }}</div>
                <div class="photo-meta-line">{{ ph.created_at.strftime('%I:%M %p') if ph.created_at else (ph.date or '‚Äî') }} ‚Ä¢ {{ ph.author or 'Unknown' }}</div>
                <div class="photo-meta-line">
                  {% if ph.labels %}
                    {% for t in ph.labels.split(',') %}
                      {% set tag = t.strip() %}
                      {% if tag %}<span class="modal-tag">{{ tag }}</span>{% endif %}
                    {% endfor %}
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="empty-state">
      <h3>No photos in this project yet</h3>
      <p>Use the Camera or Upload buttons above to add photos!</p>
    </div>
  {% endif %}

  <!-- Photo Detail Modal (same as photos_feed.html) -->
  <div id="photoModal" class="photo-modal">
    <div class="modal-overlay" onclick="closePhotoModal()"></div>
    <div class="modal-container">
      <!-- Main Photo Area -->
      <div class="modal-photo-area">
        <!-- Top Toolbar -->
        <div class="modal-toolbar">
          <button class="modal-btn" onclick="closePhotoModal()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
          <div class="modal-toolbar-center">
            <span id="modalPhotoCounter">1 of 10</span>
          </div>
          <div class="modal-toolbar-right">
            <button class="modal-btn" onclick="rotateModalPhoto()" title="Rotate">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 1 0 9-9"/>
                <polyline points="3 4 3 10 9 10"/>
              </svg>
            </button>
            <button class="modal-btn" onclick="editCurrentPhoto()" title="Edit">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20h9"></path>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
              </svg>
            </button>
            <button class="modal-btn" onclick="shareCurrentPhoto()" title="Share">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
              </svg>
            </button>
            <button class="modal-btn" onclick="downloadCurrentPhoto()" title="Download">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7,10 12,15 17,10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <button class="modal-btn danger" onclick="deleteCurrentPhoto()" title="Delete">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3,6 5,6 21,6"></polyline>
                <path d="M19,6V20a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Photo Display -->
        <div class="modal-photo-container">
          <button class="modal-nav-btn modal-nav-prev" onclick="previousPhoto()" id="modalPrevBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15,18 9,12 15,6"></polyline>
            </svg>
          </button>
          
          <div class="modal-photo-wrapper">
            <img id="modalPhoto" src="" alt="Photo" class="modal-photo">
          </div>
          
          <button class="modal-nav-btn modal-nav-next" onclick="nextPhoto()" id="modalNextBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9,18 15,12 9,6"></polyline>
            </svg>
          </button>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="modal-sidebar">
        <!-- Project Info -->
        <div class="modal-project-header">
          <h3 id="modalProjectName">{{ project.name }}</h3>
          <p id="modalProjectAddress">{{ project.address_line or '' }}{% if project.city %}, {{ project.city }}{% endif %}{% if project.state %}, {{ project.state }}{% endif %}</p>
          <div class="modal-photo-meta">
            <div class="modal-meta-item">
              <span class="modal-meta-label" id="modalUserInitials">NO</span>
              <span id="modalPhotoLocation">Location</span>
            </div>
            <div class="modal-meta-item">
              <span id="modalPhotoDate">Date</span>
            </div>
          </div>
        </div>

        <!-- Tags Section -->
        <div class="modal-section">
          <div class="modal-section-header">
            <button class="modal-add-btn" onclick="showTagEditor()" id="addTagsBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                <line x1="7" y1="7" x2="7.01" y2="7"></line>
              </svg>
              Add Tags
            </button>
          </div>
          <div id="modalTagsList" class="modal-tags-list">
            <!-- Tags will be populated here -->
          </div>
          <div id="tagEditor" class="tag-editor" style="display: none;">
            <input type="text" id="tagInput" placeholder="Add tags (comma-separated)" class="tag-input">
            <div class="tag-editor-actions">
              <button class="btn secondary" onclick="hideTagEditor()">Cancel</button>
              <button class="btn" onclick="saveTags()">Save</button>
            </div>
          </div>
        </div>

        <!-- Tasks Section -->
        <div class="modal-section">
          <div class="modal-section-header">
            <h4>Tasks</h4>
            <button class="modal-add-btn" onclick="showTaskEditor()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              New Task
            </button>
          </div>
          <div id="modalTasksList" class="modal-tasks-list">
            <div class="empty-tasks">No tasks yet</div>
          </div>
        </div>

        <!-- Voice Comment Section -->
        <div class="modal-section" id="voiceCommentSection" style="display: none;">
          <div class="modal-section-header">
            <h4>
              üéôÔ∏è Voice Comment
              <span id="voiceConfidenceScore" class="voice-confidence"></span>
            </h4>
          </div>
          <div id="modalVoiceComment" class="modal-voice-comment">
            <p class="voice-comment-text"></p>
            <div class="voice-comment-meta">
              <span class="voice-recorded-time"></span>
            </div>
          </div>
        </div>

        <!-- Description Section -->
        <div class="modal-section">
          <div class="modal-section-header">
            <h4>Description</h4>
            <button class="modal-edit-btn" onclick="editDescription()" id="editDescBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              Edit
            </button>
          </div>
          <div id="modalDescription" class="modal-description">
            <p class="description-placeholder">Add a description...</p>
          </div>
          <div id="descriptionEditor" class="description-editor" style="display: none;">
            <textarea id="descriptionInput" placeholder="Add a description..." class="description-input"></textarea>
            <div class="description-editor-actions">
              <button class="btn secondary" onclick="hideDescriptionEditor()">Cancel</button>
              <button class="btn" onclick="saveDescription()">Save</button>
            </div>
          </div>
        </div>

        <!-- Comments Section -->
        <div class="modal-section">
          <div class="modal-section-header">
            <h4>Comments</h4>
          </div>
          <div id="modalCommentsList" class="modal-comments-list">
            <!-- Comments will be populated here -->
          </div>
          <div class="modal-comment-composer">
            <textarea id="commentInput" placeholder="Add a comment..." class="comment-input"></textarea>
            <div class="comment-composer-actions">
              <button class="btn" onclick="postComment()" id="postCommentBtn">Post</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Load notes on page ready
    document.addEventListener('DOMContentLoaded', function(){
      loadNotes('{{ project.id }}');
    });

    async function loadNotes(projectId){
      try{
        const r = await fetch(`/api/projects/${projectId}/notes`);
        const j = await r.json();
        if (j && j.ok) { document.getElementById('notesText').value = j.text || ''; }
      }catch(e){}
    }
    async function saveNotes(projectId, mode){
      const text = document.getElementById('notesText').value;
      const r = await fetch(`/api/projects/${projectId}/notes`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,mode})});
      try{ const j = await r.json(); if(!(j&&j.ok)) alert(j.error||'Failed to save notes'); }catch(e){ alert('Failed to save notes'); }
    }
    // Voice-to-text (Chrome/Edge)
    let rec=null; let recActive=false;
    function toggleVoice(projectId){
      const btn=document.getElementById('voiceBtn');
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ alert('Speech Recognition not supported in this browser'); return; }
      if(!rec){ rec=new SR(); rec.continuous=true; rec.interimResults=true; rec.lang='en-US';
        rec.onresult=(ev)=>{ let final=''; for(let i=ev.resultIndex;i<ev.results.length;i++){ const res=ev.results[i]; if(res.isFinal) final+=res[0].transcript+' '; }
          if(final){ const ta=document.getElementById('notesText'); ta.value = (ta.value?ta.value+'\n':'') + final.trim(); }
        }; rec.onend=()=>{ recActive=false; if(btn) btn.textContent='üéôÔ∏è Start'; } }
      if(recActive){ rec.stop(); recActive=false; btn.textContent='üéôÔ∏è Start'; }
      else { rec.start(); recActive=true; btn.textContent='‚ñ† Stop'; }
    }
    // Check camera availability and update UI
    document.addEventListener('DOMContentLoaded', function() {
      const cameraBtn = document.getElementById('cameraBtn');
      
      if (!isCameraSupported()) {
        // Show button but with disabled state for unsupported browsers/HTTP
        cameraBtn.style.opacity = '0.5';
        cameraBtn.title = 'HTTPS required for camera access';
        cameraBtn.onclick = function() {
          const isHttps = location.protocol === 'https:';
          if (!isHttps) {
            alert('üì∏ Camera requires HTTPS for security.\n\nüîß Solutions:\n1. Access via: https://192.168.1.236:5000\n2. Or use desktop browser for HTTP testing\n\nüõ°Ô∏è Mobile browsers block camera on HTTP for security.');
          } else {
            alert('Camera is not supported in this browser. Please use Chrome, Safari, or Edge.');
          }
        };
        console.log('Camera not supported - likely HTTP instead of HTTPS');
      } else {
        // Always show camera button - let the camera interface handle permissions
        cameraBtn.style.opacity = '1';
        cameraBtn.title = 'Take photos with voice comments';
        
        // Don't pre-check permissions - this can cause the button to hide
        // Let the camera interface handle permission requests when clicked
        console.log('Camera supported - button ready');
      }
    });

    // Portal Pattern Photo Menu - Projects Only
    let currentPortalMenu = null; // Track current portal menu
    
    function togglePhotoMenu(event, photoId) {
      event.preventDefault();
      event.stopPropagation();
      
      console.log('üîç [PROJECT] Portal toggle for photo:', photoId);
      
      // Close any existing portal menu
      if (currentPortalMenu) {
        document.body.removeChild(currentPortalMenu);
        currentPortalMenu = null;
        console.log('üîí [PROJECT] Previous portal menu removed');
      }
      
      // Get button reference
      const button = event.target.closest('.photo-menu-btn');
      if (!button) {
        console.error('‚ùå [PROJECT] Button not found');
        return;
      }
      
      // Create portal menu dynamically
      currentPortalMenu = createPortalMenu(photoId);
      
      // Position the portal menu
      const buttonRect = button.getBoundingClientRect();
      const menuWidth = 200;
      
      let top = buttonRect.bottom + 8;
      let left = buttonRect.right - menuWidth;
      
      // Boundary adjustments
      if (left < 10) left = buttonRect.left;
      if (top > window.innerHeight - 300) top = buttonRect.top - 300;
      
      // Apply portal positioning
      currentPortalMenu.style.position = 'fixed';
      currentPortalMenu.style.top = `${top}px`;
      currentPortalMenu.style.left = `${left}px`;
      currentPortalMenu.style.zIndex = '999999';
      currentPortalMenu.style.opacity = '0';
      currentPortalMenu.style.visibility = 'hidden';
      currentPortalMenu.style.transform = 'translateY(-10px)';
      currentPortalMenu.style.transition = 'all 0.2s ease';
      
      // Add to body (Portal Pattern)
      document.body.appendChild(currentPortalMenu);
      
      // Show with animation
      setTimeout(() => {
        currentPortalMenu.style.opacity = '1';
        currentPortalMenu.style.visibility = 'visible';
        currentPortalMenu.style.transform = 'translateY(0)';
      }, 10);
      
      console.log('‚úÖ [PROJECT] Portal menu created and positioned:', {top, left, 'in-body': true});
    }
    
    // Create portal menu HTML
    function createPortalMenu(photoId) {
      const menu = document.createElement('div');
      menu.className = 'photo-menu portal-menu';
      menu.id = `portal-menu-${photoId}`;
      
      menu.innerHTML = `
        <div class="menu-item" onclick="downloadPhoto('${photoId}', getPhotoSrc('${photoId}'))">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7,10 12,15 17,10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Download
        </div>
        <div class="menu-item" onclick="duplicatePhoto('${photoId}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2 2v1"></path>
          </svg>
          Duplicate
        </div>
        <div class="menu-item" onclick="setCoverPhoto('{{ project.id }}', '${photoId}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21,15 16,10 5,21"></polyline>
          </svg>
          Set as Cover Photo
        </div>
        <div class="menu-item" onclick="sharePhoto('${photoId}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
          Share
        </div>
        <div class="menu-item" onclick="tagPhoto('${photoId}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
            <line x1="7" y1="7" x2="7.01" y2="7"></line>
          </svg>
          Tag
        </div>
        <div class="menu-item" onclick="openPhotoEditor('${photoId}', '{{ project.id }}', getPhotoSrc('${photoId}'))">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 20h9"></path>
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
          </svg>
          Edit
        </div>
        <div class="menu-item danger" onclick="moveToTrash('${photoId}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3,6 5,6 21,6"></polyline>
            <path d="M19,6V20a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
          </svg>
          Move to Trash
        </div>
      `;
      
      return menu;
    }
    
    // Helper function to get photo src
    function getPhotoSrc(photoId) {
      const img = document.querySelector(`[data-photo-id="${photoId}"] .photo-thumb`);
      return img ? img.src : '';
    }

    // Portal menu click outside to close
    document.addEventListener('click', function(event) {
      const clickedButton = event.target.closest('.photo-menu-btn');
      const clickedMenu = event.target.closest('.photo-menu');
      const clickedMenuItem = event.target.closest('.menu-item');
      
      // Close when clicking outside OR when selecting a menu item
      if ((!clickedButton && !clickedMenu) || (clickedMenuItem && currentPortalMenu && clickedMenuItem.closest('.photo-menu') === currentPortalMenu)) {
        if (currentPortalMenu) {
          document.body.removeChild(currentPortalMenu);
          currentPortalMenu = null;
          console.log('üîí [PROJECT] Portal menu closed');
        }
        document.querySelectorAll('.photo-menu').forEach(menu => menu.classList.remove('show'));
      }
    });

    // Photo Modal System (same as photos_feed.html)
    let currentPhotoIndex = 0;
    let currentPhotosList = [];
    let currentPhotoData = {};

    // Collect all photos for navigation
    function collectPhotosData() {
      const photoCards = document.querySelectorAll('.project-photo-card');
      currentPhotosList = Array.from(photoCards).map(card => {
        const img = card.querySelector('.photo-thumb');
        const photoId = card.dataset.photoId;
        const timeEl = card.querySelector('.photo-time');
        const authorEl = card.querySelector('.photo-author');
        
        return {
          id: photoId,
          projectId: '{{ project.id }}',
          src: img.src,
          time: timeEl ? timeEl.textContent : '',
          author: authorEl ? authorEl.textContent : '',
          project: '{{ project.name }}'
        };
      });
    }

    // Open photo modal
    function openPhotoDetail(photoId) {
      collectPhotosData();
      currentPhotoIndex = currentPhotosList.findIndex(photo => photo.id === photoId);
      
      if (currentPhotoIndex === -1) {
        console.error('Photo not found:', photoId);
        return;
      }
      
      showPhotoModal();
      loadPhotoData(currentPhotoIndex);
    }

    function showPhotoModal() {
      const modal = document.getElementById('photoModal');
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closePhotoModal() {
      const modal = document.getElementById('photoModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
      
      // Close any open editors
      hideTagEditor();
      hideDescriptionEditor();
    }

    function loadPhotoData(index) {
      if (index < 0 || index >= currentPhotosList.length) return;
      
      const photo = currentPhotosList[index];
      currentPhotoData = photo;
      
      // Update photo
      const imgEl = document.getElementById('modalPhoto');
      imgEl.style.transform = '';
      imgEl.src = photo.src;
      fixPreviewOrientation(photo.src, imgEl, photo.id);
      
      // Update counter
      document.getElementById('modalPhotoCounter').textContent = `${index + 1} of ${currentPhotosList.length}`;
      
      // Update navigation buttons
      document.getElementById('modalPrevBtn').disabled = index === 0;
      document.getElementById('modalNextBtn').disabled = index === currentPhotosList.length - 1;
      
      // Update project info (already set in template)
      // Show GPS location if available, otherwise show "Unknown Location"
      const fallbackCityState = (photo.project_city && photo.project_state) ? `${photo.project_city}, ${photo.project_state}` : 'Unknown Location';
      document.getElementById('modalPhotoLocation').textContent = photo.gps || fallbackCityState;
      // Use photo.date if present, otherwise format created_at if available
      const initialDate = photo.date || (photo.created_at ? new Date(photo.created_at).toLocaleString() : null);
      document.getElementById('modalPhotoDate').textContent = initialDate || 'Unknown Date';
      
      // Generate user initials from author name
      const author = photo.author || '';
      let initials = 'NO';
      if (author && author.trim()) {
        const words = author.trim().split(/\s+/);
        if (words.length >= 2) {
          initials = (words[0][0] + words[1][0]).toUpperCase();
        } else if (words.length === 1) {
          initials = (words[0][0] + words[0][1] || '').toUpperCase();
        }
      }
      document.getElementById('modalUserInitials').textContent = initials;
      
      // Load additional data from API
      loadPhotoMetadata(photo.id);
    }

    // ---- Orientation correction for preview (shared with photos_feed) ----
    const photoRotationMap = {};
    function getStoredRotation(id){ try{ return parseInt(localStorage.getItem('rot_'+id)||'0',10)||0; }catch(e){ return 0;} }
    function setStoredRotation(id,deg){ try{ localStorage.setItem('rot_'+id, String(deg)); }catch(e){} }
    function applyRotation(imgEl, baseDeg, extraDeg){ const total=((baseDeg+extraDeg)%360+360)%360; imgEl.style.transform = `rotate(${total}deg)`; }
    async function fixPreviewOrientation(url, imgEl, photoId){
      try{
        // Check if this is a recently captured photo (within last 5 minutes)
        // These photos were captured with our new orientation-aware logic
        const photoTimestamp = photoId ? parseInt(photoId) : 0;
        const now = Date.now();
        const fiveMinutesAgo = now - (5 * 60 * 1000);
        
        if (photoTimestamp > fiveMinutesAgo) {
          // Recent photo - likely captured with our new logic, don't apply EXIF corrections
          console.log('üì∑ [ORIENTATION] Skipping EXIF correction for recent photo:', photoId);
          const extra = getStoredRotation(photoId);
          photoRotationMap[photoId] = extra; 
          applyRotation(imgEl, 0, extra); // No base rotation, only user manual rotation
          return;
        }
        
        // Older photo - apply EXIF corrections as before
        const rel = url.startsWith('http') ? new URL(url).pathname : url;
        const res = await fetch(rel, { credentials:'same-origin' });
        if(!res.ok) return;
        const blob = await res.blob();
        const angle = await readExifOrientation(blob); // 1,3,6,8
        let base=0; if(angle===6) base=90; else if(angle===8) base=270; else if(angle===3) base=180; 
        imgEl.dataset.baseRot = String(base);
        const extra=getStoredRotation(photoId);
        photoRotationMap[photoId]=extra; applyRotation(imgEl, base, extra);
      }catch(e){
        console.warn('Error in fixPreviewOrientation:', e);
      }
    }
    function rotateModalPhoto(){
      if(!currentPhotoData) return; const id=currentPhotoData.id; const img=document.getElementById('modalPhoto');
      const base=parseInt(img.dataset.baseRot||'0',10)||0; const prev=photoRotationMap[id]||getStoredRotation(id)||0; const next=(prev+90)%360; photoRotationMap[id]=next; setStoredRotation(id,next); applyRotation(img, base, next);
    }
    async function readExifOrientation(blob){
      try{
        const buf = await blob.arrayBuffer();
        const view = new DataView(buf);
        if (view.getUint16(0, false) !== 0xFFD8) return 1;
        let offset = 2;
        const length = view.byteLength;
        while (offset < length) {
          const marker = view.getUint16(offset, false); offset += 2;
          if (marker === 0xFFE1) {
            const app1Length = view.getUint16(offset, false);
            const exifHeader = offset + 2;
            if (view.getUint32(exifHeader, false) === 0x45786966 && view.getUint16(exifHeader + 4, false) === 0x0000){
              const tiffOffset = exifHeader + 6;
              const little = view.getUint16(tiffOffset, false) === 0x4949;
              const getShort = (o)=> view.getUint16(tiffOffset + o, little);
              const getLong  = (o)=> view.getUint32(tiffOffset + o, little);
              if (getShort(2) !== 0x002A) return 1;
              let ifd = getLong(4);
              const entries = getShort(ifd);
              for (let i=0;i<entries;i++){
                const entry = ifd + 2 + i*12;
                const tag = getShort(entry);
                if (tag === 0x0112){
                  const type = getShort(entry + 2);
                  const count = getLong(entry + 4);
                  if (type === 3 && count === 1){
                    const val = getShort(entry + 8);
                    return val || 1;
                  }
                }
              }
            }
            offset += app1Length;
          } else if ((marker & 0xFF00) !== 0xFF00) {
            break;
          } else {
            offset += view.getUint16(offset, false);
          }
        }
      }catch(e){}
      return 1;
    }

    function previousPhoto() {
      if (currentPhotoIndex > 0) {
        currentPhotoIndex--;
        loadPhotoData(currentPhotoIndex);
      }
    }

    function nextPhoto() {
      if (currentPhotoIndex < currentPhotosList.length - 1) {
        currentPhotoIndex++;
        loadPhotoData(currentPhotoIndex);
      }
    }

    function editCurrentPhoto(){
      if (!currentPhotoData) return;
      openPhotoEditor(currentPhotoData.id, '{{ project.id }}', currentPhotoData.src);
    }

    // Load photo metadata from API
    function loadPhotoMetadata(photoId) {
      fetch(`/api/photos/${photoId}/metadata`)
        .then(response => response.json())
        .then(data => {
          if (data.ok) {
            updateModalTags(data.tags || '');
            updateModalDescription(data.description || '');
            updateModalComments(data.comments || []);
            updateModalVoiceComment(data);
            console.log('üéôÔ∏è [MODAL] Voice comment loaded:', data.voice_comment ? 'Yes' : 'No');
            
            // Update GPS location if available from API
            if (data.gps && data.gps.trim()) {
              document.getElementById('modalPhotoLocation').textContent = data.gps;
              console.log('üìç [MODAL] GPS location loaded:', data.gps);
            }
            if (data.project) {
              // If still unknown, use city/state
              const locEl = document.getElementById('modalPhotoLocation');
              if (!locEl.textContent || locEl.textContent === 'Unknown Location') {
                const cs = (data.project.city && data.project.state) ? `${data.project.city}, ${data.project.state}` : '';
                if (cs) locEl.textContent = cs;
              }
            }
            // Update date/time from API if available
            if (data.date || data.created_at) {
              const dt = data.date || data.created_at;
              const pretty = new Date(dt).toLocaleString();
              document.getElementById('modalPhotoDate').textContent = pretty;
              console.log('üïí [MODAL] Photo date loaded:', pretty);
            }
            
            // Update user initials if we have author data from API
            if (data.author && data.author.trim()) {
              const author = data.author;
              let initials = 'NO';
              const words = author.trim().split(/\s+/);
              if (words.length >= 2) {
                initials = (words[0][0] + words[1][0]).toUpperCase();
              } else if (words.length === 1) {
                initials = (words[0][0] + words[0][1] || '').toUpperCase();
              }
              document.getElementById('modalUserInitials').textContent = initials;
              console.log('üë§ [MODAL] User initials updated:', initials);
            }
          }
        })
        .catch(error => {
          console.error('Error loading photo metadata:', error);
        });
    }

    // Voice comment functionality
    function updateModalVoiceComment(data) {
      const voiceSection = document.getElementById('voiceCommentSection');
      const voiceText = document.querySelector('.voice-comment-text');
      const voiceTime = document.querySelector('.voice-recorded-time');
      const confidenceScore = document.getElementById('voiceConfidenceScore');
      
      if (data.voice_comment && data.voice_comment.trim()) {
        // Show voice comment section
        voiceSection.style.display = 'block';
        
        // Update voice comment text
        voiceText.textContent = data.voice_comment;
        
        // Update confidence score
        const confidence = parseFloat(data.voice_confidence || 0);
        let confidenceClass = 'low';
        let confidenceText = 'Low';
        
        if (confidence >= 0.8) {
          confidenceClass = 'high';
          confidenceText = 'High';
        } else if (confidence >= 0.6) {
          confidenceClass = 'medium';
          confidenceText = 'Med';
        }
        
        confidenceScore.className = `voice-confidence ${confidenceClass}`;
        confidenceScore.textContent = `${Math.round(confidence * 100)}%`;
        
        // Update time
        if (data.created_at) {
          const date = new Date(data.created_at);
          voiceTime.textContent = `Recorded: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        } else {
          voiceTime.textContent = 'Voice captured during photo';
        }
        
        console.log('üéôÔ∏è [MODAL] Voice comment displayed:', data.voice_comment);
      } else {
        // Hide voice comment section if no voice comment
        voiceSection.style.display = 'none';
        console.log('üìù [MODAL] No voice comment for this photo');
      }
    }

    // Tags functionality
    function updateModalTags(tagsString) {
      const tagsList = document.getElementById('modalTagsList');
      if (!tagsString || tagsString.trim() === '') {
        tagsList.innerHTML = '<div class="empty-tags" style="color: #6b7280; font-style: italic; padding: 8px 0;">No tags yet</div>';
        return;
      }
      
      const tags = tagsString.split(',').map(tag => tag.trim()).filter(tag => tag);
      tagsList.innerHTML = tags.map(tag => 
        `<span class="modal-tag">${tag}</span>`
      ).join('');
    }

    function showTagEditor() {
      document.getElementById('tagEditor').style.display = 'block';
      document.getElementById('addTagsBtn').style.display = 'none';
      
      const existingTags = Array.from(document.querySelectorAll('.modal-tag'))
        .map(tag => tag.textContent).join(', ');
      document.getElementById('tagInput').value = existingTags;
      document.getElementById('tagInput').focus();
    }

    function hideTagEditor() {
      document.getElementById('tagEditor').style.display = 'none';
      document.getElementById('addTagsBtn').style.display = 'flex';
    }

    function saveTags() {
      const tags = document.getElementById('tagInput').value;
      const photoId = currentPhotoData.id;
      
      fetch(`/api/photos/${photoId}/tags`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tags: tags })
      })
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          updateModalTags(tags);
          hideTagEditor();
        } else {
          alert('Failed to save tags: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        alert('Error saving tags: ' + error.message);
      });
    }

    // Description functionality
    function updateModalDescription(description) {
      const descEl = document.getElementById('modalDescription');
      if (!description || description.trim() === '') {
        descEl.innerHTML = '<p class="description-placeholder">Add a description...</p>';
      } else {
        descEl.innerHTML = `<p class="description-content">${description}</p>`;
      }
    }

    function editDescription() {
      const currentDesc = document.querySelector('.description-content');
      const currentText = currentDesc ? currentDesc.textContent : '';
      
      document.getElementById('descriptionEditor').style.display = 'block';
      document.getElementById('modalDescription').style.display = 'none';
      document.getElementById('editDescBtn').style.display = 'none';
      
      document.getElementById('descriptionInput').value = currentText;
      document.getElementById('descriptionInput').focus();
    }

    function hideDescriptionEditor() {
      document.getElementById('descriptionEditor').style.display = 'none';
      document.getElementById('modalDescription').style.display = 'block';
      document.getElementById('editDescBtn').style.display = 'block';
    }

    function saveDescription() {
      const description = document.getElementById('descriptionInput').value;
      const photoId = currentPhotoData.id;
      
      fetch(`/api/photos/${photoId}/description`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: description })
      })
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          updateModalDescription(description);
          hideDescriptionEditor();
        } else {
          alert('Failed to save description: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        alert('Error saving description: ' + error.message);
      });
    }

    // Comments functionality
    function updateModalComments(comments) {
      const commentsList = document.getElementById('modalCommentsList');
      
      if (!comments || comments.length === 0) {
        commentsList.innerHTML = '<div class="empty-comments" style="color: #6b7280; font-style: italic; padding: 20px 0; text-align: center;">No comments yet</div>';
        return;
      }
      
      commentsList.innerHTML = comments.map(comment => `
        <div class="modal-comment">
          <div class="comment-author">${comment.author || 'Anonymous'}</div>
          <div class="comment-content">${comment.content}</div>
          <div class="comment-date">${comment.date || 'Just now'}</div>
        </div>
      `).join('');
    }

    function postComment() {
      const commentText = document.getElementById('commentInput').value.trim();
      if (!commentText) return;
      
      const photoId = currentPhotoData.id;
      
      fetch(`/api/photos/${photoId}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: commentText })
      })
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          document.getElementById('commentInput').value = '';
          loadPhotoMetadata(photoId);
        } else {
          alert('Failed to post comment: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        alert('Error posting comment: ' + error.message);
      });
    }

    // Modal toolbar actions
    function shareCurrentPhoto() {
      if (!currentPhotoData.id) return;
      sharePhoto(currentPhotoData.id);
    }

    function downloadCurrentPhoto() {
      if (!currentPhotoData.id) return;
      downloadPhoto(currentPhotoData.id, currentPhotoData.src);
    }

    function deleteCurrentPhoto() {
      if (!currentPhotoData.id) return;
      if (confirm('Are you sure you want to delete this photo?')) {
        moveToTrash(currentPhotoData.id);
        closePhotoModal();
      }
    }

    // Keyboard navigation
    document.addEventListener('keydown', function(event) {
      const modal = document.getElementById('photoModal');
      if (!modal.classList.contains('active')) return;
      
      switch(event.key) {
        case 'Escape':
          closePhotoModal();
          break;
        case 'ArrowLeft':
          previousPhoto();
          break;
        case 'ArrowRight':
          nextPhoto();
          break;
      }
    });

    // Photo actions (original functions updated)
    function openPhotoDetailOld(photoId) {
      window.location.href = `/photo/${photoId}`;
    }

    function downloadPhoto(photoId, src) {
      console.log('üì• [PROJECT] Downloading photo:', photoId);
      setTimeout(() => {
        const link = document.createElement('a');
        link.href = src;
        link.download = `photo-${photoId}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        closeAllMenus();
      }, 100); // Small delay to ensure click is processed
    }

    function duplicatePhoto(photoId) {
      console.log('üìã [PROJECT] Duplicating photo:', photoId);
      setTimeout(() => {
        fetch(`/api/photos/${photoId}/duplicate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
          if (data.ok) {
            alert('Photo duplicated successfully! Refresh the page to see the duplicate.');
            // Optionally refresh the page to show the new photo
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } else {
            alert('Failed to duplicate photo: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          alert('Error duplicating photo: ' + error.message);
        });
        
        closeAllMenus();
      }, 100);
    }

    function setCoverPhoto(projectId, photoId) {
      console.log('üñºÔ∏è [PROJECT] Setting cover photo:', photoId, 'for project:', projectId);
      
      fetch(`/api/projects/${projectId}/cover`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ photo_id: photoId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          alert('Cover photo updated successfully!');
        } else {
          alert('Failed to update cover photo: ' + (data.error || 'Unknown error'));
        }
        closeAllMenus();
      })
      .catch(error => {
        alert('Error updating cover photo: ' + error.message);
        closeAllMenus();
      });
    }

    function sharePhoto(photoId) {
      console.log('üîó [PROJECT] Sharing photo:', photoId);
      setTimeout(() => {
        fetch(`/api/photos/${photoId}/share`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
          if (data.ok && data.share_url) {
            // Copy to clipboard
            if (navigator.clipboard) {
              navigator.clipboard.writeText(data.share_url).then(() => {
                alert('Share link copied to clipboard!\n\n' + data.share_url);
              }).catch(() => {
                // Fallback: show the link in a prompt for manual copying
                prompt('Share link (copy this):', data.share_url);
              });
            } else {
              // Fallback for older browsers
              prompt('Share link (copy this):', data.share_url);
            }
          } else {
            alert('Failed to generate share link: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          alert('Error generating share link: ' + error.message);
        });
        
        closeAllMenus();
      }, 100);
    }

    function tagPhoto(photoId) {
      console.log('üè∑Ô∏è [PROJECT] Tagging photo:', photoId);
      
      const tags = prompt('Enter tags (comma-separated):');
      if (tags) {
        fetch(`/api/photos/${photoId}/tags`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tags: tags })
        })
        .then(response => response.json())
        .then(data => {
          if (data.ok) {
            alert('Tags updated successfully!');
          } else {
            alert('Failed to update tags: ' + (data.error || 'Unknown error'));
          }
          closeAllMenus();
        })
        .catch(error => {
          alert('Error updating tags: ' + error.message);
          closeAllMenus();
        });
      } else {
        closeAllMenus();
      }
    }

    function moveToTrash(photoId) {
      console.log('üóëÔ∏è [PROJECT] Moving photo to trash:', photoId);
      
      if (confirm('Are you sure you want to move this photo to trash?')) {
        fetch(`/api/photos/${photoId}`, {
          method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
          if (data.ok) {
            document.querySelector(`[data-photo-id="${photoId}"]`).remove();
            alert('Photo moved to trash successfully!');
          } else {
            alert('Failed to delete photo: ' + (data.error || 'Unknown error'));
          }
          closeAllMenus();
        })
        .catch(error => {
          alert('Error deleting photo: ' + error.message);
          closeAllMenus();
        });
      } else {
        closeAllMenus();
      }
    }

    function closeAllMenus() {
      // Close portal menu
      if (currentPortalMenu) {
        document.body.removeChild(currentPortalMenu);
        currentPortalMenu = null;
      }
      
      // Close regular menus (fallback)
      document.querySelectorAll('.photo-menu').forEach(menu => {
        menu.classList.remove('show');
      });
    }
  </script>
{% endblock %}