<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DAR System - Damage Analysis Report v2.1</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- 🎯 META TAGS PARA MÁXIMA CALIDAD PDF -->
  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#ffffff">
  <meta name="print-color-adjust" content="exact">
  <meta name="webkit-print-color-adjust" content="exact">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #000000;
      min-height: 100vh;
      padding: 20px;
    }

    /* 🔄 FLECHAS DE NAVEGACIÓN */
    .navigation-arrows {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .nav-arrow {
      width: 50px;
      height: 50px;
      background: #38c3ff;
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-arrow:hover {
      background: #2aa3d4;
      transform: scale(1.1);
    }

    .nav-arrow:active {
      transform: scale(0.95);
    }

    /* 🎯 ESTILOS PARA DROPDOWNS DE SECCIONES - VERSIÓN ROBUSTA */
    .section-dropdown {
      margin-bottom: 20px !important;
      border: 1px solid #e0e0e0 !important;
      border-radius: 8px !important;
      overflow: hidden !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
      transition: all 0.3s ease !important;
      background: white !important;
    }

    /* 🎯 ESTILOS PARA DAMAGE ASSESSMENT OPTIONS */
    .damage-option {
      transition: all 0.3s ease !important;
    }

    .damage-option:hover {
      border-color: #38c3ff !important;
      box-shadow: 0 2px 8px rgba(56, 195, 255, 0.2) !important;
      transform: translateY(-2px) !important;
    }

    .damage-option input[type="radio"]:checked + div strong {
      color: #38c3ff !important;
    }

    .damage-option input[type="radio"]:checked {
      transform: scale(1.1) !important;
    }

    .damage-option:has(input[type="radio"]:checked) {
      border-color: #38c3ff !important;
      background: #f8fcff !important;
      box-shadow: 0 4px 12px rgba(56, 195, 255, 0.15) !important;
    }

    .section-dropdown:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .dropdown-header {
      background: linear-gradient(135deg, #87CEEB  0%, #2196f3 100%) !important;
      color: white !important;
      padding: 15px 20px !important;
      cursor: pointer !important;
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      transition: all 0.3s ease !important;
      user-select: none !important;
      border: none !important;
      outline: none !important;
    }

    .dropdown-header:hover {
      background: linear-gradient(135deg, #2aa3d4 0%, #1976d2 100%);
    }

    .dropdown-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .dropdown-header i {
      font-size: 16px;
      transition: transform 0.3s ease;
    }

    .dropdown-header.expanded i {
      transform: rotate(180deg);
    }

    .dropdown-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
      background: white;
    }

    .dropdown-content.expanded {
      max-height: 10000px !important; /* Altura aumentada para mostrar todos los 9 campos */
    }
    
    /* 🎯 REGLA ESPECÍFICA PARA HVAC - Altura extra para mostrar las 9 fotos completas */
    #hvac-content.dropdown-content.expanded {
      max-height: 15000px !important; /* Altura extra para HVAC que tiene más contenido */
    }

    .dropdown-content-inner {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
    }

    /* 🎯 ESTILOS ADICIONALES PARA MEJORAR LA EXPERIENCIA */
    .section-dropdown:first-of-type {
      margin-top: 20px;
    }

    .dropdown-header:focus {
      outline: 2px solid #38c3ff;
      outline-offset: 2px;
    }

    .dropdown-content {
      background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
    }

    /* 🎯 ANIMACIÓN SUAVE PARA EL CONTENIDO */
    .dropdown-content > * {
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .dropdown-content.expanded > * {
      opacity: 1;
      transform: translateY(0);
    }

    /* 🎯 ESTILOS PARA LOS BOTONES DE CONTROL */
    .submit-btn[onclick*="expandAllSections"],
    .submit-btn[onclick*="collapseAllSections"] {
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .submit-btn[onclick*="expandAllSections"]:hover {
      background: #218838 !important;
      transform: translateY(-2px);
    }

    .submit-btn[onclick*="collapseAllSections"]:hover {
      background: #5a6268 !important;
      transform: translateY(-2px);
    }

    .main-container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
      animation: slideUp 0.6s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Header mejorado */
    .header {
      background: linear-gradient(135deg, #38c3ff 0%, #2196f3 100%);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>');
      animation: float 20s infinite linear;
    }

    @keyframes float {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .header-content {
      position: relative;
      z-index: 2;
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .header .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
      font-weight: 300;
    }

    .logo {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 80px;
      height: 80px;
      background: rgba(255,255,255,0.2);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo img {
      max-width: 60px;
      max-height: 60px;
    }

    /* Photo remove button styles */
    .photo-wrapper {
      position: relative;
      display: inline-block;
      margin: 4px;
    }

    .photo-remove-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: #ff4757;
      color: white;
      border: 2px solid white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 10;
      transition: all 0.2s ease;
    }

    .photo-remove-btn:hover {
      background: #ff3742;
      transform: scale(1.1);
    }

    .photo-remove-btn:active {
      transform: scale(0.95);
    }

    /* Progress bar */
    .progress-container {
      background: #f8f9fa;
      padding: 20px 30px;
      border-bottom: 1px solid #e9ecef;
    }

    .progress-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c757d;
      font-weight: bold;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .step-circle.active {
      background: #38c3ff;
      color: white;
      transform: scale(1.1);
    }

    .step-circle.completed {
      background: #28a745;
      color: white;
    }

    .step-label {
      font-size: 0.85em;
      text-align: center;
      color: #6c757d;
      font-weight: 500;
    }

    .progress-line {
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 3px;
      background: #e9ecef;
      z-index: 1;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #38c3ff, #28a745);
      width: 0%;
      transition: width 0.5s ease;
    }

    /* Form content */
    .form-content {
      padding: 40px;
    }

    .form-step {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .form-step.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .step-title {
      font-size: 1.8em;
      color: #2c3e50;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .step-description {
      color: #6c757d;
      margin-bottom: 30px;
      font-size: 1.05em;
    }

    /* Form groups mejorados */
    .form-group {
      margin-bottom: 25px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-row.triple {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .form-label {
      display: block;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    .form-input, .dropdown {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 1em;
      transition: all 0.3s ease;
      background: #fafbfc;
    }

    .form-input:focus, .dropdown:focus {
      outline: none;
      border-color: #38c3ff;
      background: white;
      box-shadow: 0 0 0 3px rgba(56, 195, 255, 0.1);
    }

    /* Input con iconos */
    .input-with-icon {
      position: relative;
    }

    .input-with-icon i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
      z-index: 2;
    }

    .input-with-icon .form-input {
      padding-left: 40px;
    }

    /* Address composite field */
    .address-composite {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .address-composite:focus-within {
      border-color: #38c3ff;
      background: white;
      box-shadow: 0 0 0 3px rgba(56, 195, 255, 0.1);
    }

    .address-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      color: #2c3e50;
      font-weight: 600;
    }

    .address-header i {
      margin-right: 8px;
      color: #38c3ff;
    }

    /* V-ID section especial */
    .vid-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      margin-bottom: 30px;
      border: 2px dashed #38c3ff;
    }

    .vid-input {
      font-size: 1.2em;
      padding: 15px 20px;
      text-align: center;
      border: 3px solid #38c3ff;
      border-radius: 10px;
      width: 100%;
      max-width: 300px;
      margin: 20px auto;
      font-weight: 600;
      letter-spacing: 1px;
    }

    /* Buttons mejorados */
    .btn, .submit-btn {
      padding: 12px 30px;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary, .submit-btn {
      background: linear-gradient(135deg, #38c3ff 0%, #2196f3 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(56, 195, 255, 0.3);
    }

    .btn-primary:hover, .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(56, 195, 255, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }

    .btn:disabled, .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Navigation buttons */
    .nav-buttons, .wizard-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #e9ecef;
    }

    /* Loading spinner mejorado */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Auto-filled fields highlight */
    .auto-filled {
      background: linear-gradient(90deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
      border-color: #28a745;
    }

    /* Trade types and storm types */
    .trade-types-container, .storm-types-container {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }

    .trade-type-row, .storm-type-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .trade-type-row label, .storm-type-row label {
      display: flex;
      align-items: center;
      font-weight: 500;
      cursor: pointer;
    }

    .trade-type-row input[type="checkbox"], .storm-type-row input[type="checkbox"] {
      transform: scale(1.3);
      margin-right: 12px;
    }

    .trade-controls {
      margin-left: auto;
    }

    /* Upload sections */
    .upload-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .upload-section:hover {
      border-color: #38c3ff;
      background: white;
    }

    .upload-label {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 12px;
      display: block;
    }

    .companycam-thumbs {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .companycam-thumbs img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #38c3ff;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .companycam-thumbs img:hover {
      transform: scale(1.1);
    }

    /* Debug console (oculto por defecto) */
    .debug-console {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      max-height: 200px;
      background: #1a1a1a;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      padding: 10px;
      border-radius: 8px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }

    .debug-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #1a1a1a;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 1001;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-container {
        margin: 10px;
        border-radius: 15px;
      }

      .form-content {
        padding: 20px;
      }

      .form-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .form-row.triple {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 2em;
      }

      .logo {
        position: static;
        margin: 20px auto 0;
      }

      .nav-buttons, .wizard-buttons {
        flex-direction: column;
        gap: 15px;
      }

      .nav-buttons .btn, .wizard-buttons .btn, .nav-buttons .submit-btn, .wizard-buttons .submit-btn {
        width: 100%;
        justify-content: center;
      }

      /* CompanyCam Modal Responsive */
      .companycam-content {
        flex-direction: column !important;
        height: auto !important;
      }

      .companycam-sidebar {
        width: 100% !important;
        max-height: calc(100vh - 200px) !important;
        border-right: none !important;
        border-bottom: 1px solid #e9ecef !important;
        padding: 15px !important;
      }

      .companycam-photo-grid {
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 8px !important;
      }

      .companycam-viewer {
        height: calc(100vh - 440px) !important;
        min-height: 300px !important;
      }

      .companycam-controls {
        position: static !important;
        transform: none !important;
        margin-top: 15px !important;
        text-align: center !important;
      }

      .companycam-controls button {
        display: block !important;
        width: 100% !important;
        margin: 5px 0 !important;
      }

      /* Monday.com Upload Modal Responsive */
      #mondayUploadModal .modal-content {
        margin: 20px auto !important;
        max-width: 95% !important;
        padding: 0 !important;
      }

      #mondayUploadModal .modal-content > div {
        padding: 20px !important;
      }

      #mondayUploadModal h3 {
        font-size: 1.2em !important;
      }

      #mondayUploadModal h4 {
        font-size: 1em !important;
      }

      #mondayUploadModal .btn {
        width: 100% !important;
        margin: 5px 0 !important;
      }

      /* Photo thumbnails responsive */
      .companycam-thumbs img {
        width: 60px !important;
        height: 60px !important;
      }

      .photo-wrapper {
        margin: 2px !important;
      }

      .photo-remove-btn {
        width: 20px !important;
        height: 20px !important;
        font-size: 10px !important;
        top: -6px !important;
        right: -6px !important;
      }

      /* Form fields responsive */
      .form-input, .dropdown, textarea {
        font-size: 16px !important; /* Prevents zoom on iOS */
        padding: 12px !important;
      }

      /* Checkbox grids responsive */
      .trade-types-container .trade-type-row,
      .storm-types-container .storm-type-row {
        flex-direction: column !important;
        align-items: flex-start !important;
        padding: 15px !important;
      }

      .trade-type-row label, .storm-type-row label {
        font-size: 14px !important;
        line-height: 1.4 !important;
      }

      /* Progress bar responsive */
      .progress-container {
        padding: 15px 20px !important;
      }

      .progress-step {
        font-size: 12px !important;
      }

      .step-label {
        font-size: 10px !important;
      }

      /* Section headers responsive */
      .section-header {
        font-size: 1em !important;
        padding: 12px 15px !important;
        margin: 20px 0 15px 0 !important;
      }

      /* Upload sections responsive */
      .upload-section {
        padding: 15px !important;
        margin-bottom: 15px !important;
      }

      .upload-label {
        font-size: 14px !important;
        margin-bottom: 10px !important;
      }

      /* Modal responsive improvements */
      .modal-content {
        width: 98vw !important;
        height: 95vh !important;
        margin: 10px auto !important;
      }

      .modal-close {
        top: 10px !important;
        right: 15px !important;
        font-size: 1.5em !important;
      }
    }

    /* Extra small mobile devices */
    @media (max-width: 480px) {
      .main-container {
        margin: 5px !important;
        border-radius: 10px !important;
      }

      .form-content {
        padding: 15px !important;
      }

      .header h1 {
        font-size: 1.8em !important;
      }

      .header .subtitle {
        font-size: 1em !important;
      }

      .logo {
        width: 60px !important;
        height: 60px !important;
      }

      .logo img {
        max-width: 45px !important;
        max-height: 45px !important;
      }

      /* Even smaller photo thumbnails */
      .companycam-thumbs img {
        width: 50px !important;
        height: 50px !important;
      }

      .photo-remove-btn {
        width: 18px !important;
        height: 18px !important;
        font-size: 9px !important;
        top: -5px !important;
        right: -5px !important;
      }

      /* Smaller form elements */
      .form-input, .dropdown, textarea {
        padding: 10px !important;
        font-size: 14px !important;
      }

      /* Compact progress bar */
      .progress-container {
        padding: 10px 15px !important;
      }

      .progress-step {
        font-size: 10px !important;
      }

      .step-label {
        font-size: 8px !important;
      }

      /* Compact sections */
      .section-header {
        font-size: 0.9em !important;
        padding: 10px 12px !important;
        margin: 15px 0 10px 0 !important;
      }

      .upload-section {
        padding: 12px !important;
        margin-bottom: 12px !important;
      }

      /* Compact buttons */
      .btn, .submit-btn {
        padding: 10px 15px !important;
        font-size: 14px !important;
      }

      /* Compact modals */
      .modal-content {
        width: 99vw !important;
        height: 98vh !important;
        margin: 5px auto !important;
      }
    }

    /* Tablet optimization */
    @media (min-width: 769px) and (max-width: 1024px) {
      .main-container {
        max-width: 95% !important;
        margin: 15px auto !important;
      }

      .form-row {
        grid-template-columns: 1fr 1fr !important;
        gap: 20px !important;
      }

      .form-row.triple {
        grid-template-columns: 1fr 1fr !important;
      }

      .companycam-thumbs img {
        width: 70px !important;
        height: 70px !important;
      }

      .photo-remove-btn {
        width: 22px !important;
        height: 22px !important;
        font-size: 11px !important;
      }

      /* Optimize checkbox grids for tablet */
      .trade-types-container .trade-type-row,
      .storm-types-container .storm-type-row {
        flex-direction: row !important;
        align-items: center !important;
        padding: 12px !important;
      }

      .trade-type-row label, .storm-type-row label {
        font-size: 13px !important;
      }

      /* Better modal sizing for tablet */
      .modal-content {
        max-width: 90% !important;
        height: 85vh !important;
      }
    }

    /* Section headers */
    .section-header {
      background: linear-gradient(135deg, #38c3ff 0%, #2196f3 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin: 30px 0 20px 0;
      font-weight: 600;
      font-size: 1.1em;
    }

    .section-header i {
      margin-right: 8px;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: #fff;
      max-width: 950px;
      width: 95vw;
      height: 90vh;
      overflow-y: auto;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      padding: 0;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 2em;
      background: none;
      border: none;
      color: #38c3ff;
      z-index: 10;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .modal-close:hover {
      transform: scale(1.1);
    }

    /* ====================================================================== */
    /* COMPANYCAM MODAL RESPONSIVE STYLES */
    /* ====================================================================== */
    
    /* Modal base styles */
    .companycam-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
    }
    
    .companycam-modal-container {
      background: #fff;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    
    /* Header styles */
    .companycam-modal-header {
      background: #2c3e50;
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1001;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .companycam-header-left {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
      min-width: 0; /* Allow text truncation */
    }
    
    .companycam-header-badge {
      background: #3498db;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    
    .companycam-project-title {
      font-size: 1.2em;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .companycam-photo-count {
      color: #ecf0f1;
      font-size: 0.9em;
      white-space: nowrap;
    }
    
    .companycam-header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    /* Button styles */
    .companycam-btn {
      background: #27ae60;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
      white-space: nowrap;
    }
    
    .companycam-btn-primary { background: #3498db; }
    .companycam-btn-primary:hover { background: #2980b9; }
    
    .companycam-btn-info { background: #17a2b8; }
    .companycam-btn-info:hover { background: #138496; }
    
    .companycam-btn-success { background: #27ae60; }
    .companycam-btn-success:hover { background: #229954; }
    
    .companycam-btn-danger { background: #e74c3c; }
    .companycam-btn-danger:hover { background: #c0392b; }
    
    .companycam-btn-warning { background: #f39c12; }
    .companycam-btn-warning:hover { background: #e67e22; }
    
    .companycam-btn-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.8em;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s;
      padding: 5px;
    }
    .companycam-btn-close:hover { opacity: 1; }
    
    /* Content area */
    .companycam-modal-content {
      padding-top: 80px;
      height: calc(100vh - 80px);
      overflow-y: auto;
      background: #f8f9fa;
    }
    
    .companycam-grid-container {
      padding: 20px;
    }
    
    .companycam-photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      max-width: none;
    }
    
    /* Empty state */
    .companycam-empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }
    
    .companycam-empty-icon {
      font-size: 4em;
      opacity: 0.3;
      margin-bottom: 20px;
      display: block;
    }
    
    .companycam-empty-title {
      margin: 0 0 10px 0;
      color: #495057;
    }
    
    .companycam-empty-description {
      margin: 0;
      font-size: 1.1em;
    }
    
    /* ====================================================================== */
    /* RESPONSIVE BREAKPOINTS */
    /* ====================================================================== */
    
    /* Tablet styles (768px and below) */
    @media (max-width: 768px) {
      .companycam-modal-header {
        padding: 12px 15px;
        flex-direction: column;
        gap: 10px;
        height: auto;
      }
      
      .companycam-header-left {
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .companycam-header-badge {
        font-size: 0.9em;
        padding: 6px 10px;
      }
      
      .companycam-project-title {
        font-size: 1.1em;
      }
      
      .companycam-photo-count {
        font-size: 0.8em;
      }
      
      .companycam-header-actions {
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .companycam-btn {
        font-size: 0.8em;
        padding: 6px 12px;
      }
      
      .companycam-modal-content {
        padding-top: 120px; /* More space for wrapped header */
        height: calc(100vh - 120px);
      }
      
      .companycam-grid-container {
        padding: 15px;
      }
      
      .companycam-photo-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
      }
    }
    
    /* Mobile styles (480px and below) */
    @media (max-width: 480px) {
      .companycam-modal-header {
        padding: 10px;
      }
      
      .companycam-header-left {
        gap: 8px;
      }
      
      .companycam-badge-text {
        display: none; /* Hide text, keep only icon */
      }
      
      .companycam-project-title {
        font-size: 1em;
        max-width: 150px;
      }
      
      .companycam-btn-text {
        display: none; /* Hide button text, keep only icons */
      }
      
      .companycam-btn {
        padding: 8px;
        min-width: 36px;
        justify-content: center;
      }
      
      .companycam-grid-container {
        padding: 10px;
      }
      
      .companycam-photo-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
      }
      
      .companycam-empty-state {
        padding: 40px 15px;
      }
      
      .companycam-empty-icon {
        font-size: 3em;
      }
      
      .companycam-empty-title {
        font-size: 1.2em;
      }
      
      .companycam-empty-description {
        font-size: 1em;
      }
    }
    
    /* Extra small mobile (320px and below) */
    @media (max-width: 320px) {
      .companycam-photo-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 8px;
      }
      
      .companycam-grid-container {
        padding: 8px;
      }
    }
    
    /* ====================================================================== */
    /* PHOTO ITEM STYLES (for when photos are loaded) */
    /* ====================================================================== */
    .companycam-photo-item {
      position: relative;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .companycam-photo-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
            .companycam-photo-item.selected {
          border: 3px solid #3498db !important;
          transform: scale(0.95);
          box-shadow: 0 4px 16px rgba(52, 152, 219, 0.4) !important;
        }
        
        /* ✅ FIX: También aplicar estilos a photo-thumb.selected para compatibilidad */
        .photo-thumb.selected {
          border: 3px solid #3498db !important;
          transform: scale(0.95);
          box-shadow: 0 4px 16px rgba(52, 152, 219, 0.4) !important;
        }
    
    .companycam-photo-item img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
    }
    
    .companycam-photo-overlay {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(52, 152, 219, 0.9);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .companycam-photo-item.selected .companycam-photo-overlay {
      opacity: 1;
    }
    
    @media (max-width: 480px) {
      .companycam-photo-item img {
        height: 120px;
      }
    }
    
    @media (max-width: 320px) {
      .companycam-photo-item img {
        height: 100px;
      }
    }

    /* 🖼️ ESTILOS PARA EL MODAL DE FOTOS */
    .photo-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
    }

    .photo-modal-content {
      background: white;
      border-radius: 15px;
      max-width: 95%;
      max-height: 95%;
      width: 90%;
      height: 90%;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .photo-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 2px solid #f0f0f0;
      background: linear-gradient(135deg, #38c3ff 0%, #2196f3 100%);
      color: white;
      border-radius: 15px 15px 0 0;
    }

    .photo-modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .photo-modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .photo-modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .photo-modal-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow: hidden;
    }

    .photo-navigation {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex: 1;
      gap: 20px;
    }

    .photo-nav-btn {
      background: rgba(56, 195, 255, 0.1);
      border: 2px solid #38c3ff;
      color: #38c3ff;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .photo-nav-btn:hover:not(:disabled) {
      background: #38c3ff;
      color: white;
      transform: scale(1.1);
    }

    .photo-nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .photo-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      border-radius: 10px;
      background: #f8f9fa;
    }

    .photo-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .photo-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-top: 1px solid #e0e0e0;
      margin-top: 20px;
    }

    .photo-counter {
      font-size: 16px;
      color: #666;
      font-weight: 500;
    }

    .photo-original-link {
      color: #38c3ff;
      text-decoration: none;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      border: 2px solid #38c3ff;
      border-radius: 25px;
      transition: all 0.3s ease;
    }

    .photo-original-link:hover {
      background: #38c3ff;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(56, 195, 255, 0.3);
    }

    /* 🎯 RESPONSIVE PARA MÓVILES */
    @media (max-width: 768px) {
      .photo-modal-content {
        width: 95%;
        height: 95%;
        max-width: 95%;
        max-height: 95%;
      }

      .photo-nav-btn {
        width: 50px;
        height: 50px;
        font-size: 16px;
      }

      .photo-modal-header h3 {
        font-size: 18px;
      }

      .photo-info {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
    }

    @media (max-width: 480px) {
      .photo-modal-content {
        width: 98%;
        height: 98%;
        border-radius: 10px;
      }

      .photo-modal-header {
        padding: 15px 20px;
      }

      .photo-modal-header h3 {
        font-size: 16px;
      }

      .photo-nav-btn {
        width: 45px;
        height: 45px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1><i class="fas fa-clipboard-check"></i> DAR System</h1>
        <p class="subtitle">Damage Analysis Report - Powered by VI-A</p>
      </div>

      <div class="logo">
        <!-- <img src="static/via-logo.png" alt="VI-A Logo"> -->
        <div style="color: white; font-weight: bold;">PICK-CAM Reports</div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-line">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="progress-step">
          <div class="step-circle active" id="step-circle-1">1</div>
          <div class="step-label">V-ID Entry</div>
        </div>
        
        <div class="progress-step">
          <div class="step-circle" id="step-circle-2">2</div>
          <div class="step-label">Property Info</div>
        </div>
        
        <div class="progress-step">
          <div class="step-circle" id="step-circle-3">3</div>
          <div class="step-label">Details</div>
        </div>
        
        <div class="progress-step">
          <div class="step-circle" id="step-circle-4">4</div>
          <div class="step-label">Photos</div>
        </div>
        
        <div class="progress-step">
          <div class="step-circle" id="step-circle-5">5</div>
          <div class="step-label">Preview</div>
        </div>
        
        <div class="progress-step">
          <div class="step-circle" id="step-circle-6">6</div>
          <div class="step-label">Complete</div>
        </div>
      </div>
    </div>

    <!-- Form Content -->
    <div class="form-content">
      <form id="darForm">
        
        <!-- Step 1: V-ID Entry -->
        <div class="form-step active" id="step-1">
          <h2 class="step-title">
            <i class="fas fa-key"></i> Start Report
          </h2>
          <p class="step-description">
            Enter the V-ID to automatically retrieve property information from PICK-CAM
          </p>
          
          <div class="vid-section">
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-barcode"></i> V-ID Code
              </label>
              <input type="text" 
                     id="vIdInput" 
                     class="form-input vid-input" 
                     placeholder="Ex: C-0168, C-0167" 
                     required 
                     autocomplete="off">
              <small style="color: #6c757d; margin-top: 10px; display: block;">
                <i class="fas fa-info-circle"></i> 
                System will automatically connect to PICK-CAM to retrieve data
              </small>
            </div>
          </div>

          <div class="nav-buttons">
            <div></div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button type="button" class="btn btn-success" onclick="manualVidEntry()" id="manualEntryBtn">
                <i class="fas fa-edit"></i> Manual Entry
              </button>
              <button type="button" class="btn btn-primary" onclick="fetchMondayData()" id="nextBtnStep1">
                <span id="btnText">Fetch Data</span>
                <span id="loadingSpinner" style="display:none;" class="spinner"></span>
              </button>
              <button type="button" class="btn btn-primary" onclick="openPhotoUpload()" id="uploadPhotosBtn">
                <i class="fas fa-camera"></i> Upload Photos
              </button>
            </div>
          </div>
        </div>

        <!-- Step 2: Property Info -->
        <div class="form-step" id="step-2">
          <h2 class="step-title">
            <i class="fas fa-building"></i> Property Information
          </h2>
          <p class="step-description">
            Verify and complete the information obtained from PICK-CAM
          </p>

          <!-- Business Info -->
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-store"></i> Business Name
            </label>
            <div class="input-with-icon">
              <i class="fas fa-building"></i>
              <input type="text" id="propertyNameInput" class="form-input" required>
            </div>
          </div>

          <!-- Address Composite -->
          <div class="address-composite">
            <div class="address-header">
              <i class="fas fa-map-marker-alt"></i>
              Property Address
            </div>
            
            <div class="form-group">
              <label class="form-label">Street Address</label>
              <input type="text" id="propertyAddressInput" class="form-input" placeholder="123 Main Street" required>
            </div>
            
            <div class="form-row triple">
              <div class="form-group">
                <label class="form-label">City</label>
                <input type="text" id="city" class="form-input" placeholder="Dallas" required>
              </div>
              <div class="form-group">
                <label class="form-label">State</label>
                <input type="text" id="state" class="form-input" placeholder="TX" required>
              </div>
              <div class="form-group">
                <label class="form-label">ZIP Code</label>
                <input type="text" id="zipcode" class="form-input" placeholder="75201" required>
              </div>
            </div>
          </div>

          <!-- Inspector Info -->
          <div class="section-header">
            <i class="fas fa-user-tie"></i> Inspector Information
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">First Name</label>
              <input type="text" id="inspectorFirstName" class="form-input" placeholder="John" required>
            </div>
            <div class="form-group">
              <label class="form-label">Last Name</label>
              <input type="text" id="inspectorLastName" class="form-input" placeholder="Smith" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Phone</label>
              <div class="input-with-icon">
                <i class="fas fa-phone"></i>
                <input type="tel" id="inspectorPhone" class="form-input" placeholder="(555) 123-4567" required>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <div class="input-with-icon">
                <i class="fas fa-envelope"></i>
                <input type="email" id="inspectorEmail" class="form-input" placeholder="john@company.com" required>
              </div>
            </div>
          </div>

          <!-- Inspection Partner Info -->
          <div class="section-header">
            <i class="fas fa-handshake"></i> Inspection Partner
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">First Name</label>
              <input type="text" id="partnerFirstName" class="form-input" placeholder="Partner First Name">
            </div>
            <div class="form-group">
              <label class="form-label">Last Name</label>
              <input type="text" id="partnerLastName" class="form-input" placeholder="Partner Last Name">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Phone Number</label>
              <div class="input-with-icon">
                <i class="fas fa-phone"></i>
                <input type="tel" id="partnerPhone" class="form-input" placeholder="(555) 123-4567">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <div class="input-with-icon">
                <i class="fas fa-envelope"></i>
                <input type="email" id="partnerEmail" class="form-input" placeholder="partner@company.com" required>
              </div>
            </div>
          </div>

          <!-- Inspection Info -->
          <div class="section-header">
            <i class="fas fa-clipboard-check"></i> Inspection Information
          </div>
          


          <!-- Dates and IDs -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Inspection Date</label>
              <input type="date" id="inspectionDate" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Date of Loss</label>
              <input type="date" id="stormDateInput" class="form-input" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">V-ID</label>
              <input type="text" id="vIdField" class="form-input" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">CC ID</label>
              <input type="text" id="ccIdField" class="form-input" readonly>
            </div>
          </div>

          <!-- CompanyCam Connection Status -->
          <div id="companyCamStatus" style="display: none; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center;">
            <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 8px;">
              <i class="fas fa-camera"></i> CompanyCam Connected
            </div>
            <div style="font-size: 0.9em; opacity: 0.9;" id="companyCamProjectInfo">
              Ready to access project photos
            </div>
            <button type="button" class="btn" onclick="openInCompanyCam(document.getElementById('ccIdField').value)" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); margin-top: 10px; font-size: 0.9em;">
              <i class="fas fa-external-link-alt"></i> Open Project in CompanyCam
            </button>
          </div>

          <div class="nav-buttons">
            <button type="button" class="btn btn-secondary" onclick="prevStep(1)">
              <i class="fas fa-arrow-left"></i> Previous
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep(3)">
              Next <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 3: Property Details -->
        <div class="form-step" id="step-3">
          <h2 class="step-title">
            <i class="fas fa-clipboard-list"></i> Property Details
          </h2>
          <p class="step-description">
            Specify technical details and type of damage found
          </p>

          <!-- Property Technical Details -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Property Type</label>
              <select id="propertyType" class="dropdown">
                <option value="">Select...</option>
                <option value="Commercial">Commercial</option>
                <option value="Residential">Residential</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Building Type</label>
              <select id="buildingType" class="dropdown">
                <option value="">Select...</option>
                <option value="Single Family">Single Family</option>
                <option value="Multi-Family">Multi-Family</option>
                <option value="Office">Office</option>
                <option value="Retail">Retail</option>
                <option value="Industrial">Industrial</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Roof System</label>
              <select id="roofSystem" class="dropdown">
                <option value="">Select...</option>
                <option value="Asphalt Shingle">Asphalt Shingle</option>
                <option value="Metal">Metal</option>
                <option value="Tile">Tile</option>
                <option value="Flat/TPO">Flat/TPO</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Number of Stories</label>
              <select id="numStories" class="dropdown">
                <option value="">Select...</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4+">4+</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Roof Squares (if known)</label>
            <input type="number" id="roofSquares" class="form-input" placeholder="Approximate square footage ÷ 100">
          </div>

          <!-- Trade Types -->
          <div class="section-header">
            <i class="fas fa-tools"></i>Damage Assessment
          </div>
          
          <div class="trade-types-container">
            <div class="trade-type-row">
              <label><input type="checkbox" class="tradeType" value="HVAC"> HVAC</label>
              <span class="trade-controls" id="hvacControls" style="display:none;">
                <label style="margin-left:12px;">Severity
                  <select class="severityRating dropdown" data-trade="HVAC" id="hvacSeverityRating">
                    <option value="">Select...</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                </label>
              </span>
            </div>

            <div class="trade-type-row">
              <label><input type="checkbox" class="tradeType" value="Roofing"> Roofing</label>
              <span class="trade-controls" id="roofingControls" style="display:none;">
                <label style="margin-left:12px;">Severity
                  <select class="severityRating dropdown" data-trade="Roofing">
                    <option value="">Select...</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                </label>
              </span>
            </div>

            <div class="trade-type-row">
              <label><input type="checkbox" class="tradeType" value="Window"> Window</label>
              <span class="trade-controls" id="windowControls" style="display:none;">
                <label style="margin-left:12px;">Severity
                  <select class="severityRating dropdown" data-trade="Window">
                    <option value="">Select...</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                </label>
              </span>
            </div>
            <div class="trade-type-row">
              <label><input type="checkbox" class="tradeType" value="Interior"> Interior</label>
              <span class="trade-controls" id="interiorControls" style="display:none;">
                <label style="margin-left:12px;">Severity
                  <select class="severityRating dropdown" data-trade="Interior">
                    <option value="">Select...</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                  </select>
                </label>
              </span>
            </div>
          </div>

          <div style="margin-top:18px;">
            <label class="form-label" style="display:inline;">Confirmed Damage? </label>
            <input type="checkbox" id="confirmedDamageCheckbox" style="transform:scale(1.3);margin-left:8px;vertical-align:middle;">
          </div>



          <div id="severitySection" style="display:none;margin-top:10px;">
            <label class="form-label">Overall Severity Rating</label>
            <select id="severityRating" class="dropdown">
              <option value="">Select...</option>
              <option value="1">1 - Moderate</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10 - Severe</option>
            </select>
          </div>

          <!-- Storm Types -->
          <div class="section-header">
            <i class="fas fa-cloud-rain"></i> Storm Information
          </div>

          <div class="storm-types-container">
            <div class="storm-type-row">
              <label><input type="checkbox" class="stormType" value="Hail"> Hail</label>
            </div>
            <div class="storm-type-row">
              <label><input type="checkbox" class="stormType" value="Wind"> Wind</label>
            </div>
            <div class="storm-type-row">
              <label><input type="checkbox" class="stormType" value="Tornado"> Tornado</label>
            </div>
            <div class="storm-type-row">
              <label><input type="checkbox" class="stormType" value="Hurricane"> Hurricane</label>
            </div>
          </div>

          <div id="hailOptions" style="display:none;">
            <label class="form-label">Hail Size</label>
            <select id="hailSize" class="dropdown">
              <option value="">Select...</option>
              <option>1 inch</option>
              <option>1.25 inch</option>
              <option>1.5 inch</option>
              <option>1.75 inch</option>
              <option>2 inch</option>
              <option>2.25 inch</option>
              <option>2.5 inch</option>
              <option>2.75 inch</option>
              <option>3 inch</option>
            </select>
          </div>

          <div id="windOptions" style="display:none;">
            <label class="form-label">Wind Speed</label>
            <select id="windSpeed" class="dropdown">
              <option value="">Select...</option>
              <option>50 mph</option>
              <option>75 mph</option>
              <option>90+ mph</option>
            </select>
          </div>

          <div id="tornadoOptions" style="display:none;">
            <label class="form-label">Tornado Strength</label>
            <select id="tornadoStrength" class="dropdown">
              <option value="">Select...</option>
              <option>EF1</option>
              <option>EF2</option>
              <option>EF3</option>
              <option>EF4</option>
              <option>EF5</option>
            </select>
          </div>

          <div id="hurricaneOptions" style="display:none;">
            <label class="form-label">Hurricane Category</label>
            <select id="hurricaneCat" class="dropdown">
              <option value="">Select...</option>
              <option>CAT 1</option>
              <option>CAT 2</option>
              <option>CAT 3</option>
              <option>CAT 4</option>
              <option>CAT 5</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Storm Date Proximity</label>
            <select id="stormProximity" class="dropdown">
              <option value="">Select...</option>
              <option>0-30 days</option>
              <option>1-6 months</option>
              <option>6-12 months</option>
              <option>12+ months</option>
            </select>
          </div>





          <div class="nav-buttons">
            <button type="button" class="btn btn-secondary" onclick="prevStep(2)">
              <i class="fas fa-arrow-left"></i> Previous
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep(4)">
              Next <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 4: Photo Upload -->
        <div class="form-step" id="step-4">
          <h2 class="step-title">
            <i class="fas fa-camera"></i> Photo Upload
          </h2>
          <p class="step-description">
            Upload required photographs to document the damage
          </p>

          <!-- General/Identifying Photos -->
          <div class="section-header">
            <i class="fas fa-camera"></i> General & Identifying Photos
          </div>

          <div class="upload-section" id="identifying_photo_address_section">
            <label class="upload-label">Identifying Photo Property Address (building numbers)</label>
            <button type="button" class="submit-btn" onclick="openPickCamPhotoSelector('identifying_photo_address')">Select from PICK-CAM</button>
            <div class="companycam-thumbs" id="identifying_photo_address_thumbs"></div>
          </div>

          <div class="upload-section" id="business_identifier_sign_section">
            <label class="upload-label">Business Identifier (Sign)</label>
            <button type="button" class="submit-btn" onclick="openPickCamPhotoSelector('business_identifier_sign')">Select from PICK-CAM</button>
            <div class="companycam-thumbs" id="business_identifier_sign_thumbs"></div>
          </div>

          <!-- 🔒 PROPERTY DAMAGE HIGHLIGHTS - HIDDEN AS REQUESTED BY USER -->
          <div class="upload-section" id="property_damage_highlights_section" style="display: none;">
            <label class="upload-label">Property Damage Highlights (areas of most concern to client)</label>
            <button type="button" class="submit-btn" onclick="openCompanyCamUploader('property_damage_highlights')">Select from CompanyCam</button>
            <div class="companycam-thumbs" id="property_damage_highlights_thumbs"></div>
          </div>

          <!-- Site Access Photos -->
          <div class="section-header">
            <i class="fas fa-door-open"></i> Site Access & Obstructions
          </div>

          <div class="upload-section" id="roof_access_section">
            <label class="upload-label">Roof Access</label>
            <div style="font-size:0.95em;color:#555;margin-bottom:6px;">List the roof access point (hatch or ladder) (if ladder fixed, single or 2 story)</div>
            <button type="button" class="submit-btn" onclick="openCompanyCamUploader('roof_access')">Select from CompanyCam</button>
            <div class="companycam-thumbs" id="roof_access_thumbs"></div>
          </div>

          <div class="upload-section" id="rooftop_obstructions_section">
            <label class="upload-label">Rooftop Obstructions</label>
            <div style="font-size:0.95em;color:#555;margin-bottom:6px;">List rooftop obstructions (if any) like tree cover</div>
            <button type="button" class="submit-btn" onclick="openCompanyCamUploader('rooftop_obstructions')">Select from CompanyCam</button>
            <div class="companycam-thumbs" id="rooftop_obstructions_thumbs"></div>
          </div>

          <!-- Documentation Photos -->
          <div class="section-header">
            <i class="fas fa-file-alt"></i> Storm Documentation
          </div>

          <div class="upload-section" id="noaa_swath_screenshot_section">
            <label class="upload-label">NOAA Swath Screenshot</label>
            <button type="button" class="submit-btn" onclick="openCompanyCamUploader('noaa_swath_screenshot')">Select from CompanyCam</button>
            <div class="companycam-thumbs" id="noaa_swath_screenshot_thumbs"></div>
          </div>

          <div class="upload-section" id="impact_report_screenshot_section">
            <label class="upload-label">Impact Report Screenshot</label>
            <button type="button" class="submit-btn" onclick="openCompanyCamUploader('impact_report_screenshot')">Select from CompanyCam</button>
            <div class="companycam-thumbs" id="impact_report_screenshot_thumbs"></div>
          </div>

          <!-- Exterior Ground Photos -->
          <div class="section-header">
            <i class="fas fa-home"></i> Exterior Ground Photos
          </div>

          <div class="form-row">
            <div class="upload-section" id="ground_front_section">
              <label class="upload-label">Ground Front</label>
              <button type="button" class="submit-btn" onclick="openPickCamPhotoSelector('ground_front')">Select from PICK-CAM</button>
              <div class="companycam-thumbs" id="ground_front_thumbs"></div>
            </div>
            <div class="upload-section" id="ground_back_section">
              <label class="upload-label">Ground Back</label>
              <button type="button" class="submit-btn" onclick="openPickCamPhotoSelector('ground_back')">Select from PICK-CAM</button>
              <div class="companycam-thumbs" id="ground_back_thumbs"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="upload-section" id="ground_left_side_section">
              <label class="upload-label">Ground Left Side</label>
              <button type="button" class="submit-btn" onclick="openCompanyCamUploader('ground_left_side')">Select from CompanyCam</button>
              <div class="companycam-thumbs" id="ground_left_side_thumbs"></div>
            </div>
            <div class="upload-section" id="ground_right_side_section">
              <label class="upload-label">Ground Right Side</label>
              <button type="button" class="submit-btn" onclick="openCompanyCamUploader('ground_right_side')">Select from CompanyCam</button>
              <div class="companycam-thumbs" id="ground_right_side_thumbs"></div>
            </div>
          </div>

          <!-- Overview Photos -->
          <div class="section-header">
            <i class="fas fa-eye"></i> Overview & Access Points
          </div>

          <div class="upload-section" id="aerial_overview_section">
            <label class="upload-label">Aerial Overview</label>
            <div style="font-size:0.95em;color:#555;margin-bottom:6px;">(straight down, if you do not have a drone use google earth)</div>
            <button type="button" class="submit-btn" onclick="openCompanyCamUploader('aerial_overview')">Select from CompanyCam</button>
            <div class="companycam-thumbs" id="aerial_overview_thumbs"></div>
          </div>

          <div class="upload-section" id="property_entrance_section">
            <label class="upload-label">Property Entrance</label>
            <button type="button" class="submit-btn" onclick="openCompanyCamUploader('property_entrance')">Select from CompanyCam</button>
            <div class="companycam-thumbs" id="property_entrance_thumbs"></div>
          </div>

          <!-- Control Buttons for Dropdowns -->
          <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
            <button type="button" class="submit-btn" onclick="expandAllSections()" style="background: #28a745; border-color: #28a745;">
              <i class="fas fa-expand-arrows-alt"></i> Expand All Sections
            </button>
            <button type="button" class="submit-btn" onclick="collapseAllSections()" style="background: #6c757d; border-color: #6c757d;">
              <i class="fas fa-compress-arrows-alt"></i> Collapse All Sections
            </button>
          </div>

          <!-- Detailed Damage Photos Section -->
          <div class="section-dropdown">
            <div class="dropdown-header" data-section="interior">
              <h3><i class="fas fa-camera-retro"></i> Interior Damage Photos <h3>
              <i class="fas fa-chevron-down"></i>
          </div>
            <div class="dropdown-content" id="interior-content">
              <div class="dropdown-content-inner">
          <div style="font-size:0.97em;color:#444;margin-bottom:12px;">
            Focus on leaks, Paint bleeds, Fallen or missing ceiling tiles, active leaking, ceiling discoloration, etc<br>
            Add in Photos and Explanation of what was noticed on the Interior
          </div>
          
          <div id="numberOfLeaksSection" style="margin-bottom:15px;">
            <label class="form-label">Number of Leaks</label>
            <input type="number" id="numberOfLeaks" min="0" class="form-input" />
          </div>
          <div id="interior_photos_section">
            <!-- JS will generate 9 uploaders here -->
                </div>
              </div>
            </div>
          </div>

          <div class="section-dropdown">
            <div class="dropdown-header" data-section="hvac">
              <h3><i class="fas fa-snowflake"></i> HVAC DAMAGE <h3>
              <i class="fas fa-chevron-down"></i>
          </div>
            <div class="dropdown-content" id="hvac-content">
              <div class="dropdown-content-inner">
          <div style="font-size:0.97em;color:#444;margin-bottom:12px;">
            Focus on damage to HVAC units, compressors, coils, fans, electrical components, and ductwork
          </div>
          
          <!-- HVAC Units and RTUS Count Section -->
          <div style="display: flex; gap: 20px; margin-bottom: 15px; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 0.95em; color: #444; font-weight: 500; white-space: nowrap;">Number of HVAC Units in Total:</label>
              <input type="number" 
                     id="hvac_units_total" 
                     name="hvac_units_total"
                     min="1" 
                     max="100" 
                     class="form-input" 
                     style="width: 60px; text-align: center; padding: 6px 8px; font-size: 0.9em;"
                     placeholder="0">
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-size: 0.95em; color: #444; font-weight: 500; white-space: nowrap;">Number of RTUS in Total:</label>
              <input type="number" 
                     id="rtus_total" 
                     name="rtus_total"
                     min="1" 
                     max="100" 
                     class="form-input" 
                     style="width: 60px; text-align: center; padding: 6px 8px; font-size: 0.9em;"
                     placeholder="0">
            </div>
          </div>
          
          <div id="hvac_damage_photos_section">
            <!-- JS will generate 9 uploaders here -->
                </div>
              </div>
            </div>
          </div>

          <div class="section-dropdown">
            <div class="dropdown-header" data-section="windows">
              <h3><i class="fas fa-hammer"></i> Window Damage Observation </h3>
              <i class="fas fa-chevron-down"></i>
          </div>
            <div class="dropdown-content" id="windows-content">
              <div class="dropdown-content-inner">
          <div style="font-size:0.97em;color:#444;margin-bottom:12px;">
                  Focus on window damage observations and select applicable checklists below each photo
          </div>
          
          <div id="numberOfWindowsSection" style="margin-bottom:15px;">
            <label class="form-label">Number of Windows</label>
            <input type="number" id="numberOfWindows" min="0" class="form-input" />
          </div>
          <div id="ground_exterior_photos_section">
            <!-- JS will generate 9 uploaders here -->
                </div>
              </div>
            </div>
          </div>

          <div class="section-dropdown">
            <div class="dropdown-header" data-section="roofing">
              <h3><i class="fas fa-home"></i> Roofing System Damage & Components </h3>
              <i class="fas fa-chevron-down"></i>
          </div>
            <div class="dropdown-content" id="roofing-content">
              <div class="dropdown-content-inner">
          <div style="font-size:0.97em;color:#444;margin-bottom:12px;">
            Add photos of test square, chalked hits, openings, loose materials, roof debris, close-up damage photos
          </div>
          <div id="roof_damage_photos_section">
            <!-- JS will generate 9 uploaders here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Exterior Components Section (new) -->
          <div class="section-dropdown">
            <div class="dropdown-header" data-section="exterior-components">
              <h3><i class="fas fa-warehouse"></i> Exterior Components </h3>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="dropdown-content" id="exterior-components-content">
              <div class="dropdown-content-inner">
                <div style="font-size:0.97em;color:#444;margin-bottom:12px;">
                  Add photos of exterior components and select applicable checklists below each photo
                </div>
                <div id="exterior_components_photos_section">
                  <!-- JS will generate 9 uploaders here -->
                </div>
              </div>
            </div>
          </div>
          

          <div class="upload-section" id="test_square_photo_section">
            <label class="upload-label">Test Square</label>
            <button type="button" class="submit-btn" onclick="openCompanyCamUploader('test_square_photo')">Select from CompanyCam</button>
            <div class="companycam-thumbs" id="test_square_photo_thumbs"></div>
            
            <!-- Test Square Description with Input Field -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #38c3ff;">
              <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px; font-size: 1em; color: #2c3e50; line-height: 1.5;">
                <span>The inspector performed a test square on your roof, during which</span>
                <input type="text" 
                       id="testSquareDamagedAreas" 
                       class="form-input" 
                       placeholder="00000" 
                       style="width: 80px; text-align: center; font-weight: 600; color: #2c3e50; border: 2px solid #38c3ff; border-radius: 6px; padding: 6px 10px; font-size: 0.95em;"
                       maxlength="10">
                <span>amount of damaged areas were found within the square</span>
              </div>
            </div>

            <!-- Damage Assessment Selection -->
            <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #38c3ff;">
              <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 1.1em; font-weight: 600;">
                <i class="fas fa-clipboard-check" style="color: #38c3ff;"></i> Damage Assessment Level
              </h4>
              <p style="margin: 0 0 15px 0; color: #6c757d; font-size: 0.9em;">
                Please select the appropriate damage assessment level based on your inspection findings:
              </p>
              
              <div class="damage-assessment-options" style="display: flex; flex-direction: column; gap: 12px;">
                <label class="damage-option" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                  <input type="radio" name="damageLevel" value="no_observable_damage" id="no_damage" style="width: 18px; height: 18px; accent-color: #38c3ff;">
                  <div style="flex: 1;">
                    <strong style="color: #2c3e50; font-size: 1em;">No Observable Damage</strong>
                    <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.9em;">No visible or measurable damage. Structure/components in good condition.</p>
                  </div>
                </label>

                <label class="damage-option" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                  <input type="radio" name="damageLevel" value="minimal_localized_damage" id="minimal_damage" style="width: 18px; height: 18px; accent-color: #38c3ff;">
                  <div style="flex: 1;">
                    <strong style="color: #2c3e50; font-size: 1em;">Minimal / Localized Damage</strong>
                    <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.9em;">Minor or localized issues, integrity not compromised.</p>
                  </div>
                </label>

                <label class="damage-option" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                  <input type="radio" name="damageLevel" value="significant_widespread_damage" id="significant_damage" style="width: 18px; height: 18px; accent-color: #38c3ff;">
                  <div style="flex: 1;">
                    <strong style="color: #2c3e50; font-size: 1em;">Significant / Widespread Damage</strong>
                    <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.9em;">Substantial damage impacting safety, function, or durability.</p>
                  </div>
                </label>
              </div>

              <div style="margin-top: 15px; padding: 10px; background: #e9f7ff; border: 1px solid #38c3ff; border-radius: 6px;">
                <p style="margin: 0; color: #2980b9; font-size: 0.9em;">
                  <i class="fas fa-info-circle" style="color: #38c3ff;"></i> <strong>Note:</strong> Your selection will be highlighted in the final PDF report.
                </p>
              </div>
            </div>
          </div>

          <div class="nav-buttons">
            <button type="button" class="btn btn-secondary" onclick="prevStep(3)">
              <i class="fas fa-arrow-left"></i> Previous
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep(5)">
              Next <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 5: Preview -->
        <div class="form-step" id="step-5">
          <h2 class="step-title">
            <i class="fas fa-eye"></i> Preview
          </h2>
          <p class="step-description">
            Review the report before finalizing
          </p>



          <button type="button" class="submit-btn" id="previewPdfBtn" style="margin: 20px auto; display: none;" onclick="previewPDFContent()">
            <i class="fas fa-eye"></i> Preview PDF Content
          </button>

          <button type="button" class="submit-btn" id="exportPdfBtn" style="margin: 20px auto; display: none;" onclick="openPDFModal()">
            <i class="fas fa-download"></i> Download Report as PDF
          </button>

          <!-- 🔒 PREVIEW BUTTON HIDDEN - NOT WORKING PROPERLY -->
          <button type="button" class="submit-btn" id="previewReportPDFMakeBtn" style="margin: 20px auto; display: none; background: #17a2b8;" onclick="previewDARReportPDFMake()">
            <i class="fas fa-eye"></i> Preview PDF Report
          </button>

          <button type="button" class="submit-btn" id="downloadReportPDFMakeBtn" style="margin: 20px auto; display: block; background: #28a745;" onclick="downloadDARReportPDFMake()">
            <i class="fas fa-file-pdf"></i> Send and Download Report to Monday
          </button>

          <div class="nav-buttons" style="display: none;">
            <button type="button" class="btn btn-secondary" onclick="prevStep(4)">
              <i class="fas fa-arrow-left"></i> Previous
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep(6)">
              Next <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 6: Complete -->
        <div class="form-step" id="step-6">
          <h2 class="step-title">
            <i class="fas fa-check-circle"></i> Complete Report
          </h2>
          <p class="step-description">
            Final options and report submission
          </p>

          <div class="form-group">
            <div class="alert alert-success" style="background: #d4edda; border: 1px solid #28a745; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 10px 0; color: #155724;">
                <i class="fas fa-check-circle"></i> Report Successfully Uploaded
              </h4>
              <p style="margin: 0 0 10px 0; color: #2c3e50;">
                <strong>✅ Congratulations!</strong> Your DAR report has been successfully uploaded to Monday.com project (<strong id="submitVidDisplay">--</strong>) files column.
              </p>
              <p style="margin: 0; color: #6c757d; font-size: 0.9em;">
                Click "Finish & Start New Report" below to complete the process and begin a new inspection report.
              </p>
            </div>
          </div>

          <div class="nav-buttons">
            <button type="button" class="btn btn-secondary" onclick="prevStep(4)">
              <i class="fas fa-edit"></i> Edit Report
            </button>
            <button type="button" class="btn btn-success" id="uploadToMondayBtn" onclick="openMondayUploadModal()" style="display: none;">
              <i class="fas fa-upload"></i> Upload to Monday.com
            </button>
            <button type="button" class="btn btn-primary" id="finishReportBtn" onclick="finishAndRestart()" style="margin-left: 0px;">
              <i class="fas fa-check-circle"></i> Finish & Start New Report
            </button>
          </div>
        </div>

      </form>
    </div>
  </div>

  <!-- Debug Console -->
  <button class="debug-toggle" onclick="toggleDebug()">
    <i class="fas fa-bug"></i>
  </button>
  <div class="debug-console" id="debugConsole"></div>

  <!-- PDF Preview Modal -->
  <div id="pdfModal" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);">
    <div class="modal-content" style="background: white; margin: 2% auto; padding: 0; width: 95%; height: 95%; border-radius: 10px; position: relative; overflow: hidden;">
      <!-- Modal Header -->
      <div style="background: #38c3ff; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; font-size: 1.5em;">
          <i class="fas fa-file-pdf"></i> DAR Report Preview & Download
        </h2>
        <div>
          <button type="button" id="modalDownloadBtn" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; margin-right: 15px; cursor: pointer; font-size: 1em; font-weight: bold;">
            <i class="fas fa-download"></i> Download PDF
          </button>
          <button type="button" onclick="closePDFModal()" style="background: #dc3545; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 1.2em;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <!-- Modal Body -->
      <div id="pdfPreviewContent" style="padding: 20px; height: calc(100% - 80px); overflow-y: auto; background: #f8f9fa;">
        <div style="text-align: center; padding: 50px; color: #666;">
          <i class="fas fa-spinner fa-spin fa-3x"></i>
          <p style="margin-top: 20px; font-size: 1.2em;">Generating PDF preview...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Full-Screen CompanyCam Modal -->
  <div id="uploadModal" class="modal">
    <div style="background:#fff; padding:0; border-radius:0; width:100vw; height:100vh; overflow:hidden; box-shadow: none; position: relative;">
      <!-- CompanyCam-style Header -->
      <div style="background: #2c3e50; color: white; padding: 15px 25px; position: relative; border-bottom: 1px solid #34495e; display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <div style="background: #3498db; padding: 8px 12px; border-radius: 6px; font-weight: 600;">
            <i class="fas fa-camera"></i> CompanyCam
          </div>
          <div id="modalProjectTitle" style="font-size: 1.2em; font-weight: 500;">
            Loading Project...
          </div>
        </div>
        
        <div style="display: flex; align-items: center; gap: 15px;">
          <button type="button" onclick="openInCompanyCam(document.getElementById('ccIdField').value)" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
            <i class="fas fa-external-link-alt"></i> Open in CompanyCam
          </button>
          <button type="button" onclick="closeUploadModal()" style="background: none; border: none; color: white; font-size: 1.8em; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; padding: 5px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <!-- CompanyCam-style Content -->
      <div class="companycam-content" style="display: flex; height: calc(100vh - 120px);">
        <!-- Photos Grid Sidebar -->
        <div class="companycam-sidebar" style="width: 300px; background: #f8f9fa; border-right: 1px solid #e9ecef; overflow-y: auto; padding: 20px; max-height: calc(100vh - 120px);">
          <div style="margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0; font-size: 1.1em; color: #2c3e50;">Photos</h4>
            <div id="photoCount" style="color: #6c757d; font-size: 0.9em;">Loading...</div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <button type="button" class="btn btn-primary" onclick="selectAllPhotos()" style="width: 100%; margin-bottom: 8px; font-size: 0.9em;">
              <i class="fas fa-check-double"></i> Select All
            </button>
            <button type="button" class="btn btn-secondary" onclick="clearAllPhotos()" style="width: 100%; font-size: 0.9em;">
              <i class="fas fa-times"></i> Clear Selection
            </button>
          </div>
          
          <div id="photosSidebar" class="companycam-photo-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; min-height: 200px; overflow: visible;">
            <!-- Photos will be loaded here -->
          </div>
        </div>
        
        <!-- Main Photo Viewer -->
        <div class="companycam-viewer" style="flex: 1; background: #000; position: relative; display: flex; align-items: center; justify-content: center;">
          <div id="mainPhotoViewer" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2em;">
            <div style="text-align: center;">
              <i class="fas fa-image" style="font-size: 3em; opacity: 0.3; margin-bottom: 20px; display: block;"></i>
              Select a photo to preview
            </div>
          </div>
          
          <!-- Photo Controls Overlay -->
          <div id="photoControls" class="companycam-controls" style="display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 15px 20px; border-radius: 10px; color: white;">
            <button type="button" onclick="togglePhotoInSelection()" id="toggleSelectionBtn" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
              <i class="fas fa-plus"></i> Add to Selection
            </button>
            <button type="button" onclick="downloadCurrentPhoto()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
              <i class="fas fa-download"></i> Download
            </button>
          </div>
        </div>
      </div>
      
      <!-- Bottom Action Bar -->
      <div style="background: #f8f9fa; padding: 15px 25px; border-top: 1px solid #e9ecef; display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <span style="color: #6c757d; font-size: 0.9em;">
            <span id="selectedCountDisplay">0</span> photos selected
          </span>
          <button type="button" class="btn btn-secondary" onclick="browseLocalFiles()">
            <i class="fas fa-folder-open"></i> Browse Local Files
          </button>
        </div>
        
        <div style="display: flex; gap: 10px;">
          <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="addSelectedPhotos()" style="font-size: 1em; padding: 12px 30px;">
            <i class="fas fa-plus"></i> Add Selected Photos
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dedicated CompanyCam Photos Modal (Fully Responsive) -->
  <div id="companyCamPhotosModal" class="companycam-modal" style="display: none;">
    <div class="companycam-modal-container">
      <!-- Header -->
      <div class="companycam-modal-header">
        <div class="companycam-header-left">
          <div class="companycam-header-badge">
            <i class="fas fa-camera"></i> 
            <span class="companycam-badge-text">CompanyCam Photos</span>
          </div>
          <div id="dedicatedModalProjectTitle" class="companycam-project-title">
            Loading Project...
          </div>
          <div id="dedicatedPhotoCount" class="companycam-photo-count">
            0 photos
          </div>
        </div>
        
        <div class="companycam-header-actions">
          <!-- NEW: Upload buttons -->
          <button type="button" onclick="openGalleryFromCompanyCam()" class="companycam-btn companycam-btn-primary">
            <i class="fas fa-folder-open"></i> 
            <span class="companycam-btn-text">Select from Gallery</span>
          </button>
          <button type="button" onclick="openCameraFromCompanyCam()" class="companycam-btn companycam-btn-info">
            <i class="fas fa-camera"></i> 
            <span class="companycam-btn-text">Take Photo</span>
          </button>
          
          <!-- Existing buttons -->
          <button type="button" onclick="selectAllPhotosInDedicated()" class="companycam-btn companycam-btn-success">
            <i class="fas fa-check-double"></i> 
            <span class="companycam-btn-text">Select All</span>
          </button>
          <button type="button" onclick="clearAllPhotosInDedicated()" class="companycam-btn companycam-btn-danger">
            <i class="fas fa-times"></i> 
            <span class="companycam-btn-text">Clear All</span>
          </button>
          <button type="button" onclick="addSelectedPhotosFromDedicated()" class="companycam-btn companycam-btn-warning">
            <i class="fas fa-plus"></i> 
            <span class="companycam-btn-text">Add Selected</span>
          </button>
          <button type="button" onclick="closeDedicatedCompanyCamModal()" class="companycam-btn-close">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <!-- Photos Grid (Responsive with Scroll) -->
      <div class="companycam-modal-content">
        <div class="companycam-grid-container">
          <div id="dedicatedPhotoGrid" class="companycam-photo-grid">
            <!-- Photos will be loaded here -->
            <div class="companycam-empty-state">
              <i class="fas fa-camera companycam-empty-icon"></i>
              <h3 class="companycam-empty-title">No photos loaded</h3>
              <p class="companycam-empty-description">Click "Select from CompanyCam" to load project photos</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 🔄 FLECHAS DE NAVEGACIÓN -->
  <div class="navigation-arrows">
    <button class="nav-arrow" onclick="scrollToTop()" title="Ir arriba">
      <i class="fas fa-chevron-up"></i>
    </button>
    <button class="nav-arrow" onclick="scrollToBottom()" title="Ir abajo">
      <i class="fas fa-chevron-down"></i>
    </button>
  </div>

  <!-- Monday.com Upload Modal -->
  <div id="mondayUploadModal" class="modal">
    <div class="modal-content" style="max-width: 600px; margin: 50px auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <!-- Header -->
      <div style="background: linear-gradient(135deg, #00c851 0%, #28a745 100%); color: white; padding: 25px; text-align: center;">
        <h3 style="margin: 0; font-size: 1.5em;">
          <i class="fas fa-upload"></i> Upload to Monday.com
        </h3>
        <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 0.95em;">
          Upload your DAR report to the project files
        </p>
      </div>

      <!-- Content -->
      <div style="padding: 30px;">
        <div style="margin-bottom: 25px;">
          <h4 style="color: #2c3e50; margin: 0 0 15px 0;">
            <i class="fas fa-info-circle"></i> Project Information
          </h4>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
            <strong>V-ID:</strong> <span id="uploadVidDisplay">--</span><br>
            <strong>Project:</strong> <span id="uploadProjectDisplay">--</span><br>
            <strong>Monday.com Files Column:</strong> <code>files_mkn7es21</code>
          </div>
        </div>

        <div style="margin-bottom: 25px;">
          <h4 style="color: #2c3e50; margin: 0 0 15px 0;">
            <i class="fas fa-file-upload"></i> Upload Instructions
          </h4>
          <div style="background: #e9f7ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
            <p style="margin: 0 0 10px 0; color: #2c3e50;">
              1. <strong>Select the PDF file</strong> that you previously downloaded from the Preview step
            </p>
            <p style="margin: 0 0 10px 0; color: #2c3e50;">
              2. <strong>Click "Upload to Monday.com"</strong> to upload it to your project
            </p>
            <p style="margin: 0; color: #2c3e50;">
              3. The file will be uploaded to your Monday.com project's files column
            </p>
          </div>
        </div>

        <div style="margin-bottom: 25px;">
          <label style="display: block; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">
            <i class="fas fa-paperclip"></i> Select PDF File:
          </label>
          <div style="position: relative;">
            <input type="file" id="mondayFileInput" accept=".pdf" style="width: 100%; padding: 12px; border: 2px dashed #ddd; border-radius: 8px; cursor: pointer; font-size: 1em;" onchange="handleFileSelection(this)">
            <div id="fileSelectedInfo" style="margin-top: 10px; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; color: #155724; display: none;">
              <i class="fas fa-check-circle"></i> File selected: <span id="selectedFileName">--</span>
            </div>
          </div>
        </div>

        <div style="border-top: 1px solid #eee; padding-top: 25px; text-align: center;">
          <button type="button" class="btn btn-secondary" onclick="closeMondayUploadModal()" style="margin-right: 15px;">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" id="uploadToMondaySubmitBtn" class="btn btn-success" onclick="submitFileToMonday()" disabled>
            <i class="fas fa-upload"></i> Upload to Monday.com
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Include required JS files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- PDFMake Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  
  <script>
    // 🔄 FUNCIONES DE NAVEGACIÓN
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    function scrollToBottom() {
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth'
      });
    }
  </script>
  
  <script>
    let currentStep = 1;
    const totalSteps = 6;
    let currentUploader = null;
    let formData = null; // Initialize formData globally to prevent undefined errors

    // Debug system
    function debugLog(message) {
      // Redirigir a console.log para evitar errores
      console.log(message);
    }

    function toggleDebug() {
      const debugConsole = document.getElementById('debugConsole');
      debugConsole.style.display = debugConsole.style.display === 'block' ? 'none' : 'block';
    }

    // Step navigation
    function nextStep(step) {
      debugLog(`🎯 Moving to step ${step}`);
      
      try {
        // Hide current step
        const currentSteps = document.querySelectorAll('.form-step');
        debugLog(`📊 Found ${currentSteps.length} form steps`);
        
        currentSteps.forEach(el => {
          el.classList.remove('active');
          debugLog(`🔍 Removed active from: ${el.id}`);
        });
        
        // Show new step
        const targetStep = document.getElementById(`step-${step}`);
        if (!targetStep) {
          throw new Error(`Step ${step} not found! Element step-${step} does not exist.`);
        }
        
        targetStep.classList.add('active');
        debugLog(`✅ Activated step: step-${step}`);
        
        // 👁️ MOSTRAR BOTONES DEL STEP 5 CUANDO SE NAVEGA A ÉL
        if (step === 5) {
          // Solo mostrar el botón de download (preview está permanentemente oculto)
          const downloadBtn = document.getElementById('downloadReportPDFMakeBtn');
          
          if (downloadBtn) {
            downloadBtn.style.display = 'block';
            debugLog('👁️ Download button shown in step 5');
          }
        }
        
        // Update progress
        updateProgress(step);
        
        currentStep = step;
        debugLog(`🎯 Successfully moved to step ${step}`);
        
        // Scroll to top of the new step
        targetStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
      } catch (error) {
        debugLog(`❌ Error in nextStep(${step}): ${error.message}`);
        console.error('Step navigation error:', error);
        alert(`Error navigating to step ${step}: ${error.message}`);
      }
    }

    function prevStep(step) {
      debugLog(`Moving back to step ${step}`);
      
      // Si regresamos desde el paso 6 al paso 4, resetear todo para permitir modificaciones
      if (step === 4) {
        // Resetear el botón de envío del paso 5
        const sendBtn = document.getElementById('downloadReportPDFMakeBtn');
        if (sendBtn) {
          sendBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Send and Download Report to Monday';
          sendBtn.style.background = '#28a745';
          sendBtn.disabled = false;
        }
        
        // Resetear el progreso del paso 6
        const step6Circle = document.getElementById('step-circle-6');
        if (step6Circle) {
          step6Circle.classList.remove('active');
          step6Circle.style.opacity = '0.5';
          step6Circle.style.pointerEvents = 'none';
          step6Circle.style.cursor = 'default';
        }
        
        // Ocultar el paso 6 cuando regresamos
        const step6 = document.getElementById('step-6');
        if (step6) {
          step6.style.display = 'none';
          debugLog('✅ Step 6 (Complete) hidden when going back');
        }
        
        // Asegurar que el paso 5 esté disponible para cuando avance de nuevo
        const step5 = document.getElementById('step-5');
        if (step5) {
          step5.style.display = 'block';
          debugLog('✅ Step 5 (Preview) prepared for future navigation');
        }
        
        // 👁️ OCULTAR BOTONES DEL STEP 5 CUANDO SE EDITA EL REPORTE
        // Solo ocultar el botón de download (preview está permanentemente oculto)
        const downloadBtn = document.getElementById('downloadReportPDFMakeBtn');
        
        if (downloadBtn) {
          downloadBtn.style.display = 'none';
          debugLog('🔒 Download button hidden during edit mode');
        }
        
        debugLog('🔄 User returned to step 4 to modify form - all systems reset');
      }
      
      nextStep(step);
    }

    function updateProgress(step) {
      debugLog(`📊 Updating progress to step ${step}`);
      
      try {
        // Update progress bar
        const progressFill = document.getElementById('progressFill');
        if (progressFill) {
          const percentage = ((step - 1) / (totalSteps - 1)) * 100;
          progressFill.style.width = `${percentage}%`;
          debugLog(`📈 Progress bar updated to ${percentage}%`);
        } else {
          debugLog(`⚠️ Progress fill element not found`);
        }
        
        // Update step circles
        for (let i = 1; i <= totalSteps; i++) {
          const circle = document.getElementById(`step-circle-${i}`);
          if (circle) {
            circle.classList.remove('active', 'completed');
            
            if (i < step) {
              circle.classList.add('completed');
              circle.innerHTML = '<i class="fas fa-check"></i>';
            } else if (i === step) {
              circle.classList.add('active');
              circle.innerHTML = i;
            } else {
              circle.innerHTML = i;
            }
            debugLog(`✅ Updated step circle ${i}`);
          } else {
            debugLog(`⚠️ Step circle ${i} not found`);
          }
        }
      } catch (error) {
        debugLog(`❌ Error in updateProgress: ${error.message}`);
        console.error('Progress update error:', error);
      }
    }

    // Enhanced autofill function
    function autofillFields(data) {
      debugLog('🔄 Starting autofill process...');
      debugLog(`📊 Received data: ${JSON.stringify(data, null, 2)}`);
      
      const fieldMappings = [
        { id: 'propertyNameInput', value: data.business_name || data.property_name || '', label: 'Business Name' },
        { id: 'propertyAddressInput', value: (data.property_address || '').split(',')[0].trim(), label: 'Property Address' },
        { id: 'city', value: data.city || '', label: 'City' },
        { id: 'state', value: data.state || '', label: 'State' },
        { id: 'zipcode', value: data.zipcode || '', label: 'Zipcode' },
        { id: 'ownerFirstName', value: (data.owner_name || '').split(' ')[0] || '', label: 'Owner First Name' },
        { id: 'ownerLastName', value: (data.owner_name || '').split(' ').slice(1).join(' ') || '', label: 'Owner Last Name' },
        { id: 'ownerPhone', value: data.owner_phone_number || data.owner_phone || '', label: 'Owner Phone' },
        { id: 'ownerEmail', value: data.owner_email || '', label: 'Owner Email' },
        { id: 'inspectorFirstName', value: (data.field_rep || '').split(' ')[0] || '', label: 'Inspector First Name' },
        { id: 'inspectorLastName', value: (data.field_rep || '').split(' ').slice(1).join(' ') || '', label: 'Inspector Last Name' },
        { id: 'inspectorPhone', value: data.inspector_phone || '', label: 'Inspector Phone' },
        { id: 'inspectorEmail', value: data.inspector_email || '', label: 'Inspector Email' },
        { id: 'vIdField', value: data.v_id || '', label: 'V-ID' },
        { id: 'ccIdField', value: data.cc_id || '', label: 'CC ID' }
      ];

      fieldMappings.forEach(mapping => {
        const element = document.getElementById(mapping.id);
        if (element) {
          element.value = mapping.value;
          
          // Add visual feedback for auto-filled fields
          if (mapping.value) {
            element.classList.add('auto-filled');
            debugLog(`✅ ${mapping.label}: "${mapping.value}"`);
          } else {
            debugLog(`⚠️ ${mapping.label}: No data`);
          }
        } else {
          debugLog(`❌ Element not found: ${mapping.id}`);
        }
      });

      // Handle dates
      const inspectionDate = normalizeDateForInput(data.inspected_on || '');
      const stormDate = normalizeDateForInput(data.storm_date || '');
      
      if (inspectionDate) {
        document.getElementById('inspectionDate').value = inspectionDate;
        debugLog(`✅ Inspection Date: ${inspectionDate}`);
      }
      
      if (stormDate) {
        document.getElementById('stormDateInput').value = stormDate;
        debugLog(`✅ Storm Date: ${stormDate}`);
      }

      // Auto-select dropdowns if data available
      if (data.property_type) {
        const propertyTypeSelect = document.getElementById('propertyType');
        for (let i = 0; i < propertyTypeSelect.options.length; i++) {
          if (propertyTypeSelect.options[i].value.toLowerCase() === data.property_type.toLowerCase()) {
            propertyTypeSelect.selectedIndex = i;
            break;
          }
        }
      }

      if (data.roof_system) {
        const roofSystemSelect = document.getElementById('roofSystem');
        for (let i = 0; i < roofSystemSelect.options.length; i++) {
          if (roofSystemSelect.options[i].value.toLowerCase().includes(data.roof_system.toLowerCase())) {
            roofSystemSelect.selectedIndex = i;
            break;
          }
        }
      }

      // Show CompanyCam connection status if we have CC ID
      if (data.cc_id && data.companycam_link) {
        const statusDiv = document.getElementById('companyCamStatus');
        const projectInfo = document.getElementById('companyCamProjectInfo');
        
        if (statusDiv && projectInfo) {
          const projectName = data.business_name || 'Unknown Project';
          projectInfo.innerHTML = `
            <strong>${projectName}</strong><br>
            Project ID: ${data.cc_id} • Photos ready for upload
          `;
          statusDiv.style.display = 'block';
          debugLog(`📸 CompanyCam project connected: ${data.cc_id}`);
        }
      }

      debugLog('🎉 Autofill completed successfully!');
    }

    // PICK-CAM Photo Integration - Now using existing DAR modal
    let currentPhotoSection = '';
    let currentProjectId = '';

    // Enhanced PICK-CAM fetch
    async function fetchMondayData() {
      debugLog(`🎯 fetchMondayData() called`);
      
      const vId = document.getElementById('vIdInput').value.trim();
      const btn = document.getElementById('nextBtnStep1');
      
      debugLog(`📊 V-ID: "${vId}"`);
      debugLog(`🔍 Button found: ${btn ? 'Yes' : 'No'}`);
      
      if (!vId) {
        alert('⚠️ Please enter a valid V-ID');
        return;
      }

      debugLog(`🚀 Fetching data for V-ID: ${vId}`);
      
      // Update button state - find elements within the button
      const btnText = btn.querySelector('#btnText');
      const spinner = btn.querySelector('#loadingSpinner');
      
      debugLog(`🔍 Button text found: ${btnText ? 'Yes' : 'No'}`);
      debugLog(`🔍 Spinner found: ${spinner ? 'Yes' : 'No'}`);
      
      if (btnText) btnText.style.display = 'none';
      if (spinner) spinner.style.display = 'inline-block';
      btn.disabled = true;

      try {
        const response = await fetch('/api/fetch-monday', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ v_id: vId })
        });

        debugLog(`📡 Response status: ${response.status}`);

        const data = await response.json();
        debugLog(`📦 Received data: ${JSON.stringify(data, null, 2)}`);

        if (!response.ok) {
          if (response.status === 404 && data.error) {
            throw new Error(`${data.error}\n\n${data.message || ''}\n\nV-ID buscado: ${data.v_id}\nPáginas revisadas: ${data.searched_pages || 'N/A'}`);
          } else {
            throw new Error(`HTTP Error ${response.status}: ${data.error || 'Unknown error'}`);
          }
        }

        if (data.error) {
          throw new Error(`API Error: ${data.error}`);
        }

        if (!data || Object.keys(data).length === 0) {
          throw new Error('No data found for this V-ID');
        }

        // Success!
        autofillFields(data);
        
        // Store project ID and slug for photo integration
        currentProjectId = data.project_slug || data.project_id;
        debugLog(`📋 Stored project identifier for photos: ${currentProjectId}`);
        
        // Show success animation
        btn.innerHTML = '<i class="fas fa-check"></i> Data Retrieved!';
        btn.style.background = '#28a745';
        
        debugLog(`🎯 Data retrieved successfully, moving to step 2 in 1 second...`);
        
        setTimeout(() => {
          debugLog(`🚀 Attempting to move to step 2...`);
          nextStep(2);
        }, 1000);

      } catch (error) {
        debugLog(`❌ Error: ${error.message}`);
        alert(`❌ Error retrieving data from PICK-CAM:\n\n${error.message}\n\nCheck the debug console for more details.`);
      } finally {
        // Reset button state
        setTimeout(() => {
          const btnText = btn.querySelector('#btnText');
          const spinner = btn.querySelector('#loadingSpinner');
          
          if (btnText) btnText.style.display = 'inline';
          if (spinner) spinner.style.display = 'none';
          btn.disabled = false;
          btn.innerHTML = '<span id="btnText">Fetch Data</span><span id="loadingSpinner" style="display:none;" class="spinner"></span>';
          btn.style.background = '';
        }, 2000);
      }
    }

    // Manual V-ID entry function
    // Función para abrir la interfaz de subida de fotos
    function openPhotoUpload() {
      window.open('photo_upload.html', '_blank');
    }

    async function manualVidEntry() {
      const vId = document.getElementById('vIdInput').value.trim();
      const btn = document.getElementById('manualEntryBtn');
      
      if (!vId) {
        alert('⚠️ Please enter a valid V-ID');
        return;
      }

      debugLog(`📝 Manual entry for V-ID: ${vId}`);
      
      // Update button state
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
      btn.disabled = true;

      try {
        const response = await fetch('/api/manual-vid-entry', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ v_id: vId })
        });

        debugLog(`📡 Manual entry response status: ${response.status}`);

        const data = await response.json();
        debugLog(`📦 Manual entry data: ${JSON.stringify(data, null, 2)}`);

        if (!response.ok) {
          throw new Error(`HTTP Error ${response.status}: ${data.error || 'Unknown error'}`);
        }

        if (data.error) {
          throw new Error(`API Error: ${data.error}`);
        }

        // Success!
        autofillFields(data);
        
        // Show success animation
        btn.innerHTML = '<i class="fas fa-check"></i> Manual Entry Ready!';
        btn.style.background = '#28a745';
        
        setTimeout(() => {
          nextStep(2);
        }, 1000);

      } catch (error) {
        debugLog(`❌ Manual entry error: ${error.message}`);
        alert(`❌ Error with manual entry:\n\n${error.message}`);
      } finally {
        // Reset button state
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-edit"></i> Manual Entry';
          btn.disabled = false;
          btn.style.background = '';
        }, 2000);
      }
    }

    // Date normalization function
    function normalizeDateForInput(dateStr) {
      if (!dateStr || typeof dateStr !== 'string' || !dateStr.trim()) return '';
      
      dateStr = dateStr.trim();
      
      // If already in YYYY-MM-DD format
      if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
      
      // If in YYYY-MM-DD HH:mm format, strip time
      if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) return dateStr.slice(0, 10);
      
      // If in MM/DD/YYYY format
      if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
        const [m, d, y] = dateStr.split('/');
        return `${y.padStart(4, '0')}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
      }
      
      // Try Date parsing as fallback
      try {
        const d = new Date(dateStr);
        if (!isNaN(d.getTime()) && d.getFullYear() > 1900 && d.getFullYear() < 2100) {
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const dd = String(d.getDate()).padStart(2, '0');
          return `${yyyy}-${mm}-${dd}`;
        }
      } catch (e) {
        debugLog(`⚠️ Date parsing failed: ${dateStr}`);
      }
      
      return '';
    }

    // Trade type event handlers
    function setupTradeTypes() {
      document.querySelectorAll('.tradeType').forEach(cb => {
        cb.addEventListener('change', function() {
          const trade = cb.value;
          const controls = document.getElementById(trade.toLowerCase() + 'Controls');
          if (controls) {
            controls.style.display = cb.checked ? '' : 'none';
          }
          
          // Show/hide conditional sections - REMOVED: fields are now always visible in their respective sections
        });
      });
    }

    // Storm type event handlers
    function setupStormTypes() {
      document.querySelectorAll('.stormType').forEach(cb => {
        cb.addEventListener('change', function() {
          const storm = cb.value;
          const options = document.getElementById(storm.toLowerCase() + 'Options');
          if (options) {
            options.style.display = cb.checked ? '' : 'none';
          }
        });
      });
    }

    // Photo upload functions
    function generatePhotoUploaders() {
      const sections = [
        { id: 'interior_photos_section', prefix: 'interior_photo', label: 'Interior Photo' },
        { id: 'hvac_damage_photos_section', prefix: 'hvac_damage_photo', label: 'HVAC Damage Photo' },
        { id: 'ground_exterior_photos_section', prefix: 'ground_exterior_photo', label: 'Window Damage Photo' },
        { id: 'roof_damage_photos_section', prefix: 'roof_damage_photo', label: 'Roof Damage Photo' },
        { id: 'exterior_components_photos_section', prefix: 'exterior_components_photo', label: 'Exterior Components Photo' }
      ];

      sections.forEach(section => {
        const container = document.getElementById(section.id);
        if (container) {
          console.log(`🔧 DEBUG: Generando campos para ${section.id} - preparando ${9} campos`);
          for (let i = 1; i <= 9; i++) {
            console.log(`🔧 DEBUG: Generando campo ${i} para ${section.prefix}`);
            // Special handling for different photo types - use dropdown instead of textarea
            let explanationField = '';
            if (section.prefix === 'interior_photo' && i === 1) {
              explanationField = `
                <div style="margin-top: 10px;">
                  <label class="form-label">Interior Damage Observations:</label>
                  <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 3000px !important; overflow-y: auto; background: #f9f9f9;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_1" name="interior_photo_1_damage_1" value="water_stains_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water Stains on Ceiling – Indicating roof or window leaks during the storm.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_2" name="interior_photo_1_damage_2" value="drywall_cracks" style="margin-right: 6px; margin-top: 2px;">
                        <span>Drywall Cracks – Resulting from structural shifting or water intrusion.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_3" name="interior_photo_1_damage_3" value="warped_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Warped Flooring – Moisture caused wood or laminate floors to buckle or swell.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_4" name="interior_photo_1_damage_4" value="soggy_insulation" style="margin-right: 6px; margin-top: 2px;">
                        <span>Soggy Insulation – Wet insulation losing effectiveness and promoting mold growth.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_5" name="interior_photo_1_damage_5" value="mold_growth_walls" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold Growth on Walls – Fungal growth from prolonged moisture exposure.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_6" name="interior_photo_1_damage_6" value="damaged_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Damaged Window Frames – Wind or water caused frames to swell or crack.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_7" name="interior_photo_1_damage_7" value="broken_interior_doors" style="margin-right: 6px; margin-top: 2px;">
                        <span>Broken Interior Doors – Doors swollen or damaged by water infiltration.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_8" name="interior_photo_1_damage_8" value="debris_inside_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Debris Inside Rooms – Wind-blown debris scattered inside the property.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_9" name="interior_photo_1_damage_9" value="electrical_outlet_damage" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical Outlet Damage – Water exposure leading to corrosion or shorts.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_10" name="interior_photo_1_damage_10" value="peeling_paint_wallpaper" style="margin-right: 6px; margin-top: 2px;">
                        <span>Peeling Paint or Wallpaper – Moisture causing finishes to bubble and peel.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_11" name="interior_photo_1_damage_11" value="water_intrusion_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water intrusion can cause ceiling stains, signaling roof or window leaks. Prompt roof repairs and sealing prevent further damage.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_12" name="interior_photo_1_damage_12" value="structural_shifts_drywall" style="margin-right: 6px; margin-top: 2px;">
                        <span>Storm-related structural shifts may cause drywall cracks. Cracks should be assessed and repaired to restore wall integrity.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_13" name="interior_photo_1_damage_13" value="moisture_warp_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture can warp wood or laminate flooring, causing buckling. Damaged flooring often requires replacement or refinishing after drying.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_14" name="interior_photo_1_damage_14" value="wet_insulation_effectiveness" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wet insulation loses effectiveness and promotes mold growth. Saturated insulation must be removed and replaced.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_15" name="interior_photo_1_damage_15" value="mold_growth_walls_professional" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold growth occurs from prolonged moisture exposure inside walls. Professional mold remediation is essential for health and safety.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_16" name="interior_photo_1_damage_16" value="water_swell_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water can swell or crack window frames, compromising fit. Frames may need repair, resealing, or replacement to restore weatherproofing.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_17" name="interior_photo_1_damage_17" value="interior_doors_swell" style="margin-right: 6px; margin-top: 2px;">
                        <span>Interior doors may swell or warp from water infiltration. Doors can sometimes be repaired or may require replacement.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_18" name="interior_photo_1_damage_18" value="wind_debris_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wind-driven debris can scatter inside rooms, causing physical damage. Cleanup and repair of damaged materials are necessary.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_19" name="interior_photo_1_damage_19" value="electrical_outlets_corrosion" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical outlets exposed to water risk corrosion and shorts. Electrical components should be inspected and replaced by a qualified technician.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_1_damage_20" name="interior_photo_1_damage_20" value="moisture_paint_bubble" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture causes paint or wallpaper to peel or bubble. Damaged finishes must be removed and surfaces properly dried before refinishing.</span>
                      </label>
                    </div>
                  </div>
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else if (section.prefix === 'interior_photo' && i === 2) {
              explanationField = `
                <div style="margin-top: 10px;">
                  <label class="form-label">Interior Damage Observations:</label>
                  <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 3000px !important; overflow-y: auto; background: #f9f9f9;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_1" name="interior_photo_2_damage_1" value="water_stains_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water Stains on Ceiling – Indicating roof or window leaks during the storm.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_2" name="interior_photo_2_damage_2" value="drywall_cracks" style="margin-right: 6px; margin-top: 2px;">
                        <span>Drywall Cracks – Resulting from structural shifting or water intrusion.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_3" name="interior_photo_2_damage_3" value="warped_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Warped Flooring – Moisture caused wood or laminate floors to buckle or swell.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_4" name="interior_photo_2_damage_4" value="soggy_insulation" style="margin-right: 6px; margin-top: 2px;">
                        <span>Soggy Insulation – Wet insulation losing effectiveness and promoting mold growth.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_5" name="interior_photo_2_damage_5" value="mold_growth_walls" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold Growth on Walls – Fungal growth from prolonged moisture exposure.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_6" name="interior_photo_2_damage_6" value="damaged_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Damaged Window Frames – Wind or water caused frames to swell or crack.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_7" name="interior_photo_2_damage_7" value="broken_interior_doors" style="margin-right: 6px; margin-top: 2px;">
                        <span>Broken Interior Doors – Doors swollen or damaged by water infiltration.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_8" name="interior_photo_2_damage_8" value="debris_inside_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Debris Inside Rooms – Wind-blown debris scattered inside the property.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_9" name="interior_photo_2_damage_9" value="electrical_outlet_damage" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical Outlet Damage – Water exposure leading to corrosion or shorts.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_10" name="interior_photo_2_damage_10" value="peeling_paint_wallpaper" style="margin-right: 6px; margin-top: 2px;">
                        <span>Peeling Paint or Wallpaper – Moisture causing finishes to bubble and peel.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_11" name="interior_photo_2_damage_11" value="water_intrusion_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water intrusion can cause ceiling stains, signaling roof or window leaks. Prompt roof repairs and sealing prevent further damage.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_12" name="interior_photo_2_damage_12" value="structural_shifts_drywall" style="margin-right: 6px; margin-top: 2px;">
                        <span>Storm-related structural shifts may cause drywall cracks. Cracks should be assessed and repaired to restore wall integrity.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_13" name="interior_photo_2_damage_13" value="moisture_warp_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture can warp wood or laminate flooring, causing buckling. Damaged flooring often requires replacement or refinishing after drying.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_14" name="interior_photo_2_damage_14" value="wet_insulation_effectiveness" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wet insulation loses effectiveness and promotes mold growth. Saturated insulation must be removed and replaced.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_15" name="interior_photo_2_damage_15" value="mold_growth_walls_professional" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold growth occurs from prolonged moisture exposure inside walls. Professional mold remediation is essential for health and safety.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_16" name="interior_photo_2_damage_16" value="water_swell_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water can swell or crack window frames, compromising fit. Frames may need repair, resealing, or replacement to restore weatherproofing.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_17" name="interior_photo_2_damage_17" value="interior_doors_swell" style="margin-right: 6px; margin-top: 2px;">
                        <span>Interior doors may swell or warp from water infiltration. Doors can sometimes be repaired or may require replacement.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_18" name="interior_photo_2_damage_18" value="wind_debris_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wind-driven debris can scatter inside rooms, causing physical damage. Cleanup and repair of damaged materials are necessary.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_19" name="interior_photo_2_damage_19" value="electrical_outlets_corrosion" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical outlets exposed to water risk corrosion and shorts. Electrical components should be inspected and replaced by a qualified technician.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_2_damage_20" name="interior_photo_2_damage_20" value="moisture_paint_bubble" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture causes paint or wallpaper to peel or bubble. Damaged finishes must be removed and surfaces properly dried before refinishing.</span>
                      </label>
                    </div>
                  </div>
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else if (section.prefix === 'interior_photo' && i === 3) {
              explanationField = `
                <div style="margin-top: 10px;">
                  <label class="form-label">Interior Damage Observations:</label>
                  <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 3000px !important; overflow-y: auto; background: #f9f9f9;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_1" name="interior_photo_3_damage_1" value="water_stains_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water Stains on Ceiling – Indicating roof or window leaks during the storm.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_2" name="interior_photo_3_damage_2" value="drywall_cracks" style="margin-right: 6px; margin-top: 2px;">
                        <span>Drywall Cracks – Resulting from structural shifting or water intrusion.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_3" name="interior_photo_3_damage_3" value="warped_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Warped Flooring – Moisture caused wood or laminate floors to buckle or swell.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_4" name="interior_photo_3_damage_4" value="soggy_insulation" style="margin-right: 6px; margin-top: 2px;">
                        <span>Soggy Insulation – Wet insulation losing effectiveness and promoting mold growth.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_5" name="interior_photo_3_damage_5" value="mold_growth_walls" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold Growth on Walls – Fungal growth from prolonged moisture exposure.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_6" name="interior_photo_3_damage_6" value="damaged_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Damaged Window Frames – Wind or water caused frames to swell or crack.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_7" name="interior_photo_3_damage_7" value="broken_interior_doors" style="margin-right: 6px; margin-top: 2px;">
                        <span>Broken Interior Doors – Doors swollen or damaged by water infiltration.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_8" name="interior_photo_3_damage_8" value="debris_inside_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Debris Inside Rooms – Wind-blown debris scattered inside the property.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_9" name="interior_photo_3_damage_9" value="electrical_outlet_damage" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical Outlet Damage – Water exposure leading to corrosion or shorts.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_10" name="interior_photo_3_damage_10" value="peeling_paint_wallpaper" style="margin-right: 6px; margin-top: 2px;">
                        <span>Peeling Paint or Wallpaper – Moisture causing finishes to bubble and peel.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_11" name="interior_photo_3_damage_11" value="water_intrusion_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water intrusion can cause ceiling stains, signaling roof or window leaks. Prompt roof repairs and sealing prevent further damage.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_12" name="interior_photo_3_damage_12" value="structural_shifts_drywall" style="margin-right: 6px; margin-top: 2px;">
                        <span>Storm-related structural shifts may cause drywall cracks. Cracks should be assessed and repaired to restore wall integrity.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_13" name="interior_photo_3_damage_13" value="moisture_warp_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture can warp wood or laminate flooring, causing buckling. Damaged flooring often requires replacement or refinishing after drying.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_14" name="interior_photo_3_damage_14" value="wet_insulation_effectiveness" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wet insulation loses effectiveness and promotes mold growth. Saturated insulation must be removed and replaced.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_15" name="interior_photo_3_damage_15" value="mold_growth_walls_professional" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold growth occurs from prolonged moisture exposure inside walls. Professional mold remediation is essential for health and safety.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_16" name="interior_photo_3_damage_16" value="water_swell_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water can swell or crack window frames, compromising fit. Frames may need repair, resealing, or replacement to restore weatherproofing.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_17" name="interior_photo_3_damage_17" value="interior_doors_swell" style="margin-right: 6px; margin-top: 2px;">
                        <span>Interior doors may swell or warp from water infiltration. Doors can sometimes be repaired or may require replacement.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_18" name="interior_photo_3_damage_18" value="wind_debris_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wind-driven debris can scatter inside rooms, causing physical damage. Cleanup and repair of damaged materials are necessary.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_19" name="interior_photo_3_damage_19" value="electrical_outlets_corrosion" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical outlets exposed to water risk corrosion and shorts. Electrical components should be inspected and replaced by a qualified technician.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_3_damage_20" name="interior_photo_3_damage_20" value="moisture_paint_bubble" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture causes paint or wallpaper to peel or bubble. Damaged finishes must be removed and surfaces properly dried before refinishing.</span>
                      </label>
                    </div>
                  </div>
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else if (section.prefix === 'interior_photo' && i === 4) {
              explanationField = `
                <div style="margin-top: 10px;">
                  <label class="form-label">Interior Damage Observations:</label>
                  <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 3000px !important; overflow-y: auto; background: #f9f9f9;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_1" name="interior_photo_4_damage_1" value="water_stains_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water Stains on Ceiling – Indicating roof or window leaks during the storm.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_2" name="interior_photo_4_damage_2" value="drywall_cracks" style="margin-right: 6px; margin-top: 2px;">
                        <span>Drywall Cracks – Resulting from structural shifting or water intrusion.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_3" name="interior_photo_4_damage_3" value="warped_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Warped Flooring – Moisture caused wood or laminate floors to buckle or swell.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_4" name="interior_photo_4_damage_4" value="soggy_insulation" style="margin-right: 6px; margin-top: 2px;">
                        <span>Soggy Insulation – Wet insulation losing effectiveness and promoting mold growth.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_5" name="interior_photo_4_damage_5" value="mold_growth_walls" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold Growth on Walls – Fungal growth from prolonged moisture exposure.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_6" name="interior_photo_4_damage_6" value="damaged_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Damaged Window Frames – Wind or water caused frames to swell or crack.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_7" name="interior_photo_4_damage_7" value="broken_interior_doors" style="margin-right: 6px; margin-top: 2px;">
                        <span>Broken Interior Doors – Doors swollen or damaged by water infiltration.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_8" name="interior_photo_4_damage_8" value="debris_inside_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Debris Inside Rooms – Wind-blown debris scattered inside the property.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_9" name="interior_photo_4_damage_9" value="electrical_outlet_damage" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical Outlet Damage – Water exposure leading to corrosion or shorts.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_10" name="interior_photo_4_damage_10" value="peeling_paint_wallpaper" style="margin-right: 6px; margin-top: 2px;">
                        <span>Peeling Paint or Wallpaper – Moisture causing finishes to bubble and peel.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_11" name="interior_photo_4_damage_11" value="water_intrusion_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water intrusion can cause ceiling stains, signaling roof or window leaks. Prompt roof repairs and sealing prevent further damage.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_12" name="interior_photo_4_damage_12" value="structural_shifts_drywall" style="margin-right: 6px; margin-top: 2px;">
                        <span>Storm-related structural shifts may cause drywall cracks. Cracks should be assessed and repaired to restore wall integrity.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_13" name="interior_photo_4_damage_13" value="moisture_warp_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture can warp wood or laminate flooring, causing buckling. Damaged flooring often requires replacement or refinishing after drying.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_14" name="interior_photo_4_damage_14" value="wet_insulation_effectiveness" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wet insulation loses effectiveness and promotes mold growth. Saturated insulation must be removed and replaced.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_15" name="interior_photo_4_damage_15" value="mold_growth_walls_professional" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold growth occurs from prolonged moisture exposure inside walls. Professional mold remediation is essential for health and safety.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_16" name="interior_photo_4_damage_16" value="water_swell_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water can swell or crack window frames, compromising fit. Frames may need repair, resealing, or replacement to restore weatherproofing.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_17" name="interior_photo_4_damage_17" value="interior_doors_swell" style="margin-right: 6px; margin-top: 2px;">
                        <span>Interior doors may swell or warp from water infiltration. Doors can sometimes be repaired or may require replacement.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_19" name="interior_photo_4_damage_19" value="electrical_outlets_corrosion" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical outlets exposed to water risk corrosion and shorts. Electrical components should be inspected and replaced by a qualified technician.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_4_damage_20" name="interior_photo_4_damage_20" value="moisture_paint_bubble" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture causes paint or wallpaper to peel or bubble. Damaged finishes must be removed and surfaces properly dried before refinishing.</span>
                      </label>
                    </div>
                  </div>
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else if (section.prefix === 'exterior_components_photo') {
              // Build exterior components dropdowns dynamically from config to keep code maintainable
              const exteriorConfig = {
                'Siding': [
                  'Hail impact damage – visible dents and cracks on vinyl siding panel.',
                  'Wind displacement – siding panel lifted and unseated from locking channel.',
                  'Cracked siding From wind-driven debris impact.',
                  'Chipping and granular loss on fiber cement board due to hail.',
                  'Warping at seam due to wind uplift and moisture infiltration.'
                ],
                'Gutters & Downspouts': [
                  'Hail dents visible along entire length of gutter run.',
                  'Detached downspout elbow from high wind activity.',
                  'Crushed gutter trough from hail impact, causing improper drainage.',
                  'Seam separation due to expansion from temperature/hail stress.',
                  'Hanger pulled loose from fascia during high wind event.'
                ],
                'Fascia & Soffits': [
                  'Wind-blown soffit panel missing – exposing attic ventilation system.',
                  'Dented aluminum fascia from direct hail strike.',
                  'Warped fascia board from water intrusion after wind damage.',
                  'Peeling paint and cracks consistent with wind-driven debris impact.',
                  'Loose soffit panel with visible fastener failure after storm.'
                ],
                'Fencing': [
                  'Broken fence pickets from wind-blown debris impact.',
                  'Entire fence section leaning due to post failure in high winds.',
                  'Splintering and hail bruising visible on wooden fence surface.',
                  'Detached vinyl fence panel from interlocking system due to wind.',
                  'Cracked post cap from direct hail impact.'
                ],
                'Decks & Porches': [
                  'Splintered handrail from wind-driven object strike.',
                  'Hail impact craters visible on composite deck boards.',
                  'Detached railing bracket from wind stress.',
                  'Staining and erosion on deck surface from hail-induced water pooling.',
                  'Loose stair tread due to shifting from wind uplift.'
                ],
                'Exterior Doors & Garage Doors': [
                  'Hail dents visible across lower door panel, consistent with storm impact pattern.',
                  'Garage door panel buckling inward from wind pressure and flexing.',
                  'Weather stripping torn from frame due to wind uplift.',
                  'Paint chipping and surface abrasions caused by hailstones.',
                  'Misalignment in door track from storm-related impact force.'
                ],
                'Stucco / EIFS': [
                  'Pockmarks and surface cratering from hail impact on stucco finish.',
                  'Hairline cracking and spalling in EIFS caused by wind-driven moisture infiltration.',
                  'Chipped stucco layer exposing base mesh after hail event.',
                  'Discoloration and delamination due to water penetration following wind damage.',
                  'Vertical stress crack near corner from structural movement during storm.'
                ],
                'Driveways / Walkways': [
                  'Impact cracking from fallen tree limb due to high winds.',
                  'Surface scarring and dents consistent with large hail impact.',
                  'Heaved concrete section caused by root system exposed in windstorm.',
                  'Broken paver edges from debris impact during storm.',
                  'Oil stains and debris spread from wind-blown contaminants.'
                ],
                'Chimneys': [
                  'Missing chimney cap due to wind displacement.',
                  'Cracked masonry crown with hail spatter marks.',
                  'Dislodged flashing around chimney base – evidence of wind uplift.',
                  'Brick face pitting and chipping from hail impact.',
                  'Siding separation on chimney chase caused by wind-driven force.'
                ],
                'Awnings / Canopies': [
                  'Torn fabric canopy with visible hail punctures.',
                  'Collapsed metal awning frame due to wind gust pressure.',
                  'Loose mounting bracket pulled from wall during storm event.',
                  'Dented aluminum paneling on awning from direct hail strikes.',
                  'Stretched or sagging fabric from water pooling after hailstorm.'
                ],
                'Exterior Lighting / Electrical Fixtures': [
                  'Cracked light cover from direct hail impact.',
                  'Fixture pulled away from mounting base by wind.',
                  'Wiring exposed due to fixture displacement during storm.',
                  'Dented housing with finish loss from hail.',
                  'Short-circuit burn marks after water infiltration from wind-blown rain.'
                ],
                'Landscaping Elements (Hardscape/Retaining Walls)': [
                  'Shifted retaining wall blocks due to ground saturation from wind driven rain.',
                  'Stone chip damage from hail impact on hardscape surface.',
                  'Fallen tree damaging hardscaped edge during windstorm.',
                  'Mulch or gravel displacement from sustained wind gusts.',
                  'Decorative elements dislodged by flying debris.'
                ],
                'Solar Panels / Satellite Dishes / Antennas': [
                  'Cracked solar panel surface from hail strike.',
                  'Panel frame bent from uplift in high wind event.',
                  'Dish misaligned due to storm-force wind.',
                  'Wiring exposed or detached at junction after storm.',
                  'Mounting brackets loosened from roofing system after impact.'
                ],
                'Skylights (excluding windows)': [
                  'Outer lens cracked from hailstone impact.',
                  'Sealant separation leading to water intrusion after wind-driven rain.',
                  'Metal curb flashing lifted from roof deck by wind gusts.',
                  'Interior water staining visible beneath skylight from storm damage.',
                  'Acrylic dome skylight dented or splintered from direct hail.'
                ]
              };

              let groupsHtml = '';
              const colors = ['#0d6efd','#28a745','#dc3545','#6f42c1','#17a2b8','#fd7e14','#20c997','#6610f2','#198754','#e83e8c','#6c757d','#0dcaf0','#ffc107','#343a40'];
              let idx = 0;
              for (const [group, items] of Object.entries(exteriorConfig)) {
                const color = colors[idx % colors.length];
                const safeGroupId = group.replace(/[^a-z0-9]+/gi,'_').toLowerCase();
                groupsHtml += `
                  <div style="margin-bottom: 15px;">
                    <details style="border: 1px solid ${color}; border-radius: 4px; background: #f8f9fa;">
                      <summary style="padding: 10px; background: ${color}; color: white; cursor: pointer; font-weight: bold; font-size: 14px;">
                        ${group}
                      </summary>
                      <div style="padding: 15px; max-height: 3000px !important; overflow-y: auto;">
                        ${items.map((txt, j) => `
                          <label style="display:flex; align-items:flex-start; font-size:12px; cursor:pointer; margin-bottom:5px;">
                            <input type="checkbox" id="${section.prefix}_${i}_${safeGroupId}_${j}" name="${section.prefix}_${i}_${safeGroupId}_${j}" value="${safeGroupId}_${j}" style="margin-right:6px; margin-top:2px;">
                            <span>${txt}</span>
                          </label>
                        `).join('')}
                      </div>
                    </details>
                  </div>
                `;
                idx++;
              }

              explanationField = `
                <div style="margin-top: 10px;">
                  <label class="form-label">Exterior Components Observations:</label>
                  <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 3000px !important; overflow-y: auto; background: #f9f9f9;">
                    ${groupsHtml}
                  </div>
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else if (section.prefix === 'interior_photo' && i === 5) {
              explanationField = `
                <div style="margin-top: 10px;">
                  <label class="form-label">Interior Damage Observations:</label>
                  <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 3000px !important; overflow-y: auto; background: #f9f9f9;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_1" name="interior_photo_5_damage_1" value="water_stains_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water Stains on Ceiling – Indicating roof or window leaks during the storm.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_2" name="interior_photo_5_damage_2" value="drywall_cracks" style="margin-right: 6px; margin-top: 2px;">
                        <span>Drywall Cracks – Resulting from structural shifting or water intrusion.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_3" name="interior_photo_5_damage_3" value="warped_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Warped Flooring – Moisture caused wood or laminate floors to buckle or swell.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_4" name="interior_photo_5_damage_4" value="soggy_insulation" style="margin-right: 6px; margin-top: 2px;">
                        <span>Soggy Insulation – Wet insulation losing effectiveness and promoting mold growth.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_5" name="interior_photo_5_damage_5" value="mold_growth_walls" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold Growth on Walls – Fungal growth from prolonged moisture exposure.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_6" name="interior_photo_5_damage_6" value="damaged_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Damaged Window Frames – Wind or water caused frames to swell or crack.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_7" name="interior_photo_5_damage_7" value="broken_interior_doors" style="margin-right: 6px; margin-top: 2px;">
                        <span>Broken Interior Doors – Doors swollen or damaged by water infiltration.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_8" name="interior_photo_5_damage_8" value="debris_inside_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Debris Inside Rooms – Wind-blown debris scattered inside the property.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_9" name="interior_photo_5_damage_9" value="electrical_outlet_damage" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical Outlet Damage – Water exposure leading to corrosion or shorts.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_10" name="interior_photo_5_damage_10" value="peeling_paint_wallpaper" style="margin-right: 6px; margin-top: 2px;">
                        <span>Peeling Paint or Wallpaper – Moisture causing finishes to bubble and peel.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_11" name="interior_photo_5_damage_11" value="water_intrusion_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water intrusion can cause ceiling stains, signaling roof or window leaks. Prompt roof repairs and sealing prevent further damage.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_12" name="interior_photo_5_damage_12" value="structural_shifts_drywall" style="margin-right: 6px; margin-top: 2px;">
                        <span>Storm-related structural shifts may cause drywall cracks. Cracks should be assessed and repaired to restore wall integrity.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_13" name="interior_photo_5_damage_13" value="moisture_warp_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture can warp wood or laminate flooring, causing buckling. Damaged flooring often requires replacement or refinishing after drying.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_14" name="interior_photo_5_damage_14" value="wet_insulation_effectiveness" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wet insulation loses effectiveness and promotes mold growth. Saturated insulation must be removed and replaced.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_15" name="interior_photo_5_damage_15" value="mold_growth_walls_professional" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold growth occurs from prolonged moisture exposure inside walls. Professional mold remediation is essential for health and safety.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_16" name="interior_photo_5_damage_16" value="water_swell_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water can swell or crack window frames, compromising fit. Frames may need repair, resealing, or replacement to restore weatherproofing.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_17" name="interior_photo_5_damage_17" value="interior_doors_swell" style="margin-right: 6px; margin-top: 2px;">
                        <span>Interior doors may swell or warp from water infiltration. Doors can sometimes be repaired or may require replacement.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_18" name="interior_photo_5_damage_18" value="wind_debris_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wind-driven debris can scatter inside rooms, causing physical damage. Cleanup and repair of damaged materials are necessary.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_19" name="interior_photo_5_damage_19" value="electrical_outlets_corrosion" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical outlets exposed to water risk corrosion and shorts. Electrical components should be inspected and replaced by a qualified technician.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_5_damage_20" name="interior_photo_5_damage_20" value="moisture_paint_bubble" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture causes paint or wallpaper to peel or bubble. Damaged finishes must be removed and surfaces properly dried before refinishing.</span>
                      </label>
                    </div>
                  </div>
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else if (section.prefix === 'interior_photo' && i === 6) {
              explanationField = `
                <div style="margin-top: 10px;">
                  <label class="form-label">Interior Damage Observations:</label>
                  <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 3000px !important; overflow-y: auto; background: #f9f9f9;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_1" name="interior_photo_6_damage_1" value="water_stains_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water Stains on Ceiling – Indicating roof or window leaks during the storm.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_2" name="interior_photo_6_damage_2" value="drywall_cracks" style="margin-right: 6px; margin-top: 2px;">
                        <span>Drywall Cracks – Resulting from structural shifting or water intrusion.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_3" name="interior_photo_6_damage_3" value="warped_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Warped Flooring – Moisture caused wood or laminate floors to buckle or swell.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_4" name="interior_photo_6_damage_4" value="soggy_insulation" style="margin-right: 6px; margin-top: 2px;">
                        <span>Soggy Insulation – Wet insulation losing effectiveness and promoting mold growth.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_5" name="interior_photo_6_damage_5" value="mold_growth_walls" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold Growth on Walls – Fungal growth from prolonged moisture exposure.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_6" name="interior_photo_6_damage_6" value="damaged_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Damaged Window Frames – Wind or water caused frames to swell or crack.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_7" name="interior_photo_6_damage_7" value="broken_interior_doors" style="margin-right: 6px; margin-top: 2px;">
                        <span>Broken Interior Doors – Doors swollen or damaged by water infiltration.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_8" name="interior_photo_6_damage_8" value="debris_inside_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Debris Inside Rooms – Wind-blown debris scattered inside the property.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_9" name="interior_photo_6_damage_9" value="electrical_outlet_damage" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical Outlet Damage – Water exposure leading to corrosion or shorts.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_10" name="interior_photo_6_damage_10" value="peeling_paint_wallpaper" style="margin-right: 6px; margin-top: 2px;">
                        <span>Peeling Paint or Wallpaper – Moisture causing finishes to bubble and peel.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_11" name="interior_photo_6_damage_11" value="water_intrusion_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water intrusion can cause ceiling stains, signaling roof or window leaks. Prompt roof repairs and sealing prevent further damage.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_12" name="interior_photo_6_damage_12" value="structural_shifts_drywall" style="margin-right: 6px; margin-top: 2px;">
                        <span>Storm-related structural shifts may cause drywall cracks. Cracks should be assessed and repaired to restore wall integrity.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_13" name="interior_photo_6_damage_13" value="moisture_warp_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture can warp wood or laminate flooring, causing buckling. Damaged flooring often requires replacement or refinishing after drying.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_14" name="interior_photo_6_damage_14" value="wet_insulation_effectiveness" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wet insulation loses effectiveness and promotes mold growth. Saturated insulation must be removed and replaced.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_15" name="interior_photo_6_damage_15" value="mold_growth_walls_professional" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold growth occurs from prolonged moisture exposure inside walls. Professional mold remediation is essential for health and safety.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_16" name="interior_photo_6_damage_16" value="water_swell_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water can swell or crack window frames, compromising fit. Frames may need repair, resealing, or replacement to restore weatherproofing.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_17" name="interior_photo_6_damage_17" value="interior_doors_swell" style="margin-right: 6px; margin-top: 2px;">
                        <span>Interior doors may swell or warp from water infiltration. Doors can sometimes be repaired or may require replacement.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_18" name="interior_photo_6_damage_18" value="wind_debris_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wind-driven debris can scatter inside rooms, causing physical damage. Cleanup and repair of damaged materials are necessary.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_19" name="interior_photo_6_damage_19" value="electrical_outlets_corrosion" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical outlets exposed to water risk corrosion and shorts. Electrical components should be inspected and replaced by a qualified technician.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_6_damage_20" name="interior_photo_6_damage_20" value="moisture_paint_bubble" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture causes paint or wallpaper to peel or bubble. Damaged finishes must be removed and surfaces properly dried before refinishing.</span>
                      </label>
                    </div>
                  </div>
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else if (section.prefix === 'interior_photo' && i === 7) {
              explanationField = `
                <div style="margin-top: 10px;">
                  <label class="form-label">Interior Damage Observations:</label>
                  <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 3000px !important; overflow-y: auto; background: #f9f9f9;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_1" name="interior_photo_7_damage_1" value="water_stains_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water Stains on Ceiling – Indicating roof or window leaks during the storm.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_2" name="interior_photo_7_damage_2" value="drywall_cracks" style="margin-right: 6px; margin-top: 2px;">
                        <span>Drywall Cracks – Resulting from structural shifting or water intrusion.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_3" name="interior_photo_7_damage_3" value="warped_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Warped Flooring – Moisture caused wood or laminate floors to buckle or swell.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_4" name="interior_photo_7_damage_4" value="soggy_insulation" style="margin-right: 6px; margin-top: 2px;">
                        <span>Soggy Insulation – Wet insulation losing effectiveness and promoting mold growth.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_5" name="interior_photo_7_damage_5" value="mold_growth_walls" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold Growth on Walls – Fungal growth from prolonged moisture exposure.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_6" name="interior_photo_7_damage_6" value="damaged_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Damaged Window Frames – Wind or water caused frames to swell or crack.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_7" name="interior_photo_7_damage_7" value="broken_interior_doors" style="margin-right: 6px; margin-top: 2px;">
                        <span>Broken Interior Doors – Doors swollen or damaged by water infiltration.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_8" name="interior_photo_7_damage_8" value="debris_inside_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Debris Inside Rooms – Wind-blown debris scattered inside the property.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_9" name="interior_photo_7_damage_9" value="electrical_outlet_damage" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical Outlet Damage – Water exposure leading to corrosion or shorts.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_10" name="interior_photo_7_damage_10" value="peeling_paint_wallpaper" style="margin-right: 6px; margin-top: 2px;">
                        <span>Peeling Paint or Wallpaper – Moisture causing finishes to bubble and peel.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_11" name="interior_photo_7_damage_11" value="water_intrusion_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water intrusion can cause ceiling stains, signaling roof or window leaks. Prompt roof repairs and sealing prevent further damage.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_12" name="interior_photo_7_damage_12" value="structural_shifts_drywall" style="margin-right: 6px; margin-top: 2px;">
                        <span>Storm-related structural shifts may cause drywall cracks. Cracks should be assessed and repaired to restore wall integrity.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_13" name="interior_photo_7_damage_13" value="moisture_warp_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture can warp wood or laminate flooring, causing buckling. Damaged flooring often requires replacement or refinishing after drying.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_14" name="interior_photo_7_damage_14" value="wet_insulation_effectiveness" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wet insulation loses effectiveness and promotes mold growth. Saturated insulation must be removed and replaced.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_15" name="interior_photo_7_damage_15" value="mold_growth_walls_professional" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold growth occurs from prolonged moisture exposure inside walls. Professional mold remediation is essential for health and safety.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_16" name="interior_photo_7_damage_16" value="water_swell_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water can swell or crack window frames, compromising fit. Frames may need repair, resealing, or replacement to restore weatherproofing.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_17" name="interior_photo_7_damage_17" value="interior_doors_swell" style="margin-right: 6px; margin-top: 2px;">
                        <span>Interior doors may swell or warp from water infiltration. Doors can sometimes be repaired or may require replacement.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_18" name="interior_photo_7_damage_18" value="wind_debris_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wind-driven debris can scatter inside rooms, causing physical damage. Cleanup and repair of damaged materials are necessary.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_19" name="interior_photo_7_damage_19" value="electrical_outlets_corrosion" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical outlets exposed to water risk corrosion and shorts. Electrical components should be inspected and replaced by a qualified technician.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_7_damage_20" name="interior_photo_7_damage_20" value="moisture_paint_bubble" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture causes paint or wallpaper to peel or bubble. Damaged finishes must be removed and surfaces properly dried before refinishing.</span>
                      </label>
                    </div>
                  </div>
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else if (section.prefix === 'interior_photo' && i === 8) {
      explanationField = `
        <div style="margin-top: 10px;">
                  <label class="form-label">Interior Damage Observations:</label>
                            <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 3000px !important; overflow-y: auto; background: #f9f9f9;">
            <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_1" name="interior_photo_8_damage_1" value="water_stains_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water Stains on Ceiling – Indicating roof or window leaks during the storm.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_2" name="interior_photo_8_damage_2" value="drywall_cracks" style="margin-right: 6px; margin-top: 2px;">
                        <span>Drywall Cracks – Resulting from structural shifting or water intrusion.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_3" name="interior_photo_8_damage_3" value="warped_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Warped Flooring – Moisture caused wood or laminate floors to buckle or swell.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_4" name="interior_photo_8_damage_4" value="soggy_insulation" style="margin-right: 6px; margin-top: 2px;">
                        <span>Soggy Insulation – Wet insulation losing effectiveness and promoting mold growth.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_5" name="interior_photo_8_damage_5" value="mold_growth_walls" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold Growth on Walls – Fungal growth from prolonged moisture exposure.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_6" name="interior_photo_8_damage_6" value="damaged_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Damaged Window Frames – Wind or water caused frames to swell or crack.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_7" name="interior_photo_8_damage_7" value="broken_interior_doors" style="margin-right: 6px; margin-top: 2px;">
                        <span>Broken Interior Doors – Doors swollen or damaged by water infiltration.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_8" name="interior_photo_8_damage_8" value="debris_inside_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Debris Inside Rooms – Wind-blown debris scattered inside the property.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_9" name="interior_photo_8_damage_9" value="electrical_outlet_damage" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical Outlet Damage – Water exposure leading to corrosion or shorts.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_10" name="interior_photo_8_damage_10" value="peeling_paint_wallpaper" style="margin-right: 6px; margin-top: 2px;">
                        <span>Peeling Paint or Wallpaper – Moisture causing finishes to bubble and peel.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_11" name="interior_photo_8_damage_11" value="water_intrusion_ceiling" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water intrusion can cause ceiling stains, signaling roof or window leaks. Prompt roof repairs and sealing prevent further damage.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_12" name="interior_photo_8_damage_12" value="structural_shifts_drywall" style="margin-right: 6px; margin-top: 2px;">
                        <span>Storm-related structural shifts may cause drywall cracks. Cracks should be assessed and repaired to restore wall integrity.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_13" name="interior_photo_8_damage_13" value="moisture_warp_flooring" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture can warp wood or laminate flooring, causing buckling. Damaged flooring often requires replacement or refinishing after drying.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_14" name="interior_photo_8_damage_14" value="wet_insulation_effectiveness" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wet insulation loses effectiveness and promotes mold growth. Saturated insulation must be removed and replaced.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_15" name="interior_photo_8_damage_15" value="mold_growth_walls_professional" style="margin-right: 6px; margin-top: 2px;">
                        <span>Mold growth occurs from prolonged moisture exposure inside walls. Professional mold remediation is essential for health and safety.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_16" name="interior_photo_8_damage_16" value="water_swell_window_frames" style="margin-right: 6px; margin-top: 2px;">
                        <span>Water can swell or crack window frames, compromising fit. Frames may need repair, resealing, or replacement to restore weatherproofing.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_17" name="interior_photo_8_damage_17" value="interior_doors_swell" style="margin-right: 6px; margin-top: 2px;">
                        <span>Interior doors may swell or warp from water infiltration. Doors can sometimes be repaired or may require replacement.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_18" name="interior_photo_8_damage_18" value="wind_debris_rooms" style="margin-right: 6px; margin-top: 2px;">
                        <span>Wind-driven debris can scatter inside rooms, causing physical damage. Cleanup and repair of damaged materials are necessary.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_19" name="interior_photo_8_damage_19" value="electrical_outlets_corrosion" style="margin-right: 6px; margin-top: 2px;">
                        <span>Electrical outlets exposed to water risk corrosion and shorts. Electrical components should be inspected and replaced by a qualified technician.</span>
                      </label>
                      <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_8_damage_20" name="interior_photo_8_damage_20" value="moisture_paint_bubble" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture causes paint or wallpaper to peel or bubble. Damaged finishes must be removed and surfaces properly dried before refinishing.</span>
                      </label>
                    </div>
                  </div>
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else if (section.prefix === 'interior_photo' && i === 9) {
      explanationField = `
        <div style="margin-top: 10px;">
          <label class="form-label">Interior Damage Observations:</label>
                            <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 3000px !important; overflow-y: auto; background: #f9f9f9;">
            <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_1" name="interior_photo_9_damage_1" value="water_stains_ceiling" style="margin-right: 6px; margin-top: 2px;">
                <span>Water Stains on Ceiling – Indicating roof or window leaks during the storm.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_2" name="interior_photo_9_damage_2" value="drywall_cracks" style="margin-right: 6px; margin-top: 2px;">
                <span>Drywall Cracks – Resulting from structural shifting or water intrusion.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_3" name="interior_photo_9_damage_3" value="warped_flooring" style="margin-right: 6px; margin-top: 2px;">
                <span>Warped Flooring – Moisture caused wood or laminate floors to buckle or swell.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_4" name="interior_photo_9_damage_4" value="soggy_insulation" style="margin-right: 6px; margin-top: 2px;">
                <span>Soggy Insulation – Wet insulation losing effectiveness and promoting mold growth.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_5" name="interior_photo_9_damage_5" value="mold_growth_walls" style="margin-right: 6px; margin-top: 2px;">
                <span>Mold Growth on Walls – Fungal growth from prolonged moisture exposure.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_6" name="interior_photo_9_damage_6" value="damaged_window_frames" style="margin-right: 6px; margin-top: 2px;">
                <span>Damaged Window Frames – Wind or water caused frames to swell or crack.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_7" name="interior_photo_9_damage_7" value="broken_interior_doors" style="margin-right: 6px; margin-top: 2px;">
                <span>Broken Interior Doors – Doors swollen or damaged by water infiltration.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_8" name="interior_photo_9_damage_8" value="debris_inside_rooms" style="margin-right: 6px; margin-top: 2px;">
                <span>Debris Inside Rooms – Wind-blown debris scattered inside the property.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_9" name="interior_photo_9_damage_9" value="electrical_outlet_damage" style="margin-right: 6px; margin-top: 2px;">
                <span>Electrical Outlet Damage – Water exposure leading to corrosion or shorts.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_10" name="interior_photo_9_damage_10" value="peeling_paint_wallpaper" style="margin-right: 6px; margin-top: 2px;">
                <span>Peeling Paint or Wallpaper – Moisture causing finishes to bubble and peel.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_11" name="interior_photo_9_damage_11" value="water_intrusion_ceiling" style="margin-right: 6px; margin-top: 2px;">
                <span>Water intrusion can cause ceiling stains, signaling roof or window leaks. Prompt roof repairs and sealing prevent further damage.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_12" name="interior_photo_9_damage_12" value="structural_shifts_drywall" style="margin-right: 6px; margin-top: 2px;">
                <span>Storm-related structural shifts may cause drywall cracks. Cracks should be assessed and repaired to restore wall integrity.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_13" name="interior_photo_9_damage_13" value="moisture_warp_flooring" style="margin-right: 6px; margin-top: 2px;">
                <span>Moisture can warp wood or laminate flooring, causing buckling. Damaged flooring often requires replacement or refinishing after drying.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_14" name="interior_photo_9_damage_14" value="wet_insulation_effectiveness" style="margin-right: 6px; margin-top: 2px;">
                <span>Wet insulation loses effectiveness and promotes mold growth. Saturated insulation must be removed and replaced.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_15" name="interior_photo_9_damage_15" value="mold_growth_walls_professional" style="margin-right: 6px; margin-top: 2px;">
                <span>Mold growth occurs from prolonged moisture exposure inside walls. Professional mold remediation is essential for health and safety.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_16" name="interior_photo_9_damage_16" value="water_swell_window_frames" style="margin-right: 6px; margin-top: 2px;">
                <span>Water can swell or crack window frames, compromising fit. Frames may need repair, resealing, or replacement to restore weatherproofing.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_17" name="interior_photo_9_damage_17" value="interior_doors_swell" style="margin-right: 6px; margin-top: 2px;">
                <span>Interior doors may swell or warp from water infiltration. Doors can sometimes be repaired or may require replacement.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_18" name="interior_photo_9_damage_18" value="wind_debris_rooms" style="margin-right: 6px; margin-top: 2px;">
                <span>Wind-driven debris can scatter inside rooms, causing physical damage. Cleanup and repair of damaged materials are necessary.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_19" name="interior_photo_9_damage_19" value="electrical_outlets_corrosion" style="margin-right: 6px; margin-top: 2px;">
                <span>Electrical outlets exposed to water risk corrosion and shorts. Electrical components should be inspected and replaced by a qualified technician.</span>
              </label>
              <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                        <input type="checkbox" id="interior_photo_9_damage_20" name="interior_photo_9_damage_20" value="moisture_paint_bubble" style="margin-right: 6px; margin-top: 2px;">
                        <span>Moisture causes paint or wallpaper to peel or bubble. Damaged finishes must be removed and surfaces properly dried before refinishing.</span>
                      </label>
                    </div>
                  </div>
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else if (section.prefix === 'roof_damage_photo' && (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9)) {
      explanationField = `
        <div style="margin-top: 10px;">
                  <label class="form-label">Roof Damage Observations:</label>
                  
                  <!-- ASHPHALT SHINGLE DROPDOWN -->
                  <div style="margin-bottom: 15px;">
                    <details style="border: 1px solid #007bff; border-radius: 4px; background: #f8f9fa;">
                      <summary style="padding: 10px; background: #007bff; color: white; cursor: pointer; font-weight: bold; font-size: 14px;">
                        🏠 ASPHALT SHINGLE DAMAGE
                      </summary>
                      <div style="padding: 15px; max-height: 3000px !important; overflow-y: auto;">
                        
                        <!-- Hail Damage -->
                        <div style="margin-bottom: 15px;">
                          <h5 style="margin: 0 0 10px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 3px;">🌨️ Hail Damage</h5>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_0" name="roof_damage_photo_${i}_asphalt_hail_0" value="hail_impact_mark" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail Impact Mark – Circular dark spot with granule loss from direct hail strike.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_1" name="roof_damage_photo_${i}_asphalt_hail_1" value="granule_loss" style="margin-right: 6px; margin-top: 2px;">
                            <span>Granule Loss – Exposed asphalt indicates protective granules have been knocked off.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_2" name="roof_damage_photo_${i}_asphalt_hail_2" value="cracked_shingle" style="margin-right: 6px; margin-top: 2px;">
                            <span>Cracked Shingle – Fracture lines caused by high-impact hailstones.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_3" name="roof_damage_photo_${i}_asphalt_hail_3" value="soft_spot_bruising" style="margin-right: 6px; margin-top: 2px;">
                            <span>Soft Spot Bruising – Subsurface damage felt as a soft area, often not visibly obvious.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_4" name="roof_damage_photo_${i}_asphalt_hail_4" value="displaced_granules" style="margin-right: 6px; margin-top: 2px;">
                            <span>Displaced Granules – Accumulated granules in gutters or at shingle edges.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_5" name="roof_damage_photo_${i}_asphalt_hail_5" value="shingle_pitting" style="margin-right: 6px; margin-top: 2px;">
                            <span>Shingle Pitting – Small divots or pits where hail impacted the surface.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_6" name="roof_damage_photo_${i}_asphalt_hail_6" value="shingle_mat_exposure" style="margin-right: 6px; margin-top: 2px;">
                            <span>Shingle Mat Exposure – Fibrous mat visible due to loss of granule and asphalt layers.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_7" name="roof_damage_photo_${i}_asphalt_hail_7" value="edge_fracture" style="margin-right: 6px; margin-top: 2px;">
                            <span>Edge Fracture – Hail hit near shingle edge, causing cracks or breakage.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_8" name="roof_damage_photo_${i}_asphalt_hail_8" value="random_damage_pattern" style="margin-right: 6px; margin-top: 2px;">
                            <span>Random Damage Pattern – Impacts scattered randomly, consistent with hail rather than wear.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_9" name="roof_damage_photo_${i}_asphalt_hail_9" value="neighboring_structure_signs" style="margin-right: 6px; margin-top: 2px;">
                            <span>Neighboring Structure Signs – Dented vents or gutters support evidence of hail event.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_10" name="roof_damage_photo_${i}_asphalt_hail_10" value="hail_dislodge_granules" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail can dislodge protective granules, exposing the asphalt layer underneath and accelerating roof aging.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_11" name="roof_damage_photo_${i}_asphalt_hail_11" value="granule_loss_uv_protection" style="margin-right: 6px; margin-top: 2px;">
                            <span>Granule loss from hail impact weakens the shingle's UV protection and can lead to premature deterioration.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_12" name="roof_damage_photo_${i}_asphalt_hail_12" value="circular_impact_marks" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail strikes often leave circular impact marks, which may appear darker due to exposed asphalt.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_13" name="roof_damage_photo_${i}_asphalt_hail_13" value="repeated_hail_bruising" style="margin-right: 6px; margin-top: 2px;">
                            <span>Repeated hail hits can bruise the shingle, causing soft spots that may not be visible but compromise integrity.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_14" name="roof_damage_photo_${i}_asphalt_hail_14" value="cracks_older_materials" style="margin-right: 6px; margin-top: 2px;">
                            <span>Cracks may form in shingles from hailstones, especially in older or brittle roofing materials.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_15" name="roof_damage_photo_${i}_asphalt_hail_15" value="random_pattern_distinction" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail damage is typically random in pattern, distinguishing it from wear-and-tear or manufacturing defects.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_16" name="roof_damage_photo_${i}_asphalt_hail_16" value="severe_impacts_mat_exposure" style="margin-right: 6px; margin-top: 2px;">
                            <span>Severe impacts can expose the fiberglass mat, reducing the waterproofing capability of the shingle.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_17" name="roof_damage_photo_${i}_asphalt_hail_17" value="edge_vulnerability_cracking" style="margin-right: 6px; margin-top: 2px;">
                            <span>Edges of shingles are vulnerable to cracking from hail, especially if the hailstone strikes near the edge.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_18" name="roof_damage_photo_${i}_asphalt_hail_18" value="granule_loss_aging" style="margin-right: 6px; margin-top: 2px;">
                            <span>Loss of granules can lead to accelerated roof aging, even if leaks aren't immediately present.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_19" name="roof_damage_photo_${i}_asphalt_hail_19" value="hail_weaken_roof_system" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail-damaged shingles can weaken the overall roof system, increasing the risk of future water intrusion.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_20" name="roof_damage_photo_${i}_asphalt_hail_20" value="hail_reduce_lifespan" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail impacts can reduce shingle lifespan, even if the damage isn't immediately visible.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_21" name="roof_damage_photo_${i}_asphalt_hail_21" value="dents_water_shedding" style="margin-right: 6px; margin-top: 2px;">
                            <span>Dents from hail may compromise water shedding, leading to pooling and eventual leaks.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_22" name="roof_damage_photo_${i}_asphalt_hail_22" value="cumulative_hail_weakness" style="margin-right: 6px; margin-top: 2px;">
                            <span>Cumulative hail damage weakens shingles structurally, making them more susceptible to wind uplift.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_24" name="roof_damage_photo_${i}_asphalt_hail_24" value="hail_break_bond_layers" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail strikes can break the bond between shingle layers, reducing resistance to wind and water.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_25" name="roof_damage_photo_${i}_asphalt_hail_25" value="displaced_granules_clog_gutters" style="margin-right: 6px; margin-top: 2px;">
                            <span>Displaced granules can clog gutters, affecting drainage and increasing roof edge wear.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_26" name="roof_damage_photo_${i}_asphalt_hail_26" value="hail_damage_shiny_bare" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail-damaged areas often appear shiny or bare, due to missing granules and exposed asphalt.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_27" name="roof_damage_photo_${i}_asphalt_hail_27" value="hail_damage_sealant_strips" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail can damage sealant strips, preventing shingles from adhering properly to one another.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_28" name="roof_damage_photo_${i}_asphalt_hail_28" value="bruised_shingles_weakened_mat" style="margin-right: 6px; margin-top: 2px;">
                            <span>Bruised shingles may not leak right away, but the underlying mat is often weakened.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_hail_29" name="roof_damage_photo_${i}_asphalt_hail_29" value="insurance_adjuster_patterns" style="margin-right: 6px; margin-top: 2px;">
                            <span>Insurance adjusters look for specific hail patterns, including impact shape and distribution.</span>
                          </label>
                        </div>
                        
                        <!-- Wind Damage -->
                        <div style="margin-bottom: 15px;">
                          <h5 style="margin: 0 0 10px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 3px;">🌪️ Wind Damage</h5>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_wind_1" name="roof_damage_photo_${i}_asphalt_wind_1" value="wind_remove_shingles" style="margin-right: 6px; margin-top: 2px;">
                            <span>Wind can fully remove shingles, leaving bare spots that expose the roof deck or underlayment.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_wind_2" name="roof_damage_photo_${i}_asphalt_wind_2" value="displaced_misaligned_shingles" style="margin-right: 6px; margin-top: 2px;">
                            <span>Shingles may be displaced or misaligned, showing signs of shifting from strong lateral wind forces.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_wind_3" name="roof_damage_photo_${i}_asphalt_wind_3" value="lifted_shingles_water_intrusion" style="margin-right: 6px; margin-top: 2px;">
                            <span>Lifted shingles are vulnerable to water intrusion, especially when the adhesive bond has been compromised.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_wind_14" name="roof_damage_photo_${i}_asphalt_wind_14" value="nail_pull_through_stress" style="margin-right: 6px; margin-top: 2px;">
                            <span>Nail pull-through is common in wind damage, where shingles tear around fasteners under stress.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_wind_15" name="roof_damage_photo_${i}_asphalt_wind_15" value="corners_edges_failure_points" style="margin-right: 6px; margin-top: 2px;">
                            <span>Corners and edges are frequent failure points, as wind pressure is highest in these areas.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_wind_16" name="roof_damage_photo_${i}_asphalt_wind_16" value="flying_debris_flashing_vents" style="margin-right: 6px; margin-top: 2px;">
                            <span>Flying debris often damages flashing or vents, compromising more than just the shingles.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_wind_17" name="roof_damage_photo_${i}_asphalt_wind_17" value="loose_flapping_seal_failure" style="margin-right: 6px; margin-top: 2px;">
                            <span>Loose or flapping shingles indicate seal failure, and are likely to tear off in future wind events.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_asphalt_wind_18" name="roof_damage_photo_${i}_asphalt_wind_18" value="wind_damage_tearing_cracking" style="margin-right: 6px; margin-top: 2px;">
                            <span>Wind-damaged shingles often show tearing or cracking, particularly near the fastening points.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="sealant_bond_broken" style="margin-right: 6px; margin-top: 2px;">
                            <span>Once the sealant bond is broken, shingles no longer perform as a continuous water-shedding system.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="debris_impacts_dent_gouge" style="margin-right: 6px; margin-top: 2px;">
                            <span>Debris impacts can dent or gouge shingles, especially when driven by high winds.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="branches_scrape_granules" style="margin-right: 6px; margin-top: 2px;">
                            <span>Branches or objects may scrape granules off, reducing the shingle's protective layer.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="sharp_debris_puncture" style="margin-right: 6px; margin-top: 2px;">
                            <span>Sharp debris can puncture shingles, allowing water to enter beneath the roofing system.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="heavy_debris_crack_break" style="margin-right: 6px; margin-top: 2px;">
                            <span>Heavy debris may crack or break shingles, especially on older or brittle roofs.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="wind_debris_dislodge" style="margin-right: 6px; margin-top: 2px;">
                            <span>Wind-driven debris can dislodge shingles, particularly when combined with uplift pressure.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="granule_loss_debris_abrasion" style="margin-right: 6px; margin-top: 2px;">
                            <span>Granule loss from debris abrasion weakens UV protection and shortens shingle lifespan.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="accumulated_debris_moisture" style="margin-right: 6px; margin-top: 2px;">
                            <span>Accumulated debris can trap moisture, promoting mold, rot, or accelerated material decay.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="falling_limbs_multiple_damage" style="margin-right: 6px; margin-top: 2px;">
                            <span>Falling limbs may damage multiple shingles at once, creating large vulnerable areas.</span>
                          </label>
                        </div>
                      </div>
                    </details>
                  </div>
                  
                  <!-- METAL DROPDOWN -->
                  <div style="margin-bottom: 15px;">
                    <details style="border: 1px solid #28a745; border-radius: 4px; background: #f8f9fa;">
                      <summary style="padding: 10px; background: #28a745; color: white; cursor: pointer; font-weight: bold; font-size: 14px;">
                        🔧 METAL ROOF DAMAGE
                      </summary>
                      <div style="padding: 15px; max-height: 3000px !important; overflow-y: auto;">
                        
                        <!-- Hail Damage -->
                        <div style="margin-bottom: 15px;">
                          <h5 style="margin: 0 0 10px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 3px;">🌨️ Hail Damage</h5>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_metal_hail_1" name="roof_damage_photo_${i}_metal_hail_1" value="dented_panels" style="margin-right: 6px; margin-top: 2px;">
                            <span>Dented Panels – Visible indentations caused by hail impact.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_metal_hail_2" name="roof_damage_photo_${i}_metal_hail_2" value="paint_chipping" style="margin-right: 6px; margin-top: 2px;">
                            <span>Paint Chipping – Hail has chipped away protective paint coating.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_metal_hail_3" name="roof_damage_photo_${i}_metal_hail_3" value="surface_scratches" style="margin-right: 6px; margin-top: 2px;">
                            <span>Surface Scratches – Fine scratches from hailstone abrasion on metal surface.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_metal_hail_4" name="roof_damage_photo_${i}_metal_hail_4" value="coating_cracks" style="margin-right: 6px; margin-top: 2px;">
                            <span>Coating Cracks – Cracks in paint or protective coating caused by hail strikes.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="exposed_bare_metal" style="margin-right: 6px; margin-top: 2px;">
                            <span>Exposed Bare Metal – Protective layer worn off, leaving metal susceptible to rust.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="rust_spots_starting" style="margin-right: 6px; margin-top: 2px;">
                            <span>Rust Spots Starting – Early rust formation at hail-damaged areas.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="loose_fasteners" style="margin-right: 6px; margin-top: 2px;">
                            <span>Loose Fasteners – Hail impact may loosen screws or clips holding panels.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="bent_seams" style="margin-right: 6px; margin-top: 2px;">
                            <span>Bent Seams – Roof seams bent or distorted from hail force.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="dented_flashing" style="margin-right: 6px; margin-top: 2px;">
                            <span>Dented Flashing – Metal flashing around edges or penetrations dented by hail.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="displaced_panels" style="margin-right: 6px; margin-top: 2px;">
                            <span>Displaced Panels – Panels slightly shifted or lifted due to hail impacts.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="hail_dents_structural_integrity" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail impacts create dents in metal roofing panels, weakening structural integrity.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="repeated_hail_chip_crack" style="margin-right: 6px; margin-top: 2px;">
                            <span>Repeated hail strikes can chip or crack protective paint or coatings.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="loss_damage_coating" style="margin-right: 6px; margin-top: 2px;">
                            <span>Loss or damage of the coating exposes bare metal to the elements.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="exposed_metal_rust_corrosion" style="margin-right: 6px; margin-top: 2px;">
                            <span>Exposed metal surfaces are prone to rust and corrosion over time.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="scratches_abrasions_water_shedding" style="margin-right: 6px; margin-top: 2px;">
                            <span>Scratches and abrasions from hail reduce the roof's ability to shed water.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="dents_deformations_stress_points" style="margin-right: 6px; margin-top: 2px;">
                            <span>Dents and deformations can cause stress points, increasing risk of leaks.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="hail_loosen_fasteners" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail damage may loosen fasteners, leading to panel movement or detachment.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="damaged_seams_joints" style="margin-right: 6px; margin-top: 2px;">
                            <span>Damaged seams and joints compromise the roof's waterproof seal.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="flashing_trim_vulnerable" style="margin-right: 6px; margin-top: 2px;">
                            <span>Flashing and trim pieces are vulnerable to dents and deformation from hail.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="unrepaired_hail_accelerate_deterioration" style="margin-right: 6px; margin-top: 2px;">
                            <span>Unrepaired hail damage accelerates deterioration and can reduce roof lifespan.</span>
                          </label>
                        </div>
                        
                        <!-- Wind Damage -->
                        <div style="margin-bottom: 15px;">
                          <h5 style="margin: 0 0 10px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 3px;">🌪️ Wind Damage</h5>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_metal_wind_1" name="roof_damage_photo_${i}_metal_wind_1" value="lifted_metal_panel" style="margin-right: 6px; margin-top: 2px;">
                            <span>Lifted Metal Panel – Wind has lifted and bent a roof panel.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_metal_wind_2" name="roof_damage_photo_${i}_metal_wind_2" value="loose_missing_fasteners" style="margin-right: 6px; margin-top: 2px;">
                            <span>Loose or Missing Fasteners – Screws or clips loosened or blown off by wind.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="bent_warped_panels" style="margin-right: 6px; margin-top: 2px;">
                            <span>Bent or Warped Panels – Panels distorted from strong wind forces.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="damaged_seams" style="margin-right: 6px; margin-top: 2px;">
                            <span>Damaged Seams – Seams pulled apart or separated by wind pressure.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="torn_peeling_paint" style="margin-right: 6px; margin-top: 2px;">
                            <span>Torn or Peeling Paint – Wind has caused paint to chip or peel from the surface.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="detached_flashing" style="margin-right: 6px; margin-top: 2px;">
                            <span>Detached Flashing – Edge flashing loosened or missing due to wind.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="displaced_ridge_cap" style="margin-right: 6px; margin-top: 2px;">
                            <span>Displaced Ridge Cap – Ridge cap shifted or lifted by wind.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="panel_overlap_separation" style="margin-right: 6px; margin-top: 2px;">
                            <span>Panel Overlap Separation – Wind caused panel overlaps to separate.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="dented_panels_debris" style="margin-right: 6px; margin-top: 2px;">
                            <span>Dented Panels from Debris – Wind-driven debris caused dents or punctures.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="cracked_broken_trim" style="margin-right: 6px; margin-top: 2px;">
                            <span>Cracked or Broken Trim – Trim pieces cracked or broken from wind stress.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="strong_winds_lift_bend" style="margin-right: 6px; margin-top: 2px;">
                            <span>Strong winds can lift and bend metal roof panels, compromising roof integrity.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="fasteners_loosen_pulled" style="margin-right: 6px; margin-top: 2px;">
                            <span>Fasteners such as screws or clips may loosen or be pulled out by wind.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="panels_bent_warped" style="margin-right: 6px; margin-top: 2px;">
                            <span>Panels can become bent or warped from sustained wind pressure.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="seams_separate_water_intrusion" style="margin-right: 6px; margin-top: 2px;">
                            <span>Seams between panels may separate, allowing water intrusion.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="wind_peel_chip_coatings" style="margin-right: 6px; margin-top: 2px;">
                            <span>Wind can cause paint or protective coatings to peel or chip.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="flashing_edge_detached" style="margin-right: 6px; margin-top: 2px;">
                            <span>Flashing and edge components may become detached or damaged.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="ridge_caps_shift_lift" style="margin-right: 6px; margin-top: 2px;">
                            <span>Ridge caps can shift or lift due to wind uplift forces.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="panel_overlaps_separate" style="margin-right: 6px; margin-top: 2px;">
                            <span>Panel overlaps may separate, weakening the waterproof seal.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="wind_debris_dent_puncture" style="margin-right: 6px; margin-top: 2px;">
                            <span>Wind-driven debris can dent or puncture metal panels.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="trim_accessory_crack_break" style="margin-right: 6px; margin-top: 2px;">
                            <span>Trim and accessory pieces may crack or break under wind stress.</span>
                          </label>
                        </div>
                      </div>
                    </details>
                  </div>
                  
                  <!-- TILE DROPDOWN -->
                  <div style="margin-bottom: 15px;">
                    <details style="border: 1px solid #dc3545; border-radius: 4px; background: #f8f9fa;">
                      <summary style="padding: 10px; background: #dc3545; color: white; cursor: pointer; font-weight: bold; font-size: 14px;">
                        🏺 TILE ROOF DAMAGE
                      </summary>
                      <div style="padding: 15px; max-height: 3000px !important; overflow-y: auto;">
                        
                        <!-- Hail Damage -->
                        <div style="margin-bottom: 15px;">
                          <h5 style="margin: 0 0 10px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 3px;">🌨️ Hail Damage</h5>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_tile_hail_1" name="roof_damage_photo_${i}_tile_hail_1" value="cracked_tile_surface" style="margin-right: 6px; margin-top: 2px;">
                            <span>Cracked Tile Surface – Impact from hailstone has fractured the tile.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_tile_hail_2" name="roof_damage_photo_${i}_tile_hail_2" value="edge_chip" style="margin-right: 6px; margin-top: 2px;">
                            <span>Edge Chip – Small corner or edge of tile chipped by hail.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_tile_hail_3" name="roof_damage_photo_${i}_tile_hail_3" value="broken_tile" style="margin-right: 6px; margin-top: 2px;">
                            <span>Broken Tile – Hail impact has fully broken or split the tile.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_tile_hail_4" name="roof_damage_photo_${i}_tile_hail_4" value="spalled_surface" style="margin-right: 6px; margin-top: 2px;">
                            <span>Spalled Surface – Outer layer of tile flaked off due to hail strike.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_tile_hail_5" name="roof_damage_photo_${i}_tile_hail_5" value="granule_loss_tile" style="margin-right: 6px; margin-top: 2px;">
                            <span>Granule Loss – Surface finish worn off from hail, exposing raw material.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_tile_wind_3" name="roof_damage_photo_${i}_tile_wind_3" value="dislodged_tile" style="margin-right: 6px; margin-top: 2px;">
                            <span>Dislodged Tile – Hail impact loosened the tile from its fasteners.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="multiple_impact_marks" style="margin-right: 6px; margin-top: 2px;">
                            <span>Multiple Impact Marks – Grouped chips or cracks indicating hailstorm pattern.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="tile_fragmentation" style="margin-right: 6px; margin-top: 2px;">
                            <span>Tile Fragmentation – Hail shattered tile into smaller pieces.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="underlayment_exposed" style="margin-right: 6px; margin-top: 2px;">
                            <span>Underlayment Exposed – Broken tile reveals moisture barrier below.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="hairline_cracks" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hairline Cracks – Thin, barely visible cracks formed from hail stress.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="hail_crack_tile_surface" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail can crack the surface of roof tiles, weakening their structural integrity.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="edges_corners_chip" style="margin-right: 6px; margin-top: 2px;">
                            <span>Edges and corners of tiles may chip, especially where hailstones strike with force.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="severe_impacts_break_tiles" style="margin-right: 6px; margin-top: 2px;">
                            <span>Severe impacts can break tiles completely, exposing the underlayment beneath.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="surface_spalling" style="margin-right: 6px; margin-top: 2px;">
                            <span>Surface spalling may occur, where the top layer of the tile flakes off due to repeated hail impacts.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="granular_textured_wear" style="margin-right: 6px; margin-top: 2px;">
                            <span>Granular or textured finishes may wear away, reducing weather protection and tile lifespan.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="tiles_dislodged_fasteners" style="margin-right: 6px; margin-top: 2px;">
                            <span>Tiles can become dislodged from their fasteners, especially after multiple impacts.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="grouped_cracks_hail_event" style="margin-right: 6px; margin-top: 2px;">
                            <span>Grouped cracks or chips often indicate a widespread hail event, not isolated damage.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="hail_shatter_tiles" style="margin-right: 6px; margin-top: 2px;">
                            <span>In some cases, hail can cause tiles to shatter, leading to scattered fragments on the roof.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="broken_missing_expose_underlayment" style="margin-right: 6px; margin-top: 2px;">
                            <span>Broken or missing tiles expose the underlayment, increasing the risk of water infiltration.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="hairline_cracks_expand" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hairline cracks may form without full breakage, and can expand over time with weather exposure.</span>
                          </label>
                        </div>
                        
                        <!-- Wind Damage -->
                        <div style="margin-bottom: 15px;">
                          <h5 style="margin: 0 0 10px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 3px;">🌪️ Wind Damage</h5>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_tile_wind_1" name="roof_damage_photo_${i}_tile_wind_1" value="missing_tile" style="margin-right: 6px; margin-top: 2px;">
                            <span>Missing Tile – Tile completely blown off by strong wind.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_tile_wind_2" name="roof_damage_photo_${i}_tile_wind_2" value="lifted_tile" style="margin-right: 6px; margin-top: 2px;">
                            <span>Lifted Tile – Wind has raised tile from its original position.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="dislodged_tile_wind" style="margin-right: 6px; margin-top: 2px;">
                            <span>Dislodged Tile – Tile shifted or loosened from fasteners.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="cracked_tile_uplift" style="margin-right: 6px; margin-top: 2px;">
                            <span>Cracked Tile from Uplift – Wind uplift stress caused tile to crack.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="edge_tile_damage" style="margin-right: 6px; margin-top: 2px;">
                            <span>Edge Tile Damage – Perimeter tiles damaged due to concentrated wind force.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="broken_fastener_area" style="margin-right: 6px; margin-top: 2px;">
                            <span>Broken Fastener Area – Tile attachment point failed under wind pressure.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="sliding_tile" style="margin-right: 6px; margin-top: 2px;">
                            <span>Sliding Tile – Tile slid out of place from wind-driven movement.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="roof_ridge_damage" style="margin-right: 6px; margin-top: 2px;">
                            <span>Roof Ridge Damage – Ridge or hip tiles displaced by high wind.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="tile_debris_ground" style="margin-right: 6px; margin-top: 2px;">
                            <span>Tile Debris on Ground – Broken tiles found on ground after wind event.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="gap_tile_field" style="margin-right: 6px; margin-top: 2px;">
                            <span>Gap in Tile Field – Visible space left by displaced or lost tiles.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="strong_winds_lift_dislodge" style="margin-right: 6px; margin-top: 2px;">
                            <span>Strong winds can lift and dislodge tiles, breaking their attachment and compromising the roof system.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="entire_tiles_blown_off" style="margin-right: 6px; margin-top: 2px;">
                            <span>Entire tiles may be blown off, especially along edges, ridges, or poorly fastened areas.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="uplift_pressure_crack_tiles" style="margin-right: 6px; margin-top: 2px;">
                            <span>Uplift pressure from wind can crack tiles, even if they remain in place.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="tiles_shift_slide_gaps" style="margin-right: 6px; margin-top: 2px;">
                            <span>Tiles may shift or slide, creating gaps that expose underlayment or leave tiles unsupported.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="ridge_hip_vulnerable" style="margin-right: 6px; margin-top: 2px;">
                            <span>Ridge and hip tiles are particularly vulnerable, as wind pressure is often greatest in those areas.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="fastener_points_fail" style="margin-right: 6px; margin-top: 2px;">
                            <span>Fastener points can fail under wind stress, causing tiles to loosen or detach.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="wind_movement_hairline_fractures" style="margin-right: 6px; margin-top: 2px;">
                            <span>Wind-driven movement can create hairline fractures, which may worsen with thermal expansion.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="loose_lifted_disrupt_pattern" style="margin-right: 6px; margin-top: 2px;">
                            <span>Loose or lifted tiles disrupt the water-shedding pattern, increasing leak potential.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="repeated_wind_displacement" style="margin-right: 6px; margin-top: 2px;">
                            <span>Repeated wind exposure can cause gradual displacement, even without immediate visible damage.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="gaps_missing_expose_underlayment" style="margin-right: 6px; margin-top: 2px;">
                            <span>Gaps or missing tiles from wind damage leave the underlayment exposed, reducing the roof's overall protection.</span>
                          </label>
                        </div>
                      </div>
                    </details>
                  </div>
                  
                  <!-- FLAT/TPO DROPDOWN -->
                  <div style="margin-bottom: 15px;">
                    <details style="border: 1px solid #6f42c1; border-radius: 4px; background: #f8f9fa;">
                      <summary style="padding: 10px; background: #6f42c1; color: white; cursor: pointer; font-weight: bold; font-size: 14px;">
                        🏢 FLAT/TPO ROOF DAMAGE
                      </summary>
                      <div style="padding: 15px; max-height: 3000px !important; overflow-y: auto;">
                        
                        <!-- Hail Damage -->
                        <div style="margin-bottom: 15px;">
                          <h5 style="margin: 0 0 10px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 3px;">🌨️ Hail Damage</h5>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_hail_1" name="roof_damage_photo_${i}_flat_hail_1" value="circular_impact_mark" style="margin-right: 6px; margin-top: 2px;">
                            <span>Circular Impact Mark – Visible dent or bruise from direct hailstone impact.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_hail_2" name="roof_damage_photo_${i}_flat_hail_2" value="blistered_membrane" style="margin-right: 6px; margin-top: 2px;">
                            <span>Blistered Membrane – Raised or bubbled area caused by hail compromising the membrane.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_hail_3" name="roof_damage_photo_${i}_flat_hail_3" value="surface_granule_loss" style="margin-right: 6px; margin-top: 2px;">
                            <span>Surface Granule Loss – Protective top layer removed, exposing underlying material.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_hail_4" name="roof_damage_photo_${i}_flat_hail_4" value="cracked_coating" style="margin-right: 6px; margin-top: 2px;">
                            <span>Cracked Coating – Splits or fractures in coating from sharp hail impacts.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_hail_5" name="roof_damage_photo_${i}_flat_hail_5" value="soft_spot_bruising" style="margin-right: 6px; margin-top: 2px;">
                            <span>Soft Spot/Bruising – Subsurface damage felt underfoot, even if not visibly cracked.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_hail_6" name="roof_damage_photo_${i}_flat_hail_6" value="membrane_puncture" style="margin-right: 6px; margin-top: 2px;">
                            <span>Membrane Puncture – Hailstone penetration through the roof membrane.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_hail_7" name="roof_damage_photo_${i}_flat_hail_7" value="dented_flashing" style="margin-right: 6px; margin-top: 2px;">
                            <span>Dented Flashing – Metal edge components show dents consistent with hail size and force.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_hail_8" name="roof_damage_photo_${i}_flat_hail_8" value="pooling_around_damage" style="margin-right: 6px; margin-top: 2px;">
                            <span>Pooling Around Damage – Water collects near impact areas, increasing leak risk.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_hail_9" name="roof_damage_photo_${i}_flat_hail_9" value="displaced_debris" style="margin-right: 6px; margin-top: 2px;">
                            <span>Displaced Debris – Scattered roofing material or protective layer due to impact.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_hail_10" name="roof_damage_photo_${i}_flat_hail_10" value="random_impact_pattern" style="margin-right: 6px; margin-top: 2px;">
                            <span>Random Impact Pattern – Scattered hail strikes across the surface, indicating storm damage.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_1_flat_hail_11" name="roof_damage_photo_1_flat_hail_11" value="hail_circular_impact_marks" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail can leave circular impact marks, which may dent or bruise the surface of the flat roof membrane.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_1_flat_hail_12" name="roof_damage_photo_1_flat_hail_12" value="granule_loss_uv_protection" style="margin-right: 6px; margin-top: 2px;">
                            <span>Granule loss from hail impacts reduces the UV protection and shortens the life of the roof system.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_1_flat_hail_13" name="roof_damage_photo_1_flat_hail_13" value="membrane_punctures_large_hail" style="margin-right: 6px; margin-top: 2px;">
                            <span>Membrane punctures may occur when large or sharp hailstones strike with enough force to penetrate the surface.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_1_flat_hail_14" name="roof_damage_photo_1_flat_hail_14" value="blisters_raised_areas" style="margin-right: 6px; margin-top: 2px;">
                            <span>Blisters or raised areas can form where hail has weakened the membrane, trapping moisture or air below.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_1_flat_hail_15" name="roof_damage_photo_1_flat_hail_15" value="cracking_roof_coating" style="margin-right: 6px; margin-top: 2px;">
                            <span>Cracking in the roof coating may result from hail stress, making the surface vulnerable to future leaks.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_1_flat_hail_16" name="roof_damage_photo_1_flat_hail_16" value="subsurface_bruising_hidden" style="margin-right: 6px; margin-top: 2px;">
                            <span>Subsurface bruising may not be visible but can be felt underfoot and indicates hidden damage to the roofing layers.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_1_flat_hail_17" name="roof_damage_photo_1_flat_hail_17" value="flashing_metal_dent" style="margin-right: 6px; margin-top: 2px;">
                            <span>Flashing and metal components may dent, supporting evidence of hail and increasing the risk of seal failure.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_1_flat_hail_18" name="roof_damage_photo_1_flat_hail_18" value="pooling_water_impact_zones" style="margin-right: 6px; margin-top: 2px;">
                            <span>Pooling water around impact zones suggests low spots formed by hail-related damage to the roof structure.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_1_flat_hail_19" name="roof_damage_photo_1_flat_hail_19" value="protective_surfacing_displaced" style="margin-right: 6px; margin-top: 2px;">
                            <span>Protective surfacing can be displaced, such as granules or coatings, making those areas more susceptible to sun and water exposure.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_1_flat_hail_20" name="roof_damage_photo_1_flat_hail_20" value="hail_random_pattern" style="margin-right: 6px; margin-top: 2px;">
                            <span>Hail damage typically appears in a random pattern, helping distinguish it from mechanical wear or foot traffic.</span>
                          </label>
                        </div>
                        
                        <!-- Wind Damage -->
                        <div style="margin-bottom: 15px;">
                          <h5 style="margin: 0 0 10px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 3px;">🌪️ Wind Damage</h5>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_1" name="roof_damage_photo_${i}_flat_wind_1" value="membrane_uplift" style="margin-right: 6px; margin-top: 2px;">
                            <span>Membrane Uplift – Wind has lifted and detached the roofing membrane from the substrate.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_2" name="roof_damage_photo_${i}_flat_wind_2" value="edge_peeling" style="margin-right: 6px; margin-top: 2px;">
                            <span>Edge Peeling – Roofing material is peeling back at perimeter due to wind pressure.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_3" name="roof_damage_photo_${i}_flat_wind_3" value="blown_off_flashing" style="margin-right: 6px; margin-top: 2px;">
                            <span>Blown-Off Flashing – Metal edge flashing missing or displaced by high winds.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_4" name="roof_damage_photo_${i}_flat_wind_4" value="open_seams" style="margin-right: 6px; margin-top: 2px;">
                            <span>Open Seams – Wind stress has caused membrane seams to separate.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_5" name="roof_damage_photo_${i}_flat_wind_5" value="roof_debris_scattering" style="margin-right: 6px; margin-top: 2px;">
                            <span>Roof Debris Scattering – Loose materials scattered across roof indicate wind disturbance.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_6" name="roof_damage_photo_${i}_flat_wind_6" value="torn_membrane" style="margin-right: 6px; margin-top: 2px;">
                            <span>Torn Membrane – Wind has ripped or split the membrane along seams or penetrations.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_7" name="roof_damage_photo_${i}_flat_wind_7" value="detached_insulation_board" style="margin-right: 6px; margin-top: 2px;">
                            <span>Detached Insulation Board – Wind uplift has displaced the insulation layer below the membrane.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_8" name="roof_damage_photo_${i}_flat_wind_8" value="ponding_lifted_areas" style="margin-right: 6px; margin-top: 2px;">
                            <span>Ponding at Lifted Areas – Water pooling where membrane has lifted or bubbled.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_9" name="roof_damage_photo_${i}_flat_wind_9" value="displaced_ballast" style="margin-right: 6px; margin-top: 2px;">
                            <span>Displaced Ballast – Loose gravel or pavers moved from original position by strong wind.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_10" name="roof_damage_photo_${i}_flat_wind_10" value="parapet_curb_damage" style="margin-right: 6px; margin-top: 2px;">
                            <span>Parapet or Curb Damage – Wind pressure has damaged flashing or components at roof walls and curbs.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_11" name="roof_damage_photo_${i}_flat_wind_11" value="high_winds_lift_detach" style="margin-right: 6px; margin-top: 2px;">
                            <span>High winds can lift and detach roofing membranes, compromising the waterproof barrier.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_12" name="roof_damage_photo_${i}_flat_wind_12" value="roof_edges_vulnerable_peeling" style="margin-right: 6px; margin-top: 2px;">
                            <span>Roof edges are vulnerable to peeling, as wind pressure breaks adhesive seals.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" id="roof_damage_photo_${i}_flat_wind_13" name="roof_damage_photo_${i}_flat_wind_13" value="flashing_displaced_torn" style="margin-right: 6px; margin-top: 2px;">
                            <span>Flashing and metal components may be displaced or torn off, exposing the roof to moisture.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="seams_separate_water_infiltration" style="margin-right: 6px; margin-top: 2px;">
                            <span>Seams in the membrane can separate, creating openings for water infiltration.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="strong_winds_scatter_materials" style="margin-right: 6px; margin-top: 2px;">
                            <span>Strong winds can scatter loose roofing materials, leading to debris buildup and damage.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="tearing_splitting_membrane" style="margin-right: 6px; margin-top: 2px;">
                            <span>Tearing or splitting of the membrane often occurs, especially near penetrations and edges.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="insulation_detached_thermal" style="margin-right: 6px; margin-top: 2px;">
                            <span>Insulation layers may become detached, reducing thermal protection and roof stability.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="membrane_lifting_water_pond" style="margin-right: 6px; margin-top: 2px;">
                            <span>Membrane lifting can cause water to pond, increasing the risk of leaks and structural damage.</span>
                          </label>
                          <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer; margin-bottom: 5px;">
                            <input type="checkbox" value="parapets_curbs_penetrations" style="margin-right: 6px; margin-top: 2px;">
                            <span>Parapets, curbs, and roof penetrations are common damage points due to wind stress.</span>
                          </label>
                        </div>
                      </div>
                    </details>
                  </div>
                  
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else if (section.prefix === 'hvac_damage_photo' && (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9)) {
              // Add Manufacturer Tag Photo button for ALL HVAC items (1-9)
              const manufacturerTagButton = (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9) ? `
                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #38c3ff;">
                  <label class="upload-label" style="margin-bottom: 8px; display: block;">Manufacturer Tag Photo ${i}</label>
                  <button type="button" class="submit-btn" onclick="openCompanyCamUploader('manufacturer_tag_photo_${i}')" style="margin-bottom: 8px;">Select from CompanyCam</button>
                  <div class="companycam-thumbs" id="manufacturer_tag_photo_${i}_thumbs"></div>
                </div>
              ` : '';
              
              explanationField = `
                ${manufacturerTagButton}
                <div style="margin-top: 10px;">
                  <label class="form-label">HVAC Damage Observations:</label>
                  <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 3000px !important; overflow-y: auto; background: #f9f9f9;">
                    <div style="margin-bottom: 15px;">
                      <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">🌨️ Hail Damage Options:</h4>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_1" name="hvac_damage_photo_${i}_hail_1" value="finned_coil_dents" style="margin-right: 6px; margin-top: 2px;">
                          <span>Finned Coil Dents – Hailstones dented the condenser coil fins, restricting airflow.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_2" name="hvac_damage_photo_${i}_hail_2" value="crushed_coil_fins" style="margin-right: 6px; margin-top: 2px;">
                          <span>Crushed Coil Fins – Severe impacts flattened fins, reducing heat exchange efficiency.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_3" name="hvac_damage_photo_${i}_hail_3" value="cabinet_dents" style="margin-right: 6px; margin-top: 2px;">
                          <span>Cabinet Dents – Metal housing shows visible hail impact marks.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_4" name="hvac_damage_photo_${i}_hail_4" value="bent_fan_guard" style="margin-right: 6px; margin-top: 2px;">
                          <span>Bent Fan Guard – Protective grill over the fan bent from hail strike.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_5" name="hvac_damage_photo_${i}_hail_5" value="damaged_fan_blades" style="margin-right: 6px; margin-top: 2px;">
                          <span>Damaged Fan Blades – Fan blades bent or cracked by hail.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_6" name="hvac_damage_photo_${i}_hail_6" value="paint_chipping" style="margin-right: 6px; margin-top: 2px;">
                          <span>Paint Chipping – Hail has chipped exterior coating, exposing metal to rust.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_7" name="hvac_damage_photo_${i}_hail_7" value="electrical_box_dents" style="margin-right: 6px; margin-top: 2px;">
                          <span>Electrical Box Dents – Control box damaged, potentially affecting system operation.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_8" name="hvac_damage_photo_${i}_hail_8" value="compressor_cover_damage" style="margin-right: 6px; margin-top: 2px;">
                          <span>Compressor Cover Damage – Hail impact visible on compressor housing.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_9" name="hvac_damage_photo_${i}_hail_9" value="drain_pan_deformation" style="margin-right: 6px; margin-top: 2px;">
                          <span>Drain Pan Deformation – Hail has warped or dented the drain pan, risking water flow issues.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_10" name="hvac_damage_photo_${i}_hail_10" value="protective_screen_damage" style="margin-right: 6px; margin-top: 2px;">
                          <span>Protective Screen Damage – Hail has torn or displaced debris guards.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_11" name="hvac_damage_photo_${i}_hail_11" value="hail_dent_condenser_coil" style="margin-right: 6px; margin-top: 2px;">
                          <span>Hail can dent condenser coil fins, which reduces airflow and lowers cooling efficiency.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_12" name="hvac_damage_photo_${i}_hail_12" value="severe_impacts_crush_coil" style="margin-right: 6px; margin-top: 2px;">
                          <span>Severe impacts may crush coil fins, blocking air passage and overworking the system.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_13" name="hvac_damage_photo_${i}_hail_13" value="metal_housing_dents" style="margin-right: 6px; margin-top: 2px;">
                          <span>Metal housing panels often show dents or deformation, indicating direct hail impact.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_14" name="hvac_damage_photo_${i}_hail_14" value="fan_guards_bend_warp" style="margin-right: 6px; margin-top: 2px;">
                          <span>Fan guards can bend or warp from hail, potentially interfering with fan operation.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_15" name="hvac_damage_photo_${i}_hail_15" value="hail_bend_crack_blades" style="margin-right: 6px; margin-top: 2px;">
                          <span>Hail strikes may bend or crack fan blades, leading to imbalance or vibration during use.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_17" name="hvac_damage_photo_${i}_hail_17" value="electrical_control_dents" style="margin-right: 6px; margin-top: 2px;">
                          <span>Electrical control boxes can be dented, risking internal wiring damage or short circuits.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_18" name="hvac_damage_photo_${i}_hail_18" value="compressor_covers_damaged" style="margin-right: 6px; margin-top: 2px;">
                          <span>Compressor covers may be damaged, affecting protection and potentially insulation.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_19" name="hvac_damage_photo_${i}_hail_19" value="drain_pans_deform" style="margin-right: 6px; margin-top: 2px;">
                          <span>Drain pans or internal trays may deform, disrupting water drainage and increasing rust risk.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_hail_20" name="hvac_damage_photo_${i}_hail_20" value="debris_screens_torn" style="margin-right: 6px; margin-top: 2px;">
                          <span>Debris screens or protective grilles may be torn or loosened, reducing protection from future debris or pests.</span>
                        </label>
                      </div>
                    </div>
                    <div>
                      <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">🌪️ Wind Damage Options:</h4>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_1" name="hvac_damage_photo_${i}_wind_1" value="shifted_unit" style="margin-right: 6px; margin-top: 2px;">
                          <span>Shifted Unit – HVAC unit displaced from its original mounting position by wind.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_2" name="hvac_damage_photo_${i}_wind_2" value="disconnected_ducting" style="margin-right: 6px; margin-top: 2px;">
                          <span>Disconnected Ducting – Wind has pulled or loosened connected ductwork.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_3" name="hvac_damage_photo_${i}_wind_3" value="bent_fan_blades_wind" style="margin-right: 6px; margin-top: 2px;">
                          <span>Bent Fan Blades – Wind-driven debris has struck and bent fan blades.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_4" name="hvac_damage_photo_${i}_wind_4" value="top_cover_lifted" style="margin-right: 6px; margin-top: 2px;">
                          <span>Top Cover Lifted – Wind has lifted or loosened the unit's fan cover.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_5" name="hvac_damage_photo_${i}_wind_5" value="damaged_electrical_panel" style="margin-right: 6px; margin-top: 2px;">
                          <span>Damaged Electrical Panel – Panel cover blown open or off by wind pressure.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_6" name="hvac_damage_photo_${i}_wind_6" value="torn_insulation_wrap" style="margin-right: 6px; margin-top: 2px;">
                          <span>Torn Insulation Wrap – Exterior insulation ripped away by high winds.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_7" name="hvac_damage_photo_${i}_wind_7" value="detached_conduit_lines" style="margin-right: 6px; margin-top: 2px;">
                          <span>Detached Conduit Lines – Electrical or refrigerant lines pulled loose by wind force.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_8" name="hvac_damage_photo_${i}_wind_8" value="debris_inside_unit" style="margin-right: 6px; margin-top: 2px;">
                          <span>Debris Inside Unit – Wind has carried leaves or debris into the cabinet.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_9" name="hvac_damage_photo_${i}_wind_9" value="loose_missing_fasteners" style="margin-right: 6px; margin-top: 2px;">
                          <span>Loose or Missing Fasteners – Wind has shaken or removed panel screws.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_10" name="hvac_damage_photo_${i}_wind_10" value="tilted_mounting_base" style="margin-right: 6px; margin-top: 2px;">
                          <span>Tilted Mounting Base – Unit's platform or pad has shifted or tilted from wind stress.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_11" name="hvac_damage_photo_${i}_wind_11" value="wind_shift_dislodge_units" style="margin-right: 6px; margin-top: 2px;">
                          <span>Strong winds can shift or dislodge HVAC units, especially those not securely mounted, leading to misalignment or disconnection.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_12" name="hvac_damage_photo_${i}_wind_12" value="wind_disconnect_loosen_ductwork" style="margin-right: 6px; margin-top: 2px;">
                          <span>Wind may disconnect or loosen ductwork, reducing airflow and system efficiency.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_13" name="hvac_damage_photo_${i}_wind_13" value="wind_debris_bend_blades" style="margin-right: 6px; margin-top: 2px;">
                          <span>Fan blades can be bent or damaged by wind-driven debris, causing noise, imbalance, or failure.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_14" name="hvac_damage_photo_${i}_wind_14" value="wind_uplift_loosen_cover" style="margin-right: 6px; margin-top: 2px;">
                          <span>Wind uplift can loosen or remove the top cover, exposing internal components to weather.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_15" name="hvac_damage_photo_${i}_wind_15" value="electrical_panels_blown" style="margin-right: 6px; margin-top: 2px;">
                          <span>Electrical panels may be blown open or damaged, increasing the risk of moisture intrusion or electrical failure.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_16" name="hvac_damage_photo_${i}_wind_16" value="exterior_insulation_torn" style="margin-right: 6px; margin-top: 2px;">
                          <span>Exterior insulation or wrap can be torn off by high winds, reducing energy efficiency and exposing components.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_17" name="hvac_damage_photo_${i}_wind_17" value="conduit_refrigerant_pulled" style="margin-right: 6px; margin-top: 2px;">
                          <span>Conduit and refrigerant lines may be pulled loose, resulting in leaks or system shutdown.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_18" name="hvac_damage_photo_${i}_wind_18" value="wind_force_debris_inside" style="margin-right: 6px; margin-top: 2px;">
                          <span>Wind can force debris inside the unit, clogging components or obstructing airflow.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_19" name="hvac_damage_photo_${i}_wind_19" value="vibration_loosen_fasteners" style="margin-right: 6px; margin-top: 2px;">
                          <span>Vibration or movement from wind may loosen fasteners, leading to rattling parts or structural instability.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="hvac_damage_photo_${i}_wind_20" name="hvac_damage_photo_${i}_wind_20" value="mounting_pads_shift_tilt" style="margin-right: 6px; margin-top: 2px;">
                          <span>Mounting pads or platforms can shift or tilt, affecting drainage and putting strain on connected lines.</span>
                        </label>
                      </div>
                    </div>
                  </div>
                  
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else if (section.prefix === 'ground_exterior_photo' && (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9)) {
              explanationField = `
                <div style="margin-top: 10px;">
                  <label class="form-label">Window Damage Observations:</label>
                  <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; max-height: 3000px !important; overflow-y: auto; background: #f9f9f9;">
                    <div style="margin-bottom: 15px;">
                      <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">🌨️ Hail Damage Options:</h4>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_1" name="ground_exterior_photo_${i}_hail_1" value="cracked_glass_hail" style="margin-right: 6px; margin-top: 2px;">
                          <span>Cracked Glass – Hail impact has fractured the windowpane.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_2" name="ground_exterior_photo_${i}_hail_2" value="shattered_pane_hail" style="margin-right: 6px; margin-top: 2px;">
                          <span>Shattered Pane – Glass broken completely by hailstone force.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_3" name="ground_exterior_photo_${i}_hail_3" value="chipped_surface_hail" style="margin-right: 6px; margin-top: 2px;">
                          <span>Chipped Surface – Small chips from high-velocity hail impacts.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_4" name="ground_exterior_photo_${i}_hail_4" value="damaged_frame_hail" style="margin-right: 6px; margin-top: 2px;">
                          <span>Damaged Frame – Window frame dented or cracked by hail.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_5" name="ground_exterior_photo_${i}_hail_5" value="seal_failure_hail" style="margin-right: 6px; margin-top: 2px;">
                          <span>Seal Failure – Impact stress caused the window seal to break.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_6" name="ground_exterior_photo_${i}_hail_6" value="broken_glazing_bead_hail" style="margin-right: 6px; margin-top: 2px;">
                          <span>Broken Glazing Bead – Outer trim protecting glass dislodged or broken.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_7" name="ground_exterior_photo_${i}_hail_7" value="fogged_glass_hail" style="margin-right: 6px; margin-top: 2px;">
                          <span>Fogged Glass – Seal damage from hail allowed moisture between panes.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_8" name="ground_exterior_photo_${i}_hail_8" value="screen_tear_hail" style="margin-right: 6px; margin-top: 2px;">
                          <span>Screen Tear – Window screen ripped or punctured by hail.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_9" name="ground_exterior_photo_${i}_hail_9" value="paint_loss_hail" style="margin-right: 6px; margin-top: 2px;">
                          <span>Paint Loss – Hail chipped paint from frame or muntins.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_10" name="ground_exterior_photo_${i}_hail_10" value="debris_impact_marks_hail" style="margin-right: 6px; margin-top: 2px;">
                          <span>Debris Impact Marks – Marks from hail-driven debris hitting the window area.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_11" name="ground_exterior_photo_${i}_hail_11" value="hail_crack_glass_impact" style="margin-right: 6px; margin-top: 2px;">
                          <span>Hail can crack window glass upon impact, weakening structural integrity and posing a safety risk.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_12" name="ground_exterior_photo_${i}_hail_12" value="hail_shatter_panes" style="margin-right: 6px; margin-top: 2px;">
                          <span>Larger or faster hailstones may shatter panes completely, requiring immediate replacement.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_13" name="ground_exterior_photo_${i}_hail_13" value="hail_chips_pitting" style="margin-right: 6px; margin-top: 2px;">
                          <span>Small chips or pitting on the glass surface can occur from repeated hail strikes.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_14" name="ground_exterior_photo_${i}_hail_14" value="hail_frames_dent_crack" style="margin-right: 6px; margin-top: 2px;">
                          <span>Window frames may dent, crack, or warp, especially in aluminum, vinyl, or wood materials.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_15" name="ground_exterior_photo_${i}_hail_15" value="hail_break_seal" style="margin-right: 6px; margin-top: 2px;">
                          <span>Impact from hail can break the seal on double-pane windows, allowing moisture intrusion.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_16" name="ground_exterior_photo_${i}_hail_16" value="hail_glazing_disloged" style="margin-right: 6px; margin-top: 2px;">
                          <span>Glazing beads or trim pieces can become dislodged or broken, reducing weather resistance.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_17" name="ground_exterior_photo_${i}_hail_17" value="hail_fogging_condensation" style="margin-right: 6px; margin-top: 2px;">
                          <span>Seal failure may cause fogging or condensation between panes, reducing visibility and efficiency.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_18" name="ground_exterior_photo_${i}_hail_18" value="hail_screens_torn" style="margin-right: 6px; margin-top: 2px;">
                          <span>Window screens are easily torn or punctured by hail, leaving openings for insects and debris.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_19" name="ground_exterior_photo_${i}_hail_19" value="hail_paint_chip_weathering" style="margin-right: 6px; margin-top: 2px;">
                          <span>Paint or finish on window frames may chip away, exposing material to weathering and decay.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_hail_20" name="ground_exterior_photo_${i}_hail_20" value="hail_debris_marks" style="margin-right: 6px; margin-top: 2px;">
                          <span>Debris driven by hailstorms can leave additional impact marks or scratches on both the glass and surrounding structure.</span>
                        </label>
                      </div>
                    </div>
                    <div>
                      <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">🌪️ Wind Damage Options:</h4>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_1" name="ground_exterior_photo_${i}_wind_1" value="cracked_glass_wind" style="margin-right: 6px; margin-top: 2px;">
                          <span>Cracked Glass – Wind pressure caused the glass to crack.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_2" name="ground_exterior_photo_${i}_wind_2" value="broken_windowpane_wind" style="margin-right: 6px; margin-top: 2px;">
                          <span>Broken Windowpane – High wind impact shattered the window.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_3" name="ground_exterior_photo_${i}_wind_3" value="dislodged_window_frame_wind" style="margin-right: 6px; margin-top: 2px;">
                          <span>Dislodged Window Frame – Frame loosened or pulled away by wind.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_4" name="ground_exterior_photo_${i}_wind_4" value="damaged_window_seal_wind" style="margin-right: 6px; margin-top: 2px;">
                          <span>Damaged Window Seal – Wind stress broke the weatherproof seal.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_5" name="ground_exterior_photo_${i}_wind_5" value="bent_warped_frame_wind" style="margin-right: 6px; margin-top: 2px;">
                          <span>Bent or Warped Frame – Strong winds distorted the window frame shape.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_6" name="ground_exterior_photo_${i}_wind_6" value="detached_glazing_bead_wind" style="margin-right: 6px; margin-top: 2px;">
                          <span>Detached Glazing Bead – Trim holding glass shifted or came loose.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_7" name="ground_exterior_photo_${i}_wind_7" value="fogging_between_panes_wind" style="margin-right: 6px; margin-top: 2px;">
                          <span>Fogging Between Panes – Seal failure allowed moisture infiltration.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_8" name="ground_exterior_photo_${i}_wind_8" value="torn_damaged_screen_wind" style="margin-right: 6px; margin-top: 2px;">
                          <span>Torn or Damaged Screen – Window screen ripped by wind debris.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_9" name="ground_exterior_photo_${i}_wind_9" value="scratched_chipped_glass_wind" style="margin-right: 6px; margin-top: 2px;">
                          <span>Scratched or Chipped Glass – Debris carried by wind scratched window surface.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_10" name="ground_exterior_photo_${i}_wind_10" value="missing_window_components_wind" style="margin-right: 6px; margin-top: 2px;">
                          <span>Missing Window Components – Small parts blown away or broken by wind.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_11" name="ground_exterior_photo_${i}_wind_11" value="wind_pressure_crack" style="margin-right: 6px; margin-top: 2px;">
                          <span>Strong wind pressure can cause window glass to crack, weakening the pane.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_12" name="ground_exterior_photo_${i}_wind_12" value="wind_forces_shatter" style="margin-right: 6px; margin-top: 2px;">
                          <span>High wind forces may shatter window glass completely, requiring replacement.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_13" name="ground_exterior_photo_${i}_wind_13" value="wind_frames_disloged" style="margin-right: 6px; margin-top: 2px;">
                          <span>Window frames can become dislodged or loosened due to wind stress.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_14" name="ground_exterior_photo_${i}_wind_14" value="wind_break_seals" style="margin-right: 6px; margin-top: 2px;">
                          <span>Wind can break or damage window seals, compromising weatherproofing.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_15" name="ground_exterior_photo_${i}_wind_15" value="wind_bend_warp_frames" style="margin-right: 6px; margin-top: 2px;">
                          <span>Frames may bend or warp under sustained wind pressure, affecting fit and function.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_16" name="ground_exterior_photo_${i}_wind_16" value="wind_glazing_detach" style="margin-right: 6px; margin-top: 2px;">
                          <span>Glazing beads or trim pieces can detach, reducing glass stability.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_17" name="ground_exterior_photo_${i}_wind_17" value="wind_moisture_panes" style="margin-right: 6px; margin-top: 2px;">
                          <span>Seal failure allows moisture to enter between panes, causing fogging or condensation.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_18" name="ground_exterior_photo_${i}_wind_18" value="wind_screens_torn" style="margin-right: 6px; margin-top: 2px;">
                          <span>Window screens can be torn or damaged by wind-driven debris.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_19" name="ground_exterior_photo_${i}_wind_19" value="wind_debris_scratch" style="margin-right: 6px; margin-top: 2px;">
                          <span>Debris carried by wind may scratch or chip glass surfaces.</span>
                        </label>
                        <label style="display: flex; align-items: flex-start; font-size: 12px; cursor: pointer;">
                          <input type="checkbox" id="ground_exterior_photo_${i}_wind_20" name="ground_exterior_photo_${i}_wind_20" value="wind_components_damaged" style="margin-right: 6px; margin-top: 2px;">
                          <span>Small components like locks or handles may be damaged or lost due to wind forces.</span>
                        </label>
                      </div>
                    </div>
                  </div>
                  <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    <i class="fas fa-info-circle"></i> Check all applicable damage observations
                  </div>
                </div>
              `;
            } else {
              explanationField = `
                <div style="margin-top: 10px;">
                  <label class="form-label">Explanation:</label>
                  <textarea id="${section.prefix}_explanation_${i}" class="form-input" rows="2" placeholder="Describe what is shown in this photo..."></textarea>
                </div>
              `;
            }


              const uploaderHtml = `
                <div class="upload-section" id="${section.prefix}_${i}_section">
                  <label class="upload-label">${section.label} ${i}</label>
                  <button type="button" class="submit-btn" onclick="openCompanyCamUploader('${section.prefix}_${i}')">Select from CompanyCam</button>
                  <div class="companycam-thumbs" id="${section.prefix}_${i}_thumbs"></div>
                  ${explanationField}
                </div>
                          `;
            container.innerHTML += uploaderHtml;
            console.log(`✅ DEBUG: Campo ${i} agregado para ${section.prefix}`);
          }
          console.log(`🎉 DEBUG: Completados ${9} campos para ${section.id}`);
        } else {
          console.warn(`❌ DEBUG: Container no encontrado para ${section.id}`);
        }
      });
    }

    // Function to get selected interior observations and format them professionally
    function getSelectedObservations(containerId) {
      console.log('🔍 DEBUG: getSelectedObservations called with containerId:', containerId);
      
      // Try multiple search methods to find the container
      let container = document.querySelector(`[id*="${containerId}"]`)?.closest('div[style*="border: 1px solid #ddd"]');
      console.log('🔍 DEBUG: Container found (method 1):', container);
      
      if (!container) {
        // Try alternative search method
        container = document.querySelector(`[id*="${containerId}"]`)?.closest('.upload-section');
        console.log('🔍 DEBUG: Container found (method 2):', container);
      }
      
      let checkedBoxes = [];
      
      if (!container) {
        // Try direct search for checkboxes
        checkedBoxes = document.querySelectorAll(`[id*="${containerId}"] input[type="checkbox"]:checked`);
        console.log('🔍 DEBUG: Direct checkboxes found:', checkedBoxes.length);
        
        if (checkedBoxes.length === 0) {
          console.log('❌ No checkboxes found for:', containerId);
          return '';
        }
      } else {
        // Get all checked checkboxes within this container
        checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
        console.log('🔍 DEBUG: Checked boxes found:', checkedBoxes.length);
        
        if (checkedBoxes.length === 0) return '';
      }
      
      // Map of interior observation values to professional descriptions
      const interiorObservationDescriptions = {
        'water_stains_ceiling': 'Water intrusion can cause ceiling stains, signaling roof or window leaks. Prompt roof repairs and sealing prevent further damage.',
        'drywall_cracks': 'Storm-related structural shifts may cause drywall cracks. Cracks should be assessed and repaired to restore wall integrity.',
        'warped_flooring': 'Moisture can warp wood or laminate flooring, causing buckling. Damaged flooring often requires replacement or refinishing after drying.',
        'soggy_insulation': 'Wet insulation loses effectiveness and promotes mold growth. Saturated insulation must be removed and replaced.',
        'mold_growth_walls': 'Mold growth occurs from prolonged moisture exposure inside walls. Professional mold remediation is essential for health and safety.',
        'damaged_window_frames': 'Water can swell or crack window frames, compromising fit. Frames may need repair, resealing, or replacement to restore weatherproofing.',
        'broken_interior_doors': 'Interior doors may swell or warp from water infiltration. Doors can sometimes be repaired or may require replacement.',
        'debris_inside_rooms': 'Wind-driven debris can scatter inside rooms, causing physical damage. Cleanup and repair of damaged materials are necessary.',
        'electrical_outlet_damage': 'Electrical outlets exposed to water risk corrosion and shorts. Electrical components should be inspected and replaced by a qualified technician.',
        'peeling_paint_wallpaper': 'Moisture causes paint or wallpaper to peel or bubble. Damaged finishes must be removed and surfaces properly dried before refinishing.',
        'water_intrusion_ceiling': 'Water intrusion can cause ceiling stains, signaling roof or window leaks. Prompt roof repairs and sealing prevent further damage.',
        'structural_shifts_drywall': 'Storm-related structural shifts may cause drywall cracks. Cracks should be assessed and repaired to restore wall integrity.',
        'moisture_warp_flooring': 'Moisture can warp wood or laminate flooring, causing buckling. Damaged flooring often requires replacement or refinishing after drying.',
        'wet_insulation_effectiveness': 'Wet insulation loses effectiveness and promotes mold growth. Saturated insulation must be removed and replaced.',
        'mold_growth_walls_professional': 'Mold growth occurs from prolonged moisture exposure inside walls. Professional mold remediation is essential for health and safety.',
        'water_swell_window_frames': 'Water can swell or crack window frames, compromising fit. Frames may need repair, resealing, or replacement to restore weatherproofing.',
        'interior_doors_swell': 'Interior doors may swell or warp from water infiltration. Doors can sometimes be repaired or may require replacement.',
        'wind_debris_rooms': 'Wind-driven debris can scatter inside rooms, causing physical damage. Cleanup and repair of damaged materials are necessary.',
        'electrical_outlets_corrosion': 'Electrical outlets exposed to water risk corrosion and shorts. Electrical components should be inspected and replaced by a qualified technician.',
        'moisture_paint_bubble': 'Moisture causes paint or wallpaper to peel or bubble. Damaged finishes must be removed and surfaces properly dried before refinishing.'
      };
      
      // Build professional report text
      let reportText = 'Interior Damage Observations:\n';
      checkedBoxes.forEach((checkbox, index) => {
        const description = interiorObservationDescriptions[checkbox.value];
        if (description) {
          reportText += `${index + 1}. ${description}\n\n`;
        }
      });
      
      return reportText.trim();
    }

    // Function to get selected exterior components observations and format them professionally
    function getSelectedExteriorComponentsObservations(containerId) {
      console.log('🔍 DEBUG: getSelectedExteriorComponentsObservations called with containerId:', containerId);
      
      // Try to find the container
      let container = document.querySelector(`#${containerId}_section`);
      if (!container) {
        container = document.querySelector(`[id*="${containerId}"]`);
      }
      console.log('🔍 DEBUG: Container found:', container);
      
      if (!container) {
        console.log('❌ No container found for:', containerId);
        return '';
      }
      
      // Get all checked checkboxes within this container
      const checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
      console.log('🔍 DEBUG: Checked boxes found:', checkedBoxes.length);
      
      if (checkedBoxes.length === 0) return '';
      
      // Build professional report text
      let reportText = 'Exterior Components Damage Observations:\n';
      checkedBoxes.forEach((checkbox, index) => {
        const label = checkbox.nextElementSibling?.textContent || checkbox.value;
        if (label) {
          reportText += `${index + 1}. ${label.trim()}\n\n`;
        }
      });
      
      console.log('🔍 DEBUG: Generated report text:', reportText);
      return reportText.trim();
    }

    // Function to get selected exterior observations and format them professionally
    function getSelectedExteriorObservations(containerId) {
      console.log('🔍 DEBUG: getSelectedExteriorObservations called with containerId:', containerId);
      
      // Try multiple search methods to find the container
      let container = document.querySelector(`[id*="${containerId}"]`)?.closest('div[style*="border: 1px solid #ddd"]');
      console.log('🔍 DEBUG: Container found (method 1):', container);
      
      if (!container) {
        // Try alternative search method
        container = document.querySelector(`[id*="${containerId}"]`)?.closest('.upload-section');
        console.log('🔍 DEBUG: Container found (method 2):', container);
      }
      
      let checkedBoxes = [];
      
      if (!container) {
        // Try direct search for checkboxes
        checkedBoxes = document.querySelectorAll(`[id*="${containerId}"] input[type="checkbox"]:checked`);
        console.log('🔍 DEBUG: Direct checkboxes found:', checkedBoxes.length);
        
        if (checkedBoxes.length === 0) {
          console.log('❌ No checkboxes found for:', containerId);
          return '';
        }
      } else {
        // Get all checked checkboxes within this container
        checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
        console.log('🔍 DEBUG: Checked boxes found:', checkedBoxes.length);
        
        if (checkedBoxes.length === 0) return '';
      }
      
      // Map of exterior observation values to professional descriptions
      const exteriorObservationDescriptions = {
        // Hail Damage Options
        'cracked_glass_hail': 'Hail can crack window glass upon impact, weakening structural integrity and posing a safety risk.',
        'shattered_pane_hail': 'Larger or faster hailstones may shatter panes completely, requiring immediate replacement.',
        'chipped_surface_hail': 'Small chips or pitting on the glass surface can occur from repeated hail strikes.',
        'damaged_frame_hail': 'Window frames may dent, crack, or warp, especially in aluminum, vinyl, or wood materials.',
        'seal_failure_hail': 'Impact from hail can break the seal on double-pane windows, allowing moisture intrusion.',
        'broken_glazing_bead_hail': 'Glazing beads or trim pieces can become dislodged or broken, reducing weather resistance.',
        'fogged_glass_hail': 'Seal failure may cause fogging or condensation between panes, reducing visibility and efficiency.',
        'screen_tear_hail': 'Window screens are easily torn or punctured by hail, leaving openings for insects and debris.',
        'paint_loss_hail': 'Paint or finish on window frames may chip away, exposing material to weathering and decay.',
        'debris_impact_marks_hail': 'Debris driven by hailstorms can leave additional impact marks or scratches on both the glass and surrounding structure.',
        'hail_crack_glass_impact': 'Hail can crack window glass upon impact, weakening structural integrity and posing a safety risk.',
        'hail_shatter_panes': 'Larger or faster hailstones may shatter panes completely, requiring immediate replacement.',
        'hail_chips_pitting': 'Small chips or pitting on the glass surface can occur from repeated hail strikes.',
        'hail_frames_dent_crack': 'Window frames may dent, crack, or warp, especially in aluminum, vinyl, or wood materials.',
        'hail_break_seal': 'Impact from hail can break the seal on double-pane windows, allowing moisture intrusion.',
        'hail_glazing_disloged': 'Glazing beads or trim pieces can become dislodged or broken, reducing weather resistance.',
        'hail_fogging_condensation': 'Seal failure may cause fogging or condensation between panes, reducing visibility and efficiency.',
        'hail_screens_torn': 'Window screens are easily torn or punctured by hail, leaving openings for insects and debris.',
        'hail_paint_chip_weathering': 'Paint or finish on window frames may chip away, exposing material to weathering and decay.',
        'hail_debris_marks': 'Debris driven by hailstorms can leave additional impact marks or scratches on both the glass and surrounding structure.',
        
        // Wind Damage Options
        'cracked_glass_wind': 'Strong wind pressure can cause window glass to crack, weakening the pane.',
        'broken_windowpane_wind': 'High wind forces may shatter window glass completely, requiring replacement.',
        'dislodged_window_frame_wind': 'Window frames can become dislodged or loosened due to wind stress.',
        'damaged_window_seal_wind': 'Wind can break or damage window seals, compromising weatherproofing.',
        'bent_warped_frame_wind': 'Frames may bend or warp under sustained wind pressure, affecting fit and function.',
        'detached_glazing_bead_wind': 'Glazing beads or trim pieces can detach, reducing glass stability.',
        'fogging_between_panes_wind': 'Seal failure allows moisture to enter between panes, causing fogging or condensation.',
        'torn_damaged_screen_wind': 'Window screens can be torn or damaged by wind-driven debris.',
        'scratched_chipped_glass_wind': 'Debris carried by wind may scratch or chip glass surfaces.',
        'missing_window_components_wind': 'Small components like locks or handles may be damaged or lost due to wind forces.',
        'wind_pressure_crack': 'Strong wind pressure can cause window glass to crack, weakening the pane.',
        'wind_forces_shatter': 'High wind forces may shatter window glass completely, requiring replacement.',
        'wind_frames_disloged': 'Window frames can become dislodged or loosened due to wind stress.',
        'wind_break_seals': 'Wind can break or damage window seals, compromising weatherproofing.',
        'wind_bend_warp_frames': 'Frames may bend or warp under sustained wind pressure, affecting fit and function.',
        'wind_glazing_detach': 'Glazing beads or trim pieces can detach, reducing glass stability.',
        'wind_moisture_panes': 'Seal failure allows moisture to enter between panes, causing fogging or condensation.',
        'wind_screens_torn': 'Window screens can be torn or damaged by wind-driven debris.',
        'wind_debris_scratch': 'Debris carried by wind may scratch or chip glass surfaces.',
        'wind_components_damaged': 'Small components like locks or handles may be damaged or lost due to wind forces.'
      };
      
      // Build professional report text
                  let reportText = 'Window Damage Observations:\n';
      checkedBoxes.forEach((checkbox, index) => {
        const description = exteriorObservationDescriptions[checkbox.value];
        if (description) {
          reportText += `${index + 1}. ${description}\n\n`;
        }
      });
      
      return reportText.trim();
    }

    // Function to get selected roof damage observations and format them professionally
    function getSelectedRoofDamageObservations(containerId) {
      console.log('🔍 DEBUG: getSelectedRoofDamageObservations called with containerId:', containerId);
      
      // Try multiple search methods to find the container
      let container = document.querySelector(`[id*="${containerId}"]`)?.closest('div[style*="border: 1px solid #ddd"]');
      console.log('🔍 DEBUG: Container found (method 1):', container);
      
      if (!container) {
        // Try alternative search method
        container = document.querySelector(`[id*="${containerId}"]`)?.closest('.upload-section');
        console.log('🔍 DEBUG: Container found (method 2):', container);
      }
      
      let checkedBoxes = [];
      
      if (!container) {
        // Try direct search for checkboxes
        checkedBoxes = document.querySelectorAll(`[id*="${containerId}"] input[type="checkbox"]:checked`);
        console.log('🔍 DEBUG: Direct checkboxes found:', checkedBoxes.length);
        
        if (checkedBoxes.length === 0) {
          console.log('❌ No checkboxes found for:', containerId);
          return '';
        }
        
        console.log('🔍 DEBUG: Checked boxes found (direct):', checkedBoxes.length);
      } else {
        // Get all checked checkboxes within this container
        checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
        console.log('🔍 DEBUG: Checked boxes found:', checkedBoxes.length);
        console.log('🔍 DEBUG: Checked boxes:', checkedBoxes);
        if (checkedBoxes.length === 0) return '';
      }
      
      // Find the dropdown title (ASPHALT SHINGLE DAMAGE, METAL ROOF DAMAGE, etc.)
      let dropdownTitle = '';
      const detailsElements = container.querySelectorAll('details');
      console.log('🔍 DEBUG: Found details elements:', detailsElements.length);
      
      for (const details of detailsElements) {
        const summary = details.querySelector('summary');
        if (summary) {
          const summaryText = summary.textContent.trim();
          console.log('🔍 DEBUG: Summary text:', summaryText);
          
          // Check if this details element has checked checkboxes
          const checkedBoxesInDetails = details.querySelectorAll('input[type="checkbox"]:checked');
          console.log('🔍 DEBUG: Checked boxes in this details:', checkedBoxesInDetails.length);
          
          if (checkedBoxesInDetails.length > 0) {
            // Extract the title without the emoji
            dropdownTitle = summaryText.replace(/^[🏠🔧🏺🏢]+\s*/, '').trim();
            console.log('🔍 DEBUG: Extracted dropdown title:', dropdownTitle);
            break;
          }
        }
      }
      
      // Map of roof damage observation values to professional descriptions
      const roofDamageObservationDescriptions = {
        // Asphalt Shingle Hail Damage
        'granule_loss': 'Granule loss from hail impact weakens the shingle\'s UV protection and can lead to premature deterioration.',
        'cracked_shingle': 'Cracked shingles compromise the roof\'s waterproofing ability and require immediate attention.',
        'soft_spot_bruising': 'Soft spot bruising indicates subsurface damage that may not be visible but compromises shingle integrity.',
        'displaced_granules': 'Displaced granules in gutters indicate hail impact and reduce shingle lifespan.',
        'shingle_pitting': 'Shingle pitting creates weak points that can lead to future leaks and deterioration.',
        'shingle_mat_exposure': 'Exposed fiberglass mat reduces waterproofing capability and accelerates shingle aging.',
        'edge_fracture': 'Edge fractures compromise shingle stability and increase vulnerability to wind uplift.',
        'random_damage_pattern': 'Random damage patterns distinguish hail damage from normal wear and tear.',
        'neighboring_structure_signs': 'Dented vents or gutters provide supporting evidence of hail impact.',
        
        // Asphalt Shingle Wind Damage
        'lifted_shingle': 'Lifted shingles create entry points for water and increase vulnerability to further wind damage.',
        'missing_shingle': 'Missing shingles expose the underlayment and require immediate replacement.',
        'cracked_shingle_wind': 'Wind-induced cracks compromise shingle structural integrity.',
        'displaced_shingle': 'Displaced shingles disrupt the water-shedding pattern and increase leak potential.',
        'edge_lifting': 'Edge lifting indicates wind uplift forces that can lead to progressive shingle loss.',
        'seal_failure': 'Seal failure between shingles reduces wind resistance and increases vulnerability.',
        'shingle_curling': 'Shingle curling creates gaps that allow water infiltration and wind penetration.',
        'granule_loss_wind': 'Wind-driven granule loss accelerates shingle aging and reduces UV protection.',
        'shingle_tearing': 'Torn shingles create immediate leak points and require prompt replacement.',
        'random_wind_pattern': 'Random wind damage patterns indicate storm-related damage rather than normal wear.',
        
        // Metal Roof Hail Damage
        'dented_metal_panel': 'Dented metal panels compromise the roof\'s structural integrity and aesthetic appearance.',
        'punctured_panel': 'Punctured panels create immediate leak points and require replacement.',
        'cracked_panel': 'Cracked panels reduce the roof\'s waterproofing ability and structural strength.',
        'paint_chipped': 'Chipped paint exposes metal to corrosion and reduces the roof\'s protective coating.',
        'panel_displacement': 'Displaced panels create gaps that allow water infiltration and wind penetration.',
        'seam_damage': 'Damaged seams compromise the roof\'s waterproofing integrity.',
        'fastener_damage': 'Damaged fasteners reduce panel stability and increase wind uplift vulnerability.',
        'coating_loss': 'Loss of protective coating accelerates metal corrosion and reduces roof lifespan.',
        'panel_warping': 'Warped panels create uneven surfaces that can trap water and debris.',
        'impact_markings': 'Impact markings provide evidence of hail size and force.',
        
        // Metal Roof Wind Damage
        'lifted_metal_panel': 'Lifted metal panels create immediate leak points and increase wind vulnerability.',
        'loose_missing_fasteners': 'Loose or missing fasteners reduce panel stability and increase wind uplift risk.',
        'bent_warped_panels': 'Bent or warped panels compromise the roof\'s structural integrity.',
        'damaged_seams': 'Damaged seams allow water infiltration and reduce wind resistance.',
        'torn_peeling_paint': 'Torn or peeling paint exposes metal to corrosion and reduces protection.',
        'detached_flashing': 'Detached flashing creates entry points for water and wind.',
        'displaced_ridge_cap': 'Displaced ridge caps compromise the roof\'s weatherproofing integrity.',
        'panel_overlap_separation': 'Separated panel overlaps create gaps for water and wind penetration.',
        'dented_panels_debris': 'Debris-caused dents compromise panel integrity and aesthetic appearance.',
        'cracked_broken_trim': 'Cracked or broken trim reduces the roof\'s weather resistance.',
        
        // Tile Roof Hail Damage
        'cracked_tile_surface': 'Cracked tile surfaces compromise the roof\'s waterproofing ability.',
        'edge_chip': 'Edge chips create weak points that can lead to progressive tile failure.',
        'broken_tile': 'Broken tiles expose the underlayment and require immediate replacement.',
        'spalled_surface': 'Spalled surfaces reduce tile protection and accelerate deterioration.',
        'granule_loss_tile': 'Granule loss reduces UV protection and shortens tile lifespan.',
        'dislodged_tile': 'Dislodged tiles create gaps that allow water infiltration.',
        'multiple_impact_marks': 'Multiple impact marks indicate widespread hail damage.',
        'tile_fragmentation': 'Tile fragmentation creates debris and exposes underlayment.',
        'underlayment_exposed': 'Exposed underlayment increases water infiltration risk.',
        'hairline_cracks': 'Hairline cracks can expand over time and compromise tile integrity.',
        
        // Tile Roof Wind Damage
        'missing_tile': 'Missing tiles expose the underlayment and require immediate replacement.',
        'lifted_tile': 'Lifted tiles create entry points for water and wind.',
        'dislodged_tile_wind': 'Dislodged tiles disrupt the roof\'s water-shedding pattern.',
        'cracked_tile_uplift': 'Wind uplift can crack tiles even if they remain in place.',
        'edge_tile_damage': 'Edge tile damage is common due to concentrated wind forces.',
        'broken_fastener_area': 'Broken fastener areas reduce tile stability and increase wind vulnerability.',
        'sliding_tile': 'Sliding tiles create gaps and reduce roof protection.',
        'roof_ridge_damage': 'Ridge damage compromises the roof\'s weatherproofing integrity.',
        'tile_debris_ground': 'Tile debris on the ground indicates wind damage severity.',
        'gap_tile_field': 'Gaps in the tile field expose underlayment and increase leak risk.',
        
        // Flat/TPO Roof Hail Damage
        'circular_impact_mark': 'Circular impact marks indicate direct hailstone strikes on the membrane.',
        'blistered_membrane': 'Blistered membranes indicate hail compromise and potential moisture trapping.',
        'surface_granule_loss': 'Surface granule loss reduces UV protection and accelerates membrane aging.',
        'cracked_coating': 'Cracked coatings compromise the membrane\'s protective barrier.',
        'soft_spot_bruising': 'Soft spot bruising indicates subsurface damage that may not be visible.',
        'membrane_puncture': 'Membrane punctures create immediate leak points and require repair.',
        'dented_flashing': 'Dented flashing provides evidence of hail impact and reduces seal effectiveness.',
        'pooling_around_damage': 'Pooling around damage indicates low spots formed by hail impact.',
        'displaced_debris': 'Displaced debris indicates impact force and reduces roof protection.',
        'random_impact_pattern': 'Random impact patterns distinguish hail damage from mechanical wear.',
        
        // Flat/TPO Roof Wind Damage
        'membrane_uplift': 'Membrane uplift compromises the waterproof barrier and requires immediate attention.',
        'edge_peeling': 'Edge peeling indicates wind pressure breaking adhesive seals.',
        'blown_off_flashing': 'Blown-off flashing exposes the roof to moisture and wind damage.',
        'open_seams': 'Open seams create openings for water infiltration and wind penetration.',
        'roof_debris_scattering': 'Scattered debris indicates wind disturbance and potential damage.',
        'torn_membrane': 'Torn membranes create immediate leak points and require repair.',
        'detached_insulation_board': 'Detached insulation reduces thermal protection and roof stability.',
        'ponding_lifted_areas': 'Ponding in lifted areas increases leak and structural damage risk.',
        'displaced_ballast': 'Displaced ballast reduces roof protection and stability.',
        'parapet_curb_damage': 'Parapet and curb damage compromises roof edge protection.',
        
        // Additional Asphalt Shingle Hail Damage
        'hail_impact_mark': 'Hail Impact Mark – Circular dark spot with granule loss from direct hail strike.',
        'hail_dislodge_granules': 'Hail can dislodge protective granules, exposing the asphalt layer underneath and accelerating roof aging.',
        'granule_loss_uv_protection': 'Granule loss from hail impact weakens the shingle\'s UV protection and can lead to premature deterioration.',
        'circular_impact_marks': 'Hail strikes often leave circular impact marks, which may appear darker due to exposed asphalt.',
        'repeated_hail_bruising': 'Repeated hail hits can bruise the shingle, causing soft spots that may not be visible but compromise integrity.',
        'cracks_older_materials': 'Cracks may form in shingles from hailstones, especially in older or brittle roofing materials.',
        'random_pattern_distinction': 'Hail damage is typically random in pattern, distinguishing it from wear-and-tear or manufacturing defects.',
        'severe_impacts_mat_exposure': 'Severe impacts can expose the fiberglass mat, reducing the waterproofing capability of the shingle.',
        'edge_vulnerability_cracking': 'Edges of shingles are vulnerable to cracking from hail, especially if the hailstone strikes near the edge.',
        'granule_loss_aging': 'Loss of granules can lead to accelerated roof aging, even if leaks aren\'t immediately present.',
        'hail_weaken_roof_system': 'Hail-damaged shingles can weaken the overall roof system, increasing the risk of future water intrusion.',
        'hail_reduce_lifespan': 'Hail impacts can reduce shingle lifespan, even if the damage isn\'t immediately visible.',
        'dents_water_shedding': 'Dents from hail may compromise water shedding, leading to pooling and eventual leaks.',
        'cumulative_hail_weakness': 'Cumulative hail damage weakens shingles structurally, making them more susceptible to wind uplift.',
        'minor_hail_worsen_time': 'Minor hail damage can worsen over time, especially with repeated exposure to weather.',
        'hail_break_bond_layers': 'Hail can break the bond between shingle layers, compromising structural integrity.',
        'displaced_granules_clog_gutters': 'Displaced granules can clog gutters and downspouts, affecting drainage.',
        'hail_damage_shiny_bare': 'Hail damage can create shiny, bare spots where granules have been removed.',
        'hail_damage_sealant_strips': 'Hail can damage sealant strips between shingles, reducing wind resistance.',
        'bruised_shingles_weakened_mat': 'Bruised shingles have weakened fiberglass mat, reducing strength.',
        'insurance_adjuster_patterns': 'Random damage patterns are typical of hail and recognized by insurance adjusters.',
        
        // Additional Asphalt Shingle Wind Damage
        'wind_remove_shingles': 'High winds can completely remove shingles from the roof deck.',
        'displaced_misaligned_shingles': 'Wind can displace and misalign shingles, disrupting the water-shedding pattern.',
        'lifted_shingles_water_intrusion': 'Lifted shingles create entry points for water during rain events.',
        'cracked_shingle_wind': 'Wind-induced cracks compromise shingle structural integrity.',
        'displaced_shingle': 'Displaced shingles disrupt the water-shedding pattern and increase leak potential.',
        'edge_lifting': 'Edge lifting indicates wind uplift forces that can lead to progressive shingle loss.',
        'seal_failure': 'Seal failure between shingles reduces wind resistance and increases vulnerability.',
        'shingle_curling': 'Shingle curling creates gaps that allow water infiltration and wind penetration.',
        'granule_loss_wind': 'Wind-driven granule loss accelerates shingle aging and reduces UV protection.',
        'shingle_tearing': 'Torn shingles create immediate leak points and require prompt replacement.',
        'random_wind_pattern': 'Random wind damage patterns indicate storm-related damage rather than normal wear.',
        'creased_shingle_tab': 'Wind can crease shingle tabs, weakening their structural integrity.',
        'broken_seal_strip': 'Wind can break seal strips between shingles, reducing wind resistance.',
        'exposed_underlayment': 'Wind can expose underlayment by removing or lifting shingles.',
        'flapping_shingle': 'Flapping shingles indicate wind uplift and potential seal failure.',
        'edge_shingle_loss': 'Wind can cause progressive loss of shingles from edges inward.',
        'nail_pull_through': 'Wind stress can cause nails to pull through shingles.',
        'torn_shingle_corner': 'Wind can tear shingle corners, creating immediate leak points.',
        'high_winds_lift_shingles': 'High winds can lift shingles, breaking adhesive seals.',
        'creases_structural_weakening': 'Wind creases can weaken shingle structure over time.',
        'nail_pull_through_stress': 'Wind stress can cause nails to pull through shingles, reducing attachment.',
        'corners_edges_failure_points': 'Shingle corners and edges are common failure points during wind events.',
        'flying_debris_flashing_vents': 'Flying debris can damage flashing and vents, compromising roof integrity.',
        'loose_flapping_seal_failure': 'Loose, flapping shingles indicate seal failure and wind vulnerability.',
        'wind_damage_tearing_cracking': 'Wind can tear and crack shingles, creating immediate leak points.',
        
        // Additional Metal Roof Hail Damage
        'dented_panels': 'Hail can dent metal panels, compromising structural integrity and appearance.',
        'paint_chipping': 'Hail can chip paint from metal panels, exposing metal to corrosion.',
        'surface_scratches': 'Hail can scratch metal panel surfaces, reducing protective coating.',
        'coating_cracks': 'Hail can crack protective coatings on metal panels.',
        
        // Additional Metal Roof Wind Damage
        'lifted_metal_panel': 'Wind can lift metal panels, creating gaps for water infiltration.',
        'loose_missing_fasteners': 'Wind can loosen or remove fasteners, reducing panel stability.',
        
        // Additional Tile Roof Hail Damage
        'multiple_impact_marks': 'Multiple impact marks indicate widespread hail damage.',
        'tile_fragmentation': 'Tile fragmentation creates debris and exposes underlayment.',
        'underlayment_exposed': 'Exposed underlayment increases water infiltration risk.',
        'hairline_cracks': 'Hairline cracks can expand over time and compromise tile integrity.',
        
        // Additional Tile Roof Wind Damage
        'cracked_tile_uplift': 'Wind uplift can crack tiles even if they remain in place.',
        'edge_tile_damage': 'Edge tile damage is common due to concentrated wind forces.',
        'broken_fastener_area': 'Broken fastener areas reduce tile stability and increase wind vulnerability.',
        'sliding_tile': 'Sliding tiles create gaps and reduce roof protection.',
        'roof_ridge_damage': 'Ridge damage compromises the roof\'s weatherproofing integrity.',
        'tile_debris_ground': 'Tile debris on the ground indicates wind damage severity.',
        'gap_tile_field': 'Gaps in the tile field expose underlayment and increase leak risk.',
        
        // Additional Flat/TPO Roof Hail Damage
        'hail_circular_impact_marks': 'Hail creates distinctive circular impact marks.',
        'membrane_punctures_large_hail': 'Large hail can puncture membrane materials.',
        'blisters_raised_areas': 'Hail can cause blisters and raised areas in membranes.',
        'cracking_roof_coating': 'Hail can crack protective roof coatings.',
        'subsurface_bruising_hidden': 'Hail can cause hidden subsurface damage.',
        'flashing_metal_dent': 'Hail can dent metal flashing components.',
        'pooling_water_impact_zones': 'Hail damage can create low spots that pool water.',
        'protective_surfacing_displaced': 'Hail can displace protective surfacing materials.',
        'hail_random_pattern': 'Hail creates random damage patterns on flat roofs.',
        
        // Additional Flat/TPO Roof Wind Damage
        'high_winds_lift_detach': 'High winds can lift and detach flat roof components.',
        'roof_edges_vulnerable_peeling': 'Roof edges are vulnerable to wind peeling.',
        'flashing_displaced_torn': 'Wind can displace or tear flashing materials.'
      };
      
      // Build professional report text
      let reportText = '';
      if (dropdownTitle) {
        reportText += `${dropdownTitle} Observations:\n`;
      } else {
        reportText += 'Roof Damage Observations:\n';
      }
      checkedBoxes.forEach((checkbox, index) => {
        const description = roofDamageObservationDescriptions[checkbox.value];
        if (description) {
          reportText += `${index + 1}. ${description}\n\n`;
        }
      });
      
      return reportText.trim();
    }

    // Function to get selected HVAC damage observations and format them professionally
    function getSelectedHVACObservations(containerId) {
      console.log('🔍 DEBUG: getSelectedHVACObservations called with containerId:', containerId);
      
      // Try multiple search methods to find the container
      let container = document.querySelector(`[id*="${containerId}"]`)?.closest('div[style*="border: 1px solid #ddd"]');
      console.log('🔍 DEBUG: Container found (method 1):', container);
      
      if (!container) {
        // Try alternative search method
        container = document.querySelector(`[id*="${containerId}"]`)?.closest('.upload-section');
        console.log('🔍 DEBUG: Container found (method 2):', container);
      }
      
      let checkedBoxes = [];
      
      if (!container) {
        // Try direct search for checkboxes
        checkedBoxes = document.querySelectorAll(`[id*="${containerId}"] input[type="checkbox"]:checked`);
        console.log('🔍 DEBUG: Direct checkboxes found:', checkedBoxes.length);
        
        if (checkedBoxes.length === 0) {
          console.log('❌ No checkboxes found for:', containerId);
          return '';
        }
        
        console.log('🔍 DEBUG: Checked boxes found (direct):', checkedBoxes.length);
      } else {
        // Get all checked checkboxes within this container
        checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
        console.log('🔍 DEBUG: Checked boxes found:', checkedBoxes.length);
        console.log('🔍 DEBUG: Checked boxes:', checkedBoxes);
        if (checkedBoxes.length === 0) return '';
      }
      
      // Map of HVAC damage observation values to professional descriptions
      const hvacObservationDescriptions = {
        // Hail Damage Options
        'finned_coil_dents': 'Finned Coil Dents – Hailstones dented the condenser coil fins, restricting airflow.',
        'crushed_coil_fins': 'Crushed Coil Fins – Severe impacts flattened fins, reducing heat exchange efficiency.',
        'cabinet_dents': 'Cabinet Dents – Metal housing shows visible hail impact marks.',
        'bent_fan_guard': 'Bent Fan Guard – Protective grill over the fan bent from hail strike.',
        'damaged_fan_blades': 'Damaged Fan Blades – Fan blades bent or cracked by hail.',
        'paint_chipping': 'Paint Chipping – Hail has chipped exterior coating, exposing metal to rust.',
        'electrical_box_dents': 'Electrical Box Dents – Control box damaged, potentially affecting system operation.',
        'compressor_cover_damage': 'Compressor Cover Damage – Hail impact visible on compressor housing.',
        'drain_pan_deformation': 'Drain Pan Deformation – Hail has warped or dented the drain pan, risking water flow issues.',
        'protective_screen_damage': 'Protective Screen Damage – Hail has torn or displaced debris guards.',
        'hail_dent_condenser_coil': 'Hail can dent condenser coil fins, which reduces airflow and lowers cooling efficiency.',
        'severe_impacts_crush_coil': 'Severe impacts may crush coil fins, blocking air passage and overworking the system.',
        'metal_housing_dents': 'Metal housing panels often show dents or deformation, indicating direct hail impact.',
        'fan_guards_bend_warp': 'Fan guards can bend or warp from hail, potentially interfering with fan operation.',
        'hail_bend_crack_blades': 'Hail strikes may bend or crack fan blades, leading to imbalance or vibration during use.',
        'protective_paint_chip': 'Protective paint may chip away, exposing metal components to rust and corrosion.',
        'electrical_control_dents': 'Electrical control boxes can be dented, risking internal wiring damage or short circuits.',
        'compressor_covers_damaged': 'Compressor covers may be damaged, affecting protection and potentially insulation.',
        'drain_pans_deform': 'Drain pans or internal trays may deform, disrupting water drainage and increasing rust risk.',
        'debris_screens_torn': 'Debris screens or protective grilles may be torn or loosened, reducing protection from future debris or pests.',
        
        // Wind Damage Options
        'shifted_unit': 'Shifted Unit – HVAC unit displaced from its original mounting position by wind.',
        'disconnected_ducting': 'Disconnected Ducting – Wind has pulled or loosened connected ductwork.',
        'bent_fan_blades_wind': 'Bent Fan Blades – Wind-driven debris has struck and bent fan blades.',
        'top_cover_lifted': 'Top Cover Lifted – Wind has lifted or loosened the unit\'s fan cover.',
        'damaged_electrical_panel': 'Damaged Electrical Panel – Panel cover blown open or off by wind pressure.',
        'torn_insulation_wrap': 'Torn Insulation Wrap – Exterior insulation ripped away by high winds.',
        'detached_conduit_lines': 'Detached Conduit Lines – Electrical or refrigerant lines pulled loose by wind force.',
        'debris_inside_unit': 'Debris Inside Unit – Wind has carried leaves or debris into the cabinet.',
        'loose_missing_fasteners': 'Loose or Missing Fasteners – Wind has shaken or removed panel screws.',
        'tilted_mounting_base': 'Tilted Mounting Base – Unit\'s platform or pad has shifted or tilted from wind stress.',
        'wind_shift_dislodge_units': 'Strong winds can shift or dislodge HVAC units, especially those not securely mounted, leading to misalignment or disconnection.',
        'wind_disconnect_loosen_ductwork': 'Wind may disconnect or loosen ductwork, reducing airflow and system efficiency.',
        'wind_debris_bend_blades': 'Fan blades can be bent or damaged by wind-driven debris, causing noise, imbalance, or failure.',
        'wind_uplift_loosen_cover': 'Wind uplift can loosen or remove the top cover, exposing internal components to weather.',
        'electrical_panels_blown': 'Electrical panels may be blown open or damaged, increasing the risk of moisture intrusion or electrical failure.',
        'exterior_insulation_torn': 'Exterior insulation or wrap can be torn off by high winds, reducing energy efficiency and exposing components.',
        'conduit_refrigerant_pulled': 'Conduit and refrigerant lines may be pulled loose, resulting in leaks or system shutdown.',
        'wind_force_debris_inside': 'Wind can force debris inside the unit, clogging components or obstructing airflow.',
        'vibration_loosen_fasteners': 'Vibration or movement from wind may loosen fasteners, leading to rattling parts or structural instability.',
        'mounting_pads_shift_tilt': 'Mounting pads or platforms can shift or tilt, affecting drainage and putting strain on connected lines.'
      };
      
      // Build professional report text
      let reportText = 'HVAC Damage Observations:\n';
      checkedBoxes.forEach((checkbox, index) => {
        const description = hvacObservationDescriptions[checkbox.value];
        if (description) {
          reportText += `${index + 1}. ${description}\n\n`;
        }
      });
      
      return reportText.trim();
    }

    // Enhanced CompanyCam integration with persistent login
    function openCompanyCamUploader(uploaderId) {
      // This is now just a wrapper for the PICK-CAM version
      openPickCamPhotoSelector(uploaderId);
    }

    function openPickCamPhotoSelector(uploaderId) {
      currentUploader = uploaderId;
      window.currentUploadSection = uploaderId; // Store for dedicated modal
      localStorage.setItem('dar_currentUploader', uploaderId);
      
      // Get project info for enhanced modal
      const projectId = currentProjectId || document.getElementById('ccIdField')?.value;
      const businessName = document.getElementById('propertyNameInput')?.value || 'Unknown Project';
      
      if (!projectId) {
        alert('⚠️ No Project ID found. Please fetch data first with a V-ID.');
        return;
      }
      
      debugLog(`🔍 Opening PICK-CAM Modal for Project: ${projectId}`);
      debugLog(`🏢 Business: ${businessName}`);
      debugLog(`📂 Upload Section: ${uploaderId}`);
      
      // Open the dedicated modal (now for PICK-CAM)
      openDedicatedPickCamModal();
      
      // Load photos from PICK-CAM
      fetch(`/api/projects/${projectId}/dar-photos`)
      .then(res => {
        debugLog(`📡 PICK-CAM Response: ${res.status} ${res.statusText}`);
        return res.json();
      })
      .then(data => {
        debugLog(`📊 Raw API Response:`, data);
        
        // Handle error responses
        if (data.error) {
          debugLog(`❌ API Error: ${data.error}`);
          
          // Handle authentication errors specifically
          if (data.auth_required || data.error === "Not authenticated" || data.error === "Authentication failed") {
            showCompanyCamAuthError(data.message || "Authentication required", businessName, projectId, data.login_url);
          } else if (data.setup_required) {
            showCompanyCamSetupError(data.message || "CompanyCam not configured", businessName, projectId);
          } else {
            showCompanyCamError(data.message || data.error, businessName, projectId);
          }
          return;
        }
        
        // Handle new API response format
        let photos = [];
        if (data.success && data.photos) {
          // New format: {success: true, photos: [...], total_photos: 123, ...}
          photos = data.photos;
          debugLog(`🎯 Nueva respuesta API detectada: ${photos.length} fotos únicas de ${data.total_fetched} totales obtenidas`);
          debugLog(`📊 Estadísticas: ${data.pages_processed} páginas procesadas, ${data.duplicates_removed} duplicados eliminados`);
        } else if (Array.isArray(data)) {
          // Old format: direct array
          photos = data;
          debugLog(`📸 Formato anterior detectado: ${photos.length} fotos`);
        } else if (data.data && Array.isArray(data.data)) {
          // Alternative format
          photos = data.data;
          debugLog(`📸 Formato alternativo detectado: ${photos.length} fotos`);
        } else {
          debugLog(`⚠️ Formato de respuesta desconocido:`, data);
          photos = [];
        }
        
        debugLog(`📸 Procesadas ${photos.length} fotos del proyecto ${projectId}`);
        
        if (photos.length === 0) {
          debugLog(`⚠️ No se encontraron fotos para el proyecto ${projectId}`);
          showCompanyCamError(`No se encontraron fotos en el proyecto ${projectId}. Este proyecto puede estar vacío o el ID puede ser incorrecto.`, businessName, projectId);
        } else {
          // Use our PICK-CAM modal instead
          displayPhotosInDedicatedPickCamModal(data, projectId);
        }
      })
      .catch(err => {
        debugLog(`❌ Network/Fetch Error: ${err.message}`);
        showDedicatedModalError(`Network Error: ${err.message}`);
      });
    }

    // Show loading state with project info
    function showCompanyCamLoadingState(projectName, ccId) {
      // Update header
      document.getElementById('modalProjectTitle').textContent = projectName;
      document.getElementById('photoCount').innerHTML = '<div class="spinner" style="display: inline-block; margin-right: 8px; width: 16px; height: 16px;"></div>Loading photos...';
      
      // Show loading in sidebar
      document.getElementById('photosSidebar').innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #6c757d;">
          <div class="spinner" style="display: inline-block; margin: 0 auto 15px; width: 32px; height: 32px;"></div>
          <div style="font-size: 1.1em; font-weight: 500; margin-bottom: 8px;">Loading photos...</div>
          <div style="font-size: 0.9em;">Connecting to CompanyCam project</div>
        </div>
      `;
      
      // Show loading message in main viewer
      document.getElementById('mainPhotoViewer').innerHTML = `
        <div style="text-align: center; color: white;">
          <i class="fas fa-camera" style="font-size: 3em; opacity: 0.3; margin-bottom: 20px; display: block;"></i>
          <div style="font-size: 1.2em; margin-bottom: 10px;">Loading Project Photos</div>
          <div style="font-size: 0.9em; opacity: 0.7;">Project ID: ${ccId}</div>
        </div>
      `;
      
      // Hide photo controls
      document.getElementById('photoControls').style.display = 'none';
    }

    // Show photos with CompanyCam-style interface
    function showCompanyCamPhotos(photos, projectName, ccId) {
      // Handle new API response format
      let photosArray = photos;
      let stats = {};
      
      // Check if this is the new API response format
      if (photos && typeof photos === 'object' && photos.photos) {
        // New format: {success: true, photos: [...], total_photos: 123, ...}
        photosArray = photos.photos || [];
        stats = {
          total_photos: photos.total_photos || photosArray.length,
          pages_processed: photos.pages_processed || 0,
          total_fetched: photos.total_fetched || photosArray.length,
          duplicates_removed: photos.duplicates_removed || 0
        };
        
        console.log(`🎯 Nueva respuesta API detectada:`, stats);
      } else {
        // Old format: direct array
        photosArray = Array.isArray(photos) ? photos : [];
        stats = {
          total_photos: photosArray.length,
          pages_processed: 0,
          total_fetched: photosArray.length,
          duplicates_removed: 0
        };
      }
      
      // Update header with enhanced information
      document.getElementById('modalProjectTitle').textContent = projectName;
      
      if (stats.total_photos > 0) {
        let countText = `${stats.total_photos} photos`;
        if (stats.duplicates_removed > 0) {
          countText += ` (${stats.duplicates_removed} duplicates removed)`;
        }
        if (stats.pages_processed > 0) {
          countText += ` - ${stats.pages_processed} pages processed`;
        }
        document.getElementById('photoCount').textContent = countText;
      } else {
        document.getElementById('photoCount').textContent = '0 photos';
      }
      
      if (photosArray.length === 0) {
        document.getElementById('photosSidebar').innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #6c757d;">
            <i class="fas fa-info-circle" style="font-size: 1.5em; margin-bottom: 10px; display: block;"></i>
            No photos found in this project
          </div>
        `;
        return;
      }

      // Store photos data globally for easy access
      window.projectPhotos = photosArray;
      window.currentPhotoIndex = -1;
      
      // Generate sidebar thumbnails
      let sidebarHtml = '';
      let validPhotos = 0;
      let skippedPhotos = 0;
      
      photosArray.forEach((photo, idx) => {
        let thumbUrl = '';
        let originalUrl = '';
        
        debugLog(`🔍 Processing photo ${idx + 1}/${photosArray.length}: ID ${photo.id}`);
        
        if (photo.uris && Array.isArray(photo.uris)) {
          // Para mostrar thumbnails, usar 'web' o 'thumbnail'
          const thumbObj = photo.uris.find(u => u.type === 'web') || photo.uris.find(u => u.type === 'thumbnail') || photo.uris[0];
          
          // Para el enlace original: preferir 'original', luego 'web' de mayor tamaño, luego cualquiera
          let originalObj = photo.uris.find(u => u.type === 'original');
          if (!originalObj) {
            // Si no hay 'original', buscar el 'web' más grande o cualquier URI disponible
            const webUris = photo.uris.filter(u => u.type === 'web');
            if (webUris.length > 0) {
              // Tomar el primero de 'web' (suele ser el más grande)
              originalObj = webUris[0];
            } else {
              originalObj = photo.uris[0];
            }
          }
          
          thumbUrl = thumbObj?.url || thumbObj?.uri || '';
          let rawOriginalUrl = originalObj?.url || originalObj?.uri || thumbUrl;
          
          // La URL 'original' ya debería venir con el tamaño completo desde CompanyCam API
          originalUrl = rawOriginalUrl;
          debugLog(`📸 Photo ${idx + 1} Original URL: ${originalUrl.includes('rs:fit:4032') ? '✅ Large' : '⚠️ Small'} - ${originalUrl.substring(0, 80)}...`);
          
          debugLog(`📸 Photo ${idx + 1} URLs - Thumb: ${thumbUrl ? 'OK' : 'MISSING'}, Original: ${originalUrl ? 'OK' : 'MISSING'}`);
        } else {
          debugLog(`❌ Photo ${idx + 1} has no uris array`);
        }
        
        if (thumbUrl) {
          validPhotos++;
          sidebarHtml += `
            <div class="photo-thumb" data-index="${idx}" data-thumb="${thumbUrl}" data-original="${originalUrl}" 
                 style="position: relative; cursor: pointer; border: 2px solid #e9ecef; border-radius: 6px; overflow: hidden; transition: all 0.2s ease; aspect-ratio: 1;" 
                 onclick="selectPhotoForPreview(${idx})">
              <img src="${thumbUrl}" style="width: 100%; height: 100%; object-fit: cover;" 
                   onload="console.log('✅ Photo ${idx + 1} loaded successfully')" 
                   onerror="console.log('❌ Photo ${idx + 1} failed to load: ${thumbUrl}')">
              <div class="photo-check" style="display: none; position: absolute; top: 4px; right: 4px; background: #28a745; color: white; border-radius: 50%; width: 20px; height: 20px; line-height: 20px; text-align: center; font-size: 12px; font-weight: bold;">✓</div>
              <div class="photo-overlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(40, 167, 69, 0.3);"></div>
              <div class="photo-selection-border" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 3px solid #28a745; border-radius: 6px; pointer-events: none;"></div>
            </div>
          `;
        } else {
          skippedPhotos++;
          console.log(`⚠️ Photo ${idx + 1} skipped - no valid URL`);
        }
      });

      console.log(`📊 Photo rendering summary: ${validPhotos} valid, ${skippedPhotos} skipped, ${photosArray.length} total`);
      console.log(`📊 Generated HTML length: ${sidebarHtml.length} characters`);
      
      const sidebar = document.getElementById('photosSidebar');
      
      // Clear any previous content first
      sidebar.innerHTML = '';
      
      // Add HTML content
      sidebar.innerHTML = sidebarHtml;
      
      // Add visual indicator of total photos
      sidebar.style.border = `2px solid ${validPhotos === photosArray.length ? 'green' : 'orange'}`;
      sidebar.style.borderRadius = '8px';
      
      console.log(`🔧 Sidebar HTML set. Container dimensions: ${sidebar.offsetWidth}x${sidebar.offsetHeight}`);
      console.log(`🔧 Sidebar scroll height: ${sidebar.scrollHeight}px`);
      
      // Force refresh and count actual elements
      setTimeout(() => {
        const renderedPhotos = sidebar.querySelectorAll('.photo-thumb');
        console.log(`📊 Actually rendered photos: ${renderedPhotos.length} out of ${validPhotos} expected`);
        
        // Visual feedback in the count display with enhanced stats
        let finalCountText = `${renderedPhotos.length}/${photosArray.length} photos rendered`;
        if (stats.duplicates_removed > 0) {
          finalCountText += ` (${stats.duplicates_removed} duplicates removed)`;
        }
        document.getElementById('photoCount').textContent = finalCountText;
        
        if (renderedPhotos.length < validPhotos) {
          console.log(`⚠️ MISSING PHOTOS! Expected ${validPhotos}, got ${renderedPhotos.length}`);
          console.error('Photo rendering incomplete:', {
            expected: validPhotos,
            rendered: renderedPhotos.length,
            totalPhotos: photosArray.length,
            htmlLength: sidebarHtml.length,
            sidebarHeight: sidebar.offsetHeight,
            scrollHeight: sidebar.scrollHeight
          });
          
          // Make the sidebar border red to indicate problem
          sidebar.style.border = '3px solid red';
        } else {
          console.log(`✅ ALL PHOTOS RENDERED SUCCESSFULLY!`);
          sidebar.style.border = '2px solid green';
        }
      }, 1000);
      
      selectedPhotos = [];
      updateSelectedCount();
    }

    // Photo preview functionality
    let currentPhotoIndex = -1;
    
    function selectPhotoForPreview(index) {
      const photo = window.projectPhotos[index];
      const thumbElement = document.querySelector(`[data-index="${index}"]`);
      
      if (!photo || !thumbElement) return;
      
      currentPhotoIndex = index;
      
      // Update main viewer
      const originalUrl = thumbElement.getAttribute('data-original');
      document.getElementById('mainPhotoViewer').innerHTML = `
        <img src="${originalUrl}" style="max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      `;
      
      // Show controls
      document.getElementById('photoControls').style.display = 'block';
      
      // Update selection button
      const selectedUrl = thumbElement.getAttribute('data-original') || thumbElement.getAttribute('data-thumb');
      const isSelected = selectedPhotos.includes(selectedUrl);
      const toggleBtn = document.getElementById('toggleSelectionBtn');
      if (isSelected) {
        toggleBtn.innerHTML = '<i class="fas fa-check"></i> Selected';
        toggleBtn.style.background = '#28a745';
      } else {
        toggleBtn.innerHTML = '<i class="fas fa-plus"></i> Add to Selection';
        toggleBtn.style.background = '#3498db';
      }
      
      // Remove active state from all thumbs
      document.querySelectorAll('.photo-thumb').forEach(thumb => {
        thumb.style.border = '2px solid #e9ecef';
      });
      
      // Add active state to current thumb
      thumbElement.style.border = '2px solid #3498db';
      
      debugLog(`📸 Previewing photo ${index + 1} of ${window.projectPhotos.length}`);
    }

    function togglePhotoInSelection() {
      if (currentPhotoIndex === -1) return;
      
      const thumbElement = document.querySelector(`[data-index="${currentPhotoIndex}"]`);
      if (!thumbElement) return;
      
      const thumbUrl = thumbElement.getAttribute('data-thumb');
      const originalUrl = thumbElement.getAttribute('data-original');
      const selectedUrl = originalUrl || thumbUrl;
      const check = thumbElement.querySelector('.photo-check');
      const overlay = thumbElement.querySelector('.photo-overlay');
      const border = thumbElement.querySelector('.photo-selection-border');
      
      // ✅ Safety check: If these elements don't exist, this is the new modal
      if (!check || !overlay || !border) {
        debugLog('⚠️ Old photo selection system called on new modal - skipping');
        return;
      }
      
      if (selectedPhotos.includes(selectedUrl)) {
        // Remove from selection
        selectedPhotos = selectedPhotos.filter(url => url !== selectedUrl);
        check.style.display = 'none';
        overlay.style.display = 'none';
        border.style.display = 'none';
        
        document.getElementById('toggleSelectionBtn').innerHTML = '<i class="fas fa-plus"></i> Add to Selection';
        document.getElementById('toggleSelectionBtn').style.background = '#3498db';
      } else {
        // Add to selection
        selectedPhotos.push(selectedUrl);
        check.style.display = 'block';
        overlay.style.display = 'block';
        border.style.display = 'block';
        
        document.getElementById('toggleSelectionBtn').innerHTML = '<i class="fas fa-check"></i> Selected';
        document.getElementById('toggleSelectionBtn').style.background = '#28a745';
      }
      
      updateSelectedCount();
    }

    function downloadCurrentPhoto() {
      if (currentPhotoIndex === -1) return;
      
      const thumbElement = document.querySelector(`[data-index="${currentPhotoIndex}"]`);
      if (!thumbElement) return;
      
      const originalUrl = thumbElement.getAttribute('data-original');
      const link = document.createElement('a');
      link.href = originalUrl;
      link.download = `companycam-photo-${currentPhotoIndex + 1}.jpg`;
      link.target = '_blank';
      link.click();
      
      debugLog(`⬇️ Downloaded photo ${currentPhotoIndex + 1}`);
    }

    // Show error with project info
    function showCompanyCamError(error, projectName, ccId) {
      // Update header
      document.getElementById('modalProjectTitle').textContent = `${projectName} - Error`;
      document.getElementById('photoCount').innerHTML = '<span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Failed to load</span>';
      
      // Show error in sidebar
      document.getElementById('photosSidebar').innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #dc3545;">
          <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 15px; display: block;"></i>
          <div style="font-size: 1.1em; font-weight: 500; margin-bottom: 10px;">Error Loading Photos</div>
          <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">${error}</div>
          <button type="button" class="btn btn-primary" onclick="openInCompanyCam('${ccId}')" style="font-size: 0.9em;">
            <i class="fas fa-external-link-alt"></i> Open in CompanyCam
          </button>
        </div>
      `;
      
      // Show error message in main viewer
      document.getElementById('mainPhotoViewer').innerHTML = `
        <div style="text-align: center; color: white;">
          <i class="fas fa-exclamation-triangle" style="font-size: 3em; color: #dc3545; margin-bottom: 20px; display: block;"></i>
          <div style="font-size: 1.2em; margin-bottom: 10px; color: #dc3545;">Failed to Load Photos</div>
          <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 20px;">Project: ${projectName} (ID: ${ccId})</div>
          <div style="font-size: 0.8em; color: #888; margin-bottom: 20px;">${error}</div>
          <button type="button" class="btn btn-primary" onclick="openInCompanyCam('${ccId}')">
            <i class="fas fa-external-link-alt"></i> Try Opening in CompanyCam
          </button>
        </div>
      `;
      
      // Hide photo controls
      document.getElementById('photoControls').style.display = 'none';
    }

    // Show authentication error with login option
    function showCompanyCamAuthError(error, projectName, ccId, loginUrl) {
      // Update header
      document.getElementById('modalProjectTitle').textContent = `${projectName} - Authentication Required`;
      document.getElementById('photoCount').innerHTML = '<span style="color: #ffc107;"><i class="fas fa-lock"></i> Authentication Required</span>';
      
      // Show auth error in sidebar
      document.getElementById('photosSidebar').innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #ffc107;">
          <i class="fas fa-lock" style="font-size: 2em; margin-bottom: 15px; display: block;"></i>
          <div style="font-size: 1.1em; font-weight: 500; margin-bottom: 10px;">Authentication Required</div>
          <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">${error}</div>
          <button type="button" class="btn btn-warning" onclick="authenticateWithCompanyCam()" style="font-size: 0.9em; margin-bottom: 10px;">
            <i class="fas fa-sign-in-alt"></i> Login to CompanyCam
          </button>
          <br>
          <button type="button" class="btn btn-secondary" onclick="openInCompanyCam('${ccId}')" style="font-size: 0.9em;">
            <i class="fas fa-external-link-alt"></i> Open in CompanyCam
          </button>
        </div>
      `;
      
      // Show auth error message in main viewer
      document.getElementById('mainPhotoViewer').innerHTML = `
        <div style="text-align: center; color: white;">
          <i class="fas fa-lock" style="font-size: 3em; color: #ffc107; margin-bottom: 20px; display: block;"></i>
          <div style="font-size: 1.2em; margin-bottom: 10px; color: #ffc107;">Authentication Required</div>
          <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 20px;">Project: ${projectName} (ID: ${ccId})</div>
          <div style="font-size: 0.8em; color: #888; margin-bottom: 20px;">${error}</div>
          <button type="button" class="btn btn-warning" onclick="authenticateWithCompanyCam()" style="margin-bottom: 10px;">
            <i class="fas fa-sign-in-alt"></i> Login to CompanyCam
          </button>
          <br>
          <button type="button" class="btn btn-secondary" onclick="openInCompanyCam('${ccId}')">
            <i class="fas fa-external-link-alt"></i> Try Opening in CompanyCam
          </button>
        </div>
      `;
      
      // Hide photo controls
      document.getElementById('photoControls').style.display = 'none';
    }

    // Show setup error for CompanyCam configuration
    function showCompanyCamSetupError(error, projectName, ccId) {
      // Update header
      document.getElementById('modalProjectTitle').textContent = `${projectName} - Setup Required`;
      document.getElementById('photoCount').innerHTML = '<span style="color: #17a2b8;"><i class="fas fa-cog"></i> Setup Required</span>';
      
      // Show setup error in sidebar
      document.getElementById('photosSidebar').innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #17a2b8;">
          <i class="fas fa-cog" style="font-size: 2em; margin-bottom: 15px; display: block;"></i>
          <div style="font-size: 1.1em; font-weight: 500; margin-bottom: 10px;">CompanyCam Setup Required</div>
          <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">${error}</div>
          <div style="font-size: 0.8em; color: #6c757d; margin-bottom: 15px;">
            Please contact your administrator to configure CompanyCam integration.
          </div>
          <button type="button" class="btn btn-info" onclick="openInCompanyCam('${ccId}')" style="font-size: 0.9em;">
            <i class="fas fa-external-link-alt"></i> Open in CompanyCam
          </button>
        </div>
      `;
      
      // Show setup error message in main viewer
      document.getElementById('mainPhotoViewer').innerHTML = `
        <div style="text-align: center; color: white;">
          <i class="fas fa-cog" style="font-size: 3em; color: #17a2b8; margin-bottom: 20px; display: block;"></i>
          <div style="font-size: 1.2em; margin-bottom: 10px; color: #17a2b8;">CompanyCam Setup Required</div>
          <div style="font-size: 0.9em; opacity: 0.7; margin-bottom: 20px;">Project: ${projectName} (ID: ${ccId})</div>
          <div style="font-size: 0.8em; color: #888; margin-bottom: 20px;">${error}</div>
          <div style="font-size: 0.8em; color: #888; margin-bottom: 20px;">
            Please contact your administrator to configure CompanyCam integration.
          </div>
          <button type="button" class="btn btn-info" onclick="openInCompanyCam('${ccId}')">
            <i class="fas fa-external-link-alt"></i> Try Opening in CompanyCam
          </button>
        </div>
      `;
      
      // Hide photo controls
      document.getElementById('photoControls').style.display = 'none';
    }

    // Authenticate with CompanyCam
    function authenticateWithCompanyCam() {
      debugLog(`🔐 Iniciando autenticación con CompanyCam...`);
      
      // Redirect to CompanyCam OAuth
      const loginUrl = '/api/companycam/login?next=' + encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = loginUrl;
    }

    // Open project directly in CompanyCam
    function openInCompanyCam(ccId) {
      const url = `https://app.companycam.com/projects/${ccId}`;
      window.open(url, '_blank');
      debugLog(`🔗 Opened CompanyCam project: ${url}`);
    }

    // Photo selection functionality
    // selectedPhotos is already defined globally above

    function togglePhotoSelection(photoElement) {
      // Use data-original for the full-size URL, fallback to data-thumb
      const url = photoElement.getAttribute('data-original') || photoElement.getAttribute('data-thumb');
      const check = photoElement.querySelector('.photo-check');
      const overlay = photoElement.querySelector('.photo-overlay');
      
      // ✅ Safety check: If these elements don't exist, this is the new modal  
      if (!check || !overlay) {
        debugLog('⚠️ Old photo selection system called on new modal - skipping');
        return;
      }
      
      if (selectedPhotos.includes(url)) {
        // Deselect
        selectedPhotos = selectedPhotos.filter(u => u !== url);
        photoElement.style.border = '2px solid #e9ecef';
        check.style.display = 'none';
        overlay.style.display = 'none';
      } else {
        // Select
        selectedPhotos.push(url);
        photoElement.style.border = '2px solid #28a745';
        check.style.display = 'block';
        overlay.style.display = 'block';
      }
      
      updateSelectedCount();
    }

    function selectAllPhotos() {
      const photoThumbs = document.querySelectorAll('.photo-thumb');
      selectedPhotos = [];
      
      photoThumbs.forEach(thumb => {
        // Use data-original for the full-size URL, fallback to data-thumb
        const url = thumb.getAttribute('data-original') || thumb.getAttribute('data-thumb');
        selectedPhotos.push(url);
        
        // ✅ Safety check for old modal elements
        const check = thumb.querySelector('.photo-check');
        const overlay = thumb.querySelector('.photo-overlay');
        const border = thumb.querySelector('.photo-selection-border');
        
        if (check && overlay && border) {
          check.style.display = 'block';
          overlay.style.display = 'block';
          border.style.display = 'block';
        }
      });
      
      updateSelectedCount();
      
      // Update toggle button if we're viewing a photo
      if (currentPhotoIndex !== -1) {
        document.getElementById('toggleSelectionBtn').innerHTML = '<i class="fas fa-check"></i> Selected';
        document.getElementById('toggleSelectionBtn').style.background = '#28a745';
      }
      
      debugLog(`✅ Selected all ${selectedPhotos.length} photos`);
    }

    function clearAllPhotos() {
      const photoThumbs = document.querySelectorAll('.photo-thumb');
      selectedPhotos = [];
      
      photoThumbs.forEach(thumb => {
        // ✅ Safety check for old modal elements
        const check = thumb.querySelector('.photo-check');
        const overlay = thumb.querySelector('.photo-overlay');
        const border = thumb.querySelector('.photo-selection-border');
        
        if (check && overlay && border) {
          check.style.display = 'none';
          overlay.style.display = 'none';
          border.style.display = 'none';
        }
      });
      
      updateSelectedCount();
      
      // Update toggle button if we're viewing a photo
      if (currentPhotoIndex !== -1) {
        document.getElementById('toggleSelectionBtn').innerHTML = '<i class="fas fa-plus"></i> Add to Selection';
        document.getElementById('toggleSelectionBtn').style.background = '#3498db';
      }
      
      debugLog(`🗑️ Cleared all photo selections`);
    }

    function updateSelectedCount() {
      const countElement = document.getElementById('selectedCountDisplay');
      if (countElement) {
        countElement.textContent = selectedPhotos.length;
      }
    }

    // 🎯 FUNCIÓN PARA MANEJAR DROPDOWNS DE SECCIONES
    function toggleSection(sectionId) {
      const header = document.querySelector(`[data-section="${sectionId}"]`);
      const content = document.getElementById(`${sectionId}-content`);
      const icon = header.querySelector('i');
      
      if (!header || !content) {
        console.log(`❌ Elementos no encontrados para sección: ${sectionId}`);
        return;
      }
      
      // Toggle expanded state
      const isExpanded = header.classList.contains('expanded');
      
      if (isExpanded) {
        // Collapse
        header.classList.remove('expanded');
        content.classList.remove('expanded');
        icon.style.transform = 'rotate(0deg)';
        console.log(`🔽 Sección ${sectionId} colapsada`);
      } else {
        // Expand
        header.classList.add('expanded');
        content.classList.add('expanded');
        icon.style.transform = 'rotate(180deg)';
        console.log(`🔼 Sección ${sectionId} expandida`);
      }
    }

    // 🎯 FUNCIÓN PARA EXPANDIR TODAS LAS SECCIONES
    function expandAllSections() {
      const headers = document.querySelectorAll('.dropdown-header');
      headers.forEach(header => {
        const sectionId = header.getAttribute('data-section');
        const content = document.getElementById(`${sectionId}-content`);
        const icon = header.querySelector('i');
        
        if (content) {
          header.classList.add('expanded');
          content.classList.add('expanded');
          icon.style.transform = 'rotate(180deg)';
        }
      });
      console.log('🔼 Todas las secciones expandidas');
    }

    // 🎯 FUNCIÓN PARA COLAPSAR TODAS LAS SECCIONES
    function collapseAllSections() {
      const headers = document.querySelectorAll('.dropdown-header');
      headers.forEach(header => {
        const sectionId = header.getAttribute('data-section');
        const content = document.getElementById(`${sectionId}-content`);
        const icon = header.querySelector('i');
        
        if (content) {
          header.classList.remove('expanded');
          content.classList.remove('expanded');
          icon.style.transform = 'rotate(0deg)';
        }
      });
      console.log('🔽 Todas las secciones colapsadas');
    }

    // 🎯 INICIALIZACIÓN AUTOMÁTICA DE DROPDOWNS - VERSIÓN ROBUSTA
    function initializeDropdowns() {
      console.log('🎯 Inicializando dropdowns...');
      
      // Verificar que los elementos existan
      const dropdowns = document.querySelectorAll('.section-dropdown');
      console.log(`🔍 Encontrados ${dropdowns.length} dropdowns`);
      
      if (dropdowns.length === 0) {
        console.log('❌ No se encontraron dropdowns - verificando estructura HTML');
        return;
      }
      
                // Aplicar estilos iniciales y event listeners
          dropdowns.forEach((dropdown, index) => {
            const header = dropdown.querySelector('.dropdown-header');
            const content = dropdown.querySelector('.dropdown-content');
            
            if (header && content) {
              // Obtener el sectionId ANTES de usarlo
              const sectionId = header.getAttribute('data-section');
              
              // Asegurar que estén colapsados inicialmente
              header.classList.remove('expanded');
              content.classList.remove('expanded');
              
              // Remover event listeners existentes para evitar duplicados
              header.removeEventListener('click', header._dropdownClickHandler);
              
              // Crear nuevo event listener
              header._dropdownClickHandler = function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log(`🖱️ Click en dropdown: ${sectionId}`);
                toggleSection(sectionId);
              };
              
              // Agregar event listener
              header.addEventListener('click', header._dropdownClickHandler);
              
              // Agregar indicador visual de que es clickeable
              header.style.cursor = 'pointer';
              
              console.log(`✅ Dropdown ${index + 1} inicializado: ${sectionId}`);
            } else {
              console.log(`❌ Dropdown ${index + 1} incompleto - header: ${!!header}, content: ${!!content}`);
            }
          });
      
      console.log('🎯 Dropdowns inicializados correctamente');
      
      // Verificar que las funciones estén disponibles
      if (typeof toggleSection === 'function') {
        console.log('✅ Función toggleSection disponible');
      } else {
        console.log('❌ Función toggleSection NO disponible');
      }
    }

    // 🎯 EJECUTAR INICIALIZACIÓN CUANDO EL DOM ESTÉ LISTO
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 DOM cargado, inicializando dropdowns...');
      setTimeout(initializeDropdowns, 100); // Pequeño delay para asegurar que todo esté listo
    });

    // 🎯 INICIALIZACIÓN ADICIONAL PARA CASOS DE CARGA DINÁMICA
    window.addEventListener('load', function() {
      console.log('🌐 Página completamente cargada, verificando dropdowns...');
      setTimeout(initializeDropdowns, 200);
    });

    // 🎯 FUNCIÓN MANUAL PARA DEBUGGING (llamar desde consola)
    window.debugDropdowns = function() {
      console.log('🔧 Debugging dropdowns manualmente...');
      console.log('🔍 Función toggleSection:', typeof toggleSection);
      console.log('🔍 Función initializeDropdowns:', typeof initializeDropdowns);
      
      const dropdowns = document.querySelectorAll('.section-dropdown');
      console.log('🔍 Dropdowns encontrados:', dropdowns.length);
      
      dropdowns.forEach((dropdown, index) => {
        const header = dropdown.querySelector('.dropdown-header');
        const content = dropdown.querySelector('.dropdown-content');
        const sectionId = header?.getAttribute('data-section');
        
        console.log(`🔍 Dropdown ${index + 1}:`, {
          header: !!header,
          content: !!content,
          sectionId: sectionId,
          hasClickHandler: !!header?._dropdownClickHandler,
          headerHTML: header?.outerHTML?.substring(0, 100) + '...',
          contentHTML: content?.outerHTML?.substring(0, 100) + '...'
        });
      });
      
      // Verificar que las funciones estén disponibles
      if (typeof toggleSection === 'function') {
        console.log('✅ Función toggleSection disponible');
      } else {
        console.log('❌ Función toggleSection NO disponible');
      }
      
      // Intentar inicializar manualmente
      console.log('🔄 Inicializando dropdowns...');
      initializeDropdowns();
      
      console.log('🔧 Debug completado');
    }

    function addSelectedPhotos() {
      if (selectedPhotos.length === 0) {
        alert('⚠️ Please select at least one photo');
        return;
      }
      
      if (!currentUploader) {
        alert('⚠️ No upload section selected');
        return;
      }
      
      debugLog(`✅ Adding ${selectedPhotos.length} photos to ${currentUploader}`);
      
      // === VALIDATION: 4 PHOTOS MAX PER SECTION ===
      const thumbsContainer = document.getElementById(currentUploader + '_thumbs');
      if (thumbsContainer) {
        const existingPhotos = thumbsContainer.querySelectorAll('.photo-wrapper');
        let selectedFiles = [...selectedPhotos]; // Copy array for manipulation
        
        // Check if this is the 9th subsection (no photo limit)
        const isNinthSection = currentUploader.endsWith('_9');
        
        // Check if this is a single-photo section (5 specific sections)
        // Note: property_damage_highlights is NOT in this list - it has no restrictions
        const singlePhotoSections = [
          'identifying_photo_address', 'business_identifier_sign',
          'roof_access', 'rooftop_obstructions', 
          'noaa_swath_screenshot', 'impact_report_screenshot',
          'ground_front', 'ground_back', 'ground_left_side', 'ground_right_side',
          'aerial_overview', 'property_entrance'
        ];
        const isSinglePhotoSection = singlePhotoSections.includes(currentUploader);
        
        if (isSinglePhotoSection && existingPhotos.length + selectedFiles.length > 1) {
          alert(`⚠️ This section allows only 1 photo. Currently: ${existingPhotos.length}, trying to add: ${selectedFiles.length}`);
          if (existingPhotos.length >= 1) {
            return; // No space left
          }
          // Trim to only 1 photo
          selectedFiles = selectedFiles.slice(0, 1);
          debugLog(`🚨 SINGLE PHOTO SECTION: Only adding 1 photo`);
        } else if (!isNinthSection && !isSinglePhotoSection && existingPhotos.length + selectedFiles.length > 4) {
          alert(`Cannot add more photos. Maximum 4 photos allowed per section. Currently: ${existingPhotos.length}, trying to add: ${selectedFiles.length}`);
          if (existingPhotos.length >= 4) {
            return; // No space left
          }
          // Trim to fit within limit
          selectedFiles = selectedFiles.slice(0, 4 - existingPhotos.length);
          debugLog(`🚨 TRIMMED: Only adding ${selectedFiles.length} photos to stay within limit`);
        } else if (isNinthSection) {
          debugLog(`🚀 UNLIMITED: Section ${currentUploader} allows unlimited photos`);
        }
        
        // Add photos to the current uploader
        selectedFiles.forEach((url, index) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'photo-wrapper';
          wrapper.dataset.photoIndex = index;
          wrapper.dataset.photoUrl = url;
          
          const img = document.createElement('img');
          img.src = url;
          img.style.width = '80px';
          img.style.height = '80px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '8px';
          img.style.border = '2px solid #38c3ff';
          img.style.margin = '0';
          
          const removeBtn = document.createElement('div');
          removeBtn.className = 'photo-remove-btn';
          removeBtn.innerHTML = '×';
          removeBtn.title = 'Remove photo';
          removeBtn.onclick = function() {
            removePhotoFromThumbs(wrapper, currentUploader);
          };
          
          wrapper.appendChild(img);
          wrapper.appendChild(removeBtn);
          thumbsContainer.appendChild(wrapper);
        });
      }
      
      closeUploadModal();
      debugLog(`🎉 Successfully added ${selectedPhotos.length} photos`);
    }

    function removePhotoFromThumbs(wrapper, uploaderId) {
      if (wrapper && wrapper.parentNode) {
        wrapper.parentNode.removeChild(wrapper);
        debugLog(`🗑️ Photo removed from ${uploaderId}`);
      }
    }

    function closeUploadModal() {
      document.getElementById('uploadModal').style.display = 'none';
      currentUploader = null;
      selectedPhotos = [];
      currentPhotoIndex = -1;
      
      // Reset modal content
      document.getElementById('modalProjectTitle').textContent = 'Loading Project...';
      document.getElementById('photoCount').textContent = 'Loading...';
      document.getElementById('photosSidebar').innerHTML = '';
      document.getElementById('mainPhotoViewer').innerHTML = `
        <div style="text-align: center;">
          <i class="fas fa-image" style="font-size: 3em; opacity: 0.3; margin-bottom: 20px; display: block;"></i>
          Select a photo to preview
        </div>
      `;
      document.getElementById('photoControls').style.display = 'none';
      document.getElementById('selectedCountDisplay').textContent = '0';
      
      debugLog('📴 CompanyCam modal closed');
    }

    function browseLocalFiles() {
      if (!currentUploader) {
        alert('⚠️ No upload section selected');
        return;
      }

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true; // Allow multiple file selection
      
      input.onchange = function(e) {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        debugLog(`📁 Selected ${files.length} local files`);
        
        const thumbsContainer = document.getElementById(currentUploader + '_thumbs');
        if (!thumbsContainer) {
          alert('❌ Upload container not found');
          return;
        }
        
        // Process each file
        files.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function(evt) {
            const wrapper = document.createElement('div');
            wrapper.className = 'photo-wrapper';
            wrapper.dataset.fileName = file.name;
            wrapper.dataset.fileIndex = index;
            
            const img = document.createElement('img');
            img.src = evt.target.result;
            img.style.width = '80px';
            img.style.height = '80px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '8px';
            img.style.border = '2px solid #38c3ff';
            img.style.margin = '0';
            img.title = file.name;
            
            const removeBtn = document.createElement('div');
            removeBtn.className = 'photo-remove-btn';
            removeBtn.innerHTML = '×';
            removeBtn.title = 'Remove photo';
            removeBtn.onclick = function() {
              removePhotoFromThumbs(wrapper, currentUploader);
            };
            
            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            thumbsContainer.appendChild(wrapper);
            
            if (index === files.length - 1) {
              debugLog(`🎉 Successfully added ${files.length} local files`);
            }
          };
          reader.readAsDataURL(file);
        });
        
        closeUploadModal();
      };
      
      input.click();
    }

    // Preview functions
    function openPreviewModal() {
      document.getElementById('previewModal').style.display = 'flex';
      // Add preview generation logic here
    }

    function closePreviewModal() {
      document.getElementById('previewModal').style.display = 'none';
    }

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey && e.target.tagName.toLowerCase() === 'input') {
        e.preventDefault();
        const nextBtn = document.querySelector('.form-step.active .btn-primary');
        if (nextBtn && !nextBtn.disabled) {
          nextBtn.click();
        }
      }
    });

    // Initialize everything
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('🚀 Complete DAR System initialized');
      updateProgress(1);
      
      // Setup dynamic functionality
      setupTradeTypes();
      setupStormTypes();
      generatePhotoUploaders();
      
      // Confirmed damage logic
      const confirmedDamageCheckbox = document.getElementById('confirmedDamageCheckbox');
      const severitySection = document.getElementById('severitySection');
      if (confirmedDamageCheckbox) {
        confirmedDamageCheckbox.addEventListener('change', function() {
          severitySection.style.display = this.checked ? '' : 'none';
        });
      }

      // Preview button
  
      
      // Focus on V-ID input
      document.getElementById('vIdInput').focus();
    });

    // Debug function for browser console
    window.debugMondayAPI = function(vId) {
      console.log('🔧 DEBUG: Testing with V-ID:', vId);
      document.getElementById('vIdInput').value = vId;
      fetchMondayData();
    };

    // Test connectivity on page load
    window.testAPIConnection = function() {
      console.log('🔧 Testing API connection...');
      fetch('/api/fetch-monday', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ v_id: 'TEST' })
      })
      .then(res => {
        console.log('🔧 API Response status:', res.status);
        return res.json();
      })
      .then(data => {
        console.log('🔧 API Response data:', data);
      })
      .catch(err => {
        console.error('🔧 API Connection failed:', err);
      });
    };

    // Enhanced PDF Report Generation
    async function generatePDFReport() {
      debugLog('📄 Starting PDF generation...');
      
      const btn = document.getElementById('exportPdfBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
      btn.disabled = true;

      try {
        // Collect all form data
        debugLog('📊 Collecting form data...');
        const formData = collectAllFormData();
        debugLog(`📊 Form data collected: ${JSON.stringify(formData, null, 2)}`);
        
        // Collect all selected photos
        debugLog('📸 Collecting photos...');
        const photoData = await collectAllPhotos();
        debugLog(`📸 Photo data collected: ${JSON.stringify(Object.keys(photoData), null, 2)}`);
        
        // Generate HTML content for PDF
        debugLog('🔨 Generating PDF content...');
        const pdfContent = generatePDFContent(formData, photoData);
        debugLog(`🔨 PDF content length: ${pdfContent.length} characters`);
        debugLog(`🔨 PDF content preview: ${pdfContent.substring(0, 500)}...`);
        
        // Create temporary container for PDF generation
        debugLog('🏗️ Creating temporary container...');
        const tempContainer = document.createElement('div');
        tempContainer.innerHTML = pdfContent;
        tempContainer.style.position = 'absolute';
        tempContainer.style.left = '-9999px';
        tempContainer.style.top = '-9999px';
        tempContainer.style.backgroundColor = 'white';
        tempContainer.style.width = '800px';
        tempContainer.style.minHeight = '1000px';
        document.body.appendChild(tempContainer);
        debugLog(`🏗️ Container created with ${tempContainer.children.length} children`);
        
        // Wait for all images to load before generating PDF
        debugLog('📸 Waiting for images to load...');
        const images = tempContainer.querySelectorAll('img');
        debugLog(`📸 Found ${images.length} images to load`);
        
        const imagePromises = Array.from(images).map((img, index) => {
          return new Promise((resolve) => {
            if (img.complete) {
              debugLog(`✅ Image ${index + 1} already loaded`);
              resolve();
            } else {
              img.onload = () => {
                debugLog(`✅ Image ${index + 1} loaded successfully`);
                resolve();
              };
              img.onerror = () => {
                debugLog(`❌ Image ${index + 1} failed to load, continuing anyway`);
                resolve(); // Still resolve to not block PDF generation
              };
              // Add timeout as fallback
              setTimeout(() => {
                debugLog(`⏰ Image ${index + 1} timeout, continuing anyway`);
                resolve();
              }, 5000);
            }
          });
        });
        
        // Wait for all images with overall timeout
        await Promise.race([
          Promise.all(imagePromises),
          new Promise(resolve => setTimeout(() => {
            debugLog('⏰ Image loading timeout reached, proceeding with PDF generation');
            resolve();
          }, 10000))
        ]);
        
        debugLog('📸 Image loading complete, proceeding with PDF generation');
        
        // Simplified PDF options for better compatibility
        const opt = {
          margin: 0.5,
          filename: `DAR_Report_${formData.vId || 'Unknown'}_${new Date().toISOString().split('T')[0]}.pdf`,
            image: { type: 'jpeg', quality: 1.0 },
          html2canvas: { 
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
          },
          jsPDF: { 
            unit: 'in', 
            format: 'letter', 
            orientation: 'portrait'
          }
        };
        
        debugLog('📋 Using simplified PDF options for better compatibility');
        debugLog(`📄 Container dimensions: ${tempContainer.offsetWidth}x${tempContainer.offsetHeight}`);
        
        // Simplified PDF generation approach
        debugLog('📄 Starting simplified PDF conversion...');
        debugLog(`📄 Container content preview: ${tempContainer.innerHTML.substring(0, 200)}...`);
        
        // Ensure container is rendered at full opacity off-screen for accurate capture
        tempContainer.style.position = 'fixed';
        tempContainer.style.left = '-99999px';
        tempContainer.style.top = '0px';
        tempContainer.style.zIndex = '-1';
        tempContainer.style.visibility = 'visible';
        tempContainer.style.opacity = '1';
        
        try {
          // Check if html2pdf is available
          if (typeof html2pdf === 'undefined') {
            throw new Error('html2pdf library not loaded');
          }
          
          debugLog('📄 Using ultra-simple PDF generation method...');
          
          // Ultra-simple approach
          const element = tempContainer;
          const filename = `DAR_Report_${formData.vId || 'Unknown'}_${new Date().toISOString().split('T')[0]}.pdf`;
          
          await html2pdf()
            .from(element)
            .set({
              margin: [10, 10, 10, 10],
              filename: filename,
              html2canvas: { 
                scale: 2.5,
                useCORS: true,
                allowTaint: true,
                backgroundColor: null, // 🎯 CLAVE: Sin fondo blanco que opaca
                imageTimeout: 15000,
                quality: 1.0,
                dpi: 192,
                letterRendering: true,
                ignoreElements: function(element) {
                  return false;
                },
                logging: true // 🎯 Activar logging para debug
              },
              jsPDF: { 
                unit: 'pt',
                format: 'letter', 
                orientation: 'portrait',
                compress: false,
                putOnlyUsedFonts: true
              }
            })
            .save();
          
          debugLog('🎉 Ultra-simple PDF generation completed!');
          
        } catch (pdfError) {
          debugLog(`❌ PDF generation error: ${pdfError.message}`);
          console.error('PDF Error Details:', pdfError);
          
          // Final fallback: window.print() approach
          debugLog('🔄 Using print fallback...');
          alert('PDF generation failed. Opening print dialog instead...');
          
          // Create a new window with the content
          const printWindow = window.open('', '_blank');
          printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <title>DAR Report - ${formData.vId}</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                img { max-width: 100%; height: auto; }
                @media print { body { margin: 0; } }
              </style>
            </head>
            <body>
              ${tempContainer.innerHTML}
            </body>
            </html>
          `);
          printWindow.document.close();
          
          setTimeout(() => {
            printWindow.print();
          }, 1000);
          
          debugLog('🖨️ Print dialog opened as fallback');
        }
        
        // Cleanup
        document.body.removeChild(tempContainer);
        debugLog('🧹 Cleanup completed');
        
      } catch (error) {
        debugLog(`❌ PDF generation failed: ${error.message}`);
        alert(`Error generating PDF: ${error.message}`);
      } finally {
        // Reset button
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    

    // Collect all photos from upload sections - VERSIÓN MEJORADA POR CHATGPT
    // Collect all photos from upload sections - VERSIÓN MEJORADA POR CHATGPT
    async function collectAllPhotos() {
      const photoSections = [
        'identifying_photo_address', 'business_identifier_sign',
        'roof_access', 'rooftop_obstructions', 'noaa_swath_screenshot', 'impact_report_screenshot',
        'ground_front', 'ground_front_left', 'ground_front_right', 'ground_left_side',
        'ground_right_side', 'ground_back', 'aerial_overview', 'property_entrance', 'test_square_photo', 'manufacturer_tag_photo_1', 'manufacturer_tag_photo_2', 'manufacturer_tag_photo_3', 'manufacturer_tag_photo_4', 'manufacturer_tag_photo_5', 'manufacturer_tag_photo_6', 'manufacturer_tag_photo_7', 'manufacturer_tag_photo_8', 'manufacturer_tag_photo_9'
      ];
      
      const photoData = {};
      
      // Collect single photos (preserve original links when available)
      for (const section of photoSections) {
        const container = document.getElementById(section + '_thumbs');
        if (!container) {
          console.log(`🔍 Section ${section}: Container not found`);
          continue;
        }

        const thumbs = Array.from(container.querySelectorAll('.companycam-thumb'));
        if (thumbs.length > 0) {
          const images = [];
          const links = [];
          thumbs.forEach((t, index) => {
            const img = t.querySelector('img');
            if (img) {
              images.push(img.src);
              console.log(`📸 [COLLECT] ${section}[${index}] Thumb: ${img.src}`);
            }
            const originalUrl = t.dataset.original || (img ? img.src : '');
            links.push(originalUrl);
            console.log(`📸 [COLLECT] ${section}[${index}] Original: ${originalUrl}`);
            
            // Verify the URLs are accessible
            if (img && img.src) {
              console.log(`🔗 [COLLECT] Testing URL accessibility: ${img.src.substring(0, 100)}...`);
            }
          });
          if (images.length > 0) {
            photoData[section] = { images, links };
            console.log(`✅ ${section}: Added ${images.length} photos with original URLs`);
            console.log(`🔍 DEBUG: Estructura guardada para ${section}:`, photoData[section]);
          }
          continue;
        }

        const images = Array.from(container.querySelectorAll('img'));
        if (images.length > 0) {
          const arr = images.map(img => img.src);
          photoData[section] = { images: arr, links: arr };
        }
      }
      
      // Collect multi-photos (interior, HVAC, exterior windows, exterior components, roof damage)
      const multiSections = ['interior_photo', 'hvac_damage_photo', 'ground_exterior_photo', 'exterior_components_photo', 'roof_damage_photo'];
      console.log('🔍 DEBUG: Processing multiSections:', multiSections);
      for (const prefix of multiSections) {
        for (let i = 1; i <= 9; i++) {
          const sectionId = `${prefix}_${i}`;
          const container = document.getElementById(sectionId + '_thumbs');
          console.log('🔍 DEBUG: Processing section:', sectionId, 'Container found:', !!container);
          // Special handling for different photo types - use observations checkboxes
          let explanation = '';
          if (prefix === 'interior_photo' && (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9)) {
            explanation = getSelectedObservations(`${prefix}_${i}`);
          } else if (prefix === 'hvac_damage_photo' && (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9)) {
            console.log('🔍 DEBUG: Calling getSelectedHVACObservations for:', `${prefix}_${i}`);
            explanation = getSelectedHVACObservations(`${prefix}_${i}`);
            console.log('🔍 DEBUG: HVAC Explanation result:', explanation);
          } else if (prefix === 'ground_exterior_photo' && (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9)) {
            explanation = getSelectedExteriorObservations(`${prefix}_${i}`);
          } else if (prefix === 'exterior_components_photo' && (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9)) {
            console.log('🔍 DEBUG: Calling getSelectedExteriorComponentsObservations for:', `${prefix}_${i}`);
            explanation = getSelectedExteriorComponentsObservations(`${prefix}_${i}`);
            console.log('🔍 DEBUG: Exterior Components Explanation result:', explanation);
          } else if (prefix === 'roof_damage_photo' && (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9)) {
            console.log('🔍 DEBUG: Calling getSelectedRoofDamageObservations for:', `${prefix}_${i}`);
            explanation = getSelectedRoofDamageObservations(`${prefix}_${i}`);
            console.log('🔍 DEBUG: Explanation result:', explanation);
          } else {
            const explanationEl = document.getElementById(`${prefix}_explanation_${i}`);
            explanation = explanationEl?.value || '';
          }
          
          if (container) {
            const wrappers = container.querySelectorAll('.photo-wrapper');
            if (wrappers.length > 0) {
              const images = [];
              const links = [];
              wrappers.forEach(w => {
                const img = w.querySelector('img');
                if (img) {
                  images.push(img.src);
                  const photoUrl = w.dataset.photoUrl || img.src;
                  links.push(photoUrl);
                  console.log(`📸 ${sectionId}: Wrapper photo=${img.src.substring(0, 80)}..., URL=${photoUrl.substring(0, 80)}...`);
                }
              });
              if (images.length > 0) {
                photoData[sectionId] = {
                  images: images,
                  links: links,
                  explanation: explanation
                };
                console.log(`✅ ${sectionId}: Added ${images.length} wrapper photos`);
              }
            } else {
              // Support for `.companycam-thumb` elements (store original links)
              const thumbs = Array.from(container.querySelectorAll('.companycam-thumb'));
              if (thumbs.length > 0) {
                const images = [];
                const links = [];
              thumbs.forEach(t => {
                const img = t.querySelector('img');
                if (img) images.push(img.src);
                const originalUrl = t.dataset.original || (img ? img.src : '');
                links.push(originalUrl);
                console.log(`📸 ${sectionId}: CompanyCam thumb=${img.src.substring(0, 80)}..., Original=${originalUrl.substring(0, 80)}...`);
              });
              if (images.length > 0) {
                photoData[sectionId] = { images, links, explanation };
                console.log(`✅ ${sectionId}: Added ${images.length} CompanyCam photos with original URLs`);
                console.log(`🔍 DEBUG: Estructura guardada para ${sectionId}:`, photoData[sectionId]);
              }
            } else {
            const images = container.querySelectorAll('img');
            if (images.length > 0) {
              photoData[sectionId] = {
                images: Array.from(images).map(img => img.src),
                  links: Array.from(images).map(img => img.src),
                explanation: explanation
              };
              }
            }
            }
          }
        }
      }
      
      debugLog(`📸 Collected photos from ${Object.keys(photoData).length} sections`);
      
      // Log summary of what was collected
      console.log('📊 PHOTO COLLECTION SUMMARY:');
      for (const [section, data] of Object.entries(photoData)) {
        if (data.images && data.links) {
          console.log(`  ${section}: ${data.images.length} photos`);
          if (data.links.length > 0) {
            const firstUrl = data.links[0];
            const isLarge = firstUrl.includes('rs:fit:4032') || firstUrl.includes('rs:fit:original');
            console.log(`    First URL: ${isLarge ? '✅ Large' : '⚠️ Small'} - ${firstUrl.substring(0, 100)}...`);
          }
        }
      }
      
      console.log('🔍 DEBUG: collectAllPhotos devolviendo photoData completo:', photoData);
      console.log('🔍 DEBUG: collectAllPhotos devolviendo keys:', Object.keys(photoData));
      
      return photoData
    }

    // Generate PDF HTML content - VERSIÓN MEJORADA POR CHATGPT
    function generatePDFContent(formData, photoData) {
      // Safety check for formData
      if (!formData) {
        console.error('❌ formData is null or undefined in generatePDFContent');
        formData = {
          vId: '',
          ccId: '',
          businessName: '',
          propertyAddress: '',
          city: '',
          state: '',
          zipcode: '',
          inspectorFirstName: '',
          inspectorLastName: '',
          inspectorPhone: '',
          inspectorEmail: '',
          partnerFirstName: '',
          partnerLastName: '',
          partnerPhone: '',
          partnerEmail: '',
          ownerFirstName: '',
          ownerLastName: '',
          ownerPhone: '',
          ownerEmail: '',
          inspectionDate: '',
          stormDate: '',
          propertyType: '',
          buildingType: '',
          roofSystem: '',
          numStories: '',
          roofSquares: '',
          tradeTypes: [],
          tradeTypeSeverities: {},
          confirmedDamage: false,
          severityRating: '',
          hvacSeverityRating: '',
          stormTypes: [],
          hailSize: '',
          windSpeed: '',
          tornadoStrength: '',
          hurricaneCat: '',
          stormProximity: '',
          numberOfLeaks: '',
          numberOfWindows: '',
          testSquareDamagedAreas: '',
          interiorPhotoExplanations: {},
          groundExteriorPhotoExplanations: {},
          hvacDamagePhotoExplanations: {},
          roofDamagePhotoExplanations: {},
          roofDamageObservations: {},
          exteriorComponentsSelections: {}
        };
      }
      
      const currentDate = new Date().toLocaleDateString();
      
      return `
        <div style="font-family: Arial, sans-serif; line-height: 1.4; color: #000; max-width: 800px; margin: 0 auto;" class="main-container">
          <style>
            /* 🎯 OPTIMIZACIÓN EXTREMA PARA html2pdf.js - CONTROL TOTAL DE PÁGINAS */
            @page {
              margin: 0.2in 0.3in 0.3in 0.3in; /* Márgenes MÁS PEQUEÑOS para aprovechar espacio */
              size: letter;
            }
            
            /* 🔥 CONTROL INTELIGENTE DE SALTOS DE PÁGINA */
            .page-break-before { page-break-before: always; }
            .page-break-after { page-break-after: always; }
            .no-page-break { page-break-inside: avoid !important; }
            .keep-together { 
              page-break-inside: avoid !important; 
              page-break-after: avoid !important;
              orphans: 3;
              widows: 3;
            }
            
            /* EVITAR CORTES EN SECCIONES */
            .section { 
              page-break-inside: avoid !important;
              break-inside: avoid !important;
            }
            
            body, html {
              margin: 0;
              padding: 0;
              line-height: 1.3;
              font-size: 11px; /* Reducir un poco para más contenido */
              border: none !important;
              outline: none !important;
              box-shadow: none !important;
            }
            
            /* Contenedor principal ultra compacto */
            .main-container {
              position: static;
              padding-bottom: 0; /* Sin espacio desperdiciado */
              border: none !important;
              outline: none !important;
              box-shadow: none !important;
            }
            
            /* ELIMINAR TODAS LAS LÍNEAS Y BORDES */
            .section, .photo-container, .pdf-image, div {
              border: none !important;
              outline: none !important;
              box-shadow: none !important;
            }
            
            /* Optimized image handling for PDF */
            .pdf-image {
              max-width: 100%;
              width: auto;
              height: auto;
              object-fit: contain;
              border: 1px solid #ddd; /* Borde más delgado */
              border-radius: 4px; /* Menos redondeado */
              box-shadow: 0 1px 4px rgba(0,0,0,0.1); /* Sombra más sutil */
              page-break-inside: avoid;
              margin: 5px 0; /* Mínimo margen */
              image-rendering: -webkit-optimize-contrast;
              image-rendering: crisp-edges;
              -webkit-print-color-adjust: exact;
              print-color-adjust: exact;
              position: relative;
              z-index: 2;
            }
            
            .photo-container {
              text-align: center;
              page-break-inside: avoid;
              margin-bottom: 4px; /* Mínimo espacio */
              position: relative;
              z-index: 1;
            }
            
            .photo-title {
              margin: 0 0 8px 0; /* Menos margen */
              color: #000 !important; /* Forzar negro */
              font-size: 12px; /* Ligeramente más pequeño */
              font-weight: bold;
            }
            
            .damage-photo {
              max-height: 260px; /* Ligeramente más pequeño */
              max-width: 100%;
              object-fit: contain;
            }
            
            .regular-photo {
              max-height: 320px; /* Optimizado */
            }
            
            .test-square-photo {
              max-height: 3000px !important; /* Altura aumentada para mostrar todo el contenido */
            }
            
            /* 🔥 SECCIONES ULTRA COMPACTAS - CERO DESPERDICIO */
            .section {
              page-break-inside: avoid;
              margin-bottom: 8px; /* MUCHO menos espacio */
            }
            
            .section-title {
              margin-top: 10px; /* Reducido de 20px */
              margin-bottom: 6px; /* Reducido de 12px */
              page-break-after: avoid;
            }
            
            /* 🎯 FOOTER COMPACTO - SIN POSICIÓN ABSOLUTA */
            .footer {
              text-align: center;
              margin-top: 15px; /* Reducido de 30px */
              padding-top: 10px; /* Reducido de 15px */
              border-top: 2px solid #38c3ff;
              color: #000 !important; /* Forzar negro */
              font-size: 10px;
              page-break-inside: avoid;
            }
            
            /* Grids de fotos ULTRA compactos */
            .photo-grid-2x2 {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 6px; /* Gap mínimo */
              margin-bottom: 6px; /* Reducido */
              page-break-inside: avoid;
            }
            
            /* Headers ULTRA compactos y OSCUROS */
            h1 { font-size: 24px; margin: 6px 0; color: #000 !important; font-weight: bold; }
            h2 { font-size: 18px; margin: 4px 0; color: #000 !important; font-weight: bold; }
            h3 { font-size: 16px; margin: 6px 0 4px 0; color: #000 !important; font-weight: bold; }
            h4 { font-size: 14px; margin: 6px 0 3px 0; color: #000 !important; font-weight: bold; }
            
            /* Párrafos ULTRA compactos y ULTRA OSCUROS */
            p { margin: 3px 0; line-height: 1.2; color: #000 !important; font-weight: 500; }
            strong { color: #000 !important; font-weight: bold !important; }
            div { color: #000 !important; font-weight: 500; }
            span { color: #000 !important; font-weight: 500; }
            
            /* FORZAR TODO EL TEXTO A SER NEGRO Y CONTRASTE MÁXIMO PARA PDF */
            * { color: #000 !important; text-rendering: optimizeLegibility; }
            .pdf-content * { color: #000 !important; }
            
            /* ESTILOS SIMPLES PERO EFECTIVOS PARA PDF */
            @media print {
              * { 
                color: #000000 !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
                color-adjust: exact !important;
              }
              body { 
                color: #000000 !important; 
                background: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
              }
              div, p, span, strong { color: #000000 !important; font-weight: 900 !important; }
              h1, h2, h3, h4, h5, h6 { color: #000000 !important; font-weight: 900 !important; }
            }
            
            /* 🎯 FORZAR COLOR ADJUST GLOBALMENTE PARA html2pdf.js */
            html, body {
              -webkit-print-color-adjust: exact !important;
              print-color-adjust: exact !important;
              color-adjust: exact !important;
            }
            
            /* ESTILOS BÁSICOS PARA html2pdf.js SIN FILTROS */
            .pdf-content, .pdf-content * {
              color: #000000 !important;
              background: #ffffff !important;
              font-weight: 900 !important;
            }
            /* Ensure links are clickable in preview */
            a, img, .photo-container, .main-container {
              pointer-events: auto !important;
              cursor: pointer;
            }
            
            /* ESTILOS GLOBALES SIMPLES Y EFECTIVOS */
            * {
              color: #000000 !important;
              font-weight: 800 !important;
            }
            
            /* ELEMENTOS ESPECÍFICOS CON PESO MÁXIMO */
            div, p, span, strong, h1, h2, h3, h4, h5, h6 {
              color: #000000 !important;
              font-weight: 900 !important;
            }
            
            /* CONTENEDOR PRINCIPAL CON ESTILOS FORZADOS */
            .main-container, .main-container * {
              color: #000000 !important;
              font-weight: 900 !important;
            }
            
            /* Tablas más compactas */
            table { margin: 10px 0; border-spacing: 0; }
            td, th { padding: 4px 8px; font-size: 11px; }
          </style>
          <!-- PÁGINA 1 COMPLETA: Header + Todas las secciones de información -->
          <div class="keep-together" style="min-height: 80vh; padding-bottom: 20px;">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 8px; border-bottom: 3px solid #38c3ff; padding-bottom: 6px;">
              <h1 style="color: #000000 !important; margin: 0; font-size: 24px; font-weight: 900 !important;">DAMAGE ANALYSIS REPORT</h1>
              <h2 style="color: #000000 !important; margin: 6px 0; font-size: 18px; font-weight: 900 !important;">*** VI-A - Professional Inspection Services ***</h2>
              <p style="margin: 3px 0; color: #000000 !important; font-size: 12px; font-weight: 700 !important;">Generated on ${currentDate}</p>
            </div>

            <!-- Property Information -->
            <div class="section" style="background: #f8f9fa; padding: 6px; border-radius: 4px; margin-bottom: 4px;">
              <h3 class="section-title" style="color: #000000 !important; border-bottom: 2px solid #38c3ff; padding-bottom: 6px; font-weight: 900 !important;">Property Information</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div style="color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">V-ID:</strong> ${formData.vId}</div>
              <div style="color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">CC ID:</strong> ${formData.ccId}</div>
              <div style="grid-column: 1 / -1; color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">Business Name:</strong> ${formData.businessName}</div>
              <div style="grid-column: 1 / -1; color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">Address:</strong> ${formData.propertyAddress}, ${formData.city}, ${formData.state} ${formData.zipcode}</div>
              <div style="color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">Property Type:</strong> ${formData.propertyType}</div>
              <div style="color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">Building Type:</strong> ${formData.buildingType}</div>
              <div style="color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">Roof System:</strong> ${formData.roofSystem}</div>
              <div style="color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">Stories:</strong> ${formData.numStories}</div>
              <div style="color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">Date of Loss:</strong> ${formData.stormDate}</div>
            </div>
          </div>

            <!-- Inspector Information -->
            <div class="section" style="background: #f8f9fa; padding: 6px; border-radius: 4px; margin-bottom: 4px;">
              <h3 class="section-title" style="color: #000000 !important; border-bottom: 2px solid #38c3ff; padding-bottom: 6px; font-weight: 900 !important;">Inspector Information</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div style="color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">Inspector:</strong> ${formData.inspectorFirstName} ${formData.inspectorLastName}</div>
              <div style="color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">Phone:</strong> ${formData.inspectorPhone}</div>
              <div style="color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">Email:</strong> ${formData.inspectorEmail}</div>
              <div style="color: #000000 !important; font-weight: 800 !important;"><strong style="color: #000000 !important; font-weight: 900 !important;">Inspection Date:</strong> ${formData.inspectionDate}</div>
            </div>
          </div>

          <!-- Inspection Partner Information -->
          ${(formData.partnerFirstName || formData.partnerLastName || formData.partnerPhone || formData.partnerEmail) ? `
          <div style="margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
            <h3 style="color: #2c3e50; margin-top: 0; border-bottom: 2px solid #38c3ff; padding-bottom: 8px;">Inspection Partner Information</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              ${formData.partnerFirstName || formData.partnerLastName ? `<div><strong>Partner:</strong> ${formData.partnerFirstName} ${formData.partnerLastName}</div>` : ''}
              ${formData.partnerPhone ? `<div><strong>Phone:</strong> ${formData.partnerPhone}</div>` : ''}
              ${formData.partnerEmail ? `<div style="grid-column: 1 / -1;"><strong>Email:</strong> ${formData.partnerEmail}</div>` : ''}
            </div>
          </div>
          ` : ''}

            <!-- Inspection Information -->
            <div class="section" style="background: #f8f9fa; padding: 6px; border-radius: 4px; margin-bottom: 4px;">
              <h3 class="section-title" style="color: #000; border-bottom: 2px solid #38c3ff; padding-bottom: 6px; font-weight: bold;">Inspection Information</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div><strong>Inspection Date:</strong> ${formData.inspectionDate}</div>
              <div><strong>Date of Loss:</strong> ${formData.stormDate}</div>
              <div><strong>V-ID:</strong> ${formData.vId}</div>
              <div><strong>CC ID:</strong> ${formData.ccId}</div>
            </div>
          </div>

            <!-- ESPACIO PARA DAMAGE ASSESSMENT (EXTRA GRANDE PARA PÁGINA 2) -->
            <div style="height: 180px;"></div>
            
            <!-- Damage Assessment -->
            <div class="section" style="background: #f8f9fa; padding: 6px; border-radius: 4px; margin-bottom: 4px;">
              <h3 class="section-title" style="color: #000; border-bottom: 2px solid #38c3ff; padding-bottom: 6px; font-weight: bold;">Damage Assessment</h3>
            <div style="margin-bottom: 15px;">
              <strong>Trade Types Affected:</strong> ${formData.tradeTypes.join(', ') || 'None specified'}
            </div>
            ${Object.keys(formData.tradeTypeSeverities).length > 0 ? `
            <div style="margin-bottom: 15px;">
              <strong>Trade Type Severity Ratings:</strong>
              <div style="margin-top: 8px; padding-left: 15px;">
                ${Object.entries(formData.tradeTypeSeverities).map(([trade, severity]) => 
                  `<div style="margin-bottom: 5px;"><strong>${trade}:</strong> ${severity}</div>`
                ).join('')}
              </div>
            </div>
            ` : ''}
            <div style="margin-bottom: 15px;">
              <strong>Confirmed Damage:</strong> ${formData.confirmedDamage ? 'Yes' : 'No'}
              ${formData.severityRating ? ` (Severity: ${formData.severityRating})` : ''}
            </div>
            ${formData.roofSquares ? `
            <div style="margin-bottom: 15px;">
              <strong>Roof Squares (if known):</strong> ${formData.roofSquares}
            </div>
            ` : ''}
            ${formData.hvacSeverityRating ? `
            <div style="margin-bottom: 15px;">
              <strong>HVAC Severity Rating:</strong> ${formData.hvacSeverityRating}
            </div>
            ` : ''}
            <div style="margin-bottom: 15px;">
              <strong>Storm Types:</strong> ${formData.stormTypes.join(', ') || 'None specified'}
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div><strong>Storm Date:</strong> ${formData.stormDate}</div>
              <div><strong>Storm Proximity:</strong> ${formData.stormProximity}</div>
              ${formData.hailSize ? `<div><strong>Hail Size:</strong> ${formData.hailSize}</div>` : ''}
              ${formData.windSpeed ? `<div><strong>Wind Speed:</strong> ${formData.windSpeed}</div>` : ''}
              ${formData.tornadoStrength ? `<div><strong>Tornado Strength:</strong> ${formData.tornadoStrength}</div>` : ''}
              ${formData.hurricaneCat ? `<div><strong>Hurricane Category:</strong> ${formData.hurricaneCat}</div>` : ''}
              ${formData.numberOfLeaks ? `<div><strong>Number of Leaks:</strong> ${formData.numberOfLeaks}</div>` : ''}
              ${formData.numberOfWindows ? `<div><strong>Number of Windows:</strong> ${formData.numberOfWindows}</div>` : ''}
            </div>
            ${(formData.hvacUnitsTotal || formData.rtusTotal) ? `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
              ${formData.hvacUnitsTotal ? `<div><strong>Number of HVAC Units:</strong> ${formData.hvacUnitsTotal}</div>` : ''}
              ${formData.rtusTotal ? `<div><strong>Number of RTUS:</strong> ${formData.rtusTotal}</div>` : ''}
            </div>
            ` : ''}
            </div>
          </div>

          <!-- ESPACIO MÍNIMO PARA EVITAR CORTES -->
          <div style="height: 20px;"></div>
          
          ${generatePhotoSections(photoData, formData)}

          <!-- ESPACIO PARA TEST SQUARE EN PÁGINA SEPARADA -->
          <div style="height: 200px;"></div>
          
          <!-- Test Square Information -->
          ${formData.testSquareDamagedAreas ? `
          <div class="keep-together" style="margin-bottom: 15px; background: #f8f9fa; padding: 8px; border-radius: 4px;">
            <h3 class="section-title" style="color: #000; border-bottom: 2px solid #38c3ff; padding-bottom: 6px; font-weight: bold;">Test Square Results</h3>
            <div style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
              <p style="margin: 0;"><strong>The inspector performed a test square on your roof, during which <span style="color: #38c3ff; font-weight: bold;">${formData.testSquareDamagedAreas}</span> amount of damaged areas were found within the square.</strong></p>
            </div>
            ${photoData.test_square_photo && photoData.test_square_photo.images && photoData.test_square_photo.images.length > 0 ? `
            <div class="photo-container" style="margin-top: 20px;">
              <h4 class="photo-title">Test Square Photo</h4>
              <a href="${photoData.test_square_photo.links[0] || photoData.test_square_photo.images[0]}" target="_blank" rel="noopener noreferrer">
                <img src="${photoData.test_square_photo.images[0]}" class="pdf-image test-square-photo" alt="Test Square Photo">
              </a>
              <div style="margin-top:4px; font-size:11px;"><a href="${photoData.test_square_photo.links[0] || photoData.test_square_photo.images[0]}" target="_blank" rel="noopener noreferrer" style="color:#3498db; text-decoration: underline;">Open original</a></div>
            </div>
            ` : ''}
          </div>
          ` : ''}



          <!-- ESPACIO PARA GARANTIZAR FOOTER VISIBLE -->
          <div style="height: 60px;"></div>
          
          <!-- Footer Optimizado -->
          <div class="footer" style="page-break-inside: avoid; break-inside: avoid; margin-top: 30px; padding: 20px; background: #f8f9fa; border-top: 3px solid #38c3ff; text-align: center;">
            <p style="margin: 5px 0; color: #000 !important; font-weight: bold !important;"><strong>*** VI-A - Professional Inspection Services ***</strong></p>
            <p style="margin: 5px 0; color: #000 !important; font-weight: 600 !important;">Professional Damage Assessment & Analysis Services</p>
            <p style="margin: 5px 0; color: #000 !important; font-weight: 600 !important;">Report generated by DAR System - ${currentDate}</p>
          </div>
        </div>

        <!-- PÁGINA SEPARADA PARA ASSESSMENT RECOMMENDATIONS -->
        <div style="page-break-before: always; height: 20px;"></div>
        

        
        <div style="font-family: Arial, sans-serif; line-height: 1.4; color: #000; max-width: 800px; margin: 0 auto; padding: 20px;">
          <h2 style="color: #000; border-bottom: 3px solid #38c3ff; padding-bottom: 10px; font-weight: bold; text-align: center; margin-bottom: 30px;">
            Property Damage Assessment – Executive Summary
          </h2>

          <!-- Assessment Recommendations Table -->
          <div style="margin-bottom: 30px;">
            <h3 style="color: #000; border-bottom: 2px solid #38c3ff; padding-bottom: 8px; font-weight: bold; margin-bottom: 20px;">
              Assessment Recommendations
            </h3>
            
            <table style="width: 100%; border-collapse: collapse; border: 2px solid #38c3ff; margin-bottom: 20px;">
              <thead>
                <tr style="background: #38c3ff; color: white;">
                  <th style="border: 1px solid #38c3ff; padding: 12px; text-align: left; font-weight: bold;">Condition Level</th>
                  <th style="border: 1px solid #38c3ff; padding: 12px; text-align: left; font-weight: bold;">Findings</th>
                  <th style="border: 1px solid #38c3ff; padding: 12px; text-align: left; font-weight: bold;">Recommended Action</th>
                  <th style="border: 1px solid #38c3ff; padding: 12px; text-align: left; font-weight: bold;">Inspection Schedule</th>
                </tr>
              </thead>
              <tbody>
                <tr style="background: ${formData.damageLevel === 'no_observable_damage' ? '#ffff00' : '#ffffff'};">
                  <td style="border: 1px solid #38c3ff; padding: 12px; font-weight: bold;">No Observable Damage</td>
                  <td style="border: 1px solid #38c3ff; padding: 12px;">No visible or measurable damage. Structure/components in good condition.</td>
                  <td style="border: 1px solid #38c3ff; padding: 12px;">Maintain condition through routine care.</td>
                  <td style="border: 1px solid #38c3ff; padding: 12px;">2 scheduled inspections per <strong>year + after</strong> each storm event.</td>
                </tr>
                <tr style="background: ${formData.damageLevel === 'minimal_localized_damage' ? '#ffff00' : '#ffffff'};">
                  <td style="border: 1px solid #38c3ff; padding: 12px; font-weight: bold;">Minimal / Localized Damage</td>
                  <td style="border: 1px solid #38c3ff; padding: 12px;">Minor or localized issues, integrity not compromised.</td>
                  <td style="border: 1px solid #38c3ff; padding: 12px;">Perform timely, localized repairs. Monitor for progression.</td>
                  <td style="border: 1px solid #38c3ff; padding: 12px;">Every 3 months + after each storm event.</td>
                </tr>
                <tr style="background: ${formData.damageLevel === 'significant_widespread_damage' ? '#ffff00' : '#ffffff'};">
                  <td style="border: 1px solid #38c3ff; padding: 12px; font-weight: bold;">Significant / Widespread Damage</td>
                  <td style="border: 1px solid #38c3ff; padding: 12px;">Substantial damage impacting safety, function, or durability.</td>
                  <td style="border: 1px solid #38c3ff; padding: 12px;">Immediate <strong>emergency mitigation</strong>, followed by full replacement of affected areas/components.</td>
                  <td style="border: 1px solid #38c3ff; padding: 12px;">Every 30 days until repair/replacement is <strong>complete + after</strong> each storm event.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Conclusion Section -->
          <div>
            <h3 style="color: #000; border-bottom: 2px solid #38c3ff; padding-bottom: 8px; font-weight: bold; margin-bottom: 20px;">
              Conclusion
            </h3>
            
            <div style="line-height: 1.6; margin-bottom: 15px;">
              <p style="margin: 0 0 15px 0; text-align: justify;">
                Timely resolution of property damage is essential for protecting business operations, ensuring occupant safety, and preserving long-term asset value. Proactive repairs and scheduled inspections help control costs, extend the service life of building systems, and reduce exposure to unexpected failures.
              </p>
              
              <p style="margin: 0 0 15px 0; text-align: justify;">
                Conversely, deferring corrective action can accelerate deterioration, increase repair complexity, and drive significantly higher long-term costs. Unaddressed issues may lead to water intrusion, structural compromise, mold growth, or insurance complications—posing both financial and operational risks.
              </p>
              
              <p style="margin: 0; text-align: justify;">
                By following the recommended repair strategies and inspection intervals outlined above, stakeholders can ensure that the property remains structurally sound, compliant, and resilient against future events. This proactive approach reduces liability, supports business continuity, and safeguards the asset's value over time.
              </p>
            </div>
          </div>

          <!-- Footer for Assessment Page -->
          <div style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-top: 3px solid #38c3ff; text-align: center;">
            <p style="margin: 5px 0; color: #000 !important; font-weight: bold !important;"><strong>*** VI-A - Professional Inspection Services ***</strong></p>
            <p style="margin: 5px 0; color: #000 !important; font-weight: 600 !important;">Professional Damage Assessment & Analysis Services</p>
            <p style="margin: 5px 0; color: #000 !important; font-weight: 600 !important;">Report generated by DAR System - ${currentDate}</p>
          </div>
        </div>
      `;
    }

    // Generate photo sections for PDF
    function generatePhotoSections(photoData, formData) {
      console.log('🔍 DEBUG: generatePhotoSections recibió photoData:', photoData);
      console.log('🔍 DEBUG: generatePhotoSections recibió formData:', formData);
      
      let html = '';
      
      const sections = {
        'General & Identifying Photos': [
          { key: 'identifying_photo_address', label: 'Property Address Photo' },
          { key: 'business_identifier_sign', label: 'Business Identifier Sign' },
          { key: 'property_damage_highlights', label: 'Property Damage Highlights' }
        ],
        'Site Access & Documentation': [
          { key: 'roof_access', label: 'Roof Access' },
          { key: 'rooftop_obstructions', label: 'Rooftop Obstructions' },
          { key: 'noaa_swath_screenshot', label: 'NOAA Swath Screenshot' },
          { key: 'impact_report_screenshot', label: 'Impact Report Screenshot' }
        ],
        'Exterior Ground Photos': [
          { key: 'ground_front', label: 'Ground Front' },
          { key: 'ground_back', label: 'Ground Back' },
          { key: 'ground_left_side', label: 'Ground Left Side' },
          { key: 'ground_right_side', label: 'Ground Right Side' },
          { key: 'aerial_overview', label: 'Aerial Overview' },
          { key: 'property_entrance', label: 'Property Entrance' }
        ]
      };
      
      console.log('🔍 DEBUG: Secciones definidas:', Object.keys(sections));
      console.log('🔍 DEBUG: photoData keys disponibles en generatePhotoSections:', Object.keys(photoData));

      // Generate regular photo sections
      for (const [sectionTitle, sectionItems] of Object.entries(sections)) {
        console.log(`🔍 DEBUG: Procesando sección "${sectionTitle}" con ${sectionItems.length} items`);
        const sectionPhotos = sectionItems.filter(item => {
          const hasData = photoData[item.key];
          console.log(`🔍 DEBUG: Item ${item.key}: ${hasData ? '✅ Existe' : '❌ No existe'}`);
          if (hasData) {
            console.log(`🔍 DEBUG: ${item.key} data:`, photoData[item.key]);
            // Verificar que tenga imágenes
            if (hasData.images && hasData.images.length > 0) {
              console.log(`🔍 DEBUG: ${item.key} tiene ${hasData.images.length} imágenes`);
            } else {
              console.log(`🔍 DEBUG: ${item.key} NO tiene imágenes válidas`);
            }
          }
          return hasData && hasData.images && hasData.images.length > 0;
        });
        
        console.log(`🔍 DEBUG: ${sectionTitle} - ${sectionPhotos.length} items con fotos`);
        
        if (sectionPhotos.length > 0) {
          html += `
            <!-- ESPACIO PARA SECCIONES INDIVIDUALES -->
            <div style="height: 100px;"></div>
            
            <div class="keep-together" style="margin-bottom: 15px; background: #f8f9fa; padding: 8px; border-radius: 4px;">
              <h3 class="section-title" style="color: #000; border-bottom: 2px solid #38c3ff; padding-bottom: 6px; font-weight: bold;">${sectionTitle}</h3>
              <div class="photo-grid-2x2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 8px;">
          `;
          
          sectionPhotos.forEach(item => {
            const photoSection = photoData[item.key];
            if (photoSection && photoSection.images && photoSection.images.length > 0) {
              // Use the original URL from links array for opening, thumbnail for display
              const displayUrl = photoSection.images[0];
              const openUrl = photoSection.links[0] || displayUrl;
              html += `
                <div class="photo-container">
                  <h4 class="photo-title">${item.label}</h4>
                  <a href="${openUrl}" target="_blank" rel="noopener noreferrer">
                    <img src="${displayUrl}" class="pdf-image regular-photo" alt="${item.label}">
                  </a>
                  <div style="margin-top:4px; font-size:11px;"><a href="${openUrl}" target="_blank" rel="noopener noreferrer" style="color:#3498db; text-decoration: underline;">Open original</a></div>
                </div>
              `;
            }
          });
          
          html += '</div></div>';
        }
      }

      // Generate multi-photo sections (Interior, HVAC, Exterior, Roof)
      const multiSections = [
        { prefix: 'interior_photo', title: 'Interior Damage Photos' },
        { prefix: 'hvac_damage_photo', title: 'HVAC Damage Photos' },
        { prefix: 'ground_exterior_photo', title: 'Window Damage Photos' },
        { prefix: 'exterior_components_photo', title: 'Exterior Components Photos' },
        { prefix: 'roof_damage_photo', title: 'Roof Damage Photos' }
      ];

      console.log('🔍 DEBUG: Iniciando procesamiento de secciones múltiples...');
      console.log('🔍 DEBUG: photoData keys disponibles:', Object.keys(photoData));

      multiSections.forEach(section => {
        const sectionPhotos = [];
        console.log(`🚨 PROCESANDO SECCIÓN: ${section.title}`);
        console.log(`🚨 PREFIX: ${section.prefix}`);
        for (let i = 1; i <= 9; i++) {
                      const key = `${section.prefix}_${i}`;
            console.log(`🔍 DEBUG: Buscando ${key}:`, photoData[key]);
            if (photoData[key] && photoData[key].images && photoData[key].images.length > 0) {
              console.log(`✅ ENCONTRADO ${key} con ${photoData[key].images.length} imágenes`);
              // Get explanation from the correct source based on section type
              let explanation = photoData[key].explanation;
              if (section.prefix === 'ground_exterior_photo') {
                explanation = (formData && formData.groundExteriorPhotoExplanations) ? 
                  formData.groundExteriorPhotoExplanations[`ground_exterior_photo_explanation_${i}`] || photoData[key].explanation :
                  photoData[key].explanation;
              } else if (section.prefix === 'exterior_components_photo') {
                // Para exterior components usamos el texto de checks seleccionados como explicación
                const sel = (formData && formData.exteriorComponentsSelections) ? formData.exteriorComponentsSelections[`exterior_components_photo_${i}`] : [];
                explanation = Array.isArray(sel) && sel.length ? sel.map(s => `• ${s}`).join('<br>') : photoData[key].explanation;
              } else if (section.prefix === 'interior_photo') {
                explanation = (formData && formData.interiorPhotoExplanations) ? 
                  formData.interiorPhotoExplanations[`interior_photo_explanation_${i}`] || photoData[key].explanation :
                  photoData[key].explanation;
              } else if (section.prefix === 'hvac_damage_photo') {
                explanation = (formData && formData.hvacDamagePhotoExplanations) ? 
                  formData.hvacDamagePhotoExplanations[`hvac_damage_photo_explanation_${i}`] || photoData[key].explanation :
                  photoData[key].explanation;
              } else if (section.prefix === 'roof_damage_photo') {
                explanation = (formData && formData.roofDamagePhotoExplanations) ? 
                  formData.roofDamagePhotoExplanations[`roof_damage_photo_explanation_${i}`] || photoData[key].explanation :
                  photoData[key].explanation;
              }
              
              sectionPhotos.push({
                key,
                images: photoData[key].images,
                links: photoData[key].links, // Agregar los links para URLs originales
                explanation: explanation,
                number: i
              });
            } else {
              console.log(`❌ NO ENCONTRADO: ${key}`, photoData[key] ? 'Existe pero sin imágenes' : 'No existe');
            }
        }

        if (sectionPhotos.length > 0) {
          // TODAS LAS SECCIONES DE FOTOS EN PÁGINA NUEVA (MISMA LÓGICA QUE ROOF DAMAGE)
          html += `
            <!-- SALTO DE PÁGINA PARA TODAS LAS SECCIONES DE FOTOS -->
            <div style="page-break-before: always; height: 20px;"></div>
          `;
          
          html += `
            <div class="keep-together" style="margin-bottom: 15px; background: #f8f9fa; padding: 8px; border-radius: 4px;">
              <h3 class="section-title" style="color: #000; border-bottom: 2px solid #38c3ff; padding-bottom: 6px; font-weight: bold;">${section.title}</h3>
          `;

          sectionPhotos.forEach((photo, index) => {
            // ESTRATEGIA COMPACTA: MANTENER FOTOS JUNTAS CUANDO SEA POSIBLE
            html += `
              <!-- ESPACIO COMPACTO ENTRE FOTOS -->
              <div style="height: 20px;"></div>
            `;
            
            html += `
              <div class="keep-together" style="margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; padding: 6px; background: white; page-break-inside: avoid; break-inside: avoid;">
                <h4 style="margin: 0 0 8px 0; color: #000000 !important; font-weight: 900 !important; font-size: 14px;">Photo ${photo.number}</h4>
                <div class="photo-grid-2x2" style="page-break-inside: avoid; break-inside: avoid;">
          `;

            photo.images.forEach((imageSrc, idx) => {
              // Use the provided original URL (signed). Do not modify query/path to avoid 403.
              let openUrl = (photo.links && photo.links[idx]) ? photo.links[idx] : imageSrc;
              html += `
                <div class="photo-container" style="display: flex; flex-direction: column; align-items: center;">
                  <a href="${openUrl}" target="_blank" rel="noopener noreferrer">
                  <img src="${imageSrc}" class="pdf-image damage-photo" alt="Damage Photo ${photo.number}" style="max-width: 100%; max-height: 220px; object-fit: contain;">
                  </a>
                  <div style="margin-top:4px; font-size:11px;"><a href="${openUrl}" target="_blank" rel="noopener noreferrer" style="color:#3498db; text-decoration: underline;">Open original</a></div>
                </div>
              `;
            });

            html += `
                </div>
                ${photo.explanation ? `
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #38c3ff; border-radius: 4px;">
                  <p style="margin: 0; font-style: italic; color: #000; line-height: 1.5;">
                    <strong style="color: #38c3ff;">Damage Analysis:</strong><br>
                    ${photo.explanation}
                  </p>
                </div>
                ` : ''}
            `;

            // Add Manufacturer Tag Photo for HVAC sections (PÁGINA PROPIA)
            if (section.prefix === 'hvac_damage_photo') {
              const manufacturerTagKey = `manufacturer_tag_photo_${photo.number}`;
              if (photoData[manufacturerTagKey] && photoData[manufacturerTagKey].length > 0) {
                html += `
                <!-- MANUFACTURER TAG PHOTO -->
                <div style="margin-top: 15px; padding: 15px; background: #e9f7ff; border-left: 4px solid #38c3ff; border-radius: 4px; text-align: center;">
                  <h3 style="margin: 0 0 20px 0; color: #2980b9; font-weight: bold;">Manufacturer Tag Photo ${photo.number}</h3>
                  <div class="photo-container" style="text-align: center;">
                    <img src="${photoData[manufacturerTagKey][0]}" class="pdf-image" alt="Manufacturer Tag Photo ${photo.number}" style="max-width: 80%; max-height: 600px; object-fit: contain; border: 2px solid #38c3ff; border-radius: 8px;">
                  </div>
                </div>
                `;
              }
            }

            html += `
              </div>
            `;
          });

          html += '</div>';
        }
      });
      
      console.log('🔍 DEBUG: generatePhotoSections generó HTML de longitud:', html.length);
      console.log('🔍 DEBUG: HTML generado (primeros 500 chars):', html.substring(0, 500));

             return html;
     }

     // PDF Modal Functions
     async function openPDFModal() {
       debugLog('📄 Opening PDF modal...');
       
       // Show modal
       const modal = document.getElementById('pdfModal');
       const content = document.getElementById('pdfPreviewContent');
       modal.style.display = 'block';
       
       // Show loading
       content.innerHTML = `
         <div style="text-align: center; padding: 50px; color: #666;">
           <i class="fas fa-spinner fa-spin fa-3x"></i>
           <p style="margin-top: 20px; font-size: 1.2em;">Generating PDF preview...</p>
         </div>
       `;
       
       try {
         // Generate content
         const formData = collectAllFormData();
         console.log('🔍 DEBUG: openPDFModal - formData recolectado:', Object.keys(formData));
         
         const photoData = await collectAllPhotos();
         console.log('🔍 DEBUG: openPDFModal - photoData recolectado:', Object.keys(photoData));
         console.log('🔍 DEBUG: openPDFModal - photoData completo:', photoData);
         
         const pdfContent = generatePDFContent(formData, photoData);
         
         // Show content with download button setup
         content.innerHTML = `
           <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #e9f7ff; border: 1px solid #38c3ff; border-radius: 8px;">
             <h3 style="margin: 0; color: #2980b9;">
               <i class="fas fa-eye"></i> Review your DAR Report below, then click "Download PDF" to save it
             </h3>
           </div>
           <div id="modalPdfContent" style="background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
             ${pdfContent}
           </div>
         `;
         
         // Setup download button
         const downloadBtn = document.getElementById('modalDownloadBtn');
         downloadBtn.onclick = () => downloadFromModal();
         
         debugLog('✅ PDF modal opened successfully');
         
       } catch (error) {
         debugLog(`❌ Error opening PDF modal: ${error.message}`);
         content.innerHTML = `
           <div style="text-align: center; padding: 50px; color: #dc3545;">
             <i class="fas fa-exclamation-triangle fa-3x"></i>
             <p style="margin-top: 20px; font-size: 1.2em;">Error generating preview</p>
             <p>${error.message}</p>
           </div>
         `;
       }
     }
     
     function closePDFModal() {
       debugLog('📄 Closing PDF modal');
       document.getElementById('pdfModal').style.display = 'none';
     }
     
     // 🎯 FUNCIÓN INTELIGENTE PARA PRE-CARGAR IMÁGENES
     async function preloadAllImages(element) {
       debugLog('🖼️ Pre-cargando todas las imágenes para evitar PDF pálido...');
       
       const images = element.querySelectorAll('img');
       const imagePromises = [];
       
       images.forEach((img, index) => {
         if (img.src && !img.complete) {
           const promise = new Promise((resolve, reject) => {
             img.onload = () => {
               debugLog(`✅ Imagen ${index + 1}/${images.length} cargada: ${img.src.substring(0, 50)}...`);
               resolve();
             };
             img.onerror = () => {
               debugLog(`⚠️ Imagen ${index + 1} falló al cargar, continuando...`);
               resolve(); // Continuar aunque falle
             };
           });
           imagePromises.push(promise);
         } else if (img.complete) {
           debugLog(`✅ Imagen ${index + 1} ya estaba cargada`);
         }
       });
       
       if (imagePromises.length > 0) {
         debugLog(`🔄 Esperando a que se carguen ${imagePromises.length} imágenes...`);
         await Promise.all(imagePromises);
         debugLog('🎉 Todas las imágenes pre-cargadas exitosamente');
       } else {
         debugLog('✅ No hay imágenes pendientes de cargar');
       }
       
       // Esperar un poco más para asegurar que el DOM esté completamente estable
       await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // 🎯 FUNCIÓN MEJORADA POR CHATGPT - ROBUSTA Y OPTIMIZADA
    async function generatePDFWithRetry(element, filename, attempt = 1, maxAttempts = 2) {
       console.log(`🔄 Generando PDF - Intento ${attempt}/${maxAttempts}`);
       console.log(`📄 Elemento a convertir:`, element);
       console.log(`📄 Contenido del elemento:`, element.innerHTML.substring(0, 500));
       
       try {
         // 🎯 PASO 1: Verificar que el elemento tenga contenido
         if (!element || !element.innerHTML || element.innerHTML.trim() === '') {
           throw new Error('El elemento está vacío o no tiene contenido');
         }
         
         // 🎯 PASO 2: Generar PDF directamente desde el elemento original
         console.log(`📄 Iniciando generación de PDF...`);
         
         const pdfResult = await html2pdf()
          .from(element)
          .set({
            margin: 0.5,
            filename: filename,
             enableLinks: true,
             image: { type: 'jpeg', quality: 0.95 }, // ✅ Calidad optimizada
            html2canvas: { 
               scale: 2, // ✅ Escala balanceada
              useCORS: true, 
              allowTaint: true, // 🎯 Más permisivo para colores
              backgroundColor: null, // 🎯 CLAVE: Sin fondo blanco que opaca
               quality: 0.95, // ✅ Calidad optimizada
               dpi: 150, // ✅ DPI profesional
              letterRendering: true,
               imageTimeout: 30000, // ✅ Timeout razonable
               logging: true, // ✅ Logging habilitado para debug
              onclone: function(clonedDoc) {
                 console.log(`📄 Clonando documento para PDF...`);
                 
                 // Aplicar estilos básicos al clone
                 clonedDoc.body.style.cssText = `
                   background: white !important;
                   color: black !important;
                   font-family: Arial, sans-serif !important;
                 `;
                 
                 // Forzar estilos en elementos clave
                 const headings = clonedDoc.querySelectorAll('h1, h2, h3, h4, h5, h6, strong');
                 headings.forEach(h => {
                   h.style.setProperty('color', '#000000', 'important');
                   h.style.setProperty('font-weight', '900', 'important');
                 });
                 
                 const paragraphs = clonedDoc.querySelectorAll('p, span, div');
                 paragraphs.forEach(p => {
                   p.style.setProperty('color', '#000000', 'important');
                   p.style.setProperty('font-weight', '600', 'important');
                 });
                 
                 console.log(`📄 Estilos aplicados al clone`);
              }
            },
            jsPDF: { 
              unit: 'in', 
              format: 'letter', 
              orientation: 'portrait',
              compress: true,
               precision: 2
             }
           })
           .toPdf()
           .get('pdf')
           .then((pdf) => {
             console.log(`📄 PDF generado, agregando enlaces...`);
             
             try {
               // Agregar anotaciones de enlaces a las imágenes
               const imgs = element.querySelectorAll('a > img');
               console.log(`📄 Encontradas ${imgs.length} imágenes para enlazar`);
               
               imgs.forEach((img, index) => {
                 const a = img.parentElement;
                 const href = a && a.getAttribute('href');
                 if (!href) return;
                 
                 console.log(`📄 Agregando enlace ${index + 1}: ${href}`);
                 
                 const rect = img.getBoundingClientRect();
                 const containerRect = element.getBoundingClientRect();
                 const scale = 2;
                 const pxToPt = (px) => (px / scale) * (72 / 96);
                 const marginPt = 36;
                 
                 const x = marginPt + pxToPt(rect.left - containerRect.left);
                 const y = marginPt + pxToPt(rect.top - containerRect.top);
                 const w = pxToPt(rect.width);
                 const h = pxToPt(rect.height);
                 
                 try { 
                   pdf.link(x, y, w, h, { url: href }); 
                   console.log(`✅ Enlace ${index + 1} agregado exitosamente`);
                 } catch(e) {
                   console.log(`⚠️ Enlace ${index + 1} falló: ${e.message}`);
                 }
               });
             } catch (e) { 
               console.log(`⚠️ Error procesando enlaces: ${e.message}`); 
            }
          })
          .save();
        
         console.log(`✅ PDF generado exitosamente en intento ${attempt}`);
         return pdfResult;
        
      } catch (error) {
         console.log(`❌ Error en intento ${attempt}: ${error.message}`);
         console.error('Error completo:', error);
         
         if (attempt < maxAttempts) {
           console.log(`🔄 Reintentando en 1 segundo...`);
           await new Promise(resolve => setTimeout(resolve, 1000));
           return generatePDFWithRetry(element, filename, attempt + 1, maxAttempts);
         } else {
           throw new Error(`PDF generation failed after ${maxAttempts} attempts: ${error.message}`);
         }
       }
     }

     
     async function downloadFromModal() {
      console.log('📄 Starting download from modal with INTELLIGENT ANTI-PALE CONFIG...');
      
      const btn = document.getElementById('modalDownloadBtn');
       const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Intelligent PDF...';
       btn.disabled = true;

       try {
        const element = document.getElementById('modalPdfContent');
         const formData = collectAllFormData();
        const filename = `DAR_Report_${formData.vId || 'Unknown'}_${new Date().toISOString().split('T')[0]}.pdf`;
        
        // 🎯 PASO 1: PRE-CARGAR TODAS LAS IMÁGENES PARA EVITAR PDF PÁLIDO
        btn.innerHTML = '<i class="fas fa-images fa-spin"></i> Pre-loading all images...';
        await preloadAllImages(element);
        
        btn.innerHTML = '<i class="fas fa-cog fa-spin"></i> Generating High-Quality PDF...';
        
        // 🎯 PASO 2: GENERAR PDF CON CONFIGURACIÓN OPTIMIZADA
        const pdfResult = await generatePDFWithRetry(element, filename);
        
        btn.innerHTML = '<i class="fas fa-check"></i> Intelligent PDF Downloaded!';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
        
        console.log('✅ Ultra-Premium PDF download completed - MAXIMUM QUALITY!');
        
      } catch (error) {
        debugLog(`❌ Ultra-Premium download failed: ${error.message}`);
        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error - Try Again';
          setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 3000);
      }
    }

     // Direct PDF Download function (simple and reliable) 
     async function downloadPDFDirectly() {
       debugLog('📄 Starting direct PDF download...');
       
       const btn = document.getElementById('exportPdfBtn');
       const originalText = btn.innerHTML;
       btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
       btn.disabled = true;

       try {
         // Use same logic as preview but download directly
         const formData = collectAllFormData();
         const photoData = await collectAllPhotos();
         const pdfContent = generatePDFContent(formData, photoData);
         
         // Create temporary container
         const tempContainer = document.createElement('div');
         tempContainer.innerHTML = pdfContent;
         tempContainer.style.position = 'absolute';
         tempContainer.style.left = '-9999px';
         tempContainer.style.width = '800px';
         tempContainer.style.backgroundColor = 'white';
         tempContainer.style.padding = '20px';
         document.body.appendChild(tempContainer);
         
         // Wait a moment for rendering
         await new Promise(resolve => setTimeout(resolve, 1000));
         
         // Simple PDF generation
         const filename = `DAR_Report_${formData.vId || 'Unknown'}_${new Date().toISOString().split('T')[0]}.pdf`;
         
         await html2pdf()
           .from(tempContainer)
           .set({
             margin: 1,
             filename: filename,
             html2canvas: { 
               scale: 3, 
               useCORS: true, 
               backgroundColor: null, // 🎯 CLAVE: Sin fondo blanco que opaca
               quality: 1.0,
               dpi: 300,
               letterRendering: true
             },
             jsPDF: { 
               unit: 'in', 
               format: 'letter', 
               orientation: 'portrait',
               compress: false,
               precision: 2,
               userUnit: 1.0,
               hotfixes: ["px_scaling"],
               putOnlyUsedFonts: false
             }
           })
           .save();
         
         // Cleanup
         document.body.removeChild(tempContainer);
         
         btn.innerHTML = '<i class="fas fa-check"></i> Downloaded!';
         setTimeout(() => {
           btn.innerHTML = originalText;
           btn.disabled = false;
         }, 2000);
         
         debugLog('✅ Direct PDF download completed successfully!');
         
       } catch (error) {
         debugLog(`❌ Direct download failed: ${error.message}`);
         btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error - Try Again';
         setTimeout(() => {
           btn.innerHTML = originalText;
           btn.disabled = false;
         }, 3000);
       }
     }

     // Preview PDF Content function (for debugging)
     async function previewPDFContent() {
       debugLog('👁️ Generating PDF preview...');
       
       try {
         // Collect all form data
         debugLog('📋 Collecting form data...');
         let formData;
         try {
           formData = collectAllFormData();
           debugLog('✅ Form data collected successfully:', formData);
         } catch (formError) {
           debugLog(`❌ Error in collectAllFormData: ${formError.message}`);
           debugLog(`❌ Form error stack: ${formError.stack}`);
           throw new Error(`Form data collection failed: ${formError.message}`);
         }
         
         if (!formData) {
           throw new Error('collectAllFormData() returned null or undefined');
         }
         
         debugLog('📸 Collecting photo data...');
         const photoData = await collectAllPhotos();
         debugLog('✅ Photo data collected successfully');
         
         debugLog('📄 Generating PDF content...');
         const pdfContent = generatePDFContent(formData, photoData);
         debugLog('✅ PDF content generated successfully');
         
         // Show in a new window for debugging
         const previewWindow = window.open('', '_blank');
         previewWindow.document.write('<!DOCTYPE html><html><head><title>PDF Preview</title><style>body{margin:20px;font-family:Arial,sans-serif;}.content-preview{border:1px solid #ccc;padding:20px;}</style></head><body><h2>PDF Content Preview</h2><div class="content-preview">' + pdfContent + '</div></body></html>');
         previewWindow.document.close();
         
         debugLog('👁️ Preview opened in new window');
         
       } catch (error) {
         debugLog(`❌ Preview generation failed: ${error.message}`);
         debugLog(`❌ Error stack: ${error.stack}`);
         alert(`Error generating preview: ${error.message}\n\nPlease check the browser console for more details.`);
       }
     }

     // Improved form data collection with better field detection
     function collectAllFormData() {
       try {
         // Helper function to safely get value
         const getValue = (id) => {
           const element = document.getElementById(id);
           if (!element) {
             debugLog(`⚠️ Element not found: ${id}`);
             return '';
           }
           return element.value || '';
         };

       const getCheckedValues = (selector) => {
         return Array.from(document.querySelectorAll(selector + ':checked')).map(cb => cb.value);
       };

       const formData = {
         // Basic Info
         vId: getValue('vIdInput') || getValue('vIdField') || '',
         ccId: getValue('ccIdInput') || getValue('ccIdField') || '',
         businessName: getValue('propertyNameInput') || getValue('businessName') || '',
         propertyAddress: getValue('propertyAddressInput') || getValue('propertyAddress') || '',
         city: getValue('city') || '',
         state: getValue('state') || '',
         zipcode: getValue('zipcode') || '',
         
         // Inspector Info
         inspectorFirstName: getValue('inspectorFirstName') || '',
         inspectorLastName: getValue('inspectorLastName') || '',
         inspectorPhone: getValue('inspectorPhone') || '',
         inspectorEmail: getValue('inspectorEmail') || '',
         
         // Inspection Partner Info
         partnerFirstName: getValue('partnerFirstName') || '',
         partnerLastName: getValue('partnerLastName') || '',
         partnerPhone: getValue('partnerPhone') || '',
         partnerEmail: getValue('partnerEmail') || '',
         
         // Owner Info (removed - now handled in Inspection Information)
         ownerFirstName: '',
         ownerLastName: '',
         ownerPhone: '',
         ownerEmail: '',
         
         // Dates
         inspectionDate: getValue('inspectionDate') || '',
         stormDate: getValue('stormDateInput') || getValue('stormDate') || '',
         
         // Property Details
         propertyType: getValue('propertyType') || '',
         buildingType: getValue('buildingType') || '',
         roofSystem: getValue('roofSystem') || '',
         numStories: getValue('numStories') || '',
         roofSquares: getValue('roofSquares') || '',
         
         // Trade Types & Damage
         tradeTypes: getCheckedValues('.tradeType'),
         tradeTypeSeverities: (() => {
           const severities = {};
           document.querySelectorAll('.tradeType:checked').forEach(cb => {
             const trade = cb.value;
             const severitySelect = document.querySelector(`select[data-trade="${trade}"]`);
             if (severitySelect && severitySelect.value) {
               severities[trade] = severitySelect.value;
             }
           });
           return severities;
         })(),
                 confirmedDamage: document.getElementById('confirmedDamageCheckbox')?.checked || false,
        severityRating: getValue('severityRating') || '',
        hvacSeverityRating: getValue('hvacSeverityRating') || '',
        roofSquares: getValue('roofSquares') || '',
         
         // Storm Info
         stormTypes: getCheckedValues('.stormType'),
         hailSize: getValue('hailSize') || '',
         windSpeed: getValue('windSpeed') || '',
         tornadoStrength: getValue('tornadoStrength') || '',
         hurricaneCat: getValue('hurricaneCat') || '',
         stormProximity: getValue('stormProximity') || '',
         numberOfLeaks: getValue('numberOfLeaks') || '',
         numberOfWindows: getValue('numberOfWindows') || '',
         hvacUnitsTotal: (() => {
           const value = getValue('hvac_units_total') || '';
           console.log('🔍 DEBUG: getValue(hvac_units_total):', value);
           return value;
         })(),
         rtusTotal: (() => {
           const value = getValue('rtus_total') || '';
           console.log('🔍 DEBUG: getValue(rtus_total):', value);
           return value;
         })(),
         testSquareDamagedAreas: getValue('testSquareDamagedAreas') || '',
         damageLevel: (() => {
           const selectedRadio = document.querySelector('input[name="damageLevel"]:checked');
           return selectedRadio ? selectedRadio.value : '';
         })(),
         exteriorComponentsObservations: '',
         
         // Photo Explanations
                 interiorPhotoExplanations: {},
        groundExteriorPhotoExplanations: {},
        hvacDamagePhotoExplanations: {},
        roofDamagePhotoExplanations: {},
          roofDamageObservations: {},
          exteriorComponentsSelections: {}
       };

       // Collect photo explanations
       for (let i = 1; i <= 9; i++) {
         // Special handling for Interior Photos 1, 2, 3, 4, 5, 6, 7, 8, and 9 - use interior observations checkboxes
         if (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9) {
           formData.interiorPhotoExplanations[`interior_photo_explanation_${i}`] = getSelectedObservations(`interior_photo_${i}`);
         } else {
           // Regular textarea for other photos
           formData.interiorPhotoExplanations[`interior_photo_explanation_${i}`] = getValue(`interior_photo_explanation_${i}`);
         }
         
         // Special handling for Window Damage Photos 1, 2, 3, 4, 5, 6, 7, 8, and 9 - use exterior observations checkboxes
         if (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9) {
           formData.groundExteriorPhotoExplanations[`ground_exterior_photo_explanation_${i}`] = getSelectedExteriorObservations(`ground_exterior_photo_${i}`);
         } else {
           // Regular textarea for other window damage photos
           formData.groundExteriorPhotoExplanations[`ground_exterior_photo_explanation_${i}`] = getValue(`ground_exterior_photo_explanation_${i}`);
         }
         
         // Special handling for HVAC Damage Photos 1, 2, 3, 4, 5, 6, 7, 8, and 9 - use HVAC observations checkboxes
         if (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9) {
           formData.hvacDamagePhotoExplanations[`hvac_damage_photo_explanation_${i}`] = getSelectedHVACObservations(`hvac_damage_photo_${i}`);
         } else {
           // Regular textarea for other HVAC damage photos
           formData.hvacDamagePhotoExplanations[`hvac_damage_photo_explanation_${i}`] = getValue(`hvac_damage_photo_explanation_${i}`);
         }
         
         formData.roofDamagePhotoExplanations[`roof_damage_photo_explanation_${i}`] = getValue(`roof_damage_photo_explanation_${i}`);

          // Exterior Components selections per photo
          if (document.getElementById(`exterior_components_photo_${i}_section`)) {
            const checked = Array.from(document.querySelectorAll(`#exterior_components_photo_${i}_section input[type="checkbox"]:checked`)).map(cb => cb.nextElementSibling?.innerText || cb.value);
            formData.exteriorComponentsSelections[`exterior_components_photo_${i}`] = checked;
          }
         
         // Special handling for Roof Damage Photos 1, 2, 3, 4, 5, 6, 7, 8, and 9 - use roof damage observations checkboxes
         if (i === 1 || i === 2 || i === 3 || i === 4 || i === 5 || i === 6 || i === 7 || i === 8 || i === 9) {
           formData.roofDamageObservations[`roof_damage_photo_observations_${i}`] = getSelectedRoofDamageObservations(`roof_damage_photo_${i}`);
         }
       }

       // Log which fields have data
       const filledFields = Object.entries(formData).filter(([key, value]) => 
         value !== '' && value !== false && (!Array.isArray(value) || value.length > 0)
       );
       
       debugLog(`📊 Form data summary: ${filledFields.length}/${Object.keys(formData).length} fields filled`);
       filledFields.forEach(([key, value]) => {
         debugLog(`  ✅ ${key}: ${Array.isArray(value) ? value.join(', ') : value}`);
       });

       debugLog('✅ collectAllFormData completed successfully');
       return formData;
       
     } catch (error) {
       debugLog(`❌ Error in collectAllFormData: ${error.message}`);
       debugLog(`❌ Error stack: ${error.stack}`);
       
       // Return a minimal formData object to prevent null errors
       return {
         vId: '',
         ccId: '',
         businessName: '',
         propertyAddress: '',
         city: '',
         state: '',
         zipcode: '',
         inspectorFirstName: '',
         inspectorLastName: '',
         inspectorPhone: '',
         inspectorEmail: '',
         partnerFirstName: '',
         partnerLastName: '',
         partnerPhone: '',
         partnerEmail: '',
         ownerFirstName: '',
         ownerLastName: '',
         ownerPhone: '',
         ownerEmail: '',
         inspectionDate: '',
         stormDate: '',
         propertyType: '',
         buildingType: '',
         roofSystem: '',
         numStories: '',
         roofSquares: '',
         tradeTypes: [],
         tradeTypeSeverities: {},
         confirmedDamage: false,
         severityRating: '',
         hvacSeverityRating: '',
         stormTypes: [],
         hailSize: '',
         windSpeed: '',
         tornadoStrength: '',
         hurricaneCat: '',
         stormProximity: '',
         numberOfLeaks: '',
         numberOfWindows: '',
         hvacUnitsTotal: '',
         rtusTotal: '',
         testSquareDamagedAreas: '',
         interiorPhotoExplanations: {},
         groundExteriorPhotoExplanations: {},
         hvacDamagePhotoExplanations: {},
         roofDamagePhotoExplanations: {},
         roofDamageObservations: {}
       };
     }
   }

   // Force remove duplicate buttons on page load
   function removeDuplicateButtons() {
     debugLog('🔧 Checking for duplicate buttons...');
     
     // Find all buttons that contain "Preview" in their text
     const allButtons = document.querySelectorAll('button');
     const previewButtons = [];
     
     allButtons.forEach((btn, index) => {
       if (btn.textContent.includes('Preview') && btn.textContent.includes('Report')) {
         previewButtons.push({btn, index, text: btn.textContent.trim()});
       }
     });
     
     debugLog(`🔧 Found ${previewButtons.length} Preview Report buttons`);
     
     // Keep only the correct ones and remove duplicates
     previewButtons.forEach(({btn, index, text}) => {
       if (text === 'Preview Report' && btn.id !== 'previewPdfBtn') {
         debugLog(`🗑️ Removing duplicate button: "${text}" (index ${index})`);
         btn.remove();
       }
     });
     
     // Double check - should only be 2 buttons: Preview PDF Content & Download PDF
     setTimeout(() => {
       const remainingButtons = document.querySelectorAll('button');
       const step5Buttons = [];
       remainingButtons.forEach(btn => {
         if (btn.closest('#step-5') && btn.textContent.includes('Preview')) {
           step5Buttons.push(btn.textContent.trim());
         }
       });
       debugLog(`✅ Step 5 Preview buttons remaining: ${step5Buttons.join(', ')}`);
     }, 100);
   }

   // Download DAR Report function
   async function downloadDARReport() {
     debugLog('📥 Starting PDF download...');
     
     const btn = document.getElementById('downloadReportBtn');
     const originalText = btn.innerHTML;
     btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
     btn.disabled = true;

     try {
       // Collect form data
       const formData = collectAllFormData();
       const v_id = formData.vId;
       
       if (!v_id) {
         throw new Error('V-ID is required to generate report');
       }
       
       debugLog(`📋 Generating PDF for V-ID: ${v_id}`);
       
       // Generate PDF content
       const photoData = await collectAllPhotos();
       const pdfContent = generatePDFContent(formData, photoData);
       
       // Create temporary container for PDF generation
       const tempContainer = document.createElement('div');
       tempContainer.innerHTML = pdfContent;
       tempContainer.style.position = 'absolute';
       tempContainer.style.left = '-9999px';
       tempContainer.style.width = '800px';
       tempContainer.style.backgroundColor = 'white';
       tempContainer.style.padding = '20px';
       document.body.appendChild(tempContainer);
       
       // Wait for images to load
       await new Promise(resolve => setTimeout(resolve, 2000));
       
       // Generate PDF blob
       const pdfBlob = await html2pdf()
         .from(tempContainer)
         .set({
           margin: 1,
           html2canvas: { 
             scale: 3, 
             useCORS: true, 
             backgroundColor: null, // 🎯 CLAVE: Sin fondo blanco que opaca
             quality: 1.0,
             dpi: 300,
             letterRendering: true
           },
           jsPDF: { 
             unit: 'in', 
             format: 'letter', 
             orientation: 'portrait',
             compress: false,
             precision: 2,
             userUnit: 1.0,
             hotfixes: ["px_scaling"],
             putOnlyUsedFonts: false
           }
         })
         .outputPdf('blob');
       
       // Cleanup
       document.body.removeChild(tempContainer);
       
       debugLog('📄 PDF generated, initiating download...');
       
       // Download PDF
       const fileName = `DAR_Report_${v_id}_${new Date().toISOString().split('T')[0]}.pdf`;
       const url = URL.createObjectURL(pdfBlob);
       const a = document.createElement('a');
       a.href = url;
       a.download = fileName;
       document.body.appendChild(a);
       a.click();
       document.body.removeChild(a);
       URL.revokeObjectURL(url);
       
       btn.innerHTML = '<i class="fas fa-check"></i> PDF Downloaded!';
       
       // Show success message
       alert(`✅ DAR Report downloaded successfully!\\n\\nFile: ${fileName}\\n\\nYou can now upload this file to Monday.com using the "Upload to Monday.com" button.`);
       
       debugLog(`✅ PDF downloaded successfully: ${fileName}`);
       
       // Reset button after delay
       setTimeout(() => {
         btn.innerHTML = originalText;
         btn.disabled = false;
       }, 3000);
       
     } catch (error) {
       debugLog(`❌ Download failed: ${error.message}`);
       btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Download Failed - Try Again';
       alert(`❌ Download failed: ${error.message}`);
       
       setTimeout(() => {
         btn.innerHTML = originalText;
         btn.disabled = false;
       }, 3000);
     }
   }
       
                       // Monday.com Upload Modal Functions
        function openMondayUploadModal() {
          debugLog('📤 Opening Monday.com upload modal...');
          
          // Get V-ID and project info
          const formData = collectAllFormData();
          const v_id = formData.vId || '--';
          const projectName = formData.businessName || '--';
          
          // Update modal display
          document.getElementById('uploadVidDisplay').textContent = v_id;
          document.getElementById('uploadProjectDisplay').textContent = projectName;
          
          // Show modal
          document.getElementById('mondayUploadModal').style.display = 'block';
          
          debugLog(`📋 Upload modal opened for V-ID: ${v_id}`);
        }
        
        function closeMondayUploadModal() {
          debugLog('📴 Closing Monday.com upload modal...');
          document.getElementById('mondayUploadModal').style.display = 'none';
          
          // Reset form
          document.getElementById('mondayFileInput').value = '';
          document.getElementById('fileSelectedInfo').style.display = 'none';
          document.getElementById('uploadToMondaySubmitBtn').disabled = true;
        }
        
        function handleFileSelection(input) {
          const file = input.files[0];
          const fileInfo = document.getElementById('fileSelectedInfo');
          const fileName = document.getElementById('selectedFileName');
          const submitBtn = document.getElementById('uploadToMondaySubmitBtn');
          
          if (file) {
            // Validate file type
            if (file.type !== 'application/pdf') {
              alert('⚠️ Please select a PDF file only.');
              input.value = '';
              return;
            }
            
            // Show file info
            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            submitBtn.disabled = false;
            
            debugLog(`📎 File selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
          } else {
            fileInfo.style.display = 'none';
            submitBtn.disabled = true;
          }
        }
        
        async function submitFileToMonday() {
          debugLog('🚀 Starting REAL upload to Monday.com...');
          
          const btn = document.getElementById('uploadToMondaySubmitBtn');
          const originalText = btn.innerHTML;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading to Monday.com...';
          btn.disabled = true;
          
          try {
            const fileInput = document.getElementById('mondayFileInput');
            const file = fileInput.files[0];
            const v_id = document.getElementById('uploadVidDisplay').textContent;
            
            if (!file) {
              throw new Error('Please select a PDF file first');
            }
            
            if (!v_id || v_id === '--') {
              throw new Error('V-ID is required for upload');
            }
            
            debugLog(`📋 Uploading ${file.name} for V-ID: ${v_id}`);
            debugLog(`📊 File size: ${(file.size / 1024).toFixed(1)} KB`);
            debugLog(`📄 File type: ${file.type}`);
            debugLog(`📅 File last modified: ${new Date(file.lastModified)}`);
            debugLog(`🔍 File path: ${file.webkitRelativePath || 'N/A'}`);
            debugLog(`📋 File name analysis: ${file.name}`);
            
            // Enhanced file validation with specific debugging
            if (file.size === 0) {
              debugLog(`❌ PROBLEMA: Archivo vacío detectado`);
              throw new Error('The selected file is empty (0 bytes). Please download the PDF report first and ensure it was created successfully.');
            }
            
            if (file.size < 1000) {
              debugLog(`❌ PROBLEMA: Archivo muy pequeño - ${file.size} bytes`);
              throw new Error(`The file is very small (${file.size} bytes). This might indicate an incomplete PDF. Please regenerate and download the PDF report.`);
            }
            
            // Additional verification for PDF content
            if (!file.type.includes('pdf') && !file.name.toLowerCase().includes('.pdf')) {
              debugLog(`⚠️ ADVERTENCIA: File type is '${file.type}', name is '${file.name}'`);
              const continueUpload = confirm(`The selected file doesn't appear to be a PDF.\\n\\nFile: ${file.name}\\nType: ${file.type}\\n\\nDo you want to continue?`);
              if (!continueUpload) {
                throw new Error('Upload cancelled - please select a PDF file');
              }
            }
            
            // Advanced file analysis
            const reader = new FileReader();
            reader.onload = function(e) {
              const bytes = new Uint8Array(e.target.result.slice(0, 8));
              const hex = Array.from(bytes, byte => byte.toString(16).padStart(2, '0')).join(' ');
              debugLog(`🔍 File header (hex): ${hex}`);
              
              // PDF files should start with %PDF
              const textDecoder = new TextDecoder();
              const header = textDecoder.decode(e.target.result.slice(0, 4));
              debugLog(`🔍 File header (text): ${header}`);
              
              if (header !== '%PDF') {
                debugLog(`⚠️ WARNING: File doesn't start with '%PDF' - got '${header}'`);
              } else {
                debugLog(`✅ File appears to be a valid PDF`);
              }
              
              // Calculate file hash for integrity verification
              calculateFileHash(file);
            };
            reader.readAsArrayBuffer(file.slice(0, 32));
            
            // Detailed FormData analysis
            debugLog(`📋 FormData Analysis:`);
            debugLog(`   - V-ID: ${v_id}`);
            debugLog(`   - File object: ${file.constructor.name}`);
            debugLog(`   - File instanceof File: ${file instanceof File}`);
            debugLog(`   - File instanceof Blob: ${file instanceof Blob}`);
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('v_id', v_id);
            formData.append('file', file);
            
            debugLog(`📤 FormData created with file and V-ID`);
            debugFormData(formData);
            
            // Upload to Monday.com via our API
            const response = await fetch('/api/upload-file-to-monday', {
              method: 'POST',
              body: formData
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
              btn.innerHTML = '<i class="fas fa-check"></i> Successfully Uploaded!';
              
              // Show success message
              alert(`✅ File processed successfully!\\n\\nFile: ${result.filename}\\nV-ID: ${result.v_id}\\nColumn: files_mkn7es21\\n\\nA reference to the PDF has been added to your Monday.com project. The file is also saved locally for manual upload if needed.`);
              
              debugLog(`✅ Upload completed successfully: ${result.filename}`);
              
              // Close modal after delay
              setTimeout(() => {
                closeMondayUploadModal();
              }, 2000);
              
            } else {
              throw new Error(result.error || 'Upload failed');
            }
            
          } catch (error) {
            debugLog(`❌ Upload failed: ${error.message}`);
            btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Upload Failed - Try Again';
            alert(`❌ Upload failed: ${error.message}\\n\\nPlease check the console for more details and try again.`);
            
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.disabled = false;
            }, 3000);
          }
        }
       
               function finishAndRestart() {
          console.log('🔄 Finishing current report and starting new one...');
          
          // Show confirmation message
          const confirmed = confirm('Are you sure you want to finish this report and start a new one?\n\nThis will clear all current form data.');
          
          if (confirmed) {
            console.log('✅ User confirmed restart');
            
            try {
              // Clear all form data
              const form = document.getElementById('darForm');
              if (form) {
                form.reset();
                console.log('✅ Form reset');
              }
              
              // Clear session storage
              sessionStorage.clear();
              console.log('✅ Session storage cleared');
              
              // Reset current step
              currentStep = 1;
              console.log('✅ Current step reset to 1');
              
              // Update progress bar
              updateProgress(1);
              console.log('✅ Progress updated');
              
              // Hide all steps and show step 1
              const allSteps = document.querySelectorAll('.form-step');
              allSteps.forEach(el => {
                el.classList.remove('active');
                console.log('✅ Removed active from step');
              });
              
              const step1 = document.getElementById('step-1');
              if (step1) {
                step1.classList.add('active');
                console.log('✅ Step 1 activated');
              }
              
              // HIDE Complete Report section completely to avoid user confusion
              const step6 = document.getElementById('step-6');
              if (step6) {
                step6.style.display = 'none';
                console.log('✅ Step 6 (Complete Report) hidden from view');
              }
              
              // Reset step 6 progress circle
              const step6Circle = document.getElementById('step-circle-6');
              if (step6Circle) {
                step6Circle.classList.remove('active');
                step6Circle.style.opacity = '0.5';
                step6Circle.style.pointerEvents = 'none';
                step6Circle.style.cursor = 'default';
                console.log('✅ Step 6 progress circle reset');
              }
              
              // Clear V-ID input
              const vIdInput = document.getElementById('vIdInput');
              if (vIdInput) {
                vIdInput.value = '';
                console.log('✅ V-ID input cleared');
              }
              
              // Clear V-ID displays
              const submitVidDisplay = document.getElementById('submitVidDisplay');
              if (submitVidDisplay) {
                submitVidDisplay.textContent = '--';
                console.log('✅ V-ID display cleared');
              }
              
              // Clear all photo thumbnails
              const photoContainers = document.querySelectorAll('.companycam-thumbs');
              photoContainers.forEach(container => {
                container.innerHTML = '';
              });
              console.log('✅ Photo thumbnails cleared');
              
              // Reset button states
              const nextBtnStep1 = document.getElementById('nextBtnStep1');
              if (nextBtnStep1) {
                nextBtnStep1.innerHTML = '<span id="btnText">Fetch Data</span><span id="loadingSpinner" style="display:none;" class="spinner"></span>';
                nextBtnStep1.disabled = false;
                nextBtnStep1.style.background = '';
                console.log('✅ Button reset');
              }
              
              // Hide CompanyCam status
              const companyCamStatus = document.getElementById('companyCamStatus');
              if (companyCamStatus) {
                companyCamStatus.style.display = 'none';
                console.log('✅ CompanyCam status hidden');
              }
              
              // Show success message
              alert('✅ Form successfully reset.\n\nYou can now start a new DAR report.');
              
              console.log('🎉 Form reset complete - ready for new report');
              
              // Scroll to top
              window.scrollTo(0, 0);
              
              // Focus on V-ID input
              if (vIdInput) {
                vIdInput.focus();
                console.log('✅ Focus set on V-ID input');
              }
              
            } catch (error) {
              console.error('❌ Error during restart:', error);
              alert('❌ Error restarting the form. Please reload the page.');
            }
          } else {
            console.log('❌ User cancelled restart');
          }
        }
        
                // Calculate file hash for integrity verification
        async function calculateFileHash(file) {
          try {
            debugLog(`🔐 Calculating file hash...`);
            
            const arrayBuffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            debugLog(`🔐 File SHA-256: ${hashHex.substring(0, 16)}...`);
            debugLog(`📊 Hash calculation - Array buffer size: ${arrayBuffer.byteLength} bytes`);
            
            // Store hash for later verification
            window.currentFileHash = hashHex;
            
          } catch (error) {
            debugLog(`❌ Error calculating hash: ${error.message}`);
          }
        }
        
        // Enhanced FormData debugging
        function debugFormData(formData) {
          debugLog(`📋 FormData Debug:`);
          for (let [key, value] of formData.entries()) {
            if (value instanceof File) {
              debugLog(`   - ${key}: File(${value.name}, ${value.size} bytes, ${value.type})`);
              debugLog(`     • Last Modified: ${new Date(value.lastModified)}`);
              debugLog(`     • WebKit Path: ${value.webkitRelativePath || 'N/A'}`);
            } else {
              debugLog(`   - ${key}: ${value}`);
            }
          }
        }
        
        // Update V-ID display when form data changes
        function updateSubmitVidDisplay() {
         const vIdField = document.getElementById('vIdField') || document.getElementById('vIdInput');
         const displayElement = document.getElementById('submitVidDisplay');
         
         if (vIdField && displayElement) {
           const vId = vIdField.value || '--';
           displayElement.textContent = vId;
         }
       }
       
       // Auto-execute on page load
       document.addEventListener('DOMContentLoaded', () => {
         removeDuplicateButtons();
         updateSubmitVidDisplay();
         
         // Update V-ID display when it changes
         const vIdField = document.getElementById('vIdField') || document.getElementById('vIdInput');
         if (vIdField) {
           vIdField.addEventListener('input', updateSubmitVidDisplay);
         }
       });
       window.addEventListener('load', removeDuplicateButtons);

       // Close modals when clicking outside
       window.addEventListener('click', function(event) {
         // Close CompanyCam modal
         const uploadModal = document.getElementById('uploadModal');
         if (event.target === uploadModal) {
           closeUploadModal();
         }
         
         // Close Monday.com upload modal
         const mondayModal = document.getElementById('mondayUploadModal');
         if (event.target === mondayModal) {
           closeMondayUploadModal();
         }
             });

    // ============================================================================
    // DEDICATED COMPANYCAM MODAL FUNCTIONS
    // ============================================================================
    
    // Global variables for dedicated modal
    let dedicatedSelectedPhotos = [];
    let dedicatedProjectPhotos = [];
    
    // Open dedicated CompanyCam modal
    function openDedicatedCompanyCamModal() {
      // This is now just a wrapper for the PICK-CAM version
      openDedicatedPickCamModal();
    }

    function openDedicatedPickCamModal() {
      debugLog('🎬 Opening dedicated PICK-CAM modal');
      document.getElementById('companyCamPhotosModal').style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
      
      // Update modal header to show PICK-CAM
      const headerBadge = document.querySelector('.companycam-header-badge .companycam-badge-text');
      if (headerBadge) {
        headerBadge.textContent = 'PICK-CAM Photos';
      }
      
      // Load photos if we have project data
      const projectId = currentProjectId || document.getElementById('ccIdField')?.value;
      if (projectId) {
        loadPhotosInDedicatedPickCamModal(projectId);
      }
    }
    
    // Close dedicated CompanyCam modal
    function closeDedicatedCompanyCamModal() {
      debugLog('🎬 Closing dedicated CompanyCam modal');
      document.getElementById('companyCamPhotosModal').style.display = 'none';
      document.body.style.overflow = 'auto'; // Restore background scrolling
    }
    
    // Load photos in dedicated modal - PICK-CAM VERSION
    async function loadPhotosInDedicatedModal(projectId) {
      // This is now just a wrapper for the PICK-CAM version
      loadPhotosInDedicatedPickCamModal(projectId);
    }

    async function loadPhotosInDedicatedPickCamModal(projectId) {
      if (!projectId) {
        debugLog('❌ No Project ID provided');
        return;
      }
      
      debugLog(`📸 Loading photos in dedicated modal for project: ${projectId}`);
      
      // Show loading state
      document.getElementById('dedicatedModalProjectTitle').textContent = 'Loading Photos...';
      document.getElementById('dedicatedPhotoCount').textContent = 'Loading...';
      document.getElementById('dedicatedPhotoGrid').innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #6c757d;">
          <i class="fas fa-spinner fa-spin" style="font-size: 4em; opacity: 0.3; margin-bottom: 20px; display: block;"></i>
          <h3 style="margin: 0 0 10px 0; color: #495057;">Loading Photos...</h3>
          <p style="margin: 0; font-size: 1.1em;">Fetching all photos from PICK-CAM...</p>
        </div>
      `;
      
      try {
        const response = await fetch(`/api/projects/${projectId}/dar-photos`);
        
        const data = await response.json();
        debugLog(`📡 Dedicated modal API response:`, data);
        
        if (response.ok && !data.error) {
          displayPhotosInDedicatedPickCamModal(data, projectId);
        } else {
          showDedicatedModalError(data.error || 'Failed to load photos');
        }
      } catch (error) {
        debugLog(`❌ Error loading photos in dedicated modal: ${error}`);
        showDedicatedModalError('Network error loading photos');
      }
    }

    function displayPhotosInDedicatedPickCamModal(data, projectId) {
      const photos = data.photos || [];
      
      debugLog(`🎯 Displaying ${photos.length} PICK-CAM photos in dedicated modal`);
      
      // Store photos globally
      dedicatedProjectPhotos = photos;
      dedicatedSelectedPhotos = [];
      
      // Update header
      document.getElementById('dedicatedModalProjectTitle').textContent = data.project_name || `Project ${projectId}`;
      document.getElementById('dedicatedPhotoCount').textContent = `${photos.length} photos`;
      
      // Generate photo grid
      if (photos.length === 0) {
        document.getElementById('dedicatedPhotoGrid').innerHTML = `
          <div class="companycam-empty-state">
            <i class="fas fa-info-circle companycam-empty-icon"></i>
            <h3 class="companycam-empty-title">No Photos Found</h3>
            <p class="companycam-empty-description">This project doesn't have any photos yet. Add photos in PICK-CAM first.</p>
          </div>
        `;
        return;
      }
      
      let photosHtml = '';
      photos.forEach((photo, index) => {
        const photoDate = photo.date || 'No date';
        const photoAuthor = photo.author || 'Unknown';
        const photoDesc = photo.description || photo.voice_comment || '';
        
        photosHtml += `
          <div class="companycam-photo-item" data-index="${index}" onclick="toggleDedicatedPhotoSelection(${index})">
            <div class="companycam-photo-container">
              <img src="${photo.url}" alt="Photo ${index + 1}" class="companycam-photo-img" loading="lazy">
              <div class="companycam-photo-overlay">
                <div class="companycam-photo-checkbox">
                  <i class="fas fa-check"></i>
                </div>
              </div>
            </div>
            <div class="companycam-photo-info">
              <div class="companycam-photo-meta">
                <span class="companycam-photo-date">${photoDate}</span>
                <span class="companycam-photo-author">${photoAuthor}</span>
              </div>
              ${photoDesc ? `<div class="companycam-photo-desc">${photoDesc}</div>` : ''}
            </div>
          </div>
        `;
      });
      
      document.getElementById('dedicatedPhotoGrid').innerHTML = photosHtml;
      
      // Add event listeners to photos (backup to onclick)
      setTimeout(() => {
        document.querySelectorAll('.companycam-photo-item[data-index]').forEach((element, actualIndex) => {
          const dataIndex = element.getAttribute('data-index');
          console.log(`🔧 Setting up photo ${actualIndex}: data-index=${dataIndex}`);
          
          // Remove existing listeners to avoid duplicates
          element.onclick = null;
          
          // Add click listener
          element.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log(`🖱️ EVENT LISTENER: Photo clicked - data-index=${dataIndex}`);
            toggleDedicatedPhotoSelection(parseInt(dataIndex));
          });
        });
        
        console.log(`✅ Event listeners configured for ${document.querySelectorAll('.companycam-photo-item[data-index]').length} photos`);
      }, 100);
      
      debugLog(`✅ Successfully displayed ${photos.length} PICK-CAM photos`);
    }

    function showDedicatedModalError(errorMessage) {
      document.getElementById('dedicatedPhotoGrid').innerHTML = `
        <div class="companycam-empty-state">
          <i class="fas fa-exclamation-triangle companycam-empty-icon" style="color: #dc3545;"></i>
          <h3 class="companycam-empty-title">Error Loading Photos</h3>
          <p class="companycam-empty-description">${errorMessage}</p>
        </div>
      `;
    }
    
    // Display photos in dedicated modal
    function displayPhotosInDedicatedModal(data, ccId) {
      const photos = data.photos || [];
      const stats = {
        total_photos: data.total_photos || photos.length,
        pages_processed: data.pages_processed || 0,
        duplicates_removed: data.duplicates_removed || 0
      };
      
      debugLog(`🎯 Displaying ${photos.length} photos in dedicated modal`);
      
      // Store photos globally
      dedicatedProjectPhotos = photos;
      dedicatedSelectedPhotos = [];
      
      // Update header
      document.getElementById('dedicatedModalProjectTitle').textContent = `Project ${ccId}`;
      
      let countText = `${stats.total_photos} photos`;
      if (stats.duplicates_removed > 0) {
        countText += ` (${stats.duplicates_removed} duplicates removed)`;
      }
      if (stats.pages_processed > 0) {
        countText += ` - ${stats.pages_processed} pages`;
      }
      document.getElementById('dedicatedPhotoCount').textContent = countText;
      
      // Generate photo grid with responsive CSS classes
      if (photos.length === 0) {
        document.getElementById('dedicatedPhotoGrid').innerHTML = `
          <div class="companycam-empty-state">
            <i class="fas fa-info-circle companycam-empty-icon"></i>
            <h3 class="companycam-empty-title">No Photos Found</h3>
            <p class="companycam-empty-description">This project doesn't have any photos</p>
          </div>
        `;
        return;
      }
      
      let gridHtml = '';
      photos.forEach((photo, index) => {
        let thumbUrl = '';
        let originalUrl = '';
        
        if (photo.uris && Array.isArray(photo.uris)) {
          // Para mostrar thumbnails, usar 'web' o 'thumbnail'
          const thumbObj = photo.uris.find(u => u.type === 'web') || photo.uris.find(u => u.type === 'thumbnail') || photo.uris[0];
          
          // Para el enlace original: preferir 'original', luego 'web' de mayor tamaño, luego cualquiera
          let originalObj = photo.uris.find(u => u.type === 'original');
          if (!originalObj) {
            // Si no hay 'original', buscar el 'web' más grande o cualquier URI disponible
            const webUris = photo.uris.filter(u => u.type === 'web');
            if (webUris.length > 0) {
              // Tomar el primero de 'web' (suele ser el más grande)
              originalObj = webUris[0];
            } else {
              originalObj = photo.uris[0];
            }
          }
          
          thumbUrl = thumbObj?.url || thumbObj?.uri || '';
          let rawOriginalUrl = originalObj?.url || originalObj?.uri || thumbUrl;
          
          // La URL 'original' ya debería venir con el tamaño completo desde CompanyCam API
          originalUrl = rawOriginalUrl;
          debugLog(`📸 Modal photo Original URL: ${originalUrl.includes('rs:fit:4032') ? '✅ Large' : '⚠️ Small'} - ${originalUrl.substring(0, 80)}...`);
        }
        
        if (thumbUrl) {
          gridHtml += `
            <div class="companycam-photo-item photo-thumb" data-index="${index}">
              <img src="${thumbUrl}" alt="Photo ${index + 1}" 
                   onload="this.style.opacity='1'" 
                   onerror="this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:#6c757d;\\'>❌</div>'"
                   style="opacity: 0; transition: opacity 0.3s ease; pointer-events: none;">
              <div class="companycam-photo-overlay">
                <i class="fas fa-check"></i>
              </div>
            </div>
          `;
        }
      });
      
      document.getElementById('dedicatedPhotoGrid').innerHTML = gridHtml;
      debugLog(`✅ Rendered ${photos.length} photos in dedicated modal grid`);
      
      // ✅ NUEVA SOLUCIÓN: Event listeners en lugar de onclick inline
      console.log(`🔗 Setting up event listeners for ${photos.length} photos...`);
      
      // Agregar event listeners a todas las fotos
      document.querySelectorAll('.companycam-photo-item[data-index]').forEach((element, actualIndex) => {
        const dataIndex = parseInt(element.getAttribute('data-index'));
        console.log(`🎯 Setting listener for photo ${dataIndex + 1} (actual index: ${actualIndex})`);
        
        element.addEventListener('click', function(event) {
          event.stopPropagation();
          console.log(`🖱️ EVENT LISTENER CLICK: Photo ${dataIndex + 1} clicked!`);
          
          // ✅ APLICAR FEEDBACK VISUAL ANTES DE TOGGLE
          const wasSelected = dedicatedSelectedPhotos.includes(dataIndex);
          console.log(`🔍 BEFORE TOGGLE: Photo ${dataIndex + 1} was ${wasSelected ? 'SELECTED' : 'NOT SELECTED'}`);
          
          // Ejecutar toggle
          toggleDedicatedPhotoSelection(dataIndex);
          
          // ✅ APLICAR FEEDBACK VISUAL DESPUÉS DE TOGGLE
          const isNowSelected = dedicatedSelectedPhotos.includes(dataIndex);
          console.log(`🔍 AFTER TOGGLE: Photo ${dataIndex + 1} is ${isNowSelected ? 'SELECTED' : 'NOT SELECTED'}`);
          
          if (isNowSelected) {
            // Seleccionar visualmente
            element.classList.add('selected');
            element.style.border = '3px solid #3498db !important';
            element.style.transform = 'scale(0.95) !important';
            element.style.boxShadow = '0 4px 16px rgba(52, 152, 219, 0.4) !important';
            element.style.borderRadius = '8px !important';
            
            // ✅ AGREGAR CHECKMARK VISUAL
            let checkmark = element.querySelector('.visual-checkmark');
            if (!checkmark) {
              checkmark = document.createElement('div');
              checkmark.className = 'visual-checkmark';
              checkmark.innerHTML = '✓';
              checkmark.style.cssText = `
                position: absolute;
                top: 8px;
                right: 8px;
                background: #3498db;
                color: white;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 14px;
                z-index: 10;
                pointer-events: none;
              `;
              element.appendChild(checkmark);
            }
            checkmark.style.display = 'flex';
            
            console.log(`✅ VISUAL APPLIED: Photo ${dataIndex + 1} marcada como seleccionada con checkmark`);
          } else {
            // Deseleccionar visualmente
            element.classList.remove('selected');
            element.style.border = '';
            element.style.transform = '';
            element.style.boxShadow = '';
            element.style.borderRadius = '';
            
            // ✅ REMOVER CHECKMARK VISUAL
            const checkmark = element.querySelector('.visual-checkmark');
            if (checkmark) {
              checkmark.style.display = 'none';
            }
            
            console.log(`❌ VISUAL REMOVED: Photo ${dataIndex + 1} desmarcada sin checkmark`);
          }
        });
        
        // ✅ ASEGURAR POSICIONAMIENTO PARA CHECKMARK
        element.style.position = 'relative';
        element.style.overflow = 'hidden';
        
        // Asegurar que la imagen no interfiera
        const img = element.querySelector('img');
        if (img) {
          img.style.pointerEvents = 'none';
        }
      });
      
      console.log(`✅ Event listeners configured for ${document.querySelectorAll('.companycam-photo-item[data-index]').length} photos`);
    }
    
    // Toggle photo selection in dedicated modal
    function toggleDedicatedPhotoSelection(index) {
      // ✅ EXTRA DEBUG: Always show this even if debugLog is off
      console.log(`🖱️ CLICK TEST: Photo ${index + 1} clicked!`);
      debugLog(`🖱️ Click detected on photo ${index + 1}`);
      
      const photoElement = document.querySelector(`[data-index="${index}"]`);
      if (!photoElement) {
        console.error(`❌ CRITICAL: Photo element not found for index ${index}`);
        debugLog(`❌ Photo element not found for index ${index}`);
        return;
      }
      
      console.log(`✅ SUCCESS: Photo element found with classes: ${photoElement.className}`);
      debugLog(`✅ Photo element found: ${photoElement.className}`);
      
      const isSelected = dedicatedSelectedPhotos.includes(index);
      console.log(`📋 SELECTION STATE: ${isSelected ? 'SELECTED' : 'NOT SELECTED'}`);
      debugLog(`📋 Current selection state: ${isSelected ? 'selected' : 'not selected'}`);
      
      if (isSelected) {
        // Deselect
        dedicatedSelectedPhotos = dedicatedSelectedPhotos.filter(i => i !== index);
        photoElement.classList.remove('selected');
        // ✅ APLICAR ESTILOS DIRECTAMENTE PARA DESELECCIÓN
        photoElement.style.border = '';
        photoElement.style.transform = '';
        photoElement.style.boxShadow = '';
        console.log(`➖ DESELECTED: Photo ${index + 1}. Classes now: ${photoElement.className}`);
        debugLog(`➖ Photo ${index + 1} deselected. Removed 'selected' class.`);
      } else {
        // Select
        dedicatedSelectedPhotos.push(index);
        photoElement.classList.add('selected');
        // ✅ APLICAR ESTILOS DIRECTAMENTE PARA SELECCIÓN
        photoElement.style.border = '3px solid #3498db';
        photoElement.style.transform = 'scale(0.95)';
        photoElement.style.boxShadow = '0 4px 16px rgba(52, 152, 219, 0.4)';
        console.log(`➕ SELECTED: Photo ${index + 1}. Classes now: ${photoElement.className}`);
        debugLog(`➕ Photo ${index + 1} selected. Added 'selected' class.`);
      }
      
      console.log(`📊 TOTAL SELECTED: ${dedicatedSelectedPhotos.length} photos`);
      console.log(`📋 SELECTED ARRAY: [${dedicatedSelectedPhotos.join(', ')}]`);
      debugLog(`📊 Total selected photos: ${dedicatedSelectedPhotos.length}`);
      debugLog(`📋 Selected indices: [${dedicatedSelectedPhotos.join(', ')}]`);
      
      // Update selection count in header
      const countElement = document.getElementById('dedicatedPhotoCount');
      if (countElement) {
        const totalPhotos = dedicatedProjectPhotos.length;
        const selectedCount = dedicatedSelectedPhotos.length;
        countElement.textContent = `${totalPhotos} photos (${selectedCount} selected)`;
      }
      debugLog(`🎨 Photo element classes after change: ${photoElement.className}`);
    }
    
    // ✅ TEST FUNCTION: Call this manually from console
    window.testPhotoSelection = function(index) {
      console.log(`🧪 MANUAL TEST: Testing photo ${index} selection...`);
      toggleDedicatedPhotoSelection(index);
    };
    
    // Select all photos in dedicated modal
    function selectAllPhotosInDedicated() {
      dedicatedSelectedPhotos = [];
      
      document.querySelectorAll('.companycam-photo-item, .photo-thumb').forEach((element, index) => {
        dedicatedSelectedPhotos.push(index);
        element.classList.add('selected');
        // ✅ APLICAR ESTILOS VISUALES PARA SELECT ALL
        element.style.border = '3px solid #3498db';
        element.style.transform = 'scale(0.95)';
        element.style.boxShadow = '0 4px 16px rgba(52, 152, 219, 0.4)';
        element.style.borderRadius = '8px';
        element.style.position = 'relative';
        
        // ✅ AGREGAR CHECKMARK PARA SELECT ALL
        let checkmark = element.querySelector('.visual-checkmark');
        if (!checkmark) {
          checkmark = document.createElement('div');
          checkmark.className = 'visual-checkmark';
          checkmark.innerHTML = '✓';
          checkmark.style.cssText = `
            position: absolute;
            top: 8px;
            right: 8px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            z-index: 10;
            pointer-events: none;
          `;
          element.appendChild(checkmark);
        }
        checkmark.style.display = 'flex';
      });
      
      console.log(`✅ SELECT ALL: ${dedicatedSelectedPhotos.length} fotos visualmente seleccionadas`);
      debugLog(`✅ Selected all ${dedicatedSelectedPhotos.length} photos in dedicated modal`);
    }
    
    // Clear all selections in dedicated modal
    function clearAllPhotosInDedicated() {
      dedicatedSelectedPhotos = [];
      
      document.querySelectorAll('.companycam-photo-item, .photo-thumb').forEach(element => {
        element.classList.remove('selected');
        // ✅ REMOVER ESTILOS VISUALES PARA CLEAR ALL
        element.style.border = '';
        element.style.transform = '';
        element.style.boxShadow = '';
        element.style.borderRadius = '';
        
        // ✅ REMOVER CHECKMARK PARA CLEAR ALL
        const checkmark = element.querySelector('.visual-checkmark');
        if (checkmark) {
          checkmark.style.display = 'none';
        }
      });
      
      console.log(`🗑️ CLEAR ALL: Todas las fotos deseleccionadas visualmente`);
      debugLog(`🗑️ Cleared all photo selections in dedicated modal`);
    }
    
    // ✅ FUNCIÓN FALTANTE: Add CompanyCam photos to a section
    function addCompanyCamPhotosToSection(sectionId, photosData) {
      console.log(`📤 Adding ${photosData.length} photos to section: ${sectionId}`);
      
      const thumbsContainer = document.getElementById(`${sectionId}_thumbs`);
      if (!thumbsContainer) {
        console.error(`❌ Container not found: ${sectionId}_thumbs`);
        return;
      }
      
      // === VALIDATION: 4 PHOTOS MAX PER SECTION ===
      const existingPhotos = thumbsContainer.querySelectorAll('.companycam-thumb');
      let selectedPhotos = [...photosData]; // Copy array for manipulation
      
      // Check if this is the 9th subsection (no photo limit)
      const isNinthSection = sectionId.endsWith('_9');
      
      // Check if this is a single-photo section (5 specific sections)
      // Note: property_damage_highlights is NOT in this list - it has no restrictions
      const singlePhotoSections = [
        'identifying_photo_address', 'business_identifier_sign',
        'roof_access', 'rooftop_obstructions', 
        'noaa_swath_screenshot', 'impact_report_screenshot',
        'ground_front', 'ground_back', 'ground_left_side', 'ground_right_side',
        'aerial_overview', 'property_entrance'
      ];
      const isSinglePhotoSection = singlePhotoSections.includes(sectionId);
      
      if (isSinglePhotoSection && existingPhotos.length + selectedPhotos.length > 1) {
        if (existingPhotos.length >= 1) {
          alert('⚠️ This section allows only 1 photo. Please remove the existing photo first.');
          return;
        }
        const proceed = confirm('⚠️ This section allows only 1 photo. Continue with the first photo?');
        if (!proceed) return;
        selectedPhotos = selectedPhotos.slice(0, 1);
        console.log(`🚨 SINGLE PHOTO SECTION: Only adding 1 photo`);
      } else if (!isNinthSection && !isSinglePhotoSection && existingPhotos.length + selectedPhotos.length > 4) {
        const remaining = 4 - existingPhotos.length;
        if (remaining <= 0) {
          alert('Cannot add more photos. Maximum 4 photos allowed per section.');
          return;
        }
        const proceed = confirm(`You can only add ${remaining} more photo(s) to stay within the 4-photo limit. Continue with first ${remaining} photos?`);
        if (!proceed) return;
        selectedPhotos = selectedPhotos.slice(0, remaining);
        console.log(`🚨 TRIMMED: Only adding ${selectedPhotos.length} photos to stay within limit`);
      } else if (isNinthSection) {
        console.log(`🚀 UNLIMITED: Section ${sectionId} allows unlimited photos`);
      }
      
      selectedPhotos.forEach((photo, index) => {
        console.log(`🔧 Processing photo ${index}:`, photo);
        
        // PICK-CAM data structure (different from CompanyCam)
        let thumbUrl, originalUrl;
        
        if (photo.uris) {
          // CompanyCam format (legacy)
          const thumbObj = photo.uris.find(u => u.type === 'thumbnail') || photo.uris[0];
          const originalObj = photo.uris.find(u => u.type === 'original') || photo.uris[0];
          thumbUrl = thumbObj?.url || thumbObj?.uri || '';
          originalUrl = originalObj?.url || originalObj?.uri || thumbUrl;
        } else {
          // PICK-CAM format (our data)
          thumbUrl = photo.url || photo.src || '';
          originalUrl = photo.url || photo.src || '';
        }
        
        console.log(`📸 Photo URLs - Thumb: ${thumbUrl}, Original: ${originalUrl}`);
        
        if (thumbUrl) {
          // Crear elemento de thumbnail
          const thumbElement = document.createElement('div');
          thumbElement.className = 'companycam-thumb';
          thumbElement.innerHTML = `
            <img src="${thumbUrl}" alt="PICK-CAM Photo ${index + 1}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 2px solid #3498db;">
            <button type="button" onclick="removeCompanyCamPhoto(this)" style="position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">×</button>
          `;
          thumbElement.style.position = 'relative';
          thumbElement.style.display = 'inline-block';
          thumbElement.style.margin = '5px';
          
          // Guardar datos de la foto en el elemento
          thumbElement.dataset.photoId = photo.id;
          thumbElement.dataset.thumbUrl = thumbUrl;
          thumbElement.dataset.original = originalUrl;
          
          thumbsContainer.appendChild(thumbElement);
          console.log(`✅ Added PICK-CAM photo ${photo.id} to ${sectionId}`);
        } else {
          console.error(`❌ No URL found for photo:`, photo);
        }
      });
      
      console.log(`🎉 Successfully added ${photosData.length} photos to ${sectionId}`);
    }
    
    // ✅ FUNCIÓN AUXILIAR: Remove CompanyCam photo
    function removeCompanyCamPhoto(button) {
      const thumbElement = button.parentElement;
      if (thumbElement) {
        thumbElement.remove();
        console.log(`🗑️ Removed CompanyCam photo`);
      }
    }
    
    // Add selected photos from dedicated modal to form
    function addSelectedPhotosFromDedicated() {
      if (dedicatedSelectedPhotos.length === 0) {
        alert('Please select at least one photo');
        return;
      }
      
      debugLog(`📤 Adding ${dedicatedSelectedPhotos.length} selected photos to form`);
      
      // Get selected photos data
      const selectedPhotosData = dedicatedSelectedPhotos.map(index => dedicatedProjectPhotos[index]);
      
      // Add to current upload section (same logic as original)
      if (window.currentUploadSection) {
        addCompanyCamPhotosToSection(window.currentUploadSection, selectedPhotosData);
      }
      
      // Close modal
      closeDedicatedCompanyCamModal();
      
      // Show success message
      const count = dedicatedSelectedPhotos.length;
      alert(`Successfully added ${count} photo${count > 1 ? 's' : ''} to the form!`);
    }

              // Roof Damage Options Management - DISABLED FOR NOW
       // We'll implement the conditional logic later after all lists are working
    </script>

    <!-- 🖼️ MODAL DE FOTOS EN TAMAÑO COMPLETO -->
    <div id="photoModal" class="photo-modal" style="display: none;">
      <div class="photo-modal-content">
        <div class="photo-modal-header">
          <h3 id="photoModalTitle">Foto en Tamaño Completo</h3>
          <button class="photo-modal-close" onclick="closePhotoModal()">&times;</button>
        </div>
        
        <div class="photo-modal-body">
          <div class="photo-navigation">
            <button class="photo-nav-btn" onclick="previousPhoto()" id="prevPhotoBtn">
              <i class="fas fa-chevron-left"></i>
            </button>
            
            <div class="photo-container">
              <img id="photoModalImage" src="" alt="Foto en tamaño completo" />
            </div>
            
            <button class="photo-nav-btn" onclick="nextPhoto()" id="nextPhotoBtn">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          
          <div class="photo-info">
            <span id="photoCounter">Foto 1 de 1</span>
            <a id="photoOriginalLink" href="" target="_blank" class="photo-original-link">
              <i class="fas fa-external-link-alt"></i> Abrir Original
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- 🎯 SCRIPT SIMPLIFICADO PARA EL MODAL DE FOTOS -->
    <script>
      console.log('🚀 Script del modal de fotos cargando...');
      
      // 🖼️ VARIABLES GLOBALES
      let modalPhotoIndex = 0;
      let photoModalPhotos = [];

      // 🖼️ FUNCIÓN SIMPLE PARA ABRIR MODAL
      function openPhotoModal(photoUrl, photoIndex, photos, sectionId) {
        console.log('🖼️ Abriendo modal...', {photoUrl, photoIndex, photos, sectionId});
        
        modalPhotoIndex = photoIndex;
        photoModalPhotos = photos;
        currentPhotoSection = sectionId;
        
        const modal = document.getElementById('photoModal');
        const modalImage = document.getElementById('photoModalImage');
        const modalTitle = document.getElementById('photoModalTitle');
        
        modalImage.src = photoUrl;
        modalTitle.textContent = `Foto ${photoIndex + 1} - ${sectionId}`;
        modal.style.display = 'flex';
        
        console.log('✅ Modal abierto');
      }

      // 🖼️ FUNCIÓN SIMPLE PARA CERRAR MODAL
      function closePhotoModal() {
        console.log('🖼️ Cerrando modal...');
        document.getElementById('photoModal').style.display = 'none';
      }

      // 🖼️ FUNCIÓN SIMPLE PARA FOTO ANTERIOR
      function previousPhoto() {
        if (modalPhotoIndex > 0) {
          modalPhotoIndex--;
          const photo = photoModalPhotos[modalPhotoIndex];
          document.getElementById('photoModalImage').src = photo;
          document.getElementById('photoModalTitle').textContent = `Foto ${modalPhotoIndex + 1} - ${currentPhotoSection}`;
        }
      }

      // 🖼️ FUNCIÓN SIMPLE PARA FOTO SIGUIENTE
      function nextPhoto() {
        if (modalPhotoIndex < photoModalPhotos.length - 1) {
          modalPhotoIndex++;
          const photo = photoModalPhotos[modalPhotoIndex];
          document.getElementById('photoModalImage').src = photo;
          document.getElementById('photoModalTitle').textContent = `Foto ${modalPhotoIndex + 1} - ${currentPhotoSection}`;
        }
      }

      // 🖼️ FUNCIÓN SIMPLE PARA HACER FOTOS CLICKABLES
      function makePhotosClickable() {
        console.log('🖼️ Haciendo fotos clickables...');
        
        const images = document.querySelectorAll('img[src*="img.companycam.com"]');
        console.log('🔍 Imágenes encontradas:', images.length);
        
        images.forEach((img, index) => {
          if (img._clickable) return;
          
          img.style.cursor = 'pointer';
          img._clickable = true;
          
          img.addEventListener('click', function() {
            console.log('🖼️ Click en imagen:', this.src);
            
            // Obtener todas las fotos de la misma sección
            const sectionContainer = this.closest('.photo-section, .upload-section, [id*="_section"]');
            if (sectionContainer) {
              const sectionPhotos = Array.from(sectionContainer.querySelectorAll('img[src*="img.companycam.com"]')).map(img => img.src);
              const currentIndex = sectionPhotos.indexOf(this.src);
              
              console.log('🔍 Fotos de sección:', sectionPhotos.length, 'Índice actual:', currentIndex);
              
              if (sectionPhotos.length > 0) {
                openPhotoModal(this.src, currentIndex, sectionPhotos, sectionContainer.id);
              }
            } else {
              // Si no encuentra sección, abrir solo esta foto
              openPhotoModal(this.src, 0, [this.src], 'general');
            }
          });
        });
        
        console.log('✅ Fotos hechas clickables');
      }

      // 🖼️ INICIALIZAR
      document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 DOM cargado, inicializando modal...');
        setTimeout(makePhotosClickable, 2000);
      });

      window.addEventListener('load', function() {
        console.log('🌐 Página cargada, inicializando modal...');
        setTimeout(makePhotosClickable, 3000);
      });

      // 🖼️ FUNCIÓN DE DEBUG
      window.debugPhotoModal = function() {
        console.log('🔧 Debug modal de fotos...');
        console.log('🔍 Modal HTML:', document.getElementById('photoModal')?.outerHTML);
        console.log('🔍 Imágenes CompanyCam:', document.querySelectorAll('img[src*="img.companycam.com"]').length);
        console.log('🔍 Variables:', {modalPhotoIndex, photoModalPhotos: photoModalPhotos.length, currentPhotoSection});
        
        makePhotosClickable();
        console.log('🔧 Debug completado');
      };

      // 🖼️ EXPONER FUNCIONES
      window.openPhotoModal = openPhotoModal;
      window.closePhotoModal = closePhotoModal;
      window.previousPhoto = previousPhoto;
      window.nextPhoto = nextPhoto;
      window.makePhotosClickable = makePhotosClickable;

      console.log('✅ Script del modal de fotos cargado completamente');

      // ====== NEW COMPANYCAM MODAL UPLOAD FUNCTIONS ======
      
      // 📁 Abrir galería desde modal de Company Cam
      window.openGalleryFromCompanyCam = function() {
        console.log('📁 Opening gallery from CompanyCam modal...');
        
        // Create hidden file input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.multiple = true;
        fileInput.style.display = 'none';
        
        fileInput.addEventListener('change', function(e) {
          const files = Array.from(e.target.files);
          if (files.length > 0) {
            console.log(`📸 Selected ${files.length} file(s) from gallery`);
            uploadFilesToCompanyCam(files);
          }
          // Clean up
          document.body.removeChild(fileInput);
        });
        
        document.body.appendChild(fileInput);
        fileInput.click();
      };

      // 📷 Abrir cámara desde modal de Company Cam
      window.openCameraFromCompanyCam = function() {
        console.log('📷 Opening camera from CompanyCam modal...');
        
        // Check if camera is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('📷 Camera not supported in this browser.\n\n💡 Try using "Select from Gallery" instead.');
          return;
        }
        
        // Check if we're on HTTPS or localhost
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
          alert('📷 Camera requires HTTPS for security.\n\n🚀 Camera will work in production (Render.com uses HTTPS)\n💡 For now, use "Select from Gallery"');
          return;
        }
        
        openCameraModal();
      };

      // 📤 Upload files to Company Cam (REAL INTEGRATION)
      async function uploadFilesToCompanyCam(files) {
        console.log('📤 Starting real upload to Company Cam...', files);
        
        // Get current project info
        const projectInfo = getCurrentProjectInfo();
        if (!projectInfo || !projectInfo.project_id) {
          showAlert('❌ No project selected or Company Cam ID not found', 'error');
          return;
        }
        
        console.log('🎯 Uploading to project:', projectInfo.project_id);
        
        // Show loading state
        const loadingMessage = `📤 Uploading ${files.length} photo(s) to Company Cam...`;
        showAlert(loadingMessage, 'info');
        
        try {
          // Create FormData for upload
          const formData = new FormData();
          formData.append('project_id', projectInfo.project_id);
          formData.append('vid', projectInfo.vid || 'DAR-Upload');
          
          // Add all files
          files.forEach((file, index) => {
            formData.append('photos', file);
          });
          
          console.log('📡 Sending to backend...');
          
          // Upload to our backend (DAR-specific endpoint)
          const response = await fetch('/api/upload_photos_dar', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          console.log('📊 Upload result:', result);
          
          if (result.success) {
            const successCount = result.results ? result.results.filter(r => r.success).length : 0;
            const totalCount = files.length;
            
            showAlert(`✅ ${successCount}/${totalCount} photos uploaded successfully to Company Cam!`, 'success');
            
            if (successCount > 0) {
              // Show immediate feedback without closing modal
              showAlert(`✅ ${successCount} photo(s) uploaded! Gallery updated.`, 'success');
              
              // Add uploaded photos to the current modal immediately
              addUploadedPhotosToModal(files, successCount);
              
              // NO AUTO-REFRESH - let user manually refresh if needed
              console.log('✅ Upload complete - modal remains open');
            }
            
          } else {
            throw new Error(result.error || 'Upload failed');
          }
          
        } catch (error) {
          console.error('❌ Upload error:', error);
          showAlert('❌ Error uploading photos: ' + error.message, 'error');
        }
      }
      
      // 🔄 Refresh Company Cam modal (IMPROVED)
      function refreshCompanyCamModal() {
        console.log('🔄 Refreshing Company Cam modal...');
        
        // Try to call existing refresh function if it exists
        if (typeof loadCompanyCamPhotosInDedicated === 'function') {
          console.log('🔄 Using existing loadCompanyCamPhotosInDedicated function');
          loadCompanyCamPhotosInDedicated();
        } else if (typeof refreshCompanyCamPhotos === 'function') {
          console.log('🔄 Using existing refreshCompanyCamPhotos function');
          refreshCompanyCamPhotos();
        } else if (typeof loadCompanyCamPhotos === 'function') {
          console.log('🔄 Using loadCompanyCamPhotos function');
          loadCompanyCamPhotos();
        } else {
          // Try to refresh by finding and clicking the CompanyCam button again
          console.log('🔄 Trying to refresh via CompanyCam button...');
          const companyCamButtons = document.querySelectorAll('button[onclick*="CompanyCam"], button[onclick*="companycam"]');
          if (companyCamButtons.length > 0) {
            // Find the right button for the current section
            const currentSection = findCurrentPhotoSection();
            if (currentSection) {
              console.log('🔄 Refreshing current section:', currentSection);
              // Don't click - just reload the modal content
              reloadCurrentModalContent();
            }
          } else {
            console.log('⚠️ No refresh method found - showing success message only');
          }
        }
      }
      
      // 🔄 Reload current modal content without closing
      function reloadCurrentModalContent() {
        const photoGrid = document.getElementById('dedicatedPhotoGrid');
        if (photoGrid) {
          // Show loading state
          photoGrid.innerHTML = '<div class="companycam-empty-state"><i class="fas fa-spinner fa-spin"></i><h3>Refreshing photos...</h3></div>';
          
          // Wait a moment then show success
          setTimeout(() => {
            showAlert('🔄 Photos refreshed! New photos should appear shortly.', 'info');
          }, 1500);
        }
      }
      
      // 🎯 Find current photo section context
      function findCurrentPhotoSection() {
        // Try to determine which photo section we're in
        const modal = document.getElementById('companyCamPhotosModal');
        if (modal && modal.style.display !== 'none') {
          const title = document.getElementById('dedicatedModalProjectTitle');
          if (title) {
            return title.textContent;
          }
        }
        return 'general';
      }
      
      // 📸 Add uploaded photos to modal immediately (for instant feedback)
      function addUploadedPhotosToModal(files, successCount) {
        const photoGrid = document.getElementById('dedicatedPhotoGrid');
        if (!photoGrid) return;
        
        console.log('📸 Adding uploaded photos to modal immediately...');
        
        // If the grid is empty, clear the empty state
        const emptyState = photoGrid.querySelector('.companycam-empty-state');
        if (emptyState) {
          emptyState.remove();
        }
        
        // Add each uploaded file as a preview
        for (let i = 0; i < Math.min(files.length, successCount); i++) {
          const file = files[i];
          
          // Create preview element
          const photoItem = document.createElement('div');
          photoItem.className = 'companycam-photo-item uploading';
          photoItem.style.cssText = `
            position: relative;
            border: 2px solid #27ae60;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
            opacity: 0.8;
          `;
          
          // Create image preview
          const img = document.createElement('img');
          img.style.cssText = `
            width: 100%;
            height: 120px;
            object-fit: cover;
          `;
          
          // Use FileReader to show preview
          const reader = new FileReader();
          reader.onload = function(e) {
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
          
          // Add uploading indicator
          const indicator = document.createElement('div');
          indicator.style.cssText = `
            position: absolute;
            top: 5px;
            right: 5px;
            background: #27ae60;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
          `;
          indicator.textContent = 'UPLOADED';
          
          photoItem.appendChild(img);
          photoItem.appendChild(indicator);
          
          // Insert at the beginning of the grid
          photoGrid.insertBefore(photoItem, photoGrid.firstChild);
        }
        
        // Update photo counter if it exists
        const photoCount = document.getElementById('dedicatedPhotoCount');
        if (photoCount) {
          const currentText = photoCount.textContent;
          const currentCount = parseInt(currentText.match(/\d+/)?.[0] || '0');
          const newCount = currentCount + successCount;
          photoCount.textContent = `${newCount} photos`;
        }
        
        console.log(`✅ Added ${successCount} uploaded photos to modal`);
      }
      
      // 🎯 Get current project information
      function getCurrentProjectInfo() {
        // Try to get project info from various sources
        let projectInfo = null;
        
        // Method 1: From dedicated modal title
        const modalTitle = document.getElementById('dedicatedModalProjectTitle');
        if (modalTitle && modalTitle.textContent && modalTitle.textContent !== 'Loading Project...') {
          console.log('📊 Found project from modal title:', modalTitle.textContent);
        }
        
        // Method 2: From global variables (if they exist)
        if (typeof currentProjectId !== 'undefined' && currentProjectId) {
          projectInfo = {
            project_id: currentProjectId,
            vid: typeof currentVid !== 'undefined' ? currentVid : 'DAR-Upload'
          };
          console.log('📊 Found project from global variables:', projectInfo);
          return projectInfo;
        }
        
        // Method 3: Try to extract from Company Cam modal URL or content
        const companyCamModal = document.getElementById('companyCamPhotosModal');
        if (companyCamModal && companyCamModal.style.display !== 'none') {
          // Look for project ID in the modal content
          const projectText = modalTitle ? modalTitle.textContent : '';
          
          // Try different patterns to extract project ID
          let match = projectText.match(/Project\s+(\d+)/i);
          if (!match) {
            match = projectText.match(/(\d{8,})/); // Look for 8+ digit numbers (Company Cam IDs)
          }
          
          if (match) {
            projectInfo = {
              project_id: match[1],
              vid: 'DAR-Upload'
            };
            console.log('📊 Extracted project from modal text:', projectInfo);
            return projectInfo;
          }
          
          // Also check URL parameters or hidden inputs
          const urlParams = new URLSearchParams(window.location.search);
          const projectIdFromUrl = urlParams.get('project_id') || urlParams.get('projectId');
          if (projectIdFromUrl) {
            projectInfo = {
              project_id: projectIdFromUrl,
              vid: 'DAR-Upload'
            };
            console.log('📊 Found project from URL params:', projectInfo);
            return projectInfo;
          }
        }
        
        // Method 4: Look for V-ID input field
        const vidInput = document.querySelector('input[name="vid"], #vidInput');
        if (vidInput && vidInput.value) {
          // We have V-ID but need to get Company Cam project ID
          console.log('📊 Found V-ID but need Company Cam project ID:', vidInput.value);
          projectInfo = {
            vid: vidInput.value,
            project_id: null // We'll need to resolve this
          };
        }
        
        console.log('🎯 Final project info:', projectInfo);
        return projectInfo;
      }

      // 📷 Camera modal for Company Cam integration
      function openCameraModal() {
        console.log('📷 Opening camera modal...');
        
        // Create camera modal HTML if it doesn't exist
        let cameraModal = document.getElementById('darCameraModal');
        if (!cameraModal) {
          createCameraModal();
          cameraModal = document.getElementById('darCameraModal');
        }
        
        // Show the modal
        cameraModal.style.display = 'flex';
        
        // Start camera
        startCameraInModal();
      }
      
      // 📷 Create camera modal HTML
      function createCameraModal() {
        const modalHTML = `
          <div id="darCameraModal" style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 20000;
            justify-content: center;
            align-items: center;
          ">
            <div style="
              background: white;
              border-radius: 15px;
              padding: 20px;
              max-width: 90vw;
              max-height: 90vh;
              position: relative;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            ">
              <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #f0f0f0;
              ">
                <h3 style="margin: 0; color: #333;">📷 Take Photo</h3>
                <button onclick="closeCameraModal()" style="
                  background: none;
                  border: none;
                  font-size: 24px;
                  cursor: pointer;
                  color: #999;
                  padding: 5px;
                ">✕</button>
              </div>
              
              <video id="darCameraVideo" autoplay playsinline style="
                width: 100%;
                max-width: 500px;
                height: auto;
                border-radius: 10px;
                background: #000;
              "></video>
              
              <canvas id="darCameraCanvas" style="display: none;"></canvas>
              
              <div style="
                display: flex;
                gap: 15px;
                justify-content: center;
                margin-top: 20px;
              ">
                <button onclick="capturePhotoInModal()" style="
                  background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
                  color: white;
                  border: none;
                  padding: 15px 30px;
                  border-radius: 50px;
                  font-weight: 600;
                  cursor: pointer;
                  font-size: 1.1em;
                  transition: all 0.3s ease;
                ">📸 Capture</button>
                
                <button onclick="closeCameraModal()" style="
                  background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
                  color: white;
                  border: none;
                  padding: 15px 30px;
                  border-radius: 50px;
                  font-weight: 600;
                  cursor: pointer;
                  font-size: 1.1em;
                  transition: all 0.3s ease;
                ">Cancel</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // 📷 Start camera
      async function startCameraInModal() {
        const video = document.getElementById('darCameraVideo');
        
        try {
          // Check camera support
          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('Camera not supported in this browser');
          }
          
          // Request camera access
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: 'environment', // Back camera on mobile
              width: { ideal: 1920 },
              height: { ideal: 1080 }
            }
          });
          
          video.srcObject = stream;
          window.darCameraStream = stream; // Store for cleanup
          
          console.log('✅ Camera started successfully');
          
        } catch (error) {
          console.error('❌ Camera error:', error);
          
          let errorMsg = 'Could not access camera: ' + error.message;
          if (error.name === 'NotAllowedError') {
            errorMsg = 'Camera access denied. Please allow camera access and try again.';
          }
          
          showAlert(errorMsg, 'error');
          closeCameraModal();
        }
      }
      
      // 📷 Capture photo
      function capturePhotoInModal() {
        const video = document.getElementById('darCameraVideo');
        const canvas = document.getElementById('darCameraCanvas');
        
        if (!video || !canvas) return;
        
        try {
          // Set canvas size to match video
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          
          // Draw video frame to canvas
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);
          
          // Convert to blob
          canvas.toBlob((blob) => {
            if (blob) {
              // Create file from blob
              const timestamp = Date.now();
              const filename = `camera_photo_${timestamp}.jpg`;
              const file = new File([blob], filename, { type: 'image/jpeg' });
              
              // Upload the photo
              uploadFilesToCompanyCam([file]);
              
              // Close camera modal
              closeCameraModal();
              
              console.log('✅ Photo captured and uploaded');
            }
          }, 'image/jpeg', 0.9);
          
        } catch (error) {
          console.error('❌ Capture error:', error);
          showAlert('Error capturing photo: ' + error.message, 'error');
        }
      }
      
      // 📷 Close camera modal
      window.closeCameraModal = function() {
        const modal = document.getElementById('darCameraModal');
        const video = document.getElementById('darCameraVideo');
        
        // Stop camera stream
        if (window.darCameraStream) {
          window.darCameraStream.getTracks().forEach(track => track.stop());
          window.darCameraStream = null;
        }
        
        // Clear video
        if (video) {
          video.srcObject = null;
        }
        
        // Hide modal
        if (modal) {
          modal.style.display = 'none';
        }
        
        console.log('📷 Camera modal closed');
      };
      
      // 📷 Make capture function global
      window.capturePhotoInModal = capturePhotoInModal;

      // 💬 Enhanced alert function with visual feedback
      function showAlert(message, type) {
        console.log(`${type === 'success' ? '✅' : type === 'info' ? 'ℹ️' : '❌'} ${message}`);
        
        // Create or get existing alert container
        let alertContainer = document.getElementById('dar-alert-container');
        if (!alertContainer) {
          alertContainer = document.createElement('div');
          alertContainer.id = 'dar-alert-container';
          alertContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
          `;
          document.body.appendChild(alertContainer);
        }
        
        // Create alert element
        const alertElement = document.createElement('div');
        const bgColor = type === 'success' ? '#27ae60' : type === 'info' ? '#3498db' : '#e74c3c';
        const icon = type === 'success' ? '✅' : type === 'info' ? 'ℹ️' : '❌';
        
        alertElement.style.cssText = `
          background: ${bgColor};
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          margin-bottom: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          display: flex;
          align-items: center;
          gap: 10px;
          font-weight: 500;
          transform: translateX(100%);
          transition: transform 0.3s ease;
        `;
        
        alertElement.innerHTML = `
          <span style="font-size: 1.2em;">${icon}</span>
          <span>${message}</span>
        `;
        
        alertContainer.appendChild(alertElement);
        
        // Animate in
        setTimeout(() => {
          alertElement.style.transform = 'translateX(0)';
        }, 100);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
          alertElement.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (alertElement.parentNode) {
              alertElement.parentNode.removeChild(alertElement);
            }
          }, 300);
        }, 5000);
      }

      // 🚀 PDFMake PREVIEW SYSTEM - SOLO PREVIEW SIN UPLOAD
      async function previewDARReportPDFMake() {
        const btn = document.getElementById('previewReportPDFMakeBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Preview...';
        btn.disabled = true;

        try {
          console.log('🚀 PREVIEW: Generating PDF preview only');
          
          const formData = collectAllFormData();
          console.log('🔍 DEBUG: formData recolectado:', formData);
          console.log('🔍 DEBUG: HVAC específico - hvacUnitsTotal:', formData.hvacUnitsTotal);
          console.log('🔍 DEBUG: HVAC específico - rtusTotal:', formData.rtusTotal);
          
          const photoData = await collectAllPhotos();
          console.log('🔍 DEBUG: photoData recolectado:', photoData);
          console.log('🔍 DEBUG: photoData keys:', Object.keys(photoData));
          
          const v_id = formData.vId || 'PREVIEW';
          
          // Crear el mismo docDefinition que el sistema principal
          const docDefinition = {
            content: [
              // Header con estilo VI-A - CYAN BOLD SIN BACKGROUND
              {
                text: '*** VI-A - Professional Inspection Services ***',
                fontSize: 14,
                bold: true,
                color: '000000',
                alignment: 'center',
                margin: [0, 10, 0, 10]
              },
              {
                text: 'Professional Damage Assessment & Analysis Services',
                fontSize: 12,
                color: '#666666',
                alignment: 'center'
              },
              {
                text: `PREVIEW - Report generated by DAR System - ${new Date().toLocaleDateString()}`,
                fontSize: 11,
                color: '#666666',
                alignment: 'center',
                margin: [0, 0, 0, 30]
              }
            ],
            pageSize: 'LETTER',
            pageMargins: [40, 60, 40, 60]
          };

          // Agregar las secciones principales (mismo código que el sistema principal)
          // Property Information - ESTILO SISTEMA ANTERIOR CON CYAN
          docDefinition.content.push({
            table: {
              widths: ['*'],
              body: [[{
                text: 'Property Information',
                fontSize: 16,
                bold: true,
                color: '#000000',
                fillColor: '#f8f9fa',
                margin: [10, 8, 10, 8],
                border: [false, false, false, true],
                borderColor: ['', '', '', '#38c3ff']
              }]]
            },
            margin: [0, 20, 0, 15]
          });

          // Property Information - FORMATO LÍNEAS COMO SEGUNDO SCREENSHOT
          docDefinition.content.push(
            {text: [{text: 'V-ID: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.vId || 'C-3280', fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 5]},
            {text: [{text: 'CC ID: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.ccId || '89469704', fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 5]},
            {text: [{text: 'Business Name: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.businessName || 'Example Company', fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 5]},
            {text: [{text: 'Address: ', bold: true, fontSize: 11, color: '#000000'}, {text: `${formData.propertyAddress || '422 S Madison St'}, ${formData.city || 'Lebanon'}, ${formData.state || 'IL'} ${formData.zipcode || '75039'}`, fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 5]},
            {text: [{text: 'Property Type: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.propertyType || 'Commercial', fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 5]},
            {text: [{text: 'Building Type: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.buildingType || 'Office', fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 5]},
            {text: [{text: 'Roof System: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.roofSystem || 'Metal', fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 5]},
            {text: [{text: 'Stories: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.numberOfStories || '1', fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 5]},
            {text: [{text: 'Date of Loss: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.stormDate || 'Not specified', fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 20]}
          );

          // SOLO PREVIEW - usar open() en vez de download()
          const fileName = `DAR_Report_PREVIEW_${v_id}_${new Date().toISOString().split('T')[0]}.pdf`;
          pdfMake.createPdf(docDefinition).open(); // OPEN en nueva ventana en vez de download
          
          btn.innerHTML = '<i class="fas fa-check"></i> Preview Generated!';

        } catch (error) {
          console.error('❌ Preview error:', error);
          btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Preview Failed';
          alert(`❌ Preview failed: ${error.message}`);
        } finally {
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 3000);
        }
      }

      // 🚀 PDFMake SYSTEM - RESTORED AND CLEAN
      async function downloadDARReportPDFMake() {
        console.log('🎯 [PDF] downloadDARReportPDFMake function called!');
        
        const btn = document.getElementById('downloadReportPDFMakeBtn');
        if (!btn) {
          console.error('❌ [PDF] Button downloadReportPDFMakeBtn not found!');
          alert('Error: PDF button not found. Please refresh the page.');
          return;
        }
        
        console.log('✅ [PDF] Button found:', btn);
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Step 1/3: Generating PDF...';
        btn.disabled = true;

        try {
          console.log('🚀 INICIO: downloadDARReportPDFMake ejecutándose');
          
          const formData = collectAllFormData();
          console.log('🔍 DEBUG: formData recolectado:', formData);
          console.log('🔍 DEBUG: HVAC específico - hvacUnitsTotal:', formData.hvacUnitsTotal);
          console.log('🔍 DEBUG: HVAC específico - rtusTotal:', formData.rtusTotal);
          
          const photoData = await collectAllPhotos();
          console.log('🔍 DEBUG: photoData recolectado:', photoData);
          console.log('🔍 DEBUG: photoData keys:', Object.keys(photoData));
          
          const v_id = formData.vId;
          
          if (!v_id) {
            throw new Error('V-ID is required to generate report');
          }

          const docDefinition = {
            pageSize: 'LETTER',
            pageMargins: [40, 60, 40, 60],
            content: [
              // Header con estilo VI-A - NEGRO BOLD SIN BACKGROUND
              {
                text: '*** VI-A - Professional Inspection Services ***',
                fontSize: 14,
                bold: true,
                color: '#000000',
                alignment: 'center',
                margin: [0, 10, 0, 10]
              },
              {
                text: 'Professional Damage Assessment & Analysis Services',
                fontSize: 12,
                color: '#666666',
                alignment: 'center'
              },
              {
                text: `Report generated by DAR System - ${new Date().toLocaleDateString()}`,
                fontSize: 11,
                color: '#666666',
                alignment: 'center',
                margin: [0, 0, 0, 30]
              },
              
              // Property Information - DISEÑO COMPACTO COMO SCREENSHOT
              // Property Information - TÍTULO SIN FONDO + LÍNEA CYAN + INFORMACIÓN HORIZONTAL
              // Property Information - CON FONDO GRIS SUAVE SIN BORDES
              {
                table: {
                  widths: ['*'],
                  body: [[{
                    stack: [
                      // Título
                      {
                        text: 'Property Information',
                        fontSize: 16,
                        bold: true,
                        color: '#000000',
                        margin: [0, 0, 0, 5]
                      },
                      // Línea separadora celeste
                      {
                        canvas: [{
                          type: 'line',
                          x1: 0, y1: 0,
                          x2: 495, y2: 0,
                          lineWidth: 2,
                          lineColor: '#87CEEB'
                        }],
                        margin: [0, 0, 0, 15]
                      },
                      // Información horizontal en líneas
                      {text: [{text: 'V-ID: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.vId || 'C-0006', fontSize: 11, color: '#000000'}, {text: '     CC ID: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.ccId || '89469704', fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 5]},
                      {text: [{text: 'Business Name: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.businessName || 'Norman International', fontSize: 11, color: '#000000'}, {text: '     Address: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.property_address || '1001 Fuller Wiser RD', fontSize: 11, color: '#000000'}], margin: [0, 0, 0, 5]},
                      {text: [{text: 'City: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.city || 'Euless', fontSize: 11, color: '#000000'}, {text: '     State: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.state || 'Texas', fontSize: 11, color: '#000000'}, {text: '     Zip Code: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.zipcode || '76039', fontSize: 11, color: '#000000'}], margin: [0, 0, 0, 5]},
                      {text: [{text: 'Property Type: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.propertyType || 'Commercial', fontSize: 11, color: '#000000'}, {text: '     Building Type: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.buildingType || 'Office', fontSize: 11, color: '#000000'}, {text: '     Roof System: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.roofSystem || 'Metal', fontSize: 11, color: '#000000'}], margin: [0, 0, 0, 5]},
                      {text: [{text: 'Stories: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.numberOfStories || '1', fontSize: 11, color: '#000000'}, {text: '     Date of Loss: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.stormDate || 'Not specified', fontSize: 11, color: '#000000'}], margin: [0, 0, 0, 0]}
                    ],
                    fillColor: '#F8F8F8',
                    margin: [15, 15, 15, 15]
                  }]]
                },
                layout: 'noBorders',
                margin: [0, 20, 0, 20]
              },
              

              // Inspector Information - CON FONDO GRIS SUAVE
              {
                table: {
                  widths: ['*'],
                  body: [[{
                    stack: [
                      // Título
                      {
                        text: 'Inspector Information',
                        fontSize: 16,
                        bold: true,
                        color: '#000000',
                        margin: [0, 0, 0, 5]
                      },
                      // Línea separadora celeste
                      {
                        canvas: [{
                          type: 'line',
                          x1: 0, y1: 0,
                          x2: 495, y2: 0,
                          lineWidth: 2,
                          lineColor: '#87CEEB'
                        }],
                        margin: [0, 0, 0, 15]
                      },
                      // Información horizontal en líneas
                      {text: [{text: 'Inspector: ', bold: true, fontSize: 11, color: '#000000'}, {text: `${formData.inspectorFirstName || 'Juan'} ${formData.inspectorLastName || 'Smith'}`.trim(), fontSize: 11, color: '#000000'}, {text: '     Phone: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.inspectorPhone || '6663351122', fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 5]},
                      {text: [{text: 'Email: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.inspectorEmail || 'menmendez@gmail.com', fontSize: 11, color: '#000000'}, {text: '     Inspection Date: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.inspectionDate || '2025-09-05', fontSize: 11, color: '#000000'}], margin: [0, 0, 0, 0]}
                    ],
                    fillColor: '#F8F8F8',
                    margin: [15, 15, 15, 15]
                  }]]
                },
                layout: 'noBorders',
                margin: [0, 0, 0, 20]
              },

              // Inspector Partner Information - CON FONDO GRIS SUAVE
              {
                table: {
                  widths: ['*'],
                  body: [[{
                    stack: [
                      // Título
                      {
                        text: 'Inspector Partner Information',
                        fontSize: 16,
                        bold: true,
                        color: '#000000',
                        margin: [0, 0, 0, 5]
                      },
                      // Línea separadora celeste
                      {
                        canvas: [{
                          type: 'line',
                          x1: 0, y1: 0,
                          x2: 495, y2: 0,
                          lineWidth: 2,
                          lineColor: '#87CEEB'
                        }],
                        margin: [0, 0, 0, 15]
                      },
                      // Información horizontal en líneas
                      {text: [{text: 'Partner: ', bold: true, fontSize: 11, color: '#000000'}, {text: `${formData.partnerFirstName || 'Peter'} ${formData.partnerLastName || 'Smith'}`.trim(), fontSize: 11, color: '#000000'}, {text: '     Phone: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.partnerPhone || '7773332211', fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 5]},
                      {text: [{text: 'Email: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.partnerEmail || 'menmendez@gmail.com', fontSize: 11, color: '#000000'}], margin: [0, 0, 0, 0]}
                    ],
                    fillColor: '#F8F8F8',
                    margin: [15, 15, 15, 15]
                  }]]
                },
                layout: 'noBorders',
                margin: [0, 0, 0, 20]
              },

              // Property Details - CON FONDO GRIS SUAVE Y FORMATO COMPACTO
              {
                table: {
                  widths: ['*'],
                  body: [[{
                    stack: [
                      // Título
                      {
                        text: 'Property Details',
                        fontSize: 16,
                        bold: true,
                        color: '#000000',
                        margin: [0, 0, 0, 5]
                      },
                      // Línea separadora celeste
                      {
                        canvas: [{
                          type: 'line',
                          x1: 0, y1: 0,
                          x2: 495, y2: 0,
                          lineWidth: 2,
                          lineColor: '#87CEEB'
                        }],
                        margin: [0, 0, 0, 15]
                      },
                      // Información horizontal en líneas (formato compacto)
                      {text: [{text: 'Property Type: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.propertyType || 'Commercial', fontSize: 11, color: '#000000'}, {text: '     Building Type: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.buildingType || 'Office', fontSize: 11, color: '#000000'}], margin: [0, 5, 0, 5]},
                      {text: [{text: 'Roof System: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.roofSystem || 'Tile', fontSize: 11, color: '#000000'}, {text: '     Stories: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.numStories || '2', fontSize: 11, color: '#000000'}, {text: '     Date of Loss: ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.stormDate || 'Not specified', fontSize: 11, color: '#000000'}], margin: [0, 0, 0, 5]},
                      {text: [{text: 'Roof Squares (if known): ', bold: true, fontSize: 11, color: '#000000'}, {text: formData.roofSquares ? `Approximate square footage ~ ${formData.roofSquares}` : 'Approximate square footage ~ 180', fontSize: 11, color: '#000000'}], margin: [0, 0, 0, 0]}
                    ],
                    fillColor: '#F8F8F8',
                    margin: [15, 15, 15, 15]
                  }]]
                },
                layout: 'noBorders',
                margin: [0, 0, 0, 30]
              },

              

              // Damage Assessment - CON FONDO GRIS SUAVE (PÁGINA 2)
              {
                table: {
                  widths: ['*'],
                  body: [[{
                    stack: [
                      // Título
                      {
                        text: 'Damage Assessment',
                        fontSize: 16,
                        bold: true,
                        color: '#000000',
                        margin: [0, 0, 0, 5]
                      },
                      // Línea separadora celeste
                      {
                        canvas: [{
                          type: 'line',
                          x1: 0, y1: 0,
                          x2: 495, y2: 0,
                          lineWidth: 2,
                          lineColor: '#87CEEB'
                        }],
                        margin: [0, 0, 0, 15]
                      },
                      // Trade Types - FORMATO LÍNEAS MÁS REDUCIDO
                      {text: [{text: 'Trade Types Affected: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.tradeTypes?.join(', ') || 'Roofing', fontSize: 8, color: '#000000'}], margin: [0, 2, 0, 2]},
                      {text: [{text: 'HVAC Selected: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.tradeTypes?.includes('HVAC') ? 'Yes' : 'No', fontSize: 8, color: formData.tradeTypes?.includes('HVAC') ? '#28a745' : '#dc3545'}], margin: [0, 2, 0, 2]},
                      {text: [{text: 'HVAC Severity: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.tradeTypeSeverities?.HVAC || '2', fontSize: 8, color: '#000000'}], margin: [0, 2, 0, 2]},
                      {text: [{text: 'Roofing Selected: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.tradeTypes?.includes('Roofing') ? 'Yes' : 'No', fontSize: 8, color: formData.tradeTypes?.includes('Roofing') ? '#28a745' : '#dc3545'}], margin: [0, 2, 0, 2]},
                      {text: [{text: 'Roofing Severity: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.tradeTypeSeverities?.Roofing || '3', fontSize: 8, color: '#000000'}], margin: [0, 2, 0, 2]},
                      {text: [{text: 'Window Selected: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.tradeTypes?.includes('Window') ? 'Yes' : 'No', fontSize: 8, color: formData.tradeTypes?.includes('Window') ? '#28a745' : '#dc3545'}], margin: [0, 2, 0, 2]},
                      {text: [{text: 'Interior Selected: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.tradeTypes?.includes('Interior') ? 'Yes' : 'No', fontSize: 8, color: formData.tradeTypes?.includes('Interior') ? '#28a745' : '#dc3545'}], margin: [0, 2, 0, 8]},
                      
                      // Confirmed Damage & Overall Severity - FORMATO LÍNEAS MÁS REDUCIDO
                      {text: [{text: 'Confirmed Damage: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.confirmedDamage ? 'Yes' : 'No', fontSize: 8, color: formData.confirmedDamage ? '#28a745' : '#dc3545'}], margin: [0, 2, 0, 2]},
                      {text: [{text: 'Overall Severity Rating: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.severityRating || '6', fontSize: 8, color: '#000000'}], margin: [0, 2, 0, 0]}
                    ],
                    fillColor: '#F8F8F8',
                    margin: [15, 15, 15, 15]
                  }]]
                },
                layout: 'noBorders',
                margin: [0, 10, 0, 20],
                pageBreak: 'before'
              },

              // Storm Information - CON FONDO GRIS SUAVE
              {
                table: {
                  widths: ['*'],
                  body: [[{
                    stack: [
                      // Título
                      {
                        text: 'Storm Information',
                        fontSize: 16,
                        bold: true,
                        color: '#000000',
                        margin: [0, 0, 0, 5]
                      },
                      // Línea separadora celeste
                      {
                        canvas: [{
                          type: 'line',
                          x1: 0, y1: 0,
                          x2: 495, y2: 0,
                          lineWidth: 2,
                          lineColor: '#87CEEB'
                        }],
                        margin: [0, 0, 0, 15]
                      },
                      // Storm Types - FORMATO LÍNEAS MÁS REDUCIDO
                      {text: [{text: 'Storm Types Affected: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.stormTypes?.join(', ') || 'Hail', fontSize: 8, color: '#000000'}], margin: [0, 1, 0, 1]},
                      {text: [{text: 'Hail Selected: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.stormTypes?.includes('Hail') ? 'Yes' : 'No', fontSize: 8, color: formData.stormTypes?.includes('Hail') ? '#28a745' : '#dc3545'}], margin: [0, 1, 0, 1]},
                      {text: [{text: 'Wind Selected: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.stormTypes?.includes('Wind') ? 'Yes' : 'No', fontSize: 8, color: formData.stormTypes?.includes('Wind') ? '#28a745' : '#dc3545'}], margin: [0, 1, 0, 1]},
                      {text: [{text: 'Tornado Selected: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.stormTypes?.includes('Tornado') ? 'Yes' : 'No', fontSize: 8, color: formData.stormTypes?.includes('Tornado') ? '#28a745' : '#dc3545'}], margin: [0, 1, 0, 1]},
                      // Hurricane & Storm Date - FORMATO LÍNEAS MÁS REDUCIDO
                      {text: [{text: 'Hurricane Selected: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.stormTypes?.includes('Hurricane') ? 'Yes' : 'No', fontSize: 8, color: formData.stormTypes?.includes('Hurricane') ? '#28a745' : '#dc3545'}], margin: [0, 1, 0, 1]},
                      {text: [{text: 'Storm Date Proximity: ', bold: true, fontSize: 8, color: '#000000'}, {text: formData.stormDateProximity || 'Not specified', fontSize: 8, color: '#6c757d'}], margin: [0, 1, 0, 0]}
                    ],
                    fillColor: '#F8F8F8',
                    margin: [15, 15, 15, 15]
                  }]]
                },
                layout: 'noBorders',
                margin: [0, 10, 0, 20]
              },


            ]
          };
          
          console.log('🔍 DEBUG: Antes de generar photo sections');
          console.log('🔍 DEBUG: photoData completo:', photoData);
          console.log('🔍 DEBUG: photoData keys:', Object.keys(photoData));
          
          // EXTRA DEBUG: Verificar si hay fotos en alguna sección
          let totalPhotos = 0;
          Object.keys(photoData).forEach(key => {
            if (photoData[key] && photoData[key].images && photoData[key].images.length > 0) {
              console.log(`🔍 DEBUG: Sección "${key}" tiene ${photoData[key].images.length} fotos`);
              totalPhotos += photoData[key].images.length;
            }
          });
          console.log(`🔍 DEBUG: Total de fotos encontradas: ${totalPhotos}`);
          
          const photoSections = await generatePhotoSectionsPDFMake(photoData, formData);
          console.log('🔍 DEBUG: Photo sections generadas:', photoSections.length);
          console.log('🔍 DEBUG: Contenido de sections:', photoSections);
          
          // Agregar las secciones de fotos al contenido
          docDefinition.content.push(...photoSections);
          
          // Continuar con el resto del contenido
          docDefinition.content.push({
                table: {
                  widths: ['*'],
                  body: [[{
                    text: 'Test Square Results',
                    fontSize: 16,
                    bold: true,
                    color: '#ffffff',
                    fillColor: '#87CEEB',
                    alignment: 'center',
                    margin: [10, 12, 10, 12],
                    border: [false, false, false, false]
                  }]]
                },
                pageBreak: 'before'
              },
              {
                text: `The inspector performed a test square on your roof, during which ${formData.testSquareDamagedAreas || '0'} amount of damaged areas were found within the square.`,
                fontSize: 12,
                margin: [0, 15, 0, 20],
                lineHeight: 1.4
              });

              // Agregar foto del test square si existe
              if (photoData.test_square_photo && photoData.test_square_photo.images && photoData.test_square_photo.images.length > 0) {
                console.log('🔍 DEBUG: Adding test square photo');
                docDefinition.content.push({
                  stack: [
                    {
                      text: 'Test Square Photo',
                      fontSize: 14,
                      bold: true,
                      color: '#87CEEB',
                      margin: [0, 20, 0, 10],
                      alignment: 'center'
                    },
                    {
                      image: await imageUrlToBase64(photoData.test_square_photo.images[0]),
                      width: 350,
                      height: 235,
                      link: photoData.test_square_photo.links[0] || photoData.test_square_photo.images[0],
                      alignment: 'center'
                    }
                  ],
                  margin: [0, 10, 0, 30]
                });
              }

              docDefinition.content.push({
                table: {
                  widths: ['*'],
                  body: [[{
                    text: 'Property Damage Assessment – Executive Summary',
                    fontSize: 16,
                    bold: true,
                    color: '#ffffff',
                    fillColor: '#87CEEB',
                    alignment: 'center',
                    margin: [10, 12, 10, 12],
                    border: [false, false, false, false]
                  }]]
                },
                pageBreak: 'before'
              },
              {
                text: 'Assessment Recommendations',
                fontSize: 14,
                bold: true,
                color: '#87CEEB',
                margin: [0, 20, 0, 15]
              },
              {
                table: {
                  widths: ['20%', '25%', '30%', '25%'],
                  headerRows: 1,
                  body: [
                    // Header row
                    [
                      {text: 'Condition Level', bold: true, fillColor: '#38c3ff', color: '#ffffff'},
                      {text: 'Findings', bold: true, fillColor: '#38c3ff', color: '#ffffff'},
                      {text: 'Recommended Action', bold: true, fillColor: '#38c3ff', color: '#ffffff'},
                      {text: 'Inspection Schedule', bold: true, fillColor: '#38c3ff', color: '#ffffff'}
                    ],
                    // Row 1 - No Observable Damage
                    [
                      {text: 'No Observable Damage', bold: true, fillColor: formData.damageLevel === 'no_observable_damage' ? '#ffff00' : '#ffffff'},
                      {text: 'No visible or measurable damage. Structure/components in good condition.', fillColor: formData.damageLevel === 'no_observable_damage' ? '#ffff00' : '#ffffff'},
                      {text: 'Maintain condition through routine care.', fillColor: formData.damageLevel === 'no_observable_damage' ? '#ffff00' : '#ffffff'},
                      {text: '2 scheduled inspections per year + after each storm event.', fillColor: formData.damageLevel === 'no_observable_damage' ? '#ffff00' : '#ffffff'}
                    ],
                    // Row 2 - Minimal / Localized Damage
                    [
                      {text: 'Minimal / Localized Damage', bold: true, fillColor: formData.damageLevel === 'minimal_localized_damage' ? '#ffff00' : '#ffffff'},
                      {text: 'Minor or localized issues, integrity not compromised.', fillColor: formData.damageLevel === 'minimal_localized_damage' ? '#ffff00' : '#ffffff'},
                      {text: 'Perform timely, localized repairs. Monitor for progression.', fillColor: formData.damageLevel === 'minimal_localized_damage' ? '#ffff00' : '#ffffff'},
                      {text: 'Every 3 months + after each storm event.', fillColor: formData.damageLevel === 'minimal_localized_damage' ? '#ffff00' : '#ffffff'}
                    ],
                    // Row 3 - Significant / Widespread Damage
                    [
                      {text: 'Significant / Widespread Damage', bold: true, fillColor: formData.damageLevel === 'significant_widespread_damage' ? '#ffff00' : '#ffffff'},
                      {text: 'Substantial damage impacting safety, function, or durability.', fillColor: formData.damageLevel === 'significant_widespread_damage' ? '#ffff00' : '#ffffff'},
                      {text: 'Immediate emergency mitigation, followed by full replacement of affected areas/components.', fillColor: formData.damageLevel === 'significant_widespread_damage' ? '#ffff00' : '#ffffff'},
                      {text: 'Every 30 days until repair/replacement is complete + after each storm event.', fillColor: formData.damageLevel === 'significant_widespread_damage' ? '#ffff00' : '#ffffff'}
                    ]
                  ]
                },
                layout: {
                  hLineWidth: () => 1,
                  vLineWidth: () => 1,
                  hLineColor: () => '#38c3ff',
                  vLineColor: () => '#38c3ff'
                },
                margin: [0, 10, 0, 30]
              },
              {
                table: {
                  widths: ['*'],
                  body: [[{
                    text: 'Conclusion',
                    fontSize: 16,
                    bold: true,
                    color: '#ffffff',
                    fillColor: '#87CEEB',
                    alignment: 'center',
                    margin: [10, 12, 10, 12],
                    border: [false, false, false, false]
                  }]]
                },
                margin: [0, 0, 0, 20]
              },
              {
                text: [
                  {
                    text: 'Timely resolution of property damage is essential for protecting business operations, ensuring occupant safety, and preserving long-term asset value. Proactive repairs and scheduled inspections help control costs, extend the service life of building systems, and reduce exposure to unexpected failures.\n\n',
                    fontSize: 11,
                    lineHeight: 1.4
                  },
                  {
                    text: 'Conversely, deferring corrective action can accelerate deterioration, increase repair complexity, and drive significantly higher long-term costs. Unaddressed issues may lead to water intrusion, structural compromise, mold growth, or insurance complications—posing both financial and operational risks.\n\n',
                    fontSize: 11,
                    lineHeight: 1.4
                  },
                  {
                    text: 'By following the recommended repair strategies and inspection intervals outlined above, stakeholders can ensure that the property remains structurally sound, compliant, and resilient against future events. This proactive approach reduces liability, supports business continuity, and safeguards the asset\'s value over time.',
                    fontSize: 11,
                    lineHeight: 1.4
                  }
                ],
                alignment: 'justify',
                margin: [0, 0, 0, 40]
              });

          const fileName = `DAR_Report_PDFMake_${v_id}_${new Date().toISOString().split('T')[0]}.pdf`;
          
          // STEP 1: Download PDF
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Step 1/3: Downloading PDF...';
          pdfMake.createPdf(docDefinition).download(fileName);
          
          // Wait a moment for download to start
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          // STEP 2: Upload to Monday.com
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Step 2/4: Uploading to Monday.com...';
          
          try {
            // Generate PDF blob for upload
            const pdfBlob = await new Promise((resolve) => {
              pdfMake.createPdf(docDefinition).getBlob(resolve);
            });
            
            // Create FormData for Monday.com upload
            const uploadFormData = new FormData();
            uploadFormData.append('file', pdfBlob, fileName);
            uploadFormData.append('v_id', v_id);
            uploadFormData.append('project_id', document.getElementById('ccIdField')?.value || '');
            
            // Upload to Monday.com
            const uploadResponse = await fetch('/api/upload-file-to-monday', {
              method: 'POST',
              body: uploadFormData
            });
            
            if (!uploadResponse.ok) {
              throw new Error(`Upload failed: ${uploadResponse.statusText}`);
            }
            
            const uploadResult = await uploadResponse.json();
            console.log('✅ Upload to Monday.com successful:', uploadResult);
            
            // STEP 3: Send emails to inspectors
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Step 3/4: Sending emails to inspectors...';
            
            try {
              // Prepare email data
              const emailFormData = new FormData();
              emailFormData.append('pdf_file', pdfBlob, fileName);
              emailFormData.append('inspector_email', formData.inspectorEmail || '');
              emailFormData.append('partner_email', formData.partnerEmail || '');
              emailFormData.append('property_address', `${formData.propertyAddress || ''}, ${formData.city || ''}, ${formData.state || ''} ${formData.zipcode || ''}`.trim());
              emailFormData.append('v_id', v_id);
              
              console.log('📧 Sending emails to:', {
                inspector: formData.inspectorEmail,
                partner: formData.partnerEmail,
                address: `${formData.propertyAddress}, ${formData.city}, ${formData.state} ${formData.zipcode}`
              });
              
              // Send emails
              const emailResponse = await fetch('/api/send-report-email', {
                method: 'POST',
                body: emailFormData
              });
              
              if (!emailResponse.ok) {
                throw new Error(`Email sending failed: ${emailResponse.statusText}`);
              }
              
              const emailResult = await emailResponse.json();
              console.log('✅ Emails sent successfully:', emailResult);
              
              // STEP 4: Complete success
              btn.innerHTML = '<i class="fas fa-check"></i> Report Sent Successfully!';
              btn.style.background = '#6c757d'; // Gray color
              btn.disabled = true;
            
            // Enable step 6 (Complete)
            const step6Circle = document.getElementById('step-circle-6');
            const step6Content = document.getElementById('step-6');
            
            if (step6Circle) {
              step6Circle.classList.add('active');
              step6Circle.style.opacity = '1';
              step6Circle.style.pointerEvents = 'auto';
              step6Circle.style.cursor = 'pointer';
            }
            
            if (step6Content) {
              step6Content.style.display = 'block';
            }
            
            // MANTENER el paso 5 visible para poder regresar
            const step5Content = document.getElementById('step-5');
            if (step5Content) {
              step5Content.style.display = 'block';
              debugLog('✅ Step 5 kept visible for potential return');
            }
            
            // Update progress to step 6
            updateProgress(6);
            
            // Show success message with email info
            const emailCount = emailResult.total_sent || 0;
            const emailList = emailResult.emails_sent ? emailResult.emails_sent.join(', ') : 'None';
            alert(`✅ Success!\n\n1. ✅ PDF Downloaded: ${fileName}\n2. ✅ Uploaded to Monday.com\n3. ✅ Emails sent to ${emailCount} recipient(s): ${emailList}\n4. ✅ You can now proceed to Step 6 (Complete)`);
            
            } catch (emailError) {
              console.error('❌ Email sending error:', emailError);
              btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Email Failed';
              
              // Still enable step 6 since upload succeeded
              const step6Circle = document.getElementById('step-circle-6');
              const step6Content = document.getElementById('step-6');
              
              if (step6Circle) {
                step6Circle.classList.add('active');
                step6Circle.style.opacity = '1';
                step6Circle.style.pointerEvents = 'auto';
                step6Circle.style.cursor = 'pointer';
              }
              
              if (step6Content) {
                step6Content.style.display = 'block';
              }
              
              updateProgress(6);
              
              alert(`⚠️ Partial Success!\n\n1. ✅ PDF Downloaded: ${fileName}\n2. ✅ Uploaded to Monday.com\n3. ❌ Email sending failed: ${emailError.message}\n\nThe report was successfully generated and uploaded, but emails could not be sent. You may need to send them manually.`);
              
              // Reset button for retry
              setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.style.background = '#28a745';
              }, 5000);
              return;
            }
            
          } catch (uploadError) {
            console.error('❌ Upload error:', uploadError);
            btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Upload Failed';
            alert(`✅ PDF Downloaded successfully!\n❌ But upload to Monday.com failed: ${uploadError.message}\n\nYou can manually upload the downloaded PDF.`);
            
            // Reset button for retry
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.disabled = false;
              btn.style.background = '#28a745';
            }, 3000);
            return;
          }

        } catch (error) {
          console.error('❌ PDFMake error:', error);
          btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> PDFMake Failed';
          alert(`❌ PDFMake failed: ${error.message}`);
          
          // Reset button on main error
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            btn.style.background = '#28a745';
          }, 3000);
        }
      }

      // Helper function: Generate Photo Sections for PDFMake
      async function generatePhotoSectionsPDFMake(photoData, formData) {
        console.log('🔍 DEBUG: generatePhotoSectionsPDFMake iniciada');
        console.log('🔍 DEBUG: photoData recibido:', photoData);
        console.log('🔍 DEBUG: photoData keys:', Object.keys(photoData));
        
        // Debug each photo section
        Object.keys(photoData).forEach(key => {
          const section = photoData[key];
          console.log(`📸 [PHOTOS] Section: ${key}`);
          console.log(`📸 [PHOTOS] Images: ${section.images?.length || 0} items`);
          console.log(`📸 [PHOTOS] Links: ${section.links?.length || 0} items`);
          if (section.images && section.images.length > 0) {
            console.log(`📸 [PHOTOS] First image: ${section.images[0]}`);
            console.log(`📸 [PHOTOS] First link: ${section.links?.[0] || 'N/A'}`);
          }
        });
        
        const sections = [];
        
        const photoSectionConfig = {
          'General & Identifying Photos': [
            { key: 'identifying_photo_address', label: 'Property Address Photo' },
            { key: 'business_identifier_sign', label: 'Business Identifier Sign' }
          ],
          'Site Access & Obstructions': [
            { key: 'roof_access', label: 'Roof Access' },
            { key: 'rooftop_obstructions', label: 'Rooftop Obstructions' }
          ],
          'Storm Documentation': [
            { key: 'noaa_swath_screenshot', label: 'NOAA Swath Screenshot' },
            { key: 'impact_report_screenshot', label: 'Impact Report Screenshot' }
          ],
          'Exterior Ground Photos': [
            { key: 'ground_front', label: 'Ground Front' },
            { key: 'ground_back', label: 'Ground Back' },
            { key: 'ground_left_side', label: 'Ground Left Side' },
            { key: 'ground_right_side', label: 'Ground Right Side' }
          ],
          'Overview & Access Points': [
            { key: 'aerial_overview', label: 'Aerial Overview' },
            { key: 'property_entrance', label: 'Property Entrance' }
          ],
          'Interior Damage Photos': [
            { key: 'interior_photo_1', label: 'Interior Photo 1' },
            { key: 'interior_photo_2', label: 'Interior Photo 2' },
            { key: 'interior_photo_3', label: 'Interior Photo 3' },
            { key: 'interior_photo_4', label: 'Interior Photo 4' },
            { key: 'interior_photo_5', label: 'Interior Photo 5' },
            { key: 'interior_photo_6', label: 'Interior Photo 6' },
            { key: 'interior_photo_7', label: 'Interior Photo 7' },
            { key: 'interior_photo_8', label: 'Interior Photo 8' },
            { key: 'interior_photo_9', label: 'Interior Photo 9' }
          ],
          'HVAC Damage': [
            { key: 'hvac_damage_photo_1', label: 'HVAC Photo 1' },
            { key: 'hvac_damage_photo_2', label: 'HVAC Photo 2' },
            { key: 'hvac_damage_photo_3', label: 'HVAC Photo 3' },
            { key: 'hvac_damage_photo_4', label: 'HVAC Photo 4' },
            { key: 'hvac_damage_photo_5', label: 'HVAC Photo 5' },
            { key: 'hvac_damage_photo_6', label: 'HVAC Photo 6' },
            { key: 'hvac_damage_photo_7', label: 'HVAC Photo 7' },
            { key: 'hvac_damage_photo_8', label: 'HVAC Photo 8' },
            { key: 'hvac_damage_photo_9', label: 'HVAC Photo 9' }
          ],
          'Window Damage Observation': [
            { key: 'ground_exterior_photo_1', label: 'Window Photo 1' },
            { key: 'ground_exterior_photo_2', label: 'Window Photo 2' },
            { key: 'ground_exterior_photo_3', label: 'Window Photo 3' },
            { key: 'ground_exterior_photo_4', label: 'Window Photo 4' },
            { key: 'ground_exterior_photo_5', label: 'Window Photo 5' },
            { key: 'ground_exterior_photo_6', label: 'Window Photo 6' },
            { key: 'ground_exterior_photo_7', label: 'Window Photo 7' },
            { key: 'ground_exterior_photo_8', label: 'Window Photo 8' },
            { key: 'ground_exterior_photo_9', label: 'Window Photo 9' }
          ],
          'Roofing System Damage & Components': [
            { key: 'roof_damage_photo_1', label: 'Roof Photo 1' },
            { key: 'roof_damage_photo_2', label: 'Roof Photo 2' },
            { key: 'roof_damage_photo_3', label: 'Roof Photo 3' },
            { key: 'roof_damage_photo_4', label: 'Roof Photo 4' },
            { key: 'roof_damage_photo_5', label: 'Roof Photo 5' },
            { key: 'roof_damage_photo_6', label: 'Roof Photo 6' },
            { key: 'roof_damage_photo_7', label: 'Roof Photo 7' },
            { key: 'roof_damage_photo_8', label: 'Roof Photo 8' },
            { key: 'roof_damage_photo_9', label: 'Roof Photo 9' }
          ],
          'Exterior Components': [
            { key: 'exterior_components_photo_1', label: 'Exterior Component 1' },
            { key: 'exterior_components_photo_2', label: 'Exterior Component 2' },
            { key: 'exterior_components_photo_3', label: 'Exterior Component 3' },
            { key: 'exterior_components_photo_4', label: 'Exterior Component 4' },
            { key: 'exterior_components_photo_5', label: 'Exterior Component 5' },
            { key: 'exterior_components_photo_6', label: 'Exterior Component 6' },
            { key: 'exterior_components_photo_7', label: 'Exterior Component 7' },
            { key: 'exterior_components_photo_8', label: 'Exterior Component 8' },
            { key: 'exterior_components_photo_9', label: 'Exterior Component 9' }
          ]
        };

        // Define which sections should use simple column layout
        const simpleLayoutSections = [
          'General & Identifying Photos',
          'Site Access & Obstructions', 
          'Storm Documentation',
          'Exterior Ground Photos',
          'Overview & Access Points'
        ];

        // Process simple layout sections first (grouped together for 2 pages)
        let simplePageCount = 0;
        const maxSimpleSectionsPerPage = 3; // Adjust based on content
        
        for (const [sectionTitle, sectionItems] of Object.entries(photoSectionConfig)) {
          const isSimpleLayout = simpleLayoutSections.includes(sectionTitle);
          
          if (!isSimpleLayout) continue; // Skip non-simple sections for now
          
          console.log(`🔍 DEBUG: Procesando sección simple "${sectionTitle}"`);
          
          const sectionPhotos = sectionItems.filter(item => {
            const hasData = photoData[item.key] && photoData[item.key].images && photoData[item.key].images.length > 0;
            return hasData;
          });
          
          if (sectionPhotos.length > 0) {
            // Add page break only for first simple section or every 3rd section
            const needsPageBreak = simplePageCount === 0 || simplePageCount % maxSimpleSectionsPerPage === 0;
            
            // Add compact section title
            sections.push({
              text: sectionTitle,
              fontSize: 14,
              bold: true,
              color: '#000000',
              alignment: 'center',
              margin: [0, needsPageBreak ? 20 : 15, 0, 10],
              pageBreak: needsPageBreak ? 'before' : undefined
            });

            // Handle Exterior Ground Photos specially
            if (sectionTitle === 'Exterior Ground Photos') {
              // 2x2 GRID LAYOUT for Ground Photos (compact version)
              const groundPhotos = {
                front: null,
                back: null,
                left: null,
                right: null
              };
              
              // Collect photos for each ground position
              for (const photoItem of sectionPhotos) {
                const photos = photoData[photoItem.key];
                if (photos && photos.images && photos.images.length > 0) {
                  if (photoItem.key === 'ground_front') groundPhotos.front = { photos, label: photoItem.label };
                  if (photoItem.key === 'ground_back') groundPhotos.back = { photos, label: photoItem.label };
                  if (photoItem.key === 'ground_left_side') groundPhotos.left = { photos, label: photoItem.label };
                  if (photoItem.key === 'ground_right_side') groundPhotos.right = { photos, label: photoItem.label };
                }
              }
              
              // Create compact 2x2 grid
              const createCompactPhotoCell = async (groundData) => {
                if (!groundData) return { text: '', width: '50%' };
                
                const photoUrl = groundData.photos.images[0];
                const linkUrl = groundData.photos.links[0] || photoUrl;
                
                return {
                  stack: [
                    {
                      text: groundData.label,
                      fontSize: 12,
                      bold: true,
                      color: '#333333',
                      alignment: 'center',
                      margin: [0, 0, 0, 8]
                    },
                    {
                      image: await (async () => {
                        console.log(`🖼️ [PDFMAKE] Converting image for PDF: ${photoUrl}`);
                        const base64Result = await imageUrlToBase64(photoUrl);
                        console.log(`🖼️ [PDFMAKE] Conversion result length: ${base64Result.length}`);
                        console.log(`🖼️ [PDFMAKE] Result starts with: ${base64Result.substring(0, 50)}`);
                        return base64Result;
                      })(),
                      width: 180,
                      height: 135,
                      link: linkUrl,
                      alignment: 'center'
                    }
                  ],
                  width: '50%',
                  alignment: 'center'
                };
              };
              
              // Create 2x2 table
              sections.push({
                table: {
                  widths: ['50%', '50%'],
                  body: [
                    [
                      await createCompactPhotoCell(groundPhotos.front),
                      await createCompactPhotoCell(groundPhotos.back)
                    ],
                    [
                      await createCompactPhotoCell(groundPhotos.left),
                      await createCompactPhotoCell(groundPhotos.right)
                    ]
                  ]
                },
                layout: 'noBorders',
                margin: [0, 0, 0, 20]
              });
              
            } else {
              // COMPACT LAYOUT: All subsections in horizontal layout
              const columnContents = [];
              
              for (const photoItem of sectionPhotos) {
                const photos = photoData[photoItem.key];
                if (photos && photos.images && photos.images.length > 0) {
                  const photoUrl = photos.images[0]; // Only 1 photo per subsection
                  const linkUrl = photos.links[0] || photoUrl;
                  
                  columnContents.push({
                    stack: [
                      {
                        text: photoItem.label,
                        fontSize: 12,
                        bold: true,
                        color: '#333333',
                        alignment: 'center',
                        margin: [0, 0, 0, 8]
                      },
                      {
                        image: await (async () => {
                          console.log(`🖼️ [PDFMAKE-2] Converting image for PDF: ${photoUrl}`);
                          const base64Result = await imageUrlToBase64(photoUrl);
                          console.log(`🖼️ [PDFMAKE-2] Conversion result length: ${base64Result.length}`);
                          console.log(`🖼️ [PDFMAKE-2] Result starts with: ${base64Result.substring(0, 50)}`);
                          return base64Result;
                        })(),
                        width: 150,
                        height: 113,
                        link: linkUrl,
                        alignment: 'center'
                      }
                    ],
                    width: '*'
                  });
                }
              }
              
              if (columnContents.length > 0) {
                sections.push({
                  columns: columnContents,
                  columnGap: 20,
                  margin: [0, 0, 0, 20]
                });
              }
            }
            
            simplePageCount++;
          }
        }

        // Now process non-simple sections
        for (const [sectionTitle, sectionItems] of Object.entries(photoSectionConfig)) {
          const isSimpleLayout = simpleLayoutSections.includes(sectionTitle);
          
          if (isSimpleLayout) continue; // Skip simple sections (already processed)
          console.log(`🔍 DEBUG: Procesando sección "${sectionTitle}"`);
          console.log(`🔍 DEBUG: formData disponible:`, !!formData);
          console.log(`🔍 DEBUG: formData.interiorPhotoExplanations:`, formData?.interiorPhotoExplanations ? 'Disponible' : 'No disponible');
          console.log(`🔍 DEBUG: ${sectionTitle} - isSimpleLayout: ${isSimpleLayout}`);
          
          const sectionPhotos = sectionItems.filter(item => {
            const hasData = photoData[item.key] && photoData[item.key].images && photoData[item.key].images.length > 0;
            console.log(`🔍 DEBUG: ${item.key} - hasData: ${hasData}`);
            if (hasData) {
              console.log(`🔍 DEBUG: ${item.key} tiene ${photoData[item.key].images.length} fotos`);
            }
            return hasData;
          });
          
          if (sectionPhotos.length > 0) {
            // PÁGINA 1: Solo título de sección (página de anuncio) - for non-simple sections only
            sections.push({
              table: {
                widths: ['*'],
                body: [[{
                  text: sectionTitle,
                  fontSize: 18,
                  bold: true,
                  color: '#ffffff',
                  fillColor: '#87CEEB',
                  alignment: 'center',
                  margin: [20, 25, 20, 25],
                  border: [false, false, false, false]
                }]]
              },
              pageBreak: 'before',
              margin: [50, 150, 50, 50] // Centered vertically
            });

            // Add special content for HVAC Damage section
            if (sectionTitle === 'HVAC Damage') {
              // Add description and totals
              sections.push({
                text: 'Focus on damage to HVAC units, compressors, coils, fans, electrical components, and ductwork',
                fontSize: 12,
                italics: true,
                color: '#666666',
                alignment: 'center',
                margin: [0, 20, 0, 15]
              });

              // Add HVAC totals if available (with null check)
              console.log('🔍 DEBUG: formData para HVAC:', formData);
              console.log('🔍 DEBUG: formData.hvacUnitsTotal:', formData?.hvacUnitsTotal);
              console.log('🔍 DEBUG: formData.rtusTotal:', formData?.rtusTotal);
              
              if (formData && (formData.hvacUnitsTotal || formData.rtusTotal)) {
                console.log('🔍 DEBUG: Generando tabla de totales HVAC');
                const totalRows = [];
                
                if (formData.hvacUnitsTotal) {
                  totalRows.push([
                    { text: 'Number of HVAC Units in Total:', bold: true, fillColor: '#f0f0f0' },
                    { text: formData.hvacUnitsTotal, fillColor: '#f0f0f0' }
                  ]);
                }
                
                if (formData.rtusTotal) {
                  totalRows.push([
                    { text: 'Number of RTUS in Total:', bold: true, fillColor: '#f0f0f0' },
                    { text: formData.rtusTotal, fillColor: '#f0f0f0' }
                  ]);
                }
                
                if (totalRows.length > 0) {
                  sections.push({
                    table: {
                      widths: ['70%', '30%'],
                      body: totalRows
                    },
                    layout: {
                      hLineWidth: () => 1,
                      vLineWidth: () => 1,
                      hLineColor: () => '#cccccc',
                      vLineColor: () => '#cccccc'
                    },
                    margin: [0, 10, 0, 30]
                  });
                }
              }
            }

            // Multi-photo sections (not simple layout)
            for (const photoItem of sectionPhotos) {
              const photos = photoData[photoItem.key];
              if (photos && photos.images && photos.images.length > 0) {
                console.log(`🔍 DEBUG: ${photoItem.key} - photos structure:`, photos);
                
                // Get explanation from formData for interior or HVAC photos
                let explanation = photos.explanation;
                let observationTitle = 'Observations:';
                
                if (photoItem.key.startsWith('interior_photo_') && formData && formData.interiorPhotoExplanations) {
                  const photoNumber = photoItem.key.split('_')[2];
                  const explanationKey = `interior_photo_explanation_${photoNumber}`;
                  explanation = formData.interiorPhotoExplanations[explanationKey] || photos.explanation || '';
                  observationTitle = 'Interior Damage Observations:';
                  console.log(`🔍 DEBUG: Interior explanation for ${photoItem.key}:`, explanation);
                } else if (photoItem.key.startsWith('interior_photo_')) {
                  console.log(`⚠️ DEBUG: formData or interiorPhotoExplanations not available for ${photoItem.key}`);
                  explanation = photos.explanation || '';
                  observationTitle = 'Interior Damage Observations:';
                } else if (photoItem.key.startsWith('hvac_damage_photo_') && formData) {
                  // Get HVAC damage observations from checkboxes
                  const photoNumber = photoItem.key.split('_')[3];
                  const hvacObservations = [];
                  
                  // Check each HVAC damage checkbox
                  const hvacChecks = [
                    { key: `hvac_damage_photo_${photoNumber}_hail_1`, text: 'Finned coil dents from hail impact' },
                    { key: `hvac_damage_photo_${photoNumber}_hail_2`, text: 'Crushed coil fins reducing airflow efficiency' },
                    { key: `hvac_damage_photo_${photoNumber}_hail_3`, text: 'Cabinet dents and surface damage' },
                    { key: `hvac_damage_photo_${photoNumber}_hail_4`, text: 'Bent fan guard compromising protection' },
                    { key: `hvac_damage_photo_${photoNumber}_hail_5`, text: 'Damaged fan blades affecting operation' },
                    { key: `hvac_damage_photo_${photoNumber}_hail_6`, text: 'Paint chipping exposing metal to corrosion' }
                  ];
                  
                  for (const check of hvacChecks) {
                    if (formData[check.key]) {
                      hvacObservations.push(check.text);
                    }
                  }
                  
                  if (hvacObservations.length > 0) {
                    explanation = hvacObservations.map((obs, index) => `${index + 1}. ${obs}`).join('\n');
                  }
                  observationTitle = 'Observations: HVAC Damage Assessment:';
                  console.log(`🔍 DEBUG: HVAC explanation for ${photoItem.key}:`, explanation);
                } else if (photoItem.key.startsWith('ground_exterior_photo_') && formData) {
                  // Get Window Damage observations from checkboxes
                  const photoNumber = photoItem.key.split('_')[3];
                  const windowObservations = [];
                  
                  // Window damage checkboxes - using exterior observation descriptions
                  const windowChecks = [
                    { key: `ground_exterior_photo_${photoNumber}_hail_1`, text: 'Hail can crack window glass upon impact, weakening structural integrity and posing a safety risk' },
                    { key: `ground_exterior_photo_${photoNumber}_hail_2`, text: 'Larger or faster hailstones may shatter panes completely, requiring immediate replacement' },
                    { key: `ground_exterior_photo_${photoNumber}_hail_3`, text: 'Small chips or pitting on the glass surface can occur from repeated hail strikes' },
                    { key: `ground_exterior_photo_${photoNumber}_hail_4`, text: 'Window frames may dent, crack, or warp, especially in aluminum, vinyl, or wood materials' },
                    { key: `ground_exterior_photo_${photoNumber}_hail_5`, text: 'Impact from hail can break the seal on double-pane windows, allowing moisture intrusion' },
                    { key: `ground_exterior_photo_${photoNumber}_hail_6`, text: 'Glazing beads or trim pieces can become dislodged or broken, reducing weather resistance' },
                    { key: `ground_exterior_photo_${photoNumber}_hail_7`, text: 'Seal failure may cause fogging or condensation between panes, reducing visibility and efficiency' },
                    { key: `ground_exterior_photo_${photoNumber}_hail_8`, text: 'Window screens are easily torn or punctured by hail, leaving openings for insects and debris' },
                    { key: `ground_exterior_photo_${photoNumber}_hail_9`, text: 'Paint or finish on window frames may chip away, exposing material to weathering and decay' },
                    { key: `ground_exterior_photo_${photoNumber}_hail_10`, text: 'Debris driven by hailstorms can leave additional impact marks or scratches on both the glass and surrounding structure' }
                  ];
                  
                  for (const check of windowChecks) {
                    if (formData[check.key]) {
                      windowObservations.push(check.text);
                    }
                  }
                  
                  if (windowObservations.length > 0) {
                    explanation = windowObservations.map((obs, index) => `${index + 1}. ${obs}`).join('\n');
                  }
                  observationTitle = 'Observations: Window Damage Observations:';
                  console.log(`🔍 DEBUG: Window explanation for ${photoItem.key}:`, explanation);
                } else if (photoItem.key.startsWith('roof_damage_photo_') && formData) {
                  // Get Roof Damage observations from checkboxes
                  const photoNumber = photoItem.key.split('_')[3];
                  const roofObservations = [];
                  
                  // Roof damage checkboxes - common types
                  const roofChecks = [
                    { key: `roof_damage_photo_${photoNumber}_asphalt_hail_0`, text: 'Hail impact marks visible on shingle surface, indicating direct storm damage' },
                    { key: `roof_damage_photo_${photoNumber}_asphalt_hail_1`, text: 'Granule loss exposes underlying mat, reducing weather protection and accelerating aging' },
                    { key: `roof_damage_photo_${photoNumber}_asphalt_hail_2`, text: 'Cracked shingles compromise water barrier and require immediate repair or replacement' },
                    { key: `roof_damage_photo_${photoNumber}_asphalt_hail_3`, text: 'Soft spot bruising weakens shingle integrity and creates potential leak points' },
                    { key: `roof_damage_photo_${photoNumber}_asphalt_hail_4`, text: 'Displaced granules accumulate in gutters, indicating widespread hail impact damage' },
                    { key: `roof_damage_photo_${photoNumber}_asphalt_hail_5`, text: 'Exposed mat from granule loss accelerates UV degradation and water penetration' },
                    { key: `roof_damage_photo_${photoNumber}_asphalt_hail_6`, text: 'Fractured shingle edges create entry points for wind-driven rain and moisture' },
                    { key: `roof_damage_photo_${photoNumber}_asphalt_hail_7`, text: 'Bruised or dented shingles lose structural integrity and weather resistance' },
                    { key: `roof_damage_photo_${photoNumber}_metal_hail_0`, text: 'Metal roof denting from hail impact affects drainage and aesthetic appearance' },
                    { key: `roof_damage_photo_${photoNumber}_metal_hail_1`, text: 'Paint damage on metal roofing exposes substrate to corrosion and weathering' },
                    { key: `roof_damage_photo_${photoNumber}_metal_hail_2`, text: 'Fastener damage compromises panel attachment and wind resistance' },
                    { key: `roof_damage_photo_${photoNumber}_metal_hail_3`, text: 'Seam separation allows water infiltration and reduces structural integrity' }
                  ];
                  
                  for (const check of roofChecks) {
                    if (formData[check.key]) {
                      roofObservations.push(check.text);
                    }
                  }
                  
                  if (roofObservations.length > 0) {
                    explanation = roofObservations.map((obs, index) => `${index + 1}. ${obs}`).join('\n');
                  }
                  observationTitle = 'Observations: Roofing System Damage Assessment:';
                  console.log(`🔍 DEBUG: Roof explanation for ${photoItem.key}:`, explanation);
                } else if (photoItem.key.startsWith('exterior_components_photo_')) {
                  // Get Exterior Components observations using the same function as the regular PDF system
                  try {
                    explanation = getSelectedExteriorComponentsObservations(photoItem.key);
                    if (explanation && explanation.includes('Exterior Components Damage Observations:')) {
                      // Remove the title from the explanation since we add our own
                      explanation = explanation.replace('Exterior Components Damage Observations:\n', '').trim();
                    }
                    console.log(`🔍 DEBUG: Exterior Components explanation for ${photoItem.key}:`, explanation);
                  } catch (error) {
                    console.log(`⚠️ DEBUG: Error getting exterior components observations for ${photoItem.key}:`, error);
                    explanation = photos.explanation || '';
                  }
                  observationTitle = 'Observations: Exterior Components Assessment:';
                }
                
                // Nueva página para cada subsección (título más compacto)
                sections.push({
                  text: photoItem.label,
                  fontSize: 14,
                  bold: true,
                  color: '#87CEEB',
                  margin: [0, 0, 0, 12],
                  pageBreak: 'before'
                });
                
                // Separar fotos principales de Manufacturer Tag para mejor layout
                const mainPhotos = photos.images || [];
                const mainLinks = photos.links || mainPhotos;
                const manufacturerPhotos = [];
                const manufacturerLinks = [];
                
                // Para HVAC, separar Manufacturer Tag Photos
                if (photoItem.key.startsWith('hvac_damage_photo_')) {
                  const photoNumber = photoItem.key.split('_')[3];
                  const manufacturerTagKey = `manufacturer_tag_photo_${photoNumber}`;
                  const manufacturerTagPhotos = photoData[manufacturerTagKey];
                  
                  if (manufacturerTagPhotos && manufacturerTagPhotos.images && manufacturerTagPhotos.images.length > 0) {
                    manufacturerPhotos.push(...manufacturerTagPhotos.images);
                    manufacturerLinks.push(...(manufacturerTagPhotos.links || manufacturerTagPhotos.images));
                    console.log(`🔍 DEBUG: Adding Manufacturer Tag Photos for ${photoItem.key}:`, manufacturerTagPhotos.images.length);
                  }
                }
                
                // FOTOS PRINCIPALES en grid 2x2
                if (mainPhotos.length > 0) {
                  const photoGrid = [];
                  for (let i = 0; i < mainPhotos.length; i += 2) {
                    const row = [];
                    for (let j = 0; j < 2; j++) {
                      if (i + j < mainPhotos.length) {
                        const photoUrl = mainPhotos[i + j];
                        const linkUrl = mainLinks[i + j] || photoUrl;
                        
                        row.push({
                          stack: [
                            {
                              image: await imageUrlToBase64(photoUrl),
                              width: 220,
                              height: 165,
                              link: linkUrl,
                              alignment: 'center'
                            }
                          ],
                          width: '50%',
                          margin: [5, 5, 5, 10]
                        });
                      } else {
                        row.push({ text: '', width: '50%' });
                      }
                    }
                    photoGrid.push(row);
                  }
                  
                  sections.push({
                    table: {
                      widths: ['50%', '50%'],
                      body: photoGrid
                    },
                    layout: 'noBorders',
                    margin: [0, 10, 0, 10]
                  });
                }
                
                // MANUFACTURER TAG PHOTO centrada abajo
                if (manufacturerPhotos.length > 0) {
                  for (let i = 0; i < manufacturerPhotos.length; i++) {
                    const photoUrl = manufacturerPhotos[i];
                    const linkUrl = manufacturerLinks[i] || photoUrl;
                    
                    sections.push({
                      stack: [
                        {
                          image: await imageUrlToBase64(photoUrl),
                          width: 200,
                          height: 150,
                          link: linkUrl,
                          alignment: 'center'
                        }
                      ],
                      alignment: 'center',
                      margin: [0, 5, 0, 15]
                    });
                  }
                }

                // 📝 OBSERVACIONES ABAJO DE TODAS LAS FOTOS (como solicitó el usuario)
                if (explanation && typeof explanation === 'string' && explanation.trim()) {
                  sections.push({
                    text: observationTitle,
                    fontSize: 12,
                    bold: true,
                    color: '#87CEEB',
                    margin: [0, 20, 0, 10],
                    alignment: 'left'
                  });
                  
                  sections.push({
                    text: explanation,
                    fontSize: 11,
                    color: '#000000',
                    margin: [0, 0, 0, 20],
                    lineHeight: 1.4,
                    alignment: 'justify'
                  });
                }
              }
            } // Close else block for multi-photo layout
          }
        }

        console.log('🔍 DEBUG: Secciones generadas:', sections.length);
        console.log('🔍 DEBUG: Secciones contenido:', sections);
        return sections;
      }

      // Helper function: Convert image URL to Base64
      async function imageUrlToBase64(url) {
        console.log(`🖼️ [BASE64] Converting image to base64: ${url}`);
        
        // Convert to relative URL to avoid CORS issues
        let processedUrl = url;
        if (url.startsWith('http://localhost:5000/')) {
          processedUrl = url.replace('http://localhost:5000', '');
        } else if (url.startsWith('http://127.0.0.1:5000/')) {
          processedUrl = url.replace('http://127.0.0.1:5000', '');
        }
        console.log(`🔄 [BASE64] Using relative URL: ${processedUrl}`);
        
        try {
          console.log(`🔄 [BASE64] Fetching image...`);
          const response = await fetch(processedUrl);
          
          if (!response.ok) {
            console.error(`❌ [BASE64] Fetch failed: ${response.status} ${response.statusText}`);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          console.log(`✅ [BASE64] Fetch successful, converting to blob...`);
          const blob = await response.blob();
          console.log(`📊 [BASE64] Blob size: ${blob.size} bytes, type: ${blob.type}`);
          
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => {
              const result = reader.result;
              console.log(`✅ [BASE64] Conversion successful, result length: ${result.length}`);
              console.log(`🔍 [BASE64] Result preview: ${result.substring(0, 100)}...`);
              resolve(result);
            };
            reader.onerror = (error) => {
              console.error('❌ [BASE64] FileReader error:', error);
              resolve('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==');
            };
            reader.readAsDataURL(blob);
          });
        } catch (error) {
          console.error(`❌ [BASE64] Error converting image to base64 (original: ${url}, processed: ${processedUrl}):`, error);
          return 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='; // 1px transparent
        }
      }

      // 🔍 VERIFICAR QUE LAS FUNCIONES PDF ESTÁN DEFINIDAS AL CARGAR
      console.log('🔍 Verificando funciones PDF...');
      console.log('downloadDARReportPDFMake:', typeof downloadDARReportPDFMake);
      console.log('previewDARReportPDFMake:', typeof previewDARReportPDFMake);
      console.log('generatePhotoSectionsPDFMake:', typeof generatePhotoSectionsPDFMake);
      
      // 🔧 AGREGAR EVENT LISTENER DE RESPALDO AL BOTÓN PDF
      document.addEventListener('DOMContentLoaded', function() {
        const pdfBtn = document.getElementById('downloadReportPDFMakeBtn');
        if (pdfBtn) {
          console.log('✅ [INIT] PDF button found, adding backup event listener');
          
          // Remove any existing onclick to avoid duplicates
          pdfBtn.onclick = null;
          
          // Add fresh event listener
          pdfBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('🖱️ [CLICK] PDF button clicked via event listener');
            downloadDARReportPDFMake();
          });
        } else {
          console.error('❌ [INIT] PDF button not found during initialization');
        }
      });

    </script>
  </body>
</html>
 